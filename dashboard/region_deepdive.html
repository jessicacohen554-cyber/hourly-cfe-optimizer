<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The 8,760 Problem — Regional Deep Dives</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
@font-face {
    font-family: 'Franklin Gothic Demi';
    src: local('Franklin Gothic Demi'), local('Franklin Gothic Medium'), local('ITC Franklin Gothic Demi'), local('Franklin Gothic Demi Cond');
    font-weight: 600;
    font-style: normal;
    font-display: swap;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
/* ========== RESET & BASE ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
    font-size: 17px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    scroll-behavior: smooth;
}

body {
    font-family: 'Plus Jakarta Sans', 'Helvetica Neue', Arial, sans-serif;
    background: #0F1A2E;
    background-image:
        radial-gradient(ellipse at 20% 0%, rgba(14,165,233,0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(245,158,11,0.04) 0%, transparent 50%);
    background-attachment: fixed;
    color: #000000;
    line-height: 1.55;
    min-height: 100vh;
}

:root {
    --navy: #1A2744;
    --navy-light: #2D3A52;
    --bg-card: #FFFFFF;
    --bg-card-hover: #F7F8FA;
    --border: #D4D8E0;
    --border-light: #E5E7EB;
    --text-primary: #000000;
    --text-secondary: #000000;
    --text-muted: #6B7280;
    --clean-firm: #1E3A5F;
    --solar: #F59E0B;
    --wind: #22C55E;
    --hydro: #0EA5E9;
    --storage: #EF4444;
    --accent-blue: #4a90d9;
    --accent-warm: #f4a261;
}

/* ========== TOP NAVIGATION BAR ========== */
.top-nav {
    background: #1a1a2e;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: sticky;
    top: 0;
    z-index: 999;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    min-height: 48px;
}
.top-nav-inner {
    display: flex;
    align-items: center;
    gap: 0;
    max-width: 1440px;
    width: 100%;
    justify-content: center;
}
.top-nav a {
    color: rgba(255,255,255,0.75);
    text-decoration: none;
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', 'Arial Narrow', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 14px 18px;
    transition: color 0.2s, background 0.2s, border-color 0.2s;
    border-bottom: 3px solid transparent;
    white-space: nowrap;
}
.top-nav a:hover {
    color: #ffffff;
    background: rgba(255,255,255,0.06);
}
.top-nav a.nav-active {
    color: #ffffff;
    border-bottom-color: #0EA5E9;
    background: rgba(14,165,233,0.1);
}
.nav-hamburger {
    display: none;
    background: none;
    border: none;
    color: #ffffff;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 10px;
    min-width: 44px;
    min-height: 44px;
    align-items: center;
    justify-content: center;
}
.nav-hamburger svg {
    width: 24px;
    height: 24px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
}
@media (max-width: 768px) {
    .top-nav {
        flex-wrap: wrap;
        padding: 0 12px;
        justify-content: space-between;
    }
    .top-nav-inner {
        display: none;
        flex-direction: column;
        width: 100%;
        padding-bottom: 8px;
    }
    .top-nav-inner.nav-open {
        display: flex;
    }
    .top-nav a {
        padding: 12px 16px;
        border-bottom: none;
        border-left: 3px solid transparent;
        width: 100%;
        text-align: left;
    }
    .top-nav a.nav-active {
        border-left-color: #0EA5E9;
        border-bottom: none;
        background: rgba(14,165,233,0.12);
    }
    .nav-hamburger {
        display: flex;
    }
    .nav-brand {
        display: flex;
        align-items: center;
        color: #ffffff;
        font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
        font-size: 0.9rem;
        font-weight: 700;
        letter-spacing: 0.03em;
        padding: 12px 0;
    }
}
@media (min-width: 769px) {
    .nav-brand { display: none; }
}

/* ========== HEADER BANNER ========== */
.header {
    background: linear-gradient(135deg, #0F1A2E 0%, #122952 30%, #1565C0 70%, #0D47A1 100%);
    color: #ffffff;
    padding: 72px 24px 64px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
.header::before {
    content: '';
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    background:
        radial-gradient(ellipse 55% 70% at 12% 75%, rgba(14,165,233,0.4) 0%, transparent 65%),
        radial-gradient(ellipse 45% 60% at 38% 85%, rgba(34,197,94,0.35) 0%, transparent 60%),
        radial-gradient(ellipse 50% 65% at 62% 80%, rgba(245,158,11,0.35) 0%, transparent 60%),
        radial-gradient(ellipse 40% 55% at 88% 70%, rgba(239,68,68,0.3) 0%, transparent 55%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 240' preserveAspectRatio='none'%3E%3Cdefs%3E%3ClinearGradient id='a1' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0' stop-color='rgba(255,255,255,0.15)'/%3E%3Cstop offset='1' stop-color='rgba(255,255,255,0.01)'/%3E%3C/linearGradient%3E%3ClinearGradient id='a2' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0' stop-color='rgba(34,197,94,0.35)'/%3E%3Cstop offset='1' stop-color='rgba(34,197,94,0.03)'/%3E%3C/linearGradient%3E%3ClinearGradient id='a3' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0' stop-color='rgba(245,158,11,0.35)'/%3E%3Cstop offset='1' stop-color='rgba(245,158,11,0.03)'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M0,240 L0,130 C200,100 400,70 600,80 C800,90 1000,120 1200,100 L1200,240 Z' fill='url(%23a1)'/%3E%3Cpath d='M0,240 L0,160 C200,140 400,115 600,125 C800,135 1000,155 1200,140 L1200,240 Z' fill='url(%23a2)'/%3E%3Cpath d='M0,240 L0,190 C200,180 400,165 600,170 C800,175 1000,188 1200,180 L1200,240 Z' fill='url(%23a3)'/%3E%3Cpath d='M0,130 C200,100 400,70 600,80 C800,90 1000,120 1200,100' fill='none' stroke='rgba(255,255,255,0.45)' stroke-width='2'/%3E%3Cpath d='M0,160 C200,140 400,115 600,125 C800,135 1000,155 1200,140' fill='none' stroke='%2322C55E' stroke-width='2' stroke-opacity='0.6'/%3E%3Cpath d='M0,190 C200,180 400,165 600,170 C800,175 1000,188 1200,180' fill='none' stroke='%23F59E0B' stroke-width='2' stroke-opacity='0.6'/%3E%3C/svg%3E") no-repeat bottom center;
    background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
}
.header::after {
    content: '';
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    background:
        radial-gradient(ellipse 70% 45% at 50% 45%, rgba(5,15,35,0.55) 0%, transparent 100%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 80' preserveAspectRatio='none'%3E%3Cpath d='M0,50 L250,50 L270,18 L288,68 L306,22 L324,60 L342,50 L1200,50' fill='none' stroke='rgba(14,165,233,0.5)' stroke-width='2'/%3E%3Cpath d='M0,35 L600,35 L618,10 L636,60 L654,14 L672,55 L690,35 L1200,35' fill='none' stroke='rgba(245,158,11,0.4)' stroke-width='2'/%3E%3C/svg%3E") no-repeat top center;
    background-size: 100% 100%, 100% 80px;
}
.header-accent {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 25%, #22C55E 50%, #F59E0B 75%, #EF4444 100%);
    z-index: 2;
}
.header h1 {
    font-family: 'Franklin Gothic Demi', 'Lexend', 'Rajdhani', 'Arial Narrow', 'Helvetica Neue', Arial, sans-serif;
    font-weight: 700;
    font-size: 3.2rem;
    letter-spacing: 0.5px;
    margin-bottom: 14px;
    position: relative;
    z-index: 3;
    text-shadow: 0 2px 20px rgba(0,0,0,0.5), 0 1px 3px rgba(0,0,0,0.3);
    line-height: 1.15;
}
.header .subtitle {
    font-family: 'Plus Jakarta Sans', 'Helvetica Neue', Arial, sans-serif;
    font-size: 1.15rem;
    font-weight: 400;
    opacity: 0.92;
    max-width: 660px;
    margin: 0 auto;
    position: relative;
    z-index: 3;
    text-shadow: 0 2px 12px rgba(0,0,0,0.4), 0 1px 2px rgba(0,0,0,0.2);
    line-height: 1.55;
}

/* ========== REGION TOGGLE ========== */
.region-selector {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 20px 24px;
    background: #F3F4F8;
    border-bottom: 1px solid var(--border-light);
    flex-wrap: wrap;
    position: sticky;
    top: 48px;
    z-index: 998;
}
.region-btn {
    padding: 10px 24px;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: #fff;
    color: var(--text-muted);
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.88rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 44px;
    min-width: 44px;
}
.region-btn:hover {
    border-color: #0EA5E9;
    color: #0284C7;
    background: rgba(14,165,233,0.06);
}
.region-btn.active {
    border-color: var(--navy);
    background: var(--navy);
    color: #fff;
}

/* ========== MAIN CONTENT ========== */
.main-content {
    max-width: 1440px;
    margin: 0 auto;
    padding: 0;
    background: #F3F4F8;
    box-shadow: 0 4px 24px rgba(0,0,0,0.12);
    padding: 20px 0 40px;
}

/* ========== STORY SECTIONS (Act Panels) ========== */
.story-divider-wrap {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0;
}
.story-divider {
    border: none;
    height: 3px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 15%, #22C55E 35%, #F59E0B 55%, #EF4444 80%, #DC2626 100%);
    margin: 0;
    opacity: 0.7;
}

.story-section {
    max-width: 900px;
    margin: 0 auto;
    padding: 72px 48px;
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}
.story-section.visible {
    opacity: 1;
    transform: translateY(0);
}
.story-content {
    position: relative;
}
.story-badge {
    display: inline-block;
    padding: 5px 18px;
    border-radius: 9999px;
    font-size: 0.8rem;
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', 'Arial Narrow', sans-serif;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: capitalize;
    margin-bottom: 18px;
    background: rgba(26,39,68,0.1);
    color: #1A2744;
}
.story-badge-orange {
    background: rgba(239,68,68,0.1);
    color: #DC2626;
}
.story-badge-green {
    background: rgba(34,197,94,0.12);
    color: #7A8B5C;
}

.story-section h2 {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', 'Arial Narrow', sans-serif;
    font-size: 2.4rem;
    font-weight: 800;
    color: #DC2626;
    margin-bottom: 20px;
    letter-spacing: -0.5px;
    line-height: 1.2;
}
.story-section p {
    font-size: 0.98rem;
    color: #1A1A1A;
    line-height: 1.75;
    margin-bottom: 16px;
}

/* Energy spectrum accent bar */
.energy-spectrum-bar {
    height: 3px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 15%, #22C55E 35%, #F59E0B 55%, #EF4444 80%, #DC2626 100%);
    border-radius: 2px;
    margin: 28px 0;
    opacity: 0.6;
}

/* ========== STAT ROW ========== */
.story-stat-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin: 28px 0;
}
.story-stat-card {
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(221,208,192,0.5);
    border-radius: 16px;
    padding: 24px 18px;
    text-align: center;
    box-shadow: 0 4px 6px -4px rgba(0,0,0,0.04);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.story-stat-card:hover {
    transform: translateY(-2px);
}
.story-stat-label {
    font-size: 0.78rem;
    font-weight: 700;
    color: #6B7280;
    letter-spacing: 0.8px;
    text-transform: capitalize;
    margin-bottom: 6px;
}
.story-stat-value {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 2.2rem;
    font-weight: 800;
    color: var(--navy);
    line-height: 1;
}
.story-stat-sub {
    font-size: 0.82rem;
    color: #6B7280;
    margin-top: 6px;
}

/* ========== CHART CONTAINERS ========== */
.chart-container {
    width: 100%;
    margin: 0 auto 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 28px;
    position: relative;
}
.chart-container canvas {
    width: 100% !important;
    height: 340px !important;
}
.chart-container .chart-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 1.0rem;
    color: var(--navy);
    margin-bottom: 16px;
    text-align: center;
}

/* ========== KEY INSIGHT BOX ========== */
.story-insight-box {
    display: flex;
    gap: 16px;
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(221,208,192,0.5);
    border-left: 4px solid #C75B4A;
    border-radius: 0 16px 16px 0;
    padding: 20px 24px;
    margin: 20px 0;
    font-size: 0.92rem;
    color: #1A1A1A;
    line-height: 1.65;
    box-shadow: 0 4px 6px -4px rgba(0,0,0,0.04);
}
.insight-icon {
    font-size: 1.4rem;
    flex-shrink: 0;
    margin-top: 2px;
}

/* ========== FOOTER ========== */
.page-footer {
    background: #1a1a2e;
    color: rgba(255,255,255,0.7);
    padding: 48px 24px;
    text-align: center;
}
.footer-links {
    display: flex;
    gap: 24px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
}
.footer-links a {
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 8px 16px;
    border-radius: 6px;
    transition: background 0.2s, color 0.2s;
    min-height: 44px;
    display: flex;
    align-items: center;
}
.footer-links a:hover {
    background: rgba(255,255,255,0.08);
    color: #ffffff;
}
.footer-note {
    font-size: 0.82rem;
    opacity: 0.5;
    margin-top: 12px;
}

/* ========== BOTTOM ACCENT BAR ========== */
.bottom-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 25%, #22C55E 50%, #F59E0B 75%, #EF4444 100%);
    z-index: 1000;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
    .header { padding: 60px 16px 50px; }
    .header h1 { font-size: 2.2rem; }
    .header .subtitle { font-size: 1rem; }
    .story-section { padding: 48px 20px; }
    .story-section h2 { font-size: 1.8rem; }
    .chart-container { padding: 16px; }
    .chart-container canvas { height: 340px !important; }
    .story-stat-row { gap: 10px; }
    .story-stat-card { padding: 16px 12px; }
    .story-stat-value { font-size: 1.7rem; }
    .region-selector { gap: 6px; padding: 14px 12px; }
    .region-btn { padding: 8px 16px; font-size: 0.82rem; }
}
@media (max-width: 480px) {
    .header h1 { font-size: 1.8rem; }
    .story-stat-row { grid-template-columns: repeat(2, 1fr); }
    .story-insight-box { flex-direction: column; gap: 8px; }
    .chart-container canvas { height: 340px !important; }
    .chart-container { min-height: 360px; }
    .region-btn { padding: 10px 14px; min-height: 44px; font-size: 0.82rem; }
    #headerTitle { font-size: 1.5rem !important; }
    #headerSubtitle { font-size: 0.88rem !important; }
    .story-stat-label { font-size: 0.75rem; }
}
@media (max-width: 375px) {
    .header { padding: 40px 12px 32px; }
    .header h1 { font-size: 1.6rem; }
    .header .subtitle { font-size: 0.88rem; }
    #headerTitle { font-size: 1.3rem !important; }
    .story-section { padding: 32px 14px; }
    .region-btn { width: calc(50% - 4px); }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
    .story-section { opacity: 1; transform: none; transition: none; }
}
</style>
</head>
<body>

<!-- ========== TOP NAVIGATION ========== -->
<nav class="top-nav">
    <span class="nav-brand">The 8,760 Problem</span>
    <button class="nav-hamburger" onclick="document.querySelector('.top-nav-inner').classList.toggle('nav-open')" aria-label="Toggle navigation">
        <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="top-nav-inner">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Cost Optimizer</a>
        <a href="abatement_dashboard.html">Abatement Dashboard</a>
        <a href="region_deepdive.html" class="nav-active">Regional Deep Dives</a>
        <a href="abatement_comparison.html">CO&#8322; Abatement Summary</a>
        <a href="eac_scarcity.html">EAC Scarcity</a>
        <a href="research_paper.html">Methodology &amp; Paper</a>
        <a href="about.html">About</a>
        <a href="../power-gen-decarbonization/site/index.html">Generator Analysis</a>
        <a href="about.html">About</a>
    </div>
</nav>
<div style="background:#F3F4F8;padding:8px 24px;"><a href="index.html" style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-size:0.82rem;font-weight:600;color:#1A2744;text-decoration:none;display:inline-flex;align-items:center;gap:6px;letter-spacing:0.03em;min-height:44px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>Back to Home</a></div>

<!-- ========== HEADER BANNER (shared across all pages) ========== -->
<header class="header">
    <h1>The 8,760 Problem</h1>
    <p class="subtitle">How geography, grid mix, and resource availability shape the path to hourly clean energy matching.</p>
    <div class="header-accent"></div>
</header>

<!-- ========== PAGE TITLE ========== -->
<div style="max-width:900px;margin:0 auto;padding:40px 48px 8px;background:#F3F4F8;">
    <h2 id="headerTitle" style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed','Arial Narrow',sans-serif;font-size:2.4rem;font-weight:800;color:#DC2626;margin-bottom:16px;letter-spacing:-0.5px;line-height:1.2;">Regional Deep Dives</h2>
    <p id="headerSubtitle" style="font-size:0.98rem;color:#1A1A1A;line-height:1.75;max-width:800px;">
        Each U.S. grid region has a unique resource endowment that shapes its path to hourly clean energy.<sup style="font-size:0.7em;color:#6B7280;">[1]</sup>
        Select a region below to explore its existing generation mix, cost trajectory, optimal resource
        portfolio, storage requirements, and carbon abatement economics &mdash; all driven by the optimizer's
        co-optimized results using hourly profiles from EIA<sup style="font-size:0.7em;color:#6B7280;">[1]</sup> and cost assumptions from NREL ATB 2024<sup style="font-size:0.7em;color:#6B7280;">[2]</sup> and Lazard LCOE v17.<sup style="font-size:0.7em;color:#6B7280;">[3]</sup>
    </p>
</div>

<!-- ========== REGION TOGGLE ========== -->
<div class="region-selector">
    <button class="region-btn active" data-region="CAISO">CAISO</button>
    <button class="region-btn" data-region="ERCOT">ERCOT</button>
    <button class="region-btn" data-region="PJM">PJM</button>
    <button class="region-btn" data-region="NYISO">NYISO</button>
    <button class="region-btn" data-region="NEISO">NEISO</button>
</div>

<!-- ========== MAIN CONTENT ========== -->
<main class="main-content">

    <!-- ===== ACT I: The Grid Today ===== -->
    <section class="story-section story-fade-in">
        <div class="story-content">
            <span class="story-badge">Act I</span>
            <h2>The Grid Today</h2>

            <div class="chart-container">
                <div class="chart-title">Current Resource Mix</div>
                <canvas id="gridTodayChart"></canvas>
            </div>

            <div class="story-insight-box" id="insightBaseline">
                <span class="insight-icon">&#9889;</span>
                <div>Loading insight...</div>
            </div>

            <p id="narrativeBaseline">Loading...</p>
        </div>
    </section>

    <div class="story-divider-wrap"><hr class="story-divider"></div>

    <!-- ===== ACT II: The Cost of Ambition + Sensitivity Envelope ===== -->
    <section class="story-section story-fade-in">
        <div class="story-content">
            <span class="story-badge story-badge-orange">Act II</span>
            <h2>The Cost of Ambition</h2>

            <p>The medium-cost trajectory shows the central estimate, anchored to NREL ATB 2024 mid-case projections.<sup style="font-size:0.7em;color:#6B7280;">[2]</sup> The shaded band spans all 324 sensitivity scenarios &mdash; from the most optimistic to the most pessimistic assumptions across renewable generation, firm generation, storage, fossil fuel prices, and transmission costs.<sup style="font-size:0.7em;color:#6B7280;">[2][3]</sup></p>

            <div class="chart-container">
                <div class="chart-title">Cost Trajectory with Sensitivity Envelope: 75% to 100% Hourly Clean Energy</div>
                <canvas id="pathwayChart"></canvas>
            </div>

            <div class="story-insight-box" id="insightCost">
                <span class="insight-icon">&#9889;</span>
                <div>Loading insight...</div>
            </div>

            <p id="narrativeCost">Loading...</p>
        </div>
    </section>

    <div class="story-divider-wrap"><hr class="story-divider"></div>

    <!-- ===== ACT III: Resource Mix Evolution (with storage + curtailment) ===== -->
    <section class="story-section story-fade-in">
        <div class="story-content">
            <span class="story-badge story-badge-green">Act III</span>
            <h2>How the Optimal Mix Evolves</h2>

            <div class="chart-container">
                <div class="chart-title">Resource Mix at Each Threshold (Including Storage &amp; Curtailment)</div>
                <canvas id="mixEvolutionChart"></canvas>
            </div>

            <div class="story-insight-box" id="insightMix">
                <span class="insight-icon">&#9889;</span>
                <div>Loading insight...</div>
            </div>

            <p id="narrativeMix">Loading...</p>
        </div>
    </section>

    <div class="story-divider-wrap"><hr class="story-divider"></div>

    <!-- ===== ACT IV: What You Need Depends on What You Have ===== -->
    <section class="story-section story-fade-in">
        <div class="story-content">
            <span class="story-badge">Act IV</span>
            <h2>What You Need Depends on What You Have</h2>

            <p class="story-lead">The optimal portfolio at any target is shaped by what this region already has.<sup style="font-size:0.7em;color:#6B7280;">[1]</sup> Regions with abundant existing clean energy need less new procurement &mdash; but the <em>type</em> of new resources needed depends on the gap between existing supply and hourly demand.<sup style="font-size:0.7em;color:#6B7280;">[5]</sup></p>

            <div class="chart-container">
                <div class="chart-title">New vs. Existing Resources at Each Threshold</div>
                <canvas id="newVsExistingChart"></canvas>
            </div>

            <div class="story-insight-box" id="insightNewVsExisting">
                <span class="insight-icon">&#9889;</span>
                <div>Loading insight...</div>
            </div>

            <p id="narrativeNewVsExisting">Loading...</p>
        </div>
    </section>

    <div class="story-divider-wrap"><hr class="story-divider"></div>

    <!-- ===== ACT V: Carbon Abatement ===== -->
    <section class="story-section story-fade-in">
        <div class="story-content">
            <span class="story-badge story-badge-orange">Act V</span>
            <h2>Carbon Abatement Economics</h2>

            <div class="chart-container">
                <div class="chart-title">Cost per Ton of CO&#8322; Avoided</div>
                <canvas id="abatementChart"></canvas>
            </div>

            <div class="story-insight-box" id="insightAbatement">
                <span class="insight-icon">&#9889;</span>
                <div>Loading insight...</div>
            </div>

            <p id="narrativeAbatement">Loading...</p>
        </div>
    </section>

</main>

<!-- ========== SOURCES ========== -->
<div style="max-width:900px;margin:0 auto;padding:32px 48px 0;background:#F3F4F8;">
    <details style="border:1px solid #D4D8E0;border-radius:10px;padding:16px 20px;background:#fff;">
        <summary style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-size:0.92rem;font-weight:700;color:#1A2744;cursor:pointer;letter-spacing:0.03em;">Sources &amp; References</summary>
        <ol style="margin-top:14px;padding-left:22px;font-size:0.84rem;color:#374151;line-height:1.85;">
            <li>EIA Hourly Electric Grid Monitor (2021&ndash;2025). U.S. Energy Information Administration.</li>
            <li>NREL Annual Technology Baseline (ATB) 2024. National Renewable Energy Laboratory.</li>
            <li>Lazard&rsquo;s Levelized Cost of Energy Analysis, Version 17.0 (2024).</li>
            <li>EPA eGRID 2022. Emissions &amp; Generation Resource Integrated Database. U.S. Environmental Protection Agency.</li>
            <li>LBNL Utility-Scale Solar &amp; Wind reports (2024). Lawrence Berkeley National Laboratory.</li>
            <li>FERC/ISO Market Reports &mdash; regional wholesale electricity prices.</li>
            <li>LBNL &ldquo;Queued Up&rdquo; (2024) &mdash; characteristics of power plants seeking transmission interconnection.</li>
            <li>IEA Net Zero Roadmap: A Global Pathway to Keep the 1.5&deg;C Goal in Reach (2023 Update).</li>
        </ol>
    </details>
</div>

<!-- ========== FOOTER ========== -->
<footer class="page-footer">
    <div class="footer-links">
        <a href="dashboard.html">Cost Optimizer</a>
        <a href="abatement_dashboard.html">Abatement Dashboard</a>
        <a href="abatement_comparison.html">CO&#8322; Abatement Summary</a>
        <a href="eac_scarcity.html">EAC Scarcity</a>
        <a href="research_paper.html">Methodology &amp; Paper</a>
        <a href="about.html">About</a>
        <a href="../power-gen-decarbonization/site/index.html">Generator Analysis</a>
        <a href="about.html">About</a>
    </div>
    <div class="footer-note">The 8,760 Problem &mdash; 2025 Snapshot Model</div>
</footer>

<!-- ========== BOTTOM ACCENT BAR ========== -->
<div class="bottom-banner"></div>

<!-- ========== DATA-DRIVEN CHARTS ========== -->
<script>
(function() {
    /* ===== CONFIG ===== */
    const REGION_META = {
        CAISO: { name: 'California (CAISO)', color: '#0EA5E9', colorFill: 'rgba(14,165,233,0.35)' },
        ERCOT: { name: 'Texas (ERCOT)', color: '#F59E0B', colorFill: 'rgba(245,158,11,0.35)' },
        PJM:   { name: 'Mid-Atlantic (PJM)', color: '#1E3A5F', colorFill: 'rgba(30,58,95,0.35)' },
        NYISO: { name: 'New York (NYISO)', color: '#22C55E', colorFill: 'rgba(34,197,94,0.35)' },
        NEISO: { name: 'New England (NEISO)', color: '#6366F1', colorFill: 'rgba(99,102,241,0.35)' }
    };

    const MIX_COLORS = {
        clean_firm: { fill: 'rgba(30,58,95,0.50)',    border: '#1E3A5F' },
        ccs_ccgt:   { fill: 'rgba(13,148,136,0.50)',  border: '#0D9488' },
        solar:      { fill: 'rgba(245,158,11,0.50)',  border: '#F59E0B' },
        wind:       { fill: 'rgba(34,197,94,0.50)',   border: '#22C55E' },
        hydro:      { fill: 'rgba(14,165,233,0.50)',  border: '#0EA5E9' },
        battery:    { fill: 'rgba(139,92,246,0.50)',  border: '#8B5CF6' },
        ldes:       { fill: 'rgba(236,72,153,0.50)',  border: '#EC4899' }
    };

    const EMISSION_RATES = { CAISO: 0.37, ERCOT: 0.41, PJM: 0.55, NYISO: 0.37, NEISO: 0.40 }; // EPA eGRID 2022 [4]

    const bodyFont = { family: "'Plus Jakarta Sans', 'Helvetica Neue', Arial, sans-serif" };
    Chart.defaults.font.family = bodyFont.family;
    Chart.defaults.plugins.datalabels = { display: false };

    let currentRegion = 'CAISO';
    let allData = null;
    const chartInstances = {};

    /* ===== REGION TOGGLE ===== */
    document.querySelectorAll('.region-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentRegion = this.dataset.region;
            if (allData) renderAll(allData);
            // Update URL hash for direct linking
            history.replaceState(null, '', '#' + currentRegion);
        });
    });

    // Read hash on load
    const hash = location.hash.replace('#', '');
    if (hash && REGION_META[hash]) {
        currentRegion = hash;
        document.querySelectorAll('.region-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.region === currentRegion);
        });
    }

    /* ===== LOAD DATA ===== */
    fetch('overprocure_results.json')
        .then(r => { if (!r.ok) throw new Error('Failed to load'); return r.json(); })
        .then(data => { allData = data; renderAll(data); })
        .catch(err => console.error('Error loading optimizer results:', err));

    /* ===== SCENARIO RESOLVER (always Medium = MMM_M_M) ===== */
    function resolveScenario(thresholdData) {
        if (!thresholdData?.scenarios) return null;
        return thresholdData.scenarios['MMM_M_M'] || null;
    }
    function getUnifiedCosts(entry) {
        if (!entry) return {};
        const detail = entry.costs_detail || {};
        const costs = entry.costs || {};
        return {
            resource_costs: detail.resource_costs || null,
            effective_cost_per_useful_mwh: detail.effective_cost_per_useful_mwh ?? costs.effective_cost ?? null,
            total_cost_per_demand_mwh: detail.total_cost_per_demand_mwh ?? costs.total_cost ?? null,
            incremental_above_baseline: detail.incremental_above_baseline ?? costs.incremental ?? null,
            baseline_wholesale_cost: detail.baseline_wholesale_cost ?? costs.wholesale ?? null,
            curtailment_pct: detail.curtailment_pct ?? null,
        };
    }

    /* ===== DESTROY CHART HELPER ===== */
    function destroyChart(id) {
        if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; }
    }

    /* ===== RENDER ALL ===== */
    function renderAll(data) {
        const config = data.config;
        const regionData = data.results[currentRegion];
        if (!regionData) return;

        const thresholds = config.thresholds;
        const thresholdLabels = thresholds.map(t => t + '%');
        const gridMix = config.grid_mix_shares[currentRegion];
        const wholesalePrice = config.wholesale_prices[currentRegion];
        const meta = REGION_META[currentRegion];

        // Update page title (not site banner)
        document.getElementById('headerTitle').textContent = currentRegion + ' Regional Deep Dive';
        document.getElementById('headerSubtitle').textContent = meta.name + ' — exploring the cost trajectory, optimal resource mix, storage needs, and abatement economics for this region.';

        // Extract threshold data
        const costData = [], mixData = { clean_firm: [], ccs_ccgt: [], solar: [], wind: [], hydro: [], battery: [], ldes: [] };
        const storageData = [], matchScores = [];

        thresholds.forEach(t => {
            const tData = regionData.thresholds[String(t)];
            const td = tData ? resolveScenario(tData) : null;
            if (td) {
                const uc = getUnifiedCosts(td);
                costData.push(uc.effective_cost_per_useful_mwh);
                matchScores.push(td.hourly_match_score);
                storageData.push((td.battery_dispatch_pct || 0) + (td.ldes_dispatch_pct || 0));
                for (const res of ['clean_firm', 'ccs_ccgt', 'solar', 'wind', 'hydro']) {
                    mixData[res].push(td.resource_mix?.[res] || 0);
                }
                mixData.battery.push(td.battery_dispatch_pct || 0);
                mixData.ldes.push(td.ldes_dispatch_pct || 0);
            }
        });

        const totalClean = gridMix.clean_firm + gridMix.solar + gridMix.wind + gridMix.hydro;

        // ========== CHART 1: Grid Today (bar chart) ==========
        destroyChart('gridTodayChart');
        const gridResources = ['solar', 'wind', 'clean_firm', 'hydro'];
        const gridLabels = { solar: 'Solar', wind: 'Wind', clean_firm: 'Clean Firm', hydro: 'Hydro' };
        const gridValues = gridResources.map(r => gridMix[r] || 0);
        const fossilPct = Math.max(0, 100 - gridValues.reduce((a, b) => a + b, 0));

        chartInstances['gridTodayChart'] = new Chart(document.getElementById('gridTodayChart'), {
            type: 'bar',
            data: {
                labels: [...gridResources.map(r => gridLabels[r]), 'Fossil/Other'],
                datasets: [{
                    data: [...gridValues, fossilPct],
                    backgroundColor: [
                        MIX_COLORS.solar.fill, MIX_COLORS.wind.fill,
                        MIX_COLORS.clean_firm.fill, MIX_COLORS.hydro.fill,
                        'rgba(156,163,175,0.40)'
                    ],
                    borderColor: [
                        MIX_COLORS.solar.border, MIX_COLORS.wind.border,
                        MIX_COLORS.clean_firm.border, MIX_COLORS.hydro.border,
                        '#9CA3AF'
                    ],
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        display: true,
                        anchor: 'end',
                        align: 'right',
                        formatter: v => v.toFixed(1) + '%',
                        font: { size: 12, weight: '600', family: bodyFont.family },
                        color: '#374151',
                        padding: { left: 6 }
                    },
                    tooltip: { callbacks: { label: ctx => ctx.label + ': ' + ctx.parsed.x.toFixed(1) + '%' } }
                },
                scales: {
                    x: { beginAtZero: true, max: 100, title: { display: true, text: 'Share of Generation (%)', font: { size: 12 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } },
                    y: { grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
                }
            },
            plugins: [ChartDataLabels]
        });

        document.getElementById('insightBaseline').innerHTML =
            '<span class="insight-icon">&#9889;</span><div><strong>Key Insight:</strong> ' + currentRegion +
            '\'s existing grid delivers <strong>' + totalClean.toFixed(1) + '% clean energy</strong> on average. <sup style="font-size:0.7em;color:#6B7280;">[1][4]</sup> ' +
            'Solar contributes ' + gridMix.solar.toFixed(1) + '%, wind ' + gridMix.wind.toFixed(1) +
            '%, clean firm ' + gridMix.clean_firm.toFixed(1) + '%, and hydro ' + gridMix.hydro.toFixed(1) +
            '%. The remaining ' + fossilPct.toFixed(1) + '% is fossil or unspecified generation that must be displaced.</div>';
        document.getElementById('narrativeBaseline').textContent =
            'The existing resource mix &mdash; sourced from EIA hourly grid data [1] and EPA eGRID [4] &mdash; provides the foundation for any hourly matching strategy. Understanding this starting point reveals which resources are already available and how large the gap is to any given target.';

        // ========== CHART 2: Cost trajectory + sensitivity fan (combined) ==========
        destroyChart('pathwayChart');
        const cost75 = costData[0] || 0;
        const cost90 = costData[thresholds.indexOf(90)] || costData[costData.length - 3] || 0;
        const cost100 = costData[costData.length - 1] || 0;

        // ========== SENSITIVITY COST TABLES (NREL ATB 2024 [2], Lazard LCOE v17 [3]) ==========
        const LCOE_TABLES = {
            solar:      { Low: { CAISO: 45, ERCOT: 40, PJM: 50, NYISO: 70, NEISO: 62 }, Medium: { CAISO: 60, ERCOT: 54, PJM: 65, NYISO: 92, NEISO: 82 }, High: { CAISO: 78, ERCOT: 70, PJM: 85, NYISO: 120, NEISO: 107 } },
            wind:       { Low: { CAISO: 55, ERCOT: 30, PJM: 47, NYISO: 61, NEISO: 55 }, Medium: { CAISO: 73, ERCOT: 40, PJM: 62, NYISO: 81, NEISO: 73 }, High: { CAISO: 95, ERCOT: 52, PJM: 81, NYISO: 105, NEISO: 95 } },
            clean_firm: { Low: { CAISO: 58, ERCOT: 63, PJM: 72, NYISO: 75, NEISO: 73 }, Medium: { CAISO: 78, ERCOT: 85, PJM: 93, NYISO: 98, NEISO: 96 }, High: { CAISO: 110, ERCOT: 120, PJM: 140, NYISO: 150, NEISO: 145 } },
            ccs_ccgt:   { Low: { CAISO: 58, ERCOT: 52, PJM: 62, NYISO: 78, NEISO: 75 }, Medium: { CAISO: 86, ERCOT: 71, PJM: 79, NYISO: 99, NEISO: 96 }, High: { CAISO: 115, ERCOT: 92, PJM: 102, NYISO: 128, NEISO: 122 } },
            battery:    { Low: { CAISO: 77, ERCOT: 69, PJM: 74, NYISO: 81, NEISO: 79 }, Medium: { CAISO: 102, ERCOT: 92, PJM: 98, NYISO: 108, NEISO: 105 }, High: { CAISO: 133, ERCOT: 120, PJM: 127, NYISO: 140, NEISO: 137 } },
            ldes:       { Low: { CAISO: 135, ERCOT: 116, PJM: 128, NYISO: 150, NEISO: 143 }, Medium: { CAISO: 180, ERCOT: 155, PJM: 170, NYISO: 200, NEISO: 190 }, High: { CAISO: 234, ERCOT: 202, PJM: 221, NYISO: 260, NEISO: 247 } }
        };
        // Transmission cost adders (LBNL "Queued Up" [7], FERC/ISO reports [6])
        const TX_TABLES = {
            solar:      { None: 0, Low: { CAISO: 1, ERCOT: 1, PJM: 2, NYISO: 3, NEISO: 3 }, Medium: { CAISO: 3, ERCOT: 3, PJM: 5, NYISO: 7, NEISO: 6 }, High: { CAISO: 6, ERCOT: 5, PJM: 9, NYISO: 12, NEISO: 10 } },
            wind:       { None: 0, Low: { CAISO: 4, ERCOT: 3, PJM: 5, NYISO: 7, NEISO: 6 }, Medium: { CAISO: 8, ERCOT: 6, PJM: 10, NYISO: 14, NEISO: 12 }, High: { CAISO: 14, ERCOT: 10, PJM: 18, NYISO: 22, NEISO: 20 } },
            clean_firm: { None: 0, Low: { CAISO: 1, ERCOT: 1, PJM: 1, NYISO: 2, NEISO: 2 }, Medium: { CAISO: 3, ERCOT: 2, PJM: 3, NYISO: 5, NEISO: 4 }, High: { CAISO: 6, ERCOT: 4, PJM: 6, NYISO: 9, NEISO: 7 } },
            ccs_ccgt:   { None: 0, Low: { CAISO: 1, ERCOT: 1, PJM: 1, NYISO: 2, NEISO: 2 }, Medium: { CAISO: 2, ERCOT: 2, PJM: 3, NYISO: 4, NEISO: 3 }, High: { CAISO: 4, ERCOT: 3, PJM: 5, NYISO: 7, NEISO: 6 } },
            battery:    { None: 0, Low: { CAISO: 0, ERCOT: 0, PJM: 0, NYISO: 1, NEISO: 1 }, Medium: { CAISO: 1, ERCOT: 1, PJM: 1, NYISO: 2, NEISO: 2 }, High: { CAISO: 2, ERCOT: 2, PJM: 3, NYISO: 4, NEISO: 3 } },
            ldes:       { None: 0, Low: { CAISO: 1, ERCOT: 1, PJM: 1, NYISO: 2, NEISO: 2 }, Medium: { CAISO: 2, ERCOT: 2, PJM: 3, NYISO: 4, NEISO: 3 }, High: { CAISO: 4, ERCOT: 3, PJM: 5, NYISO: 7, NEISO: 6 } }
        };
        const FUEL_WHOLESALE_MULT = { Low: 0.85, Medium: 1.0, High: 1.35 }; // FERC/ISO market reports [6]
        const LEVELS = ['Low', 'Medium', 'High'];
        const TX_LEVELS = ['None', 'Low', 'Medium', 'High'];

        function getTxAdder(resource, txLevel, region) {
            const tbl = TX_TABLES[resource];
            if (!tbl || txLevel === 'None') return 0;
            const entry = tbl[txLevel];
            return typeof entry === 'number' ? entry : (entry ? (entry[region] || 0) : 0);
        }

        function computeScenarioCost(region, thresholdData, renewLevel, firmLevel, storageLevel, fuelLevel, txLevel) {
            const mix = thresholdData.resource_mix;
            const procPct = thresholdData.procurement_pct || 100;
            const storagePct = thresholdData.storage_dispatch_pct || 0;
            let totalCostPerDemand = 0;
            const levelMap = { solar: renewLevel, wind: renewLevel, clean_firm: firmLevel };
            for (const res of ['clean_firm', 'solar', 'wind']) {
                const sharePct = mix[res] || 0;
                if (sharePct <= 0) continue;
                const totalOfDemand = sharePct * procPct / 100;
                const existingOfDemand = Math.min(totalOfDemand, gridMix[res] || 0);
                const newOfDemand = totalOfDemand - existingOfDemand;
                const lcoe = LCOE_TABLES[res][levelMap[res]][region];
                const txAdd = newOfDemand > 0 ? getTxAdder(res, txLevel, region) : 0;
                totalCostPerDemand += existingOfDemand * wholesalePrice / 100 + newOfDemand * (lcoe + txAdd) / 100;
            }
            totalCostPerDemand += (mix.hydro || 0) * procPct / 100 * wholesalePrice / 100;
            if (storagePct > 0) {
                const threshVal = thresholdData.hourly_match_score || 0;
                let ldesShare = 0, batteryShare = storagePct;
                if (threshVal >= 95) { ldesShare = Math.min(storagePct, storagePct * ((threshVal - 90) / 15)); batteryShare = storagePct - ldesShare; }
                totalCostPerDemand += batteryShare * (LCOE_TABLES.battery[storageLevel][region] + getTxAdder('battery', txLevel, region)) / 100;
                totalCostPerDemand += ldesShare * (LCOE_TABLES.ldes[storageLevel][region] + getTxAdder('ldes', txLevel, region)) / 100;
            }
            const uc = getUnifiedCosts(thresholdData);
            const curtailmentPct = uc.curtailment_pct || 0;
            const usefulFraction = (100 - curtailmentPct) / 100;
            return usefulFraction > 0 ? totalCostPerDemand / usefulFraction : totalCostPerDemand;
        }

        // ========== CHART 2: Cost Sensitivity Envelope (combined cost + fan) ==========
        destroyChart('pathwayChart');
        const fanMinCosts = [], fanMaxCosts = [], fanMidCosts = [];

        thresholds.forEach(t => {
            const tData = regionData.thresholds[String(t)];
            const td = tData ? resolveScenario(tData) : null;
            if (!td) { fanMinCosts.push(0); fanMaxCosts.push(0); fanMidCosts.push(0); return; }
            let minC = Infinity, maxC = -Infinity;
            for (const rl of LEVELS) for (const fl of LEVELS) for (const sl of LEVELS) for (const fuelL of LEVELS) for (const txL of TX_LEVELS) {
                const c = computeScenarioCost(currentRegion, td, rl, fl, sl, fuelL, txL);
                if (c < minC) minC = c;
                if (c > maxC) maxC = c;
            }
            fanMinCosts.push(minC);
            fanMaxCosts.push(maxC);
            fanMidCosts.push(costData[thresholds.indexOf(t)] || (minC + maxC) / 2);
        });

        const idx90 = thresholds.indexOf(90);

        // Build annotation labels at 75%, 90%, 100% showing High/Med/Low values
        const labelAnnotations = {};
        [75, 90, 100].forEach(target => {
            const ti = thresholds.indexOf(target);
            if (ti < 0) return;
            const xLabel = target + '%';
            labelAnnotations['labelHigh_' + target] = {
                type: 'label', xValue: xLabel, yValue: fanMaxCosts[ti],
                content: 'High: $' + fanMaxCosts[ti].toFixed(0),
                font: { size: 10, weight: '700', family: bodyFont.family }, color: '#EF4444',
                backgroundColor: 'rgba(255,255,255,0.92)', borderRadius: 4, padding: 4,
                position: { x: 'end', y: 'start' }, yAdjust: -14
            };
            labelAnnotations['labelMed_' + target] = {
                type: 'label', xValue: xLabel, yValue: fanMidCosts[ti],
                content: 'Med: $' + fanMidCosts[ti].toFixed(0),
                font: { size: 10, weight: '700', family: bodyFont.family }, color: meta.color,
                backgroundColor: 'rgba(255,255,255,0.92)', borderRadius: 4, padding: 4,
                position: { x: 'start', y: 'center' }, xAdjust: -6
            };
            labelAnnotations['labelLow_' + target] = {
                type: 'label', xValue: xLabel, yValue: fanMinCosts[ti],
                content: 'Low: $' + fanMinCosts[ti].toFixed(0),
                font: { size: 10, weight: '700', family: bodyFont.family }, color: '#22C55E',
                backgroundColor: 'rgba(255,255,255,0.92)', borderRadius: 4, padding: 4,
                position: { x: 'end', y: 'end' }, yAdjust: 14
            };
        });

        chartInstances['pathwayChart'] = new Chart(document.getElementById('pathwayChart'), {
            type: 'line',
            data: {
                labels: thresholdLabels,
                datasets: [
                    { label: 'High Bound', data: fanMaxCosts, borderColor: 'rgba(239,68,68,0.7)', backgroundColor: 'transparent', borderWidth: 2, borderDash: [4, 3], pointRadius: 3, pointBackgroundColor: '#EF4444', pointBorderColor: '#fff', pointBorderWidth: 1, fill: false, tension: 0.3, order: 2 },
                    { label: 'Sensitivity Range', data: fanMaxCosts, borderColor: 'transparent', backgroundColor: 'rgba(14,165,233,0.12)', fill: '+1', pointRadius: 0, tension: 0.3, order: 3 },
                    { label: 'Low Bound', data: fanMinCosts, borderColor: 'rgba(34,197,94,0.7)', backgroundColor: 'transparent', borderWidth: 2, borderDash: [4, 3], pointRadius: 3, pointBackgroundColor: '#22C55E', pointBorderColor: '#fff', pointBorderWidth: 1, fill: false, tension: 0.3, order: 4 },
                    { label: 'Medium (Central)', data: fanMidCosts, borderColor: meta.color, backgroundColor: 'transparent', borderWidth: 3, pointRadius: 5, pointBackgroundColor: meta.color, pointBorderColor: '#fff', pointBorderWidth: 2, fill: false, tension: 0.3, order: 1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font: { size: 12 }, filter: item => item.text !== 'Sensitivity Range' } },
                    annotation: { annotations: labelAnnotations },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label === 'Sensitivity Range' ? null : ctx.dataset.label + ': $' + ctx.parsed.y.toFixed(1) + '/MWh' } }
                },
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: 'Effective Cost ($/MWh)', font: { size: 12 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } },
                    x: { title: { display: true, text: 'Hourly Clean Energy Target', font: { size: 12 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
                }
            }
        });

        // Cost insight (combined)
        if (idx90 >= 0) {
            const spread90 = fanMaxCosts[idx90] - fanMinCosts[idx90];
            document.getElementById('insightCost').innerHTML =
                '<span class="insight-icon">&#9889;</span><div><strong>Key Insight:</strong> In ' + currentRegion +
                ', reaching 75% costs ~$' + fanMidCosts[0].toFixed(0) + '/MWh at medium assumptions. At 90%, the medium estimate is ~$' + fanMidCosts[idx90].toFixed(0) +
                '/MWh but could range from $' + fanMinCosts[idx90].toFixed(0) + ' to $' + fanMaxCosts[idx90].toFixed(0) +
                ' — a $' + spread90.toFixed(0) + ' spread across 324 scenarios. The envelope widens at higher thresholds as marginal resources carry the most cost uncertainty.</div>';
        }
        document.getElementById('narrativeCost').textContent =
            'The shaded band spans all 324 sensitivity scenarios. The solid line shows medium assumptions. ' +
            'The spread widens above 90% because the marginal resources needed (clean firm, CCS, LDES) have the widest cost uncertainty across published estimates [2][3]. ' +
            'Labels at 75%, 90%, and 100% show the high/medium/low range at key decision points.';

        // ========== CHART 3: Resource Mix Evolution (with storage, LDES, curtailment) ==========
        destroyChart('mixEvolutionChart');
        const mixResources = ['clean_firm', 'ccs_ccgt', 'solar', 'wind', 'hydro'];
        const mixLabels = { clean_firm: 'Clean Firm', ccs_ccgt: 'CCS-CCGT', solar: 'Solar', wind: 'Wind', hydro: 'Hydro', battery: 'Battery (4hr)', ldes: 'LDES (100hr)', curtailment: 'Curtailment' };

        // Use actual battery/LDES dispatch from optimizer results
        const batteryPcts = mixData.battery;
        const ldesPcts = mixData.ldes;
        const curtailmentPcts = [];
        thresholds.forEach((t, i) => {
            const td = regionData.thresholds[String(t)];
            const procPct = td ? (resolveScenario(td)?.procurement_pct || 100) : 100;
            curtailmentPcts.push(Math.max(0, procPct - 100));
        });

        // Build datasets: resources stack to ~100%, then curtailment above
        const mixDatasets = [
            ...mixResources.map(r => ({
                label: mixLabels[r],
                data: mixData[r],
                backgroundColor: MIX_COLORS[r].fill,
                borderColor: MIX_COLORS[r].border,
                borderWidth: 1.5,
                borderRadius: 6,
                stack: 'mix'
            })),
            {
                label: mixLabels.battery || 'Battery (4hr)',
                data: batteryPcts,
                backgroundColor: MIX_COLORS.battery.fill,
                borderColor: MIX_COLORS.battery.border,
                borderWidth: 1.5,
                borderRadius: 6,
                stack: 'mix'
            },
            {
                label: mixLabels.ldes || 'LDES (100hr)',
                data: ldesPcts,
                backgroundColor: MIX_COLORS.ldes.fill,
                borderColor: MIX_COLORS.ldes.border,
                borderWidth: 1.5,
                borderRadius: 6,
                stack: 'mix'
            },
            {
                label: 'Curtailment',
                data: curtailmentPcts,
                backgroundColor: (function() {
                    // Create diagonal hatch pattern for curtailment
                    const patternCanvas = document.createElement('canvas');
                    patternCanvas.width = 10;
                    patternCanvas.height = 10;
                    const pctx = patternCanvas.getContext('2d');
                    pctx.strokeStyle = 'rgba(156,163,175,0.7)';
                    pctx.lineWidth = 1.5;
                    pctx.beginPath();
                    pctx.moveTo(0, 10); pctx.lineTo(10, 0);
                    pctx.moveTo(-2, 2); pctx.lineTo(2, -2);
                    pctx.moveTo(8, 12); pctx.lineTo(12, 8);
                    pctx.stroke();
                    return document.getElementById('mixEvolutionChart').getContext('2d').createPattern(patternCanvas, 'repeat');
                })(),
                borderColor: '#9CA3AF',
                borderWidth: 1.5,
                borderDash: [3, 2],
                borderRadius: 6,
                stack: 'mix'
            }
        ];

        // Compute max Y for chart (total procurement %)
        const maxProcPct = Math.max(...thresholds.map((t, i) => {
            let sum = 0;
            mixResources.forEach(r => sum += mixData[r][i] || 0);
            sum += batteryPcts[i] + ldesPcts[i] + curtailmentPcts[i];
            return sum;
        }));

        chartInstances['mixEvolutionChart'] = new Chart(document.getElementById('mixEvolutionChart'), {
            type: 'bar',
            data: { labels: thresholdLabels, datasets: mixDatasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'rectRounded', padding: 14, font: { size: 11 } } },
                    annotation: {
                        annotations: {
                            line100: {
                                type: 'line', yMin: 100, yMax: 100,
                                borderColor: 'rgba(0,0,0,0.35)', borderWidth: 1.5, borderDash: [6, 4],
                                label: { display: true, content: '100% of demand', position: 'start', backgroundColor: 'rgba(0,0,0,0.6)', color: '#fff', font: { size: 10 }, borderRadius: 3, padding: 3 }
                            }
                        }
                    },
                    datalabels: {
                        display: function(ctx) {
                            // Show percentage on each segment if > 5%
                            return ctx.dataset.data[ctx.dataIndex] > 5;
                        },
                        formatter: function(value) { return value.toFixed(0) + '%'; },
                        color: '#fff',
                        font: { size: 10, weight: '700' },
                        textStrokeColor: 'rgba(0,0,0,0.5)',
                        textStrokeWidth: 2
                    },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + '%' } }
                },
                scales: {
                    y: { stacked: true, beginAtZero: true, max: Math.ceil(maxProcPct / 10) * 10 + 5, title: { display: true, text: 'Share of Demand (%)', font: { size: 12 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } },
                    x: { stacked: true, title: { display: true, text: 'Hourly Clean Energy Target', font: { size: 12 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
                }
            },
            plugins: [ChartDataLabels]
        });

        // Mix insight (updated to include storage + curtailment)
        let domRes = 'clean_firm', domVal = 0;
        if (idx90 >= 0) {
            mixResources.forEach(r => { if (mixData[r][idx90] > domVal) { domRes = r; domVal = mixData[r][idx90]; } });
        }
        const maxCurt = Math.max(...curtailmentPcts);
        const maxCurtThresh = thresholds[curtailmentPcts.indexOf(maxCurt)];
        const maxStorageTotal = Math.max(...storageData);
        document.getElementById('insightMix').innerHTML =
            '<span class="insight-icon">&#9889;</span><div><strong>Key Insight:</strong> At 90%, <strong>' +
            mixLabels[domRes] + '</strong> dominates at ' + domVal.toFixed(0) + '%. ' +
            'Storage peaks at ' + maxStorageTotal.toFixed(1) + '% of demand &mdash; batteries handle daily shifting while LDES enters at 95%+ for multi-day gaps. ' +
            (maxCurt > 0 ? 'Curtailment reaches ' + maxCurt.toFixed(0) + '% at ' + maxCurtThresh + '%, shown in cross-hatching above the 100% line &mdash; energy procured but not usable.' : '') +
            '</div>';
        document.getElementById('narrativeMix').textContent =
            'The stacked bars show the complete procurement portfolio including generation, storage, and curtailment. ' +
            'Below the 100% line is useful energy; above it (cross-hatched) is curtailed overprocurement. ' +
            'Batteries (4hr Li-ion, 85% round-trip efficiency [2]) handle daily cycles; LDES (100hr iron-air, 50% round-trip efficiency [3]) bridges multi-day gaps. ' +
            'As thresholds rise, clean firm\'s share grows because only dispatchable generation can cover the hardest hours [8].';

        // ========== CHART 4: What You Need Depends on What You Have ==========
        destroyChart('newVsExistingChart');
        const existingData = {}, newData = {};
        const nvResources = ['clean_firm', 'ccs_ccgt', 'solar', 'wind', 'hydro', 'battery', 'ldes'];
        nvResources.forEach(r => { existingData[r] = []; newData[r] = []; });

        thresholds.forEach(t => {
            const tData = regionData.thresholds[String(t)];
            const td = tData ? resolveScenario(tData) : null;
            if (!td) { nvResources.forEach(r => { existingData[r].push(0); newData[r].push(0); }); return; }
            const procPct = td.procurement_pct || 100;
            const uc = getUnifiedCosts(td);
            const rc = uc.resource_costs || {};
            nvResources.forEach(r => {
                if (r === 'battery' || r === 'ldes') {
                    // Storage: all new build, dispatch_pct from costs_detail
                    const dispatchPct = rc[r]?.dispatch_pct || (r === 'battery' ? (td.battery_dispatch_pct || 0) : (td.ldes_dispatch_pct || 0));
                    existingData[r].push(0);
                    newData[r].push(parseFloat(dispatchPct.toFixed(1)));
                } else {
                    // Generation: split existing vs new using costs_detail if available, else resource_mix
                    const rdDetail = rc[r];
                    if (rdDetail && (rdDetail.existing_pct != null || rdDetail.new_pct != null || rdDetail.existing_share != null)) {
                        const existPct = rdDetail.existing_pct || rdDetail.existing_share || 0;
                        const newPct = rdDetail.new_pct || rdDetail.new_share || 0;
                        existingData[r].push(parseFloat(existPct.toFixed(1)));
                        newData[r].push(parseFloat(newPct.toFixed(1)));
                    } else {
                        const totalOfDemand = (td.resource_mix?.[r] || 0) * procPct / 100;
                        const existingPct = gridMix[r] || 0;
                        const existing = Math.min(totalOfDemand, existingPct);
                        existingData[r].push(parseFloat(existing.toFixed(1)));
                        newData[r].push(parseFloat((totalOfDemand - existing).toFixed(1)));
                    }
                }
            });
        });

        const nvDatasets = [];
        // Existing resources (solid, lower opacity)
        const nvExistingOrder = ['clean_firm', 'ccs_ccgt', 'hydro', 'wind', 'solar'];
        nvExistingOrder.forEach(r => {
            if (!MIX_COLORS[r]) return;
            nvDatasets.push({
                label: mixLabels[r] + ' (Existing)',
                data: existingData[r],
                backgroundColor: MIX_COLORS[r].fill.replace('0.50', '0.30'),
                borderColor: MIX_COLORS[r].border,
                borderWidth: 1,
                borderRadius: 6,
                stack: 'nv'
            });
        });
        // New resources (saturated)
        const nvNewOrder = ['solar', 'wind', 'hydro', 'battery', 'ldes', 'ccs_ccgt', 'clean_firm'];
        nvNewOrder.forEach(r => {
            if (!MIX_COLORS[r]) return;
            nvDatasets.push({
                label: mixLabels[r] + ' (New)',
                data: newData[r],
                backgroundColor: MIX_COLORS[r].fill,
                borderColor: MIX_COLORS[r].border,
                borderWidth: 2,
                borderRadius: 6,
                stack: 'nv'
            });
        });

        // Boundary line between existing and new
        const existingTotals = thresholds.map((_, i) => {
            let sum = 0;
            nvExistingOrder.forEach(r => sum += existingData[r][i]);
            return sum;
        });

        chartInstances['newVsExistingChart'] = new Chart(document.getElementById('newVsExistingChart'), {
            type: 'bar',
            data: { labels: thresholdLabels, datasets: nvDatasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true, pointStyle: 'rectRounded', padding: 12, font: { size: 11 },
                            filter: item => item.text.includes('(New)')
                        }
                    },
                    annotation: {
                        annotations: {
                            existingLine: {
                                type: 'line',
                                yMin: existingTotals[0], yMax: existingTotals[0],
                                borderColor: 'rgba(0,0,0,0.4)', borderWidth: 2, borderDash: [8, 4],
                                label: { display: true, content: 'Existing Clean: ' + existingTotals[0].toFixed(0) + '%', position: 'end', backgroundColor: 'rgba(0,0,0,0.6)', color: '#fff', font: { size: 10 }, borderRadius: 3, padding: 3 }
                            }
                        }
                    },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + '%' } }
                },
                scales: {
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Share of Demand (%)', font: { size: 12 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } },
                    x: { stacked: true, title: { display: true, text: 'Hourly Clean Energy Target', font: { size: 12 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
                }
            }
        });

        // New vs existing insight
        const totalNewAt90 = idx90 >= 0 ? nvResources.reduce((s, r) => s + newData[r][idx90], 0) : 0;
        const totalExistAt90 = idx90 >= 0 ? nvResources.reduce((s, r) => s + existingData[r][idx90], 0) : 0;
        let biggestNewRes = '', biggestNewVal = 0;
        if (idx90 >= 0) nvResources.forEach(r => { if (newData[r][idx90] > biggestNewVal) { biggestNewRes = mixLabels[r]; biggestNewVal = newData[r][idx90]; } });
        document.getElementById('insightNewVsExisting').innerHTML =
            '<span class="insight-icon">&#9889;</span><div><strong>Key Insight:</strong> At the 90% target, ' + currentRegion +
            ' leverages ' + totalExistAt90.toFixed(0) + '% from existing resources and needs ' + totalNewAt90.toFixed(0) +
            '% new procurement. The largest new-build need is <strong>' + biggestNewRes + '</strong> at ' + biggestNewVal.toFixed(0) +
            '%. Regions with more existing clean energy face a smaller &mdash; but potentially more expensive &mdash; gap to fill. <sup style="font-size:0.7em;color:#6B7280;">[5][7]</sup></div>';
        document.getElementById('narrativeNewVsExisting').textContent =
            'The faded bars show what the existing grid already provides; the saturated bars show what must be built new. ' +
            'This decomposition reveals why cost varies so much across regions [1][4]: some start with 40%+ clean energy, others below 20%. ' +
            'The type of new resources needed &mdash; and whether they are dispatchable &mdash; drives the marginal cost of each additional percentage point.';

        // ========== CHART 5: Abatement ==========
        destroyChart('abatementChart');
        const emissionRate = EMISSION_RATES[currentRegion];
        const avgAbatement = [], margAbatement = [];

        thresholds.forEach((t, i) => {
            const tData = regionData.thresholds[String(t)];
            const td = tData ? resolveScenario(tData) : null;
            if (!td) return;
            const uc = getUnifiedCosts(td);
            const cleanPct = t / 100;
            const incrementalCost = uc.incremental_above_baseline || 0;
            const tonsAvoided = cleanPct * emissionRate;
            const avg = tonsAvoided > 0 ? incrementalCost / tonsAvoided : 0;
            avgAbatement.push(parseFloat(avg.toFixed(1)));
            if (i > 0) {
                const prevTData = regionData.thresholds[String(thresholds[i - 1])];
                const prevTd = prevTData ? resolveScenario(prevTData) : null;
                if (prevTd) {
                    const prevUc = getUnifiedCosts(prevTd);
                    const deltaCost = (uc.effective_cost_per_useful_mwh || 0) - (prevUc.effective_cost_per_useful_mwh || 0);
                    const deltaPct = (t - thresholds[i - 1]) / 100;
                    const deltaTons = deltaPct * emissionRate;
                    margAbatement.push(deltaTons > 0 ? parseFloat((deltaCost / deltaTons).toFixed(1)) : 0);
                } else { margAbatement.push(0); }
            } else { margAbatement.push(avgAbatement[0]); }
        });

        chartInstances['abatementChart'] = new Chart(document.getElementById('abatementChart'), {
            type: 'bar',
            data: {
                labels: thresholdLabels,
                datasets: [
                    { label: 'Average $/ton CO\u2082', data: avgAbatement, backgroundColor: 'rgba(30,58,95,0.50)', borderColor: '#1E3A5F', borderWidth: 1.5, borderRadius: 6, order: 2 },
                    { label: 'Marginal $/ton CO\u2082', data: margAbatement, type: 'line', borderColor: '#EF4444', backgroundColor: 'rgba(239,68,68,0.1)', pointBackgroundColor: '#EF4444', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 5, borderWidth: 2.5, tension: 0.3, fill: false, order: 1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16, font: { size: 12 } } },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': $' + ctx.parsed.y.toFixed(0) + '/ton' } }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Abatement Cost ($/ton CO\u2082)', font: { size: 12 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } },
                    x: { title: { display: true, text: 'Hourly Clean Energy Target', font: { size: 12 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
                }
            }
        });

        const avgAt90 = avgAbatement[thresholds.indexOf(90)] || avgAbatement[avgAbatement.length - 3] || 0;
        document.getElementById('insightAbatement').innerHTML =
            '<span class="insight-icon">&#9889;</span><div><strong>Key Insight:</strong> At ' + currentRegion + '\'s emission rate of ' +
            emissionRate.toFixed(2) + ' tCO\u2082/MWh <sup style="font-size:0.7em;color:#6B7280;">[4]</sup>, the average abatement cost at 90% is ~$' + avgAt90.toFixed(0) +
            '/ton. The marginal cost rises steeply above 95%, reflecting the expense of eliminating the last few hours of fossil generation. <sup style="font-size:0.7em;color:#6B7280;">[2][3]</sup></div>';
        document.getElementById('narrativeAbatement').textContent =
            'Each clean MWh displaces ' + emissionRate.toFixed(2) + ' metric tons of CO\u2082 (EPA eGRID 2022 [4]) from fossil generation in this region. ' +
            'The early tons are cheap; the last tons are expensive [8]. Understanding this curve helps set realistic decarbonization budgets.';
    }

    /* ===== SCROLL REVEAL ===== */
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) entry.target.classList.add('visible');
        });
    }, { threshold: 0.08, rootMargin: '0px 0px -60px 0px' });

    document.querySelectorAll('.story-section').forEach(el => observer.observe(el));
})();
</script>
</body>
</html>
