<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The 8,760 Problem — EAC Scarcity &amp; Clean Premium Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
@font-face {
    font-family: 'Franklin Gothic Demi';
    src: local('Franklin Gothic Demi'), local('Franklin Gothic Medium'), local('ITC Franklin Gothic Demi'), local('Franklin Gothic Demi Cond');
    font-weight: 600;
    font-style: normal;
    font-display: swap;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<style>
/* ========== RESET & BASE ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }
body {
    font-family: 'Plus Jakarta Sans', 'Helvetica Neue', Arial, sans-serif;
    background: #F3F4F8;
    background-image:
        radial-gradient(ellipse at 20% 0%, rgba(245,158,11,0.04) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(239,68,68,0.03) 0%, transparent 50%);
    background-attachment: fixed;
    color: #000000;
    line-height: 1.7;
}
:root {
    --navy: #1A2744;
    --navy-light: #2D3A52;
    --bg-card: #FFFFFF;
    --border: #D4D8E0;
    --border-light: #E5E7EB;
    --text-primary: #000000;
    --text-secondary: #000000;
    --text-muted: #6B7280;
    --font-heading: 'Barlow Semi Condensed', 'Arial Narrow', sans-serif;
    --abundant: #22c55e;
    --adequate: #84cc16;
    --tightening: #eab308;
    --scarce: #f97316;
    --critical: #ef4444;
}

/* ========== TOP NAV ========== */
.top-nav {
    background: #1a1a2e;
    padding: 0 24px;
    display: flex; align-items: center; justify-content: center;
    position: sticky; top: 0; z-index: 999;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    min-height: 48px;
}
.top-nav-inner { display: flex; align-items: center; gap: 0; max-width: 1440px; width: 100%; justify-content: center; }
.top-nav a {
    color: rgba(255,255,255,0.75); text-decoration: none;
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', 'Arial Narrow', sans-serif;
    font-size: 0.85rem; font-weight: 600; letter-spacing: 0.04em;
    padding: 14px 18px; transition: color 0.2s, background 0.2s;
    border-bottom: 3px solid transparent; white-space: nowrap;
}
.top-nav a:hover { color: #ffffff; background: rgba(255,255,255,0.06); }
.top-nav a.nav-active { color: #ffffff; border-bottom-color: #0EA5E9; background: rgba(14,165,233,0.1); }
.nav-hamburger {
    display: none; background: none; border: none; color: #ffffff;
    font-size: 1.5rem; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px;
    align-items: center; justify-content: center;
}
.nav-hamburger svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; }
@media (max-width: 768px) {
    .top-nav { flex-wrap: wrap; padding: 0 12px; justify-content: space-between; }
    .top-nav-inner { display: none; flex-direction: column; width: 100%; padding-bottom: 8px; }
    .top-nav-inner.nav-open { display: flex; }
    .top-nav a { padding: 12px 16px; border-bottom: none; border-left: 3px solid transparent; width: 100%; text-align: left; }
    .top-nav a.nav-active { border-left-color: #0EA5E9; border-bottom: none; background: rgba(14,165,233,0.12); }
    .nav-hamburger { display: flex; }
}

/* ========== HEADER ========== */
.header {
    background: linear-gradient(135deg, #0F1A2E 0%, #122952 30%, #1565C0 70%, #0D47A1 100%);
    color: #ffffff; padding: 56px 24px 48px; text-align: center;
    position: relative; overflow: hidden;
}
.header h1 {
    font-family: 'Rajdhani', 'Arial Narrow', sans-serif;
    font-size: 2.2rem; font-weight: 700; letter-spacing: 1px;
    text-transform: capitalize; position: relative; z-index: 2;
}
.header .subtitle {
    font-size: 1.0rem; color: rgba(255,255,255,0.85);
    max-width: 720px; margin: 10px auto 0; position: relative; z-index: 2;
}
.header-accent {
    position: absolute; bottom: 0; left: 0; right: 0; height: 4px;
    background: linear-gradient(90deg, #22C55E, #84cc16, #eab308, #f97316, #EF4444);
    z-index: 2;
}

/* ========== LAYOUT ========== */
.dashboard-wrap { max-width: 1200px; margin: 0 auto; padding: 24px 24px 60px; }
.controls-bar {
    background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 10px;
    padding: 20px 24px; margin-bottom: 24px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;
}
.control-group { display: flex; flex-direction: column; gap: 4px; min-width: 140px; }
.control-group label {
    font-family: var(--font-heading); font-size: 0.78rem; font-weight: 700;
    letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted);
}
.control-group .control-value {
    font-family: var(--font-heading); font-size: 1.1rem; font-weight: 700; color: var(--navy);
}
.control-group select, .control-group input[type=range] {
    font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.9rem;
    padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px;
    background: #fff; min-height: 36px; cursor: pointer;
}
.control-group input[type=range] { padding: 0; min-height: 28px; accent-color: #1565C0; }

/* Region pills */
.region-pills { display: flex; gap: 6px; flex-wrap: wrap; }
.region-pill {
    font-family: var(--font-heading); font-size: 0.82rem; font-weight: 600;
    padding: 6px 14px; border-radius: 20px; cursor: pointer; border: 2px solid var(--border);
    background: #fff; color: var(--navy); transition: all 0.2s; min-height: 36px;
    display: flex; align-items: center;
}
.region-pill:hover { border-color: #1565C0; background: rgba(21,101,192,0.05); }
.region-pill.active { background: #1565C0; color: #fff; border-color: #1565C0; }

/* Growth pills */
.growth-pills { display: flex; gap: 4px; }
.growth-pill {
    font-family: var(--font-heading); font-size: 0.8rem; font-weight: 600;
    padding: 5px 12px; border-radius: 16px; cursor: pointer; border: 2px solid var(--border);
    background: #fff; color: var(--navy); transition: all 0.2s; min-height: 34px;
}
.growth-pill:hover { border-color: #1565C0; }
.growth-pill.active { background: var(--navy); color: #fff; border-color: var(--navy); }

/* Stats row */
.stat-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 14px; margin-bottom: 24px; }
.stat-tile {
    background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 10px;
    padding: 18px 14px; text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; overflow: hidden;
}
.stat-tile::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: var(--navy);
}
.stat-tile.green::before { background: var(--abundant); }
.stat-tile.amber::before { background: var(--tightening); }
.stat-tile.red::before { background: var(--critical); }
.stat-tile.blue::before { background: #1565C0; }
.stat-value {
    font-family: var(--font-heading); font-size: 1.8rem; font-weight: 700; color: var(--navy);
    line-height: 1.1;
}
.stat-label { font-size: 0.78rem; color: var(--text-muted); margin-top: 4px; line-height: 1.3; }

/* Chart containers */
.chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
.chart-card {
    background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 10px;
    padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.chart-card h3 {
    font-family: var(--font-heading); font-size: 1.1rem; font-weight: 700;
    color: var(--navy); margin-bottom: 4px;
}
.chart-card .chart-subtitle { font-size: 0.82rem; color: var(--text-muted); margin-bottom: 12px; }
.chart-container { position: relative; width: 100%; min-height: 320px; }
.chart-card-full { grid-column: 1 / -1; }

/* Heatmap */
.heatmap-grid {
    display: grid; gap: 2px; width: 100%;
}
.heatmap-cell {
    border-radius: 3px; display: flex; align-items: center; justify-content: center;
    font-family: var(--font-heading); font-size: 0.72rem; font-weight: 600;
    color: #fff; min-height: 36px; cursor: default; transition: transform 0.15s;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.heatmap-cell:hover { transform: scale(1.05); z-index: 2; }
.heatmap-header {
    font-family: var(--font-heading); font-size: 0.72rem; font-weight: 700;
    color: var(--text-muted); display: flex; align-items: center; justify-content: center;
    text-transform: uppercase; letter-spacing: 0.05em;
}

/* Scarcity band legend */
.legend-row { display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0; }
.legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.78rem; color: var(--text-muted); }
.legend-dot { width: 12px; height: 12px; border-radius: 3px; }

/* Insight callout */
.insight-box {
    background: linear-gradient(135deg, #EFF6FF 0%, #F0F9FF 100%);
    border: 1px solid #BFDBFE; border-left: 4px solid #1565C0;
    border-radius: 8px; padding: 16px 20px; margin: 20px 0;
}
.insight-box h4 {
    font-family: var(--font-heading); font-size: 0.95rem; font-weight: 700;
    color: #1565C0; margin-bottom: 6px;
}
.insight-box p { font-size: 0.88rem; color: #1E3A5F; line-height: 1.5; }
.insight-box.warning { background: linear-gradient(135deg, #FFFBEB, #FEF3C7); border-color: #FCD34D; border-left-color: #D97706; }
.insight-box.warning h4 { color: #D97706; }
.insight-box.danger { background: linear-gradient(135deg, #FEF2F2, #FEE2E2); border-color: #FECACA; border-left-color: #DC2626; }
.insight-box.danger h4 { color: #DC2626; }

/* Section */
.section-header {
    font-family: var(--font-heading); font-size: 1.3rem; font-weight: 700; color: var(--navy);
    margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border-light);
}

/* ISO comparison table */
.iso-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
.iso-table th, .iso-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-light); }
.iso-table th { background: #F0F2F5; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.04em; }
.iso-table tr:hover { background: #F7F8FA; }
.scarcity-badge {
    display: inline-block; font-family: var(--font-heading); font-size: 0.72rem; font-weight: 700;
    padding: 3px 10px; border-radius: 12px; text-transform: uppercase; letter-spacing: 0.05em;
}

.accent-bar { height: 4px; background: linear-gradient(90deg, #22C55E, #84cc16, #eab308, #f97316, #EF4444); }

/* Responsive */
@media (max-width: 900px) { .chart-row { grid-template-columns: 1fr; } }
@media (max-width: 768px) {
    .dashboard-wrap { padding: 16px 12px 40px; }
    .controls-bar { padding: 16px; gap: 14px; }
    .stat-row { grid-template-columns: repeat(2, 1fr); }
    .chart-container { min-height: 280px; }
    .header h1 { font-size: 1.7rem; }
}
@media (max-width: 480px) {
    .stat-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- ========== TOP NAVIGATION ========== -->
<nav class="top-nav">
    <span class="nav-brand" style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-weight:600;color:#fff;font-size:0.9rem;white-space:nowrap;padding:14px 18px;">The 8,760 Problem</span>
    <button class="nav-hamburger" onclick="document.querySelector('.top-nav-inner').classList.toggle('nav-open')" aria-label="Toggle navigation">
        <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="top-nav-inner">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Cost Optimizer</a>
        <a href="abatement_dashboard.html">Abatement Dashboard</a>
        <a href="region_deepdive.html">Regional Deep Dives</a>
        <a href="abatement_comparison.html">CO&#8322; Abatement Summary</a>
        <a href="eac_scarcity.html" class="nav-active">EAC Scarcity</a>
        <a href="research_paper.html">Methodology &amp; Paper</a>
        <a href="about.html">About</a>
        <a href="../power-gen-decarbonization/site/index.html">Generator Analysis</a>
    </div>
</nav>
<div style="background:#F3F4F8;padding:8px 24px;"><a href="index.html" style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-size:0.82rem;font-weight:600;color:#1A2744;text-decoration:none;display:inline-flex;align-items:center;gap:6px;letter-spacing:0.03em;min-height:44px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>Back to Home</a></div>

<header class="header">
    <h1>EAC Scarcity &amp; Clean Premium Dashboard</h1>
    <p class="subtitle">How corporate hourly matching demand collides with limited uncommitted clean supply &mdash; and what it costs</p>
    <div class="header-accent"></div>
</header>

<div class="dashboard-wrap">

    <!-- ========== CONTROLS ========== -->
    <div class="controls-bar">
        <div class="control-group">
            <label>Region</label>
            <div class="region-pills" id="regionPills">
                <button class="region-pill active" data-iso="ALL">All ISOs</button>
                <button class="region-pill" data-iso="CAISO">CAISO</button>
                <button class="region-pill" data-iso="ERCOT">ERCOT</button>
                <button class="region-pill" data-iso="PJM">PJM</button>
                <button class="region-pill" data-iso="NYISO">NYISO</button>
                <button class="region-pill" data-iso="NEISO">NEISO</button>
            </div>
        </div>
        <div class="control-group" style="flex:1;min-width:200px;">
            <label>Time Horizon: <span id="yearValue" class="control-value">2030</span></label>
            <div style="display:flex;align-items:center;gap:8px;">
                <input type="range" id="yearSlider" min="2025" max="2050" value="2030" step="1" style="flex:1;">
                <button id="playBtn" title="Animate through years" style="background:var(--navy);color:#fff;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.9rem;min-width:32px;">&#9654;</button>
            </div>
        </div>
        <div class="control-group" style="min-width:120px;">
            <label>Demand Growth</label>
            <div class="growth-pills" id="growthPills">
                <button class="growth-pill" data-growth="Low">Low</button>
                <button class="growth-pill active" data-growth="Medium">Med</button>
                <button class="growth-pill" data-growth="High">High</button>
            </div>
        </div>
        <div class="control-group" style="flex:1;min-width:200px;">
            <label>Corporate Participation: <span id="participationValue" class="control-value">15%</span></label>
            <input type="range" id="participationSlider" min="0" max="100" value="15" step="5" style="width:100%;">
        </div>
        <div class="control-group" style="flex:1;min-width:200px;">
            <label>Hourly Match Target: <span id="matchValue" class="control-value">90%</span></label>
            <input type="range" id="matchSlider" min="75" max="100" value="90" step="1" style="width:100%;">
        </div>
    </div>

    <!-- ========== STATS ROW ========== -->
    <div class="stat-row" id="statsRow">
        <div class="stat-tile blue" id="statDemand">
            <div class="stat-value" id="statDemandVal">--</div>
            <div class="stat-label">Corporate EAC Demand (TWh)</div>
        </div>
        <div class="stat-tile green" id="statSupply">
            <div class="stat-value" id="statSupplyVal">--</div>
            <div class="stat-label">Available Non-SSS Supply (TWh)</div>
        </div>
        <div class="stat-tile" id="statRatio">
            <div class="stat-value" id="statRatioVal">--</div>
            <div class="stat-label">Demand / Supply Ratio</div>
        </div>
        <div class="stat-tile" id="statScarcity">
            <div class="stat-value" id="statScarcityVal">--</div>
            <div class="stat-label">Scarcity Classification</div>
        </div>
        <div class="stat-tile" id="statPremium">
            <div class="stat-value" id="statPremiumVal">--</div>
            <div class="stat-label">Clean Premium ($/MWh)</div>
        </div>
    </div>

    <!-- ========== DYNAMIC INSIGHT ========== -->
    <div id="insightBox" class="insight-box" style="display:none;">
        <h4 id="insightTitle"></h4>
        <p id="insightText"></p>
    </div>

    <!-- ========== CHARTS ROW 1 ========== -->
    <div class="chart-row">
        <!-- Scarcity heatmap -->
        <div class="chart-card chart-card-full">
            <h3>Scarcity Heatmap: All ISOs at Current Settings</h3>
            <div class="chart-subtitle" id="heatmapSubtitle">Participation vs. Match Target — colored by scarcity classification</div>
            <div class="legend-row">
                <div class="legend-item"><div class="legend-dot" style="background:#22c55e;"></div>Abundant</div>
                <div class="legend-item"><div class="legend-dot" style="background:#84cc16;"></div>Adequate</div>
                <div class="legend-item"><div class="legend-dot" style="background:#eab308;"></div>Tightening</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f97316;"></div>Scarce</div>
                <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div>Critical</div>
            </div>
            <div id="heatmapContainer" style="overflow-x:auto;"></div>
        </div>
    </div>

    <!-- ========== CHARTS ROW 2 ========== -->
    <div class="chart-row">
        <!-- Clean Premium by ISO -->
        <div class="chart-card">
            <h3>Clean Premium Across Match Targets</h3>
            <div class="chart-subtitle">$/MWh premium at current participation &amp; year</div>
            <div class="chart-container"><canvas id="premiumChart"></canvas></div>
        </div>
        <!-- Supply vs Demand -->
        <div class="chart-card">
            <h3>Available Supply vs. Corporate Demand</h3>
            <div class="chart-subtitle">TWh — non-SSS supply vs. EAC demand by participation</div>
            <div class="chart-container"><canvas id="supplyDemandChart"></canvas></div>
        </div>
    </div>

    <!-- ========== CHARTS ROW 3 ========== -->
    <div class="chart-row">
        <!-- Supply projection timeline -->
        <div class="chart-card">
            <h3>Supply Projection: SSS vs. Non-SSS Over Time</h3>
            <div class="chart-subtitle">How clean supply evolves with new build and policy expirations</div>
            <div class="chart-container"><canvas id="supplyTimelineChart"></canvas></div>
        </div>
        <!-- Inflection point chart -->
        <div class="chart-card">
            <h3>Scarcity Inflection Points</h3>
            <div class="chart-subtitle">Corporate participation % where scarcity begins, by match target</div>
            <div class="chart-container"><canvas id="inflectionChart"></canvas></div>
        </div>
    </div>

    <!-- ========== CHARTS ROW 4: RPS vs Voluntary ========== -->
    <div class="chart-row">
        <div class="chart-card">
            <h3>RPS Mandated Build vs. Voluntary Corporate Demand</h3>
            <div class="chart-subtitle">TWh of new build driven by state mandates vs. corporate hourly matching</div>
            <div class="chart-container"><canvas id="rpsDemandChart"></canvas></div>
        </div>
        <div class="chart-card">
            <h3>Buildable Supply Headroom</h3>
            <div class="chart-subtitle">Total buildable capacity vs. combined demand — how much runway remains</div>
            <div class="chart-container"><canvas id="headroomChart"></canvas></div>
        </div>
    </div>

    <!-- ========== ISO COMPARISON TABLE ========== -->
    <h2 class="section-header">ISO Comparison at Current Settings</h2>
    <div class="chart-card" style="overflow-x:auto;">
        <table class="iso-table" id="isoTable">
            <thead>
                <tr>
                    <th>ISO</th>
                    <th>Total Clean (TWh)</th>
                    <th>SSS (TWh)</th>
                    <th>Available (TWh)</th>
                    <th>Corp Demand (TWh)</th>
                    <th>Ratio</th>
                    <th>Scarcity</th>
                    <th>Premium ($/MWh)</th>
                </tr>
            </thead>
            <tbody id="isoTableBody"></tbody>
        </table>
    </div>

    <!-- ========== SOCIAL COST BENCHMARKS ========== -->
    <div class="insight-box" style="margin-top:24px;">
        <h4>Carbon Cost Benchmarks</h4>
        <p>EPA Social Cost of Carbon: <strong>$51/ton</strong> | Rennert et al. (2022): <strong>$185/ton</strong> | EU ETS range: <strong>$60&ndash;100/ton</strong>. When the clean premium exceeds these benchmarks divided by the grid emission rate (~0.4 tCO2/MWh), direct abatement alternatives may be more cost-effective than additional hourly matching.</p>
    </div>

    <!-- ========== METHODOLOGY SECTION ========== -->
    <h2 class="section-header">Methodology</h2>
    <div class="chart-card">
        <p style="font-size:0.88rem;color:var(--text-secondary);line-height:1.6;">
            <strong>SSS Framework:</strong> Standard Supply Service = mandatory/non-bypassable procurement creating a financial relationship between customers and generation. Includes RPS/CES mandates, public ownership, vertically integrated rate-base assets, and state nuclear programs (ZEC, CMC, CES). Does <em>not</em> include 45U PTC, merchant generation, or voluntary corporate PPAs.
        </p>
        <p style="font-size:0.88rem;color:var(--text-secondary);line-height:1.6;margin-top:8px;">
            <strong>Available Supply:</strong> Total non-SSS clean generation minus existing corporate PPAs already contracted. This represents the uncommitted pool available for new voluntary corporate procurement.
        </p>
        <p style="font-size:0.88rem;color:var(--text-secondary);line-height:1.6;margin-top:8px;">
            <strong>Demand Scope:</strong> &ldquo;Corporate participation&rdquo; represents voluntary, hourly-matched EAC procurement by commercial &amp; industrial (C&amp;I) customers. The C&amp;I share of total load is fixed at 62% (EIA 2024 national average). At X% participation, corporate EAC demand = X% &times; C&amp;I load &times; procurement ratio for the hourly match target. Residential load participates in RPS but not voluntary procurement.
        </p>
        <p style="font-size:0.88rem;color:var(--text-secondary);line-height:1.6;margin-top:8px;">
            <strong>Supply Stack:</strong> New clean generation enters the available pool only when its LCOE is below the wholesale electricity price plus the regional RPS demand adder. Existing clean (hydro, nuclear merchant, wind/solar PPAs) is priced at wholesale. The clean premium for corporate buyers equals the marginal cost of the next MWh on the supply stack above wholesale&mdash;rising as demand exhausts cheaper tiers.
        </p>
        <p style="font-size:0.88rem;color:var(--text-secondary);line-height:1.6;margin-top:8px;">
            <strong>Scarcity Classification:</strong> Based on demand/supply ratio. Abundant (&le;0.3), Adequate (&le;0.6), Tightening (&le;0.8), Scarce (&le;0.95), Critical (&gt;0.95).
        </p>
        <p style="font-size:0.88rem;color:var(--text-secondary);line-height:1.6;margin-top:8px;">
            <strong>Data Sources:</strong> SSS baselines from EIA Form 923, NRC status reports, DSIRE state RPS database, ISO annual reports. Demand from EIA Hourly Electric Grid Monitor (2021&ndash;2025). LCOEs from NREL ATB 2024. Wholesale prices from ISO market data. RPS adders from observed 2025 REC prices scaled by target trajectory.
        </p>
        <p style="font-size:0.88rem;color:var(--text-secondary);line-height:1.6;margin-top:8px;">
            Full methodology: <a href="research_paper.html" style="color:#1565C0;">Methodology &amp; Paper</a>
        </p>
    </div>

</div>

<div class="accent-bar"></div>

<script>
// ========== DATA & STATE ==========
let DATA = null;
let state = {
    iso: 'ALL',
    year: '2030',
    growth: 'Medium',
    participation: 15,
    matchTarget: 90
};

const ISOS = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
const ISO_LABELS = { CAISO: 'CAISO', ERCOT: 'ERCOT', PJM: 'PJM', NYISO: 'NYISO', NEISO: 'ISO-NE' };
const ISO_COLORS = { CAISO: '#F59E0B', ERCOT: '#22C55E', PJM: '#1565C0', NYISO: '#8B5CF6', NEISO: '#EC4899' };
const SCARCITY_COLORS = { abundant: '#22c55e', adequate: '#84cc16', tightening: '#eab308', scarce: '#f97316', critical: '#ef4444' };
const SCARCITY_BG = { abundant: '#D1FAE5', adequate: '#ECFCCB', tightening: '#FEF9C3', scarce: '#FFEDD5', critical: '#FEE2E2' };
const SCARCITY_TEXT = { abundant: '#059669', adequate: '#65A30D', tightening: '#CA8A04', scarce: '#EA580C', critical: '#DC2626' };

const PARTICIPATION_RATES = [0, 5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 100];
const MATCH_TARGETS = [75, 80, 85, 90, 95, 99, 100];
const YEARS = [2025, 2030, 2035, 2040, 2045, 2050];
const YEARS_ALL = Array.from({length: 26}, (_, i) => 2025 + i); // 2025-2050 annual
let playInterval = null;

let charts = {};

// ========== LOAD DATA ==========
async function loadData() {
    try {
        const resp = await fetch('eac_scarcity_results.json');
        DATA = await resp.json();
        initControls();
        updateAll();
    } catch (e) {
        console.error('Failed to load scarcity data:', e);
        document.getElementById('statsRow').innerHTML = '<div class="stat-tile red"><div class="stat-value">Error</div><div class="stat-label">Could not load eac_scarcity_results.json</div></div>';
    }
}

// ========== FIND SCENARIO ==========
function findScenario(iso, year, growth, participation, matchTarget) {
    const scenarios = DATA.scenarios[iso]?.[year]?.[growth];
    if (!scenarios) return null;
    // Find closest participation
    let closestPart = PARTICIPATION_RATES[0];
    let minDist = 999;
    for (const p of PARTICIPATION_RATES) {
        if (Math.abs(p - participation) < minDist) { minDist = Math.abs(p - participation); closestPart = p; }
    }
    // Find closest match target
    let closestMatch = MATCH_TARGETS[0];
    minDist = 999;
    for (const m of MATCH_TARGETS) {
        if (Math.abs(m - matchTarget) < minDist) { minDist = Math.abs(m - matchTarget); closestMatch = m; }
    }
    return scenarios.find(s => s.participation_pct === closestPart && s.match_target_pct === closestMatch) || null;
}

// ========== CONTROLS ==========
function initControls() {
    // Region pills
    document.querySelectorAll('.region-pill').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.region-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.iso = btn.dataset.iso;
            updateAll();
        });
    });
    // Growth pills
    document.querySelectorAll('.growth-pill').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.growth-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.growth = btn.dataset.growth;
            updateAll();
        });
    });
    // Year slider
    const ySlider = document.getElementById('yearSlider');
    ySlider.addEventListener('input', e => {
        state.year = e.target.value;
        document.getElementById('yearValue').textContent = state.year;
        updateAll();
    });
    // Play button
    const playBtn = document.getElementById('playBtn');
    playBtn.addEventListener('click', () => {
        if (playInterval) {
            clearInterval(playInterval);
            playInterval = null;
            playBtn.innerHTML = '&#9654;';
            playBtn.title = 'Animate through years';
            return;
        }
        playBtn.innerHTML = '&#9646;&#9646;';
        playBtn.title = 'Pause animation';
        let year = parseInt(ySlider.value);
        if (year >= 2050) year = 2025;
        playInterval = setInterval(() => {
            year++;
            if (year > 2050) { clearInterval(playInterval); playInterval = null; playBtn.innerHTML = '&#9654;'; return; }
            ySlider.value = year;
            state.year = String(year);
            document.getElementById('yearValue').textContent = year;
            updateAll();
        }, 600);
    });
    // Participation slider
    const pSlider = document.getElementById('participationSlider');
    pSlider.addEventListener('input', e => {
        state.participation = parseInt(e.target.value);
        document.getElementById('participationValue').textContent = state.participation + '%';
        updateAll();
    });
    // Match target slider
    const mSlider = document.getElementById('matchSlider');
    mSlider.addEventListener('input', e => {
        state.matchTarget = parseInt(e.target.value);
        document.getElementById('matchValue').textContent = state.matchTarget + '%';
        updateAll();
    });
}

// ========== UPDATE ALL ==========
function updateAll() {
    updateStats();
    updateInsight();
    updateHeatmap();
    updatePremiumChart();
    updateSupplyDemandChart();
    updateSupplyTimeline();
    updateInflectionChart();
    updateRPSDemandChart();
    updateHeadroomChart();
    updateISOTable();
}

// ========== STATS ==========
function updateStats() {
    const isos = state.iso === 'ALL' ? ISOS : [state.iso];
    let totalDemand = 0, totalSupply = 0, totalPremium = 0, count = 0;
    let worstScarcity = 'abundant';
    const scarcityOrder = ['abundant', 'adequate', 'tightening', 'scarce', 'critical'];

    for (const iso of isos) {
        const sc = findScenario(iso, state.year, state.growth, state.participation, state.matchTarget);
        if (!sc) continue;
        totalDemand += sc.corp_eac_demand_twh;
        const supply = DATA.supply_projections[iso]?.[state.year]?.[state.growth];
        if (supply) totalSupply += supply.available_non_sss_twh;
        totalPremium += sc.clean_premium_per_mwh;
        count++;
        if (scarcityOrder.indexOf(sc.scarcity_class) > scarcityOrder.indexOf(worstScarcity)) {
            worstScarcity = sc.scarcity_class;
        }
    }

    const ratio = totalSupply > 0 ? totalDemand / totalSupply : (totalDemand > 0 ? 99 : 0);
    const avgPremium = count > 0 ? totalPremium / count : 0;

    document.getElementById('statDemandVal').textContent = totalDemand.toFixed(1);
    document.getElementById('statSupplyVal').textContent = totalSupply.toFixed(1);
    document.getElementById('statRatioVal').textContent = ratio.toFixed(2) + 'x';
    document.getElementById('statScarcityVal').textContent = worstScarcity.charAt(0).toUpperCase() + worstScarcity.slice(1);
    document.getElementById('statScarcityVal').style.color = SCARCITY_COLORS[worstScarcity];
    document.getElementById('statPremiumVal').textContent = '$' + avgPremium.toFixed(1);

    // Color stat tiles
    const ratioTile = document.getElementById('statRatio');
    ratioTile.className = 'stat-tile';
    if (ratio > 0.95) ratioTile.classList.add('red');
    else if (ratio > 0.6) ratioTile.classList.add('amber');
    else ratioTile.classList.add('green');
}

// ========== DYNAMIC INSIGHT ==========
function updateInsight() {
    const box = document.getElementById('insightBox');
    const title = document.getElementById('insightTitle');
    const text = document.getElementById('insightText');

    if (state.participation === 0) {
        box.style.display = 'none';
        return;
    }

    box.style.display = 'block';
    const isos = state.iso === 'ALL' ? ISOS : [state.iso];
    let criticalISOs = [], scarceISOs = [], abundantISOs = [];

    for (const iso of isos) {
        const sc = findScenario(iso, state.year, state.growth, state.participation, state.matchTarget);
        if (!sc) continue;
        if (sc.scarcity_class === 'critical') criticalISOs.push(ISO_LABELS[iso]);
        else if (sc.scarcity_class === 'scarce') scarceISOs.push(ISO_LABELS[iso]);
        else if (sc.scarcity_class === 'abundant' || sc.scarcity_class === 'adequate') abundantISOs.push(ISO_LABELS[iso]);
    }

    if (criticalISOs.length > 0) {
        box.className = 'insight-box danger';
        title.textContent = 'Critical EAC Scarcity Detected';
        text.textContent = `At ${state.participation}% corporate participation with ${state.matchTarget}% hourly matching in ${state.year}: ${criticalISOs.join(', ')} face critical scarcity — corporate EAC demand exceeds available uncommitted clean supply. New clean firm generation (CCS, nuclear, LDES) is required to close the gap.`;
    } else if (scarceISOs.length > 0) {
        box.className = 'insight-box warning';
        title.textContent = 'Scarcity Emerging';
        text.textContent = `At ${state.participation}% participation with ${state.matchTarget}% matching in ${state.year}: ${scarceISOs.join(', ')} show scarcity — clean premium will rise and drive investment signals for new clean capacity. ${abundantISOs.length > 0 ? abundantISOs.join(', ') + ' remain(s) well-supplied.' : ''}`;
    } else if (abundantISOs.length > 0) {
        box.className = 'insight-box';
        title.textContent = 'Supply Adequate';
        text.textContent = `At ${state.participation}% participation with ${state.matchTarget}% matching in ${state.year}: All selected ISOs have adequate uncommitted clean supply. Clean premiums remain moderate.`;
    } else {
        box.style.display = 'none';
    }
}

// ========== HEATMAP ==========
function updateHeatmap() {
    const container = document.getElementById('heatmapContainer');
    const isos = state.iso === 'ALL' ? ISOS : [state.iso];
    const subtitle = document.getElementById('heatmapSubtitle');
    subtitle.textContent = `${state.year} | ${state.growth} growth | ${isos.map(i => ISO_LABELS[i]).join(', ')}`;

    // Build grid: rows = participation, cols = match targets, one heatmap per ISO
    let html = '';
    for (const iso of isos) {
        html += `<div style="margin-bottom:16px;">`;
        html += `<div style="font-family:var(--font-heading);font-size:0.95rem;font-weight:700;color:var(--navy);margin-bottom:6px;">${ISO_LABELS[iso]}</div>`;

        const cols = MATCH_TARGETS.length + 1;
        html += `<div class="heatmap-grid" style="grid-template-columns: 60px repeat(${MATCH_TARGETS.length}, 1fr);">`;

        // Header row
        html += `<div class="heatmap-header"></div>`;
        for (const mt of MATCH_TARGETS) {
            html += `<div class="heatmap-header">${mt}%</div>`;
        }

        // Data rows
        for (const part of PARTICIPATION_RATES) {
            html += `<div class="heatmap-header" style="justify-content:flex-end;padding-right:8px;">${part}%</div>`;
            for (const mt of MATCH_TARGETS) {
                const sc = findScenario(iso, state.year, state.growth, part, mt);
                if (sc) {
                    const bg = SCARCITY_COLORS[sc.scarcity_class];
                    const isSelected = part === state.participation && mt === state.matchTarget;
                    const border = isSelected ? 'border:2px solid #000;' : '';
                    html += `<div class="heatmap-cell" style="background:${bg};${border}" title="${ISO_LABELS[iso]} | ${part}% participation | ${mt}% match\nDemand: ${sc.corp_eac_demand_twh} TWh\nRatio: ${sc.demand_supply_ratio}x\nPremium: $${sc.clean_premium_per_mwh}/MWh\nClass: ${sc.scarcity_label}">${sc.demand_supply_ratio > 0 ? sc.demand_supply_ratio.toFixed(1) : '0'}</div>`;
                } else {
                    html += `<div class="heatmap-cell" style="background:#e5e7eb;color:#888;">—</div>`;
                }
            }
        }
        html += '</div></div>';
    }

    container.innerHTML = html;
}

// ========== PREMIUM CHART ==========
function updatePremiumChart() {
    const ctx = document.getElementById('premiumChart').getContext('2d');
    const isos = state.iso === 'ALL' ? ISOS : [state.iso];

    const datasets = isos.map(iso => {
        const data = MATCH_TARGETS.map(mt => {
            const sc = findScenario(iso, state.year, state.growth, state.participation, mt);
            return sc ? sc.clean_premium_per_mwh : null;
        });
        return {
            label: ISO_LABELS[iso],
            data: data,
            borderColor: ISO_COLORS[iso],
            backgroundColor: ISO_COLORS[iso] + '20',
            borderWidth: 2.5,
            pointRadius: 4,
            pointHoverRadius: 6,
            tension: 0.3,
            fill: false,
        };
    });

    if (charts.premium) charts.premium.destroy();
    charts.premium = new Chart(ctx, {
        type: 'line',
        data: { labels: MATCH_TARGETS.map(m => m + '%'), datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
                annotation: {
                    annotations: {
                        epaLine: {
                            type: 'line', yMin: 51 / 0.4, yMax: 51 / 0.4,
                            borderColor: 'rgba(220,38,38,0.4)', borderWidth: 1, borderDash: [6, 3],
                            label: { display: true, content: 'EPA SCC @ 0.4 tCO2', position: 'start', font: { size: 10 }, backgroundColor: 'rgba(220,38,38,0.1)', color: '#DC2626' }
                        }
                    }
                },
                tooltip: {
                    callbacks: { label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y?.toFixed(1)}/MWh` }
                }
            },
            scales: {
                x: { title: { display: true, text: 'Hourly Match Target', font: { size: 12 } } },
                y: { title: { display: true, text: 'Clean Premium ($/MWh)', font: { size: 12 } }, beginAtZero: true }
            }
        }
    });
}

// ========== SUPPLY VS DEMAND CHART ==========
function updateSupplyDemandChart() {
    const ctx = document.getElementById('supplyDemandChart').getContext('2d');
    const isos = state.iso === 'ALL' ? ISOS : [state.iso];

    // X-axis = participation rates, for each ISO show supply line + demand line
    const datasets = [];
    for (const iso of isos) {
        const supply = DATA.supply_projections[iso]?.[state.year]?.[state.growth];
        if (!supply) continue;

        // Supply is constant horizontal line
        datasets.push({
            label: ISO_LABELS[iso] + ' Supply',
            data: PARTICIPATION_RATES.map(() => supply.available_non_sss_twh),
            borderColor: ISO_COLORS[iso],
            borderWidth: 2, borderDash: [6, 3],
            pointRadius: 0, fill: false,
        });
        // Demand increases with participation
        datasets.push({
            label: ISO_LABELS[iso] + ' Demand',
            data: PARTICIPATION_RATES.map(p => {
                const sc = findScenario(iso, state.year, state.growth, p, state.matchTarget);
                return sc ? sc.corp_eac_demand_twh : 0;
            }),
            borderColor: ISO_COLORS[iso],
            backgroundColor: ISO_COLORS[iso] + '15',
            borderWidth: 2.5,
            pointRadius: 3, fill: false,
        });
    }

    if (charts.supplyDemand) charts.supplyDemand.destroy();
    charts.supplyDemand = new Chart(ctx, {
        type: 'line',
        data: { labels: PARTICIPATION_RATES.map(p => p + '%'), datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 10, font: { size: 10 } } },
                tooltip: {
                    callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(1)} TWh` }
                }
            },
            scales: {
                x: { title: { display: true, text: 'Corporate Participation (% of C&I Demand)', font: { size: 12 } } },
                y: { title: { display: true, text: 'TWh', font: { size: 12 } }, beginAtZero: true }
            }
        }
    });
}

// ========== SUPPLY TIMELINE ==========
function updateSupplyTimeline() {
    const ctx = document.getElementById('supplyTimelineChart').getContext('2d');
    const iso = state.iso === 'ALL' ? 'PJM' : state.iso;
    const titleEl = ctx.canvas.closest('.chart-card').querySelector('h3');
    titleEl.textContent = `Supply Projection: ${ISO_LABELS[iso]} — SSS vs. Non-SSS Over Time`;

    const sssData = YEARS_ALL.map(y => {
        const sp = DATA.supply_projections[iso]?.[String(y)]?.[state.growth];
        return sp ? sp.sss_twh : null;
    });
    const nonSSSData = YEARS_ALL.map(y => {
        const sp = DATA.supply_projections[iso]?.[String(y)]?.[state.growth];
        return sp ? sp.available_non_sss_twh : null;
    });
    const ppasData = YEARS_ALL.map(y => {
        const sp = DATA.supply_projections[iso]?.[String(y)]?.[state.growth];
        return sp ? sp.existing_ppas_twh : null;
    });

    // Highlight current year
    const currentYearIdx = YEARS_ALL.indexOf(parseInt(state.year));

    if (charts.supplyTimeline) charts.supplyTimeline.destroy();
    charts.supplyTimeline = new Chart(ctx, {
        type: 'line',
        data: {
            labels: YEARS_ALL.map(String),
            datasets: [
                {
                    label: 'SSS (State-Supported)',
                    data: sssData,
                    backgroundColor: 'rgba(148,163,184,0.25)',
                    borderColor: '#94A3B8',
                    borderWidth: 2, fill: true, tension: 0.3, pointRadius: 0,
                },
                {
                    label: 'Existing Corporate PPAs',
                    data: ppasData,
                    backgroundColor: 'rgba(139,92,246,0.2)',
                    borderColor: '#8B5CF6',
                    borderWidth: 2, fill: true, tension: 0.3, pointRadius: 0,
                },
                {
                    label: 'Available for New Corporate',
                    data: nonSSSData,
                    backgroundColor: 'rgba(34,197,94,0.25)',
                    borderColor: '#22C55E',
                    borderWidth: 2.5, fill: true, tension: 0.3, pointRadius: 0,
                },
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
                tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(1)} TWh` } },
                annotation: {
                    annotations: {
                        yearLine: {
                            type: 'line',
                            xMin: currentYearIdx, xMax: currentYearIdx,
                            borderColor: 'rgba(220,38,38,0.7)', borderWidth: 2, borderDash: [4, 3],
                            label: { display: true, content: state.year, position: 'start', font: { size: 10, weight: 'bold' }, backgroundColor: 'rgba(220,38,38,0.15)', color: '#DC2626' }
                        }
                    }
                }
            },
            scales: {
                x: { title: { display: true, text: 'Year', font: { size: 12 } }, ticks: { maxTicksLimit: 10 } },
                y: { stacked: true, title: { display: true, text: 'TWh', font: { size: 12 } }, beginAtZero: true }
            }
        }
    });
}

// ========== INFLECTION CHART ==========
function updateInflectionChart() {
    const ctx = document.getElementById('inflectionChart').getContext('2d');
    const isos = state.iso === 'ALL' ? ISOS : [state.iso];

    const datasets = isos.map(iso => {
        const inflections = DATA.inflection_points[iso]?.[state.year]?.[state.growth];
        if (!inflections) return null;
        const data = MATCH_TARGETS.map(mt => {
            const ip = inflections[String(mt)];
            return ip ? ip.inflection_participation_pct : null;
        });
        return {
            label: ISO_LABELS[iso],
            data: data,
            backgroundColor: ISO_COLORS[iso] + 'CC',
            borderColor: ISO_COLORS[iso],
            borderWidth: 1.5,
            borderRadius: 4,
        };
    }).filter(Boolean);

    if (charts.inflection) charts.inflection.destroy();
    charts.inflection = new Chart(ctx, {
        type: 'bar',
        data: { labels: MATCH_TARGETS.map(m => m + '%'), datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
                tooltip: {
                    callbacks: { label: ctx => `${ctx.dataset.label}: scarcity at ${ctx.parsed.y}% participation` }
                },
                annotation: {
                    annotations: {
                        currentLine: {
                            type: 'line', yMin: state.participation, yMax: state.participation,
                            borderColor: 'rgba(220,38,38,0.6)', borderWidth: 2, borderDash: [4, 4],
                            label: { display: true, content: `Current: ${state.participation}%`, position: 'end', font: { size: 10 }, backgroundColor: 'rgba(220,38,38,0.15)', color: '#DC2626' }
                        }
                    }
                }
            },
            scales: {
                x: { title: { display: true, text: 'Hourly Match Target', font: { size: 12 } } },
                y: { title: { display: true, text: 'Participation % at Scarcity Inflection', font: { size: 12 } }, beginAtZero: true, max: 100 }
            }
        }
    });
}

// ========== RPS vs VOLUNTARY DEMAND CHART ==========
function updateRPSDemandChart() {
    const ctx = document.getElementById('rpsDemandChart').getContext('2d');
    const isos = state.iso === 'ALL' ? ISOS : [state.iso];

    const datasets = [];
    for (const iso of isos) {
        // RPS mandated new build (from supply projections)
        const rpsData = PARTICIPATION_RATES.map(p => {
            const sc = findScenario(iso, state.year, state.growth, p, state.matchTarget);
            return sc ? sc.rps_mandated_new_twh : 0;
        });
        datasets.push({
            label: ISO_LABELS[iso] + ' RPS Mandated',
            data: rpsData,
            borderColor: ISO_COLORS[iso],
            backgroundColor: ISO_COLORS[iso] + '30',
            borderWidth: 2, borderDash: [6, 3],
            pointRadius: 0, fill: false, tension: 0.3,
        });
        // Voluntary corporate demand
        const volData = PARTICIPATION_RATES.map(p => {
            const sc = findScenario(iso, state.year, state.growth, p, state.matchTarget);
            return sc ? sc.corp_eac_demand_twh : 0;
        });
        datasets.push({
            label: ISO_LABELS[iso] + ' Voluntary',
            data: volData,
            borderColor: ISO_COLORS[iso],
            backgroundColor: ISO_COLORS[iso] + '15',
            borderWidth: 2.5,
            pointRadius: 3, fill: false, tension: 0.3,
        });
    }

    if (charts.rpsDemand) charts.rpsDemand.destroy();
    charts.rpsDemand = new Chart(ctx, {
        type: 'line',
        data: { labels: PARTICIPATION_RATES.map(p => p + '%'), datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 8, font: { size: 10 } } },
                tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(1)} TWh` } }
            },
            scales: {
                x: { title: { display: true, text: 'Corporate Participation (%)', font: { size: 12 } } },
                y: { title: { display: true, text: 'TWh', font: { size: 12 } }, beginAtZero: true }
            }
        }
    });
}

// ========== HEADROOM CHART ==========
function updateHeadroomChart() {
    const ctx = document.getElementById('headroomChart').getContext('2d');
    const isos = state.iso === 'ALL' ? ISOS : [state.iso];

    const datasets = [];
    for (const iso of isos) {
        const headroomData = PARTICIPATION_RATES.map(p => {
            const sc = findScenario(iso, state.year, state.growth, p, state.matchTarget);
            if (!sc) return null;
            // Headroom = total buildable - combined demand
            return Math.max(0, sc.total_buildable_twh - sc.combined_new_demand_twh);
        });
        datasets.push({
            label: ISO_LABELS[iso],
            data: headroomData,
            borderColor: ISO_COLORS[iso],
            backgroundColor: ISO_COLORS[iso] + '20',
            borderWidth: 2.5,
            pointRadius: 3, fill: true, tension: 0.3,
        });
    }

    if (charts.headroom) charts.headroom.destroy();
    charts.headroom = new Chart(ctx, {
        type: 'line',
        data: { labels: PARTICIPATION_RATES.map(p => p + '%'), datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
                tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(1)} TWh headroom` } },
                annotation: {
                    annotations: {
                        zeroLine: {
                            type: 'line', yMin: 0, yMax: 0,
                            borderColor: 'rgba(220,38,38,0.5)', borderWidth: 2,
                            label: { display: true, content: 'No headroom', position: 'end', font: { size: 10 }, color: '#DC2626', backgroundColor: 'rgba(220,38,38,0.1)' }
                        }
                    }
                }
            },
            scales: {
                x: { title: { display: true, text: 'Corporate Participation (%)', font: { size: 12 } } },
                y: { title: { display: true, text: 'Buildable Headroom (TWh)', font: { size: 12 } }, beginAtZero: true }
            }
        }
    });
}

// ========== ISO TABLE ==========
function updateISOTable() {
    const tbody = document.getElementById('isoTableBody');
    let html = '';
    for (const iso of ISOS) {
        const sc = findScenario(iso, state.year, state.growth, state.participation, state.matchTarget);
        const supply = DATA.supply_projections[iso]?.[state.year]?.[state.growth];
        if (!sc || !supply) continue;

        const badgeBg = SCARCITY_BG[sc.scarcity_class] || '#E5E7EB';
        const badgeColor = SCARCITY_TEXT[sc.scarcity_class] || '#666';

        html += `<tr>
            <td><strong style="color:${ISO_COLORS[iso]}">${ISO_LABELS[iso]}</strong></td>
            <td>${supply.total_clean_twh.toFixed(1)}</td>
            <td>${supply.sss_twh.toFixed(1)}</td>
            <td>${supply.available_non_sss_twh.toFixed(1)}</td>
            <td>${sc.corp_eac_demand_twh.toFixed(1)}</td>
            <td>${sc.demand_supply_ratio.toFixed(2)}x</td>
            <td><span class="scarcity-badge" style="background:${badgeBg};color:${badgeColor}">${sc.scarcity_label}</span></td>
            <td>$${sc.clean_premium_per_mwh.toFixed(1)}</td>
        </tr>`;
    }

    // National totals
    const natSummary = DATA.national_summary?.[state.year]?.[state.growth];
    if (natSummary) {
        let totalDemand = 0, totalPremium = 0;
        for (const iso of ISOS) {
            const sc = findScenario(iso, state.year, state.growth, state.participation, state.matchTarget);
            if (sc) { totalDemand += sc.corp_eac_demand_twh; totalPremium += sc.clean_premium_per_mwh; }
        }
        const ratio = natSummary.total_available_twh > 0 ? totalDemand / natSummary.total_available_twh : 0;
        html += `<tr style="font-weight:600;border-top:2px solid var(--border);">
            <td>National Total</td>
            <td>${natSummary.total_clean_twh.toFixed(1)}</td>
            <td>${natSummary.total_sss_twh.toFixed(1)}</td>
            <td>${natSummary.total_available_twh.toFixed(1)}</td>
            <td>${totalDemand.toFixed(1)}</td>
            <td>${ratio.toFixed(2)}x</td>
            <td>—</td>
            <td>$${(totalPremium / 5).toFixed(1)} avg</td>
        </tr>`;
    }

    tbody.innerHTML = html;
}

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
