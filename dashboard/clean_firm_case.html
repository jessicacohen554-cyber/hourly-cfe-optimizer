<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Case for Clean Firm Power — The 8,760 Problem</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles/shared.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
body { background: #0B1120; }

/* ========== HERO ========== */
.hero-overview {
    background: linear-gradient(180deg, #0B1120 0%, #13203D 100%);
    position: relative;
    overflow: hidden;
    padding: 48px 24px;
}
.hero-overview::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 30% 20%, rgba(14,165,233,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(239,68,68,0.06) 0%, transparent 60%);
    pointer-events: none;
}
.hero-inner {
    position: relative;
    max-width: 1320px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 48px;
    align-items: center;
}
.hero-text h2 {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 800;
    color: #fff;
    margin-bottom: 16px;
    line-height: 1.2;
    letter-spacing: -0.5px;
}
.hero-text p {
    font-size: 0.95rem;
    color: rgba(255,255,255,0.75);
    line-height: 1.75;
    margin-bottom: 16px;
}

/* ========== COUNTERS ========== */
.counter-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 24px 0 0;
}
.counter-card {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 16px 14px;
    text-align: center;
    flex: 1;
    min-width: 110px;
}
.counter-val {
    font-family: var(--font-heading);
    font-size: 1.8rem;
    font-weight: 800;
    color: #EF4444;
    line-height: 1;
    margin-bottom: 4px;
}
.counter-val.green { color: #22C55E; }
.counter-val.blue { color: #0EA5E9; }
.counter-lbl {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.5);
    font-weight: 600;
    letter-spacing: 0.3px;
    text-transform: uppercase;
}

/* ========== CHART PANELS ========== */
.chart-panel {
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    background: rgba(15,26,46,0.95);
    border: 1px solid rgba(74,144,217,0.2);
    border-radius: 16px;
    padding: 24px 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 100%;
    box-sizing: border-box;
}
.chart-panel .chart-container {
    position: relative;
    width: 100%;
    min-height: 340px;
}
.chart-title {
    font-family: var(--font-heading);
    font-size: 0.85rem;
    font-weight: 700;
    color: rgba(255,255,255,0.85);
    text-align: center;
    margin-bottom: 10px;
    letter-spacing: 0.02em;
}

/* ========== ISO SELECTOR ========== */
.iso-selector {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 10px;
}
.iso-btn {
    padding: 5px 12px;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 6px;
    background: rgba(255,255,255,0.06);
    font-family: var(--font-heading);
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s;
    color: rgba(255,255,255,0.5);
    min-width: 44px;
    min-height: 34px;
}
.iso-btn:hover {
    background: rgba(14,165,233,0.12);
    border-color: rgba(14,165,233,0.3);
    color: rgba(255,255,255,0.8);
}
.iso-btn.active {
    background: rgba(14,165,233,0.2);
    color: #fff;
    border-color: rgba(14,165,233,0.5);
}

/* ========== CONCEPT SECTIONS ========== */
.concept-section {
    background: #0B1120;
    position: relative;
    border-top: 1px solid rgba(255,255,255,0.06);
}
.concept-inner {
    max-width: 1320px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    min-height: auto;
}
.concept-chart-col {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 32px;
}
.concept-narrative-col {
    padding: 48px 48px 48px 32px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

/* ========== NARRATIVE CARDS ========== */
.narrative-card {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 28px;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s cubic-bezier(0.4,0,0.2,1),
                transform 0.8s cubic-bezier(0.4,0,0.2,1);
}
.narrative-card.visible {
    opacity: 1;
    transform: translateY(0);
}
.narrative-card h3 {
    font-family: var(--font-heading);
    font-size: 1.4rem;
    font-weight: 800;
    color: #fff;
    margin-bottom: 10px;
    line-height: 1.25;
    letter-spacing: -0.3px;
}
.narrative-card p {
    font-size: 0.9rem;
    color: rgba(255,255,255,0.72);
    line-height: 1.7;
    margin-bottom: 0;
}
.iso-tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-family: var(--font-heading);
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    margin-bottom: 10px;
    text-transform: uppercase;
}
.stat-callout {
    display: inline-block;
    margin-top: 12px;
    padding: 8px 14px;
    border-radius: 10px;
    font-family: var(--font-heading);
    font-size: 0.82rem;
    font-weight: 700;
}
.stat-red {
    background: rgba(239,68,68,0.12);
    border: 1px solid rgba(239,68,68,0.25);
    color: #f87171;
}
.stat-green {
    background: rgba(34,197,94,0.12);
    border: 1px solid rgba(34,197,94,0.25);
    color: #4ade80;
}
.stat-blue {
    background: rgba(14,165,233,0.12);
    border: 1px solid rgba(14,165,233,0.25);
    color: #38bdf8;
}
.stat-amber {
    background: rgba(245,158,11,0.12);
    border: 1px solid rgba(245,158,11,0.25);
    color: #fbbf24;
}

/* ========== SYNTHESIS ========== */
.synthesis-section {
    background: #0B1120;
    padding: 56px 24px;
    border-top: 1px solid rgba(255,255,255,0.06);
}
.synthesis-inner {
    max-width: 1320px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}
.synthesis-card {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 28px;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s cubic-bezier(0.4,0,0.2,1),
                transform 0.8s cubic-bezier(0.4,0,0.2,1);
}
.synthesis-card.visible {
    opacity: 1;
    transform: translateY(0);
}
.synthesis-card h3 {
    font-family: var(--font-heading);
    font-size: 1.2rem;
    font-weight: 800;
    color: #fff;
    margin-bottom: 10px;
    line-height: 1.25;
}
.synthesis-card p {
    font-size: 0.88rem;
    color: rgba(255,255,255,0.72);
    line-height: 1.7;
    margin-bottom: 0;
}

/* ========== SECTION HEADERS ========== */
.section-header {
    max-width: 1320px;
    margin: 0 auto;
    padding: 40px 32px 0;
    text-align: center;
}
.section-number {
    display: inline-block;
    width: 32px;
    height: 32px;
    line-height: 32px;
    border-radius: 50%;
    background: rgba(239,68,68,0.15);
    color: #f87171;
    font-family: var(--font-heading);
    font-size: 0.85rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 10px;
}
.section-header h2 {
    font-family: var(--font-heading);
    font-size: 1.6rem;
    font-weight: 800;
    color: #fff;
    margin-bottom: 8px;
    letter-spacing: -0.3px;
}
.section-header p {
    font-size: 0.88rem;
    color: rgba(255,255,255,0.55);
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.6;
}

/* ========== FOOTER ========== */
.page-footer {
    background: #0F1A2E;
    color: rgba(255,255,255,0.7);
    padding: 32px 24px;
    text-align: center;
}
.footer-links { display: flex; flex-wrap: wrap; gap: 16px 24px; justify-content: center; margin-bottom: 12px; }
.footer-links a {
    color: rgba(255,255,255,0.65);
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    padding: 8px 4px;
    transition: color 0.2s;
}
.footer-links a:hover { color: #ffffff; }
.footer-note { font-size: 0.78rem; color: rgba(255,255,255,0.4); }
.bottom-banner {
    height: 4px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 25%, #22C55E 50%, #F59E0B 75%, #EF4444 100%);
}

/* ========== RESPONSIVE ========== */
html, body { overflow-x: hidden; max-width: 100vw; }

@media (max-width: 900px) {
    .hero-inner { grid-template-columns: 1fr; gap: 24px; }
    .hero-overview { padding: 36px 16px; }
    .concept-inner { grid-template-columns: 1fr; }
    .concept-chart-col { padding: 24px 16px 16px; }
    .concept-narrative-col { padding: 16px 16px 32px; }
    .chart-panel { padding: 16px 14px; border-radius: 12px; }
    .chart-panel .chart-container { min-height: 300px; }
    .synthesis-inner { grid-template-columns: 1fr; gap: 16px; }
    .synthesis-section { padding: 36px 16px; }
    .narrative-card { padding: 22px 18px; }
    .narrative-card h3 { font-size: 1.2rem; }
    .section-header { padding: 32px 16px 0; }
    .section-header h2 { font-size: 1.35rem; }
}
@media (max-width: 600px) {
    .hero-overview { padding: 28px 12px; }
    .chart-panel { padding: 12px 10px; }
    .chart-panel .chart-container { min-height: 260px; }
    .concept-chart-col { padding: 16px 10px 10px; }
    .concept-narrative-col { padding: 10px 12px 24px; }
    .narrative-card { padding: 18px 14px; }
    .narrative-card h3 { font-size: 1.1rem; }
    .narrative-card p { font-size: 0.82rem; }
    .synthesis-card { padding: 18px 14px; }
    .synthesis-card h3 { font-size: 1rem; }
    .counter-card { min-width: 80px; padding: 10px 8px; }
    .counter-val { font-size: 1.4rem; }
    .counter-lbl { font-size: 0.65rem; }
    .hero-text h2 { font-size: 1.5rem; }
    .hero-text p { font-size: 0.85rem; }
}
@media (max-width: 480px) {
    .hero-overview { padding: 20px 8px; }
    .chart-panel .chart-container { min-height: 240px; }
    .iso-btn { padding: 4px 9px; font-size: 0.68rem; min-height: 30px; }
    .stat-callout { font-size: 0.75rem; padding: 6px 10px; }
    .section-header h2 { font-size: 1.2rem; }
    .section-header p { font-size: 0.8rem; }
}
</style>
</head>
<body>

<!-- NAV -->
<nav id="topNav"></nav>

<!-- HEADER -->
<header class="header">
    <div class="header-accent"></div>
    <h1>The Case for Clean Firm Power</h1>
    <p class="subtitle">Why every ISO needs dispatchable clean generation — and why the gas alternative is more expensive than it looks</p>
</header>

<!-- ==================== HERO ==================== -->
<section class="hero-overview">
    <div class="hero-inner">
        <div class="hero-text">
            <h2>You're building gas plants today that become stranded assets tomorrow.</h2>
            <p>At 90% clean energy, America's 5 major ISOs need <strong style="color:#f87171;">120 GW of new gas construction</strong> to maintain reliability. That's billions in capital that earns diminishing returns as decarbonization continues. Clean firm power — nuclear, enhanced geothermal, CCS — prevents this trap. The investment case holds across all 324 cost scenarios we tested.</p>
            <div class="counter-row">
                <div class="counter-card">
                    <div class="counter-val" id="ctrNewGas">120</div>
                    <div class="counter-lbl">GW New Gas at Risk</div>
                </div>
                <div class="counter-card">
                    <div class="counter-val" id="ctrAnnualCost">$12B</div>
                    <div class="counter-lbl">Annual Stranding Cost</div>
                </div>
                <div class="counter-card">
                    <div class="counter-val blue" id="ctrISOs">5</div>
                    <div class="counter-lbl">ISOs Analyzed</div>
                </div>
                <div class="counter-card">
                    <div class="counter-val green" id="ctrScenarios">324</div>
                    <div class="counter-lbl">Cost Scenarios</div>
                </div>
            </div>
        </div>
        <div class="hero-chart-block">
            <div class="chart-panel">
                <div class="chart-title">New Gas Construction Required at 90% Clean (GW)</div>
                <div class="chart-container">
                    <canvas id="heroChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ==================== SECTION 1: THE GAS TRAP ==================== -->
<div class="section-header">
    <div class="section-number">1</div>
    <h2>The Gas Trap: You're Paying to Build Stranded Assets</h2>
    <p>Every ISO needs new gas capacity to guarantee reliability — but that capital becomes stranded as clean energy scales. Click each ISO to see the scale of the problem.</p>
</div>
<section class="concept-section">
    <div class="concept-inner">
        <div class="concept-chart-col">
            <div class="chart-panel" style="width:100%;">
                <div class="iso-selector" id="gasTrapISO">
                    <button class="iso-btn active" data-iso="PJM">PJM</button>
                    <button class="iso-btn" data-iso="ERCOT">ERCOT</button>
                    <button class="iso-btn" data-iso="CAISO">CAISO</button>
                    <button class="iso-btn" data-iso="NYISO">NYISO</button>
                    <button class="iso-btn" data-iso="NEISO">NEISO</button>
                </div>
                <div class="chart-title" id="gasTrapTitle">PJM: Gas Backup Capacity by Threshold</div>
                <div class="chart-container">
                    <canvas id="gasTrapChart"></canvas>
                </div>
            </div>
        </div>
        <div class="concept-narrative-col">
            <div class="narrative-card" id="gasTrapCard"></div>
        </div>
    </div>
</section>

<!-- ==================== SECTION 2: CLEAN FIRM DISPLACES GAS ==================== -->
<div class="section-header">
    <div class="section-number">2</div>
    <h2>Clean Firm Displaces Gas — Dollar for Dollar</h2>
    <p>As dispatchable clean generation enters, gas backup drops and clean coverage rises. The displacement is consistent across every cost scenario.</p>
</div>
<section class="concept-section">
    <div class="concept-inner">
        <div class="concept-chart-col">
            <div class="chart-panel" style="width:100%;">
                <div class="iso-selector" id="displacementISO">
                    <button class="iso-btn active" data-iso="PJM">PJM</button>
                    <button class="iso-btn" data-iso="ERCOT">ERCOT</button>
                    <button class="iso-btn" data-iso="CAISO">CAISO</button>
                    <button class="iso-btn" data-iso="NYISO">NYISO</button>
                    <button class="iso-btn" data-iso="NEISO">NEISO</button>
                </div>
                <div class="chart-title" id="displacementTitle">PJM: Gas Drops as Clean Firm Rises</div>
                <div class="chart-container">
                    <canvas id="displacementChart"></canvas>
                </div>
            </div>
        </div>
        <div class="concept-narrative-col">
            <div class="narrative-card" id="displacementCard"></div>
        </div>
    </div>
</section>

<!-- ==================== SECTION 3: THE INVESTMENT CASE ==================== -->
<div class="section-header">
    <div class="section-number">3</div>
    <h2>The Investment Math: Gas Costs Are Permanent, FOAK Costs Decline</h2>
    <p>Gas backup cost recurs annually and compounds with demand growth. Clean firm FOAK costs are one-time premiums that shrink with every deployment.</p>
</div>
<section class="concept-section">
    <div class="concept-inner">
        <div class="concept-chart-col">
            <div class="chart-panel" style="width:100%;">
                <div class="chart-title">Gas Backup Cost vs Nuclear LCOE at 90% Clean — All ISOs</div>
                <div class="chart-container">
                    <canvas id="investmentChart"></canvas>
                </div>
            </div>
        </div>
        <div class="concept-narrative-col">
            <div class="narrative-card" id="investmentCard"></div>
        </div>
    </div>
</section>

<!-- ==================== SYNTHESIS ==================== -->
<section class="synthesis-section">
    <div class="synthesis-inner">
        <div class="synthesis-card">
            <h3>The stranding risk is already here</h3>
            <p>120 GW of new gas construction across 5 ISOs at 90% clean energy. This capital earns diminishing returns as clean targets rise. The stranding cost is $7&ndash;10/MWh — a permanent annual tax on every region's ratepayers. Without clean firm power, this cost is unavoidable.</p>
            <span class="stat-callout stat-red">120 GW new gas &middot; $12B/yr stranding cost &middot; Permanent</span>
        </div>
        <div class="synthesis-card">
            <h3>The FOAK premium is an investment, not a cost</h3>
            <p>Nuclear FOAK costs are ~$135&ndash;170/MWh. NOAK targets are $68&ndash;75/MWh after 10&ndash;20 deployments (DOE Liftoff). Geothermal is moving even faster — Fervo cut drilling costs 50% in 3 years. Every deployment accelerates the next. The gas cost it displaces never declines.</p>
            <span class="stat-callout stat-green">~40% cost decline FOAK&rarr;NOAK &middot; Fervo: 35% learning rate</span>
        </div>
    </div>
</section>

<!-- SOURCES -->
<div style="max-width:1320px;margin:0 auto;padding:24px;">
    <details style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:16px 20px;">
        <summary style="font-family:var(--font-heading);font-size:0.85rem;font-weight:600;color:rgba(255,255,255,0.8);cursor:pointer;min-height:44px;display:flex;align-items:center;">Sources &amp; Methodology</summary>
        <div style="font-size:0.78rem;color:rgba(255,255,255,0.5);line-height:1.8;margin-top:12px;">
            <p><strong>Data:</strong> Hourly CFE Optimizer (2025 snapshot, 5 ISOs, 13 thresholds, 324 sensitivity scenarios). Gas backup modeled with 15% reserve margin above ISO peak demand.</p>
            <p><strong>Key sources:</strong> Sepulveda &amp; Jenkins (2018), <em>Joule</em> — 10&ndash;62% cost reduction from firm resources &bull;
            CATF (2025), "Clean Firm Electricity Technologies" &bull;
            DOE (2024), "Pathways to Commercial Liftoff: Advanced Nuclear" — FOAK $6,200/kW &rarr; NOAK $3,600/kW &bull;
            Fervo Energy (2024) — 35% learning rate, 50% drilling cost reduction &bull;
            NREL (2021), "The Challenge of the Last Few Percent" — 29% cost spike at 100% RE &bull;
            IEA (2025), World Energy Outlook &bull;
            Princeton Net-Zero America Project (2021)</p>
        </div>
    </details>
</div>

<!-- FOOTER -->
<footer class="page-footer">
    <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Grid Simulation</a>
        <a href="abatement_dashboard.html">CO&#8322; Abatement</a>
        <a href="research_paper.html">Research Paper</a>
    </div>
    <div class="footer-note">The 8,760 Problem &mdash; 2025 Snapshot Model &middot; <a href="dashboard.html" style="color:rgba(255,255,255,0.5);">Explore all 324 scenarios &rarr;</a></div>
</footer>
<div class="bottom-banner"></div>

<!-- ==================== SCRIPTS ==================== -->
<script src="js/shared-data.js"></script>
<script src="js/nav.js"></script>
<script>
// ============================================================================
// STATE & CONSTANTS
// ============================================================================
const ISOS = ['PJM', 'ERCOT', 'CAISO', 'NYISO', 'NEISO'];
const ISO_CLR = { CAISO: '#F59E0B', ERCOT: '#22C55E', PJM: '#4a90d9', NYISO: '#E91E63', NEISO: '#9C27B0' };
const ISO_TAG_BG = { CAISO: 'rgba(245,158,11,0.15)', ERCOT: 'rgba(34,197,94,0.15)', PJM: 'rgba(74,144,217,0.15)', NYISO: 'rgba(233,30,99,0.15)', NEISO: 'rgba(156,39,176,0.15)' };

let gasTrapISO = 'PJM';
let displacementISO = 'PJM';
let gasTrapChart = null;
let displacementChart = null;
let investmentChart = null;

// Threshold indices for readable charts: 50,70,80,85,90,95,97.5,99
const DISPLAY_IDXS = [0, 2, 4, 5, 7, 9, 10, 11];
const DISPLAY_LABELS = DISPLAY_IDXS.map(i => THRESHOLDS[i] + '%');

// ============================================================================
// DATA HELPERS
// ============================================================================
function gd(iso) { return GAS_BACKUP_DATA[iso]; }
function gw(mw) { return (mw / 1000).toFixed(0); }
function gwf(mw) { return (mw / 1000).toFixed(1); }

// Per-ISO narrative data at 90% threshold (index 7)
function isoStats(iso) {
    var d = gd(iso);
    var demand = REGIONAL_DEMAND_TWH[iso];
    return {
        newGW: gw(d.new_gas_build_mw[7]),
        existGW: gw(d.existing_gas_used_mw[7]),
        totalGW: gw(d.gas_backup_mw[7]),
        newCost: d.new_gas_cost[7].toFixed(1),
        totalCost: d.gas_backup_cost[7].toFixed(1),
        annualB: (d.new_gas_cost[7] * demand / 1000).toFixed(1),
        covStart: d.clean_coverage_pct[0].toFixed(0),
        cov90: d.clean_coverage_pct[7].toFixed(0),
        covEnd: d.clean_coverage_pct[10].toFixed(0),
        gasDisplaced: gw(d.gas_backup_mw[0] - d.gas_backup_mw[10]),
        nucFOAK: NUCLEAR_NEWBUILD_LCOE.H[iso],
        nucNOAK: NUCLEAR_NEWBUILD_LCOE.L[iso],
        nucMed: NUCLEAR_NEWBUILD_LCOE.M[iso]
    };
}

// ============================================================================
// PER-ISO NARRATIVES
// ============================================================================
var GAS_TRAP_TEXT = {
    PJM: {
        headline: '{newGW} GW of new gas — the largest absolute build',
        text: 'PJM needs {newGW} GW of new gas construction at 90% clean, on top of {existGW} GW existing. The Mid-Atlantic\'s moderate wind and solar resources leave a large shape gap that only dispatchable generation can fill. That\'s <strong>${annualB}B/yr</strong> in new gas capital at risk of stranding.',
        statClass: 'stat-red'
    },
    ERCOT: {
        headline: '{newGW} GW of new gas — highest per-MWh cost',
        text: 'Texas needs {newGW} GW of new gas at 90% clean, driven by extreme summer peaks. Despite leading in wind deployment, ERCOT\'s {totalGW} GW gas dependency costs <strong>${totalCost}/MWh</strong> across all generation — the highest rate of any ISO.',
        statClass: 'stat-red'
    },
    CAISO: {
        headline: '{newGW} GW of new gas despite leading in solar',
        text: 'Even with America\'s deepest solar resources, California needs {newGW} GW of new gas at 90% clean. Solar overproduction during the day doesn\'t help at night. The evening ramp demands gas backup every single day.',
        statClass: 'stat-amber'
    },
    NYISO: {
        headline: '{newGW} GW of new gas — hydro delays but doesn\'t prevent',
        text: 'New York\'s existing hydro and nuclear reduce the new gas need to {newGW} GW — relatively modest. But at <strong>${newCost}/MWh</strong> in new gas cost, the per-unit burden is substantial. CLCPA mandates require this gap to close.',
        statClass: 'stat-red'
    },
    NEISO: {
        headline: '{newGW} GW of new gas with winter vulnerability',
        text: 'New England needs {newGW} GW of new gas at 90% clean. Winter gas pipeline constraints make this the most vulnerable region — when heating demand spikes, gas for power becomes scarce and prices spike. At <strong>${totalCost}/MWh</strong>, it\'s among the costliest per-MWh.',
        statClass: 'stat-red'
    }
};

var DISPLACEMENT_TEXT = {
    PJM: {
        headline: 'Clean coverage: {covStart}% → {covEnd}% of peak',
        text: 'PJM\'s existing nuclear fleet gives it the highest starting coverage of any ISO. Adding new clean firm lifts coverage to {cov90}% at 90% clean, displacing {gasDisplaced} GW of gas backup. Each GW of clean firm added here is leveraged against the largest gas fleet in the country.',
        statClass: 'stat-green'
    },
    ERCOT: {
        headline: 'Clean coverage: {covStart}% → {covEnd}% of peak',
        text: 'ERCOT\'s 96 GW peak means each percentage point of clean coverage requires enormous capacity. Coverage rises from {covStart}% to {covEnd}% — modest in percentage terms, but the absolute gas displaced ({gasDisplaced} GW) is significant.',
        statClass: 'stat-green'
    },
    CAISO: {
        headline: 'Clean coverage: {covStart}% → {covEnd}% of peak',
        text: 'Enhanced geothermal potential in the Imperial Valley makes CAISO the strongest long-term displacement story. Clean coverage rises from {covStart}% to {covEnd}%, with each additional GW of firm generation directly eliminating gas capacity.',
        statClass: 'stat-green'
    },
    NYISO: {
        headline: 'Clean coverage: {covStart}% → {covEnd}% of peak',
        text: 'Existing hydro and nuclear give New York a head start at {covStart}% coverage. New clean firm lifts this to {covEnd}% at 97.5% threshold — the second-highest proportional gain. But the last 10 points require breakthrough firm generation costs.',
        statClass: 'stat-blue'
    },
    NEISO: {
        headline: 'Clean coverage: {covStart}% → {covEnd}% of peak',
        text: 'New England\'s small 30 GW peak means each new firm GW has outsized impact. Coverage rises from {covStart}% to {covEnd}%, and {gasDisplaced} GW of gas is displaced. This region shows the strongest per-MW return on clean firm investment.',
        statClass: 'stat-green'
    }
};

function renderNarrative(cardId, textObj, iso) {
    var s = isoStats(iso);
    var t = textObj[iso];
    var headline = t.headline.replace(/\{(\w+)\}/g, function(_, k) { return s[k]; });
    var text = t.text.replace(/\{(\w+)\}/g, function(_, k) { return s[k]; });
    var stat = iso + ': ' + s.newGW + ' GW new gas · $' + s.totalCost + '/MWh gas cost · $' + s.annualB + 'B/yr';
    if (cardId === 'displacementCard') {
        stat = iso + ': ' + s.gasDisplaced + ' GW gas displaced · ' + s.covStart + '% → ' + s.covEnd + '% clean coverage';
    }
    var card = document.getElementById(cardId);
    card.innerHTML =
        '<span class="iso-tag" style="background:' + ISO_TAG_BG[iso] + ';color:' + ISO_CLR[iso] + ';">' + iso + '</span>' +
        '<h3>' + headline + '</h3>' +
        '<p>' + text + '</p>' +
        '<span class="stat-callout ' + t.statClass + '">' + stat + '</span>';
    card.classList.add('visible');
}

// ============================================================================
// HERO CHART — All ISOs horizontal stacked bar at 90%
// ============================================================================
function buildHeroChart() {
    var ctx = document.getElementById('heroChart');
    if (!ctx) return;

    var existData = ISOS.map(function(iso) { return gd(iso).existing_gas_used_mw[7] / 1000; });
    var newData = ISOS.map(function(iso) { return gd(iso).new_gas_build_mw[7] / 1000; });

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ISOS,
            datasets: [
                {
                    label: 'Existing Gas (GW)',
                    data: existData,
                    backgroundColor: 'rgba(156,163,175,0.5)',
                    borderColor: 'rgba(156,163,175,0.8)',
                    borderWidth: 1
                },
                {
                    label: 'New Gas Build (GW)',
                    data: newData,
                    backgroundColor: 'rgba(239,68,68,0.65)',
                    borderColor: '#EF4444',
                    borderWidth: 1
                }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: 'rgba(255,255,255,0.6)', font: { size: 11 }, usePointStyle: true, padding: 12 }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.85)',
                    padding: 10,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(c) { return c.dataset.label + ': ' + c.raw.toFixed(0) + ' GW'; }
                    }
                },
                datalabels: {
                    display: true,
                    color: '#fff',
                    font: { size: 11, weight: 'bold', family: "'Barlow Semi Condensed', sans-serif" },
                    anchor: 'center',
                    align: 'center',
                    formatter: function(v) { return v >= 5 ? v.toFixed(0) : ''; }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    title: { display: true, text: 'Capacity (GW)', color: 'rgba(255,255,255,0.4)', font: { size: 10 } },
                    ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.06)' },
                    border: { color: 'rgba(255,255,255,0.15)' }
                },
                y: {
                    stacked: true,
                    ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 12, weight: '600' } },
                    grid: { display: false },
                    border: { color: 'rgba(255,255,255,0.15)' }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

// ============================================================================
// SECTION 1: GAS TRAP CHART — Stacked bar + cost line, per ISO
// ============================================================================
function buildGasTrapChart() {
    var ctx = document.getElementById('gasTrapChart');
    if (!ctx) return;
    var d = gd(gasTrapISO);

    gasTrapChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: DISPLAY_LABELS,
            datasets: [
                {
                    label: 'Existing Gas (GW)',
                    data: DISPLAY_IDXS.map(function(i) { return (d.gas_backup_mw[i] - d.new_gas_build_mw[i]) / 1000; }),
                    backgroundColor: 'rgba(156,163,175,0.45)',
                    borderColor: 'rgba(156,163,175,0.7)',
                    borderWidth: 1,
                    stack: 'gas',
                    order: 2
                },
                {
                    label: 'New Gas Build (GW)',
                    data: DISPLAY_IDXS.map(function(i) { return d.new_gas_build_mw[i] / 1000; }),
                    backgroundColor: 'rgba(239,68,68,0.6)',
                    borderColor: '#EF4444',
                    borderWidth: 1,
                    stack: 'gas',
                    order: 2
                },
                {
                    label: 'Gas Cost ($/MWh)',
                    data: DISPLAY_IDXS.map(function(i) { return d.gas_backup_cost[i]; }),
                    type: 'line',
                    yAxisID: 'y2',
                    borderColor: '#fbbf24',
                    backgroundColor: 'rgba(251,191,36,0.08)',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: '#fbbf24',
                    tension: 0.3,
                    fill: true,
                    order: 1
                }
            ]
        },
        options: chartOpts('Gas Backup (GW)', 'Gas Cost ($/MWh)', true),
        plugins: [ChartDataLabels]
    });
}

function updateGasTrapChart() {
    if (!gasTrapChart) return;
    var d = gd(gasTrapISO);
    gasTrapChart.data.datasets[0].data = DISPLAY_IDXS.map(function(i) { return (d.gas_backup_mw[i] - d.new_gas_build_mw[i]) / 1000; });
    gasTrapChart.data.datasets[1].data = DISPLAY_IDXS.map(function(i) { return d.new_gas_build_mw[i] / 1000; });
    gasTrapChart.data.datasets[2].data = DISPLAY_IDXS.map(function(i) { return d.gas_backup_cost[i]; });
    document.getElementById('gasTrapTitle').textContent = gasTrapISO + ': Gas Backup Capacity by Threshold';
    gasTrapChart.update('none');
}

// ============================================================================
// SECTION 2: DISPLACEMENT CHART — Gas bars declining + clean coverage rising
// ============================================================================
function buildDisplacementChart() {
    var ctx = document.getElementById('displacementChart');
    if (!ctx) return;
    var d = gd(displacementISO);
    var c = ISO_CLR[displacementISO];

    displacementChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: DISPLAY_LABELS,
            datasets: [
                {
                    label: 'Gas Backup (GW)',
                    data: DISPLAY_IDXS.map(function(i) { return d.gas_backup_mw[i] / 1000; }),
                    backgroundColor: 'rgba(239,68,68,0.35)',
                    borderColor: 'rgba(239,68,68,0.6)',
                    borderWidth: 1,
                    order: 2
                },
                {
                    label: 'Clean Coverage (%)',
                    data: DISPLAY_IDXS.map(function(i) { return d.clean_coverage_pct[i]; }),
                    type: 'line',
                    yAxisID: 'y2',
                    borderColor: c,
                    backgroundColor: c + '18',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: c,
                    tension: 0.3,
                    fill: true,
                    order: 1
                }
            ]
        },
        options: chartOpts('Gas Backup (GW)', 'Clean Coverage (%)'),
        plugins: [ChartDataLabels]
    });
}

function updateDisplacementChart() {
    if (!displacementChart) return;
    var d = gd(displacementISO);
    var c = ISO_CLR[displacementISO];
    displacementChart.data.datasets[0].data = DISPLAY_IDXS.map(function(i) { return d.gas_backup_mw[i] / 1000; });
    displacementChart.data.datasets[1].data = DISPLAY_IDXS.map(function(i) { return d.clean_coverage_pct[i]; });
    displacementChart.data.datasets[1].borderColor = c;
    displacementChart.data.datasets[1].pointBackgroundColor = c;
    displacementChart.data.datasets[1].backgroundColor = c + '18';
    document.getElementById('displacementTitle').textContent = displacementISO + ': Gas Drops as Clean Firm Rises';
    displacementChart.update('none');
}

// ============================================================================
// SECTION 3: INVESTMENT CHART — All-ISO comparison: gas cost vs nuclear LCOE
// ============================================================================
function buildInvestmentChart() {
    var ctx = document.getElementById('investmentChart');
    if (!ctx) return;

    var gasTotal = ISOS.map(function(iso) { return gd(iso).gas_backup_cost[7]; });
    var newGasCost = ISOS.map(function(iso) { return gd(iso).new_gas_cost[7]; });
    var foakLCOE = ISOS.map(function(iso) { return NUCLEAR_NEWBUILD_LCOE.H[iso]; });
    var noakLCOE = ISOS.map(function(iso) { return NUCLEAR_NEWBUILD_LCOE.L[iso]; });
    var medLCOE = ISOS.map(function(iso) { return NUCLEAR_NEWBUILD_LCOE.M[iso]; });

    investmentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ISOS,
            datasets: [
                {
                    label: 'Total Gas Backup Cost',
                    data: gasTotal,
                    backgroundColor: 'rgba(239,68,68,0.55)',
                    borderColor: '#EF4444',
                    borderWidth: 1,
                    barPercentage: 0.5,
                    order: 3
                },
                {
                    label: 'New Gas Cost Only',
                    data: newGasCost,
                    backgroundColor: 'rgba(239,68,68,0.25)',
                    borderColor: 'rgba(239,68,68,0.5)',
                    borderWidth: 1,
                    borderDash: [4, 2],
                    barPercentage: 0.5,
                    order: 3
                },
                {
                    label: 'Nuclear FOAK LCOE',
                    data: foakLCOE,
                    type: 'line',
                    borderColor: 'rgba(239,68,68,0.8)',
                    borderWidth: 2,
                    borderDash: [6, 3],
                    pointRadius: 6,
                    pointBackgroundColor: '#EF4444',
                    tension: 0,
                    fill: false,
                    order: 1
                },
                {
                    label: 'Nuclear Medium LCOE',
                    data: medLCOE,
                    type: 'line',
                    borderColor: 'rgba(245,158,11,0.8)',
                    borderWidth: 2,
                    pointRadius: 6,
                    pointBackgroundColor: '#F59E0B',
                    tension: 0,
                    fill: '+1',
                    backgroundColor: 'rgba(245,158,11,0.08)',
                    order: 1
                },
                {
                    label: 'Nuclear NOAK LCOE',
                    data: noakLCOE,
                    type: 'line',
                    borderColor: 'rgba(34,197,94,0.8)',
                    borderWidth: 2,
                    pointRadius: 6,
                    pointBackgroundColor: '#22C55E',
                    tension: 0,
                    fill: false,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: 'rgba(255,255,255,0.6)', font: { size: 10 }, usePointStyle: true, padding: 10 }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.85)',
                    padding: 10,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(c) { return c.dataset.label + ': $' + c.raw.toFixed(1) + '/MWh'; }
                    }
                },
                datalabels: { display: false },
                annotation: {
                    annotations: {
                        catalyticBand: {
                            type: 'box',
                            yMin: Math.min.apply(null, noakLCOE),
                            yMax: Math.max.apply(null, foakLCOE),
                            backgroundColor: 'rgba(30,58,95,0.06)',
                            borderColor: 'rgba(30,58,95,0.12)',
                            borderWidth: 1,
                            label: {
                                display: true,
                                content: 'Catalytic Premium',
                                position: 'end',
                                font: { size: 10, style: 'italic' },
                                color: 'rgba(255,255,255,0.4)'
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 12, weight: '600' } },
                    grid: { display: false },
                    border: { color: 'rgba(255,255,255,0.15)' }
                },
                y: {
                    title: { display: true, text: '$/MWh', color: 'rgba(255,255,255,0.4)', font: { size: 10 } },
                    ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 }, callback: function(v) { return '$' + v; } },
                    grid: { color: 'rgba(255,255,255,0.06)' },
                    border: { color: 'rgba(255,255,255,0.15)' },
                    beginAtZero: true
                }
            }
        }
    });

    // Render investment narrative
    var card = document.getElementById('investmentCard');
    card.innerHTML =
        '<h3>Gas costs are permanent. Clean firm costs decline.</h3>' +
        '<p>The red bars show each ISO\'s annual gas backup cost at 90% clean — $7&ndash;10/MWh that recurs every year and grows with demand. The lines show nuclear LCOE at three price points: FOAK (red dashed), Medium (amber), and NOAK (green). The shaded band between FOAK and NOAK is the catalytic premium — the gap that early deployment closes.</p>' +
        '<p style="margin-top:10px;">At NOAK costs ($68&ndash;75/MWh), nuclear is competitive with wholesale electricity in every ISO. The only question is how quickly we get there. DOE projects ~40% cost reduction after 10&ndash;20 deployments. Geothermal is even faster — Fervo cut costs 50% in 3 years.</p>' +
        '<span class="stat-callout stat-blue">FOAK: $135&ndash;170/MWh &rarr; NOAK: $68&ndash;75/MWh &middot; ~40% decline after 10&ndash;20 builds</span>';
    card.classList.add('visible');
}

// ============================================================================
// SHARED CHART OPTIONS
// ============================================================================
function chartOpts(yTitle, y2Title, stacked) {
    return {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: {
                position: 'bottom',
                labels: { color: 'rgba(255,255,255,0.6)', font: { size: 10 }, usePointStyle: true, padding: 10 }
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.85)',
                padding: 10,
                cornerRadius: 8,
                callbacks: {
                    label: function(c) {
                        if (c.dataset.yAxisID === 'y2') return c.dataset.label + ': ' + c.raw.toFixed(1) + (y2Title.indexOf('%') >= 0 ? '%' : '');
                        return c.dataset.label + ': ' + c.raw.toFixed(1) + (yTitle.indexOf('GW') >= 0 ? ' GW' : '');
                    }
                }
            },
            datalabels: { display: false }
        },
        scales: {
            x: {
                title: { display: true, text: 'Clean Energy Threshold', color: 'rgba(255,255,255,0.4)', font: { size: 10 } },
                ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } },
                grid: { display: false },
                border: { color: 'rgba(255,255,255,0.15)' },
                stacked: !!stacked
            },
            y: {
                title: { display: true, text: yTitle, color: 'rgba(255,255,255,0.4)', font: { size: 10 } },
                ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } },
                grid: { color: 'rgba(255,255,255,0.06)' },
                border: { color: 'rgba(255,255,255,0.15)' },
                stacked: !!stacked
            },
            y2: {
                position: 'right',
                title: { display: true, text: y2Title, color: 'rgba(255,255,255,0.4)', font: { size: 10 } },
                ticks: {
                    color: 'rgba(255,255,255,0.5)',
                    font: { size: 10 },
                    callback: function(v) { return y2Title.indexOf('%') >= 0 ? v + '%' : '$' + v; }
                },
                grid: { display: false },
                border: { color: 'rgba(255,255,255,0.15)' },
                min: 0,
                max: y2Title.indexOf('%') >= 0 ? 100 : undefined
            }
        }
    };
}

// ============================================================================
// ISO SELECTOR WIRING
// ============================================================================
function wireISOSelector(containerId, updateFn, narrativeFn) {
    document.querySelectorAll('#' + containerId + ' .iso-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#' + containerId + ' .iso-btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            var iso = this.getAttribute('data-iso');
            updateFn(iso);
            narrativeFn(iso);
        });
    });
}

// ============================================================================
// SCROLL ANIMATIONS
// ============================================================================
function initFadeIn() {
    var obs = new IntersectionObserver(function(entries) {
        entries.forEach(function(e) {
            if (e.isIntersecting) e.target.classList.add('visible');
        });
    }, { threshold: 0.15, rootMargin: '0px 0px -50px 0px' });
    document.querySelectorAll('.narrative-card, .synthesis-card').forEach(function(el) { obs.observe(el); });
}

// ============================================================================
// ANIMATED COUNTERS
// ============================================================================
function animateCounter(el, target, prefix, suffix) {
    var duration = 1200;
    var start = performance.now();
    function step(ts) {
        var p = Math.min((ts - start) / duration, 1);
        var eased = 1 - Math.pow(1 - p, 3);
        el.textContent = prefix + Math.round(target * eased) + suffix;
        if (p < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

// ============================================================================
// INIT
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    // Compute hero counters from data
    var totalNewGas = 0;
    var totalAnnualCost = 0;
    ISOS.forEach(function(iso) {
        totalNewGas += gd(iso).new_gas_build_mw[7];
        totalAnnualCost += gd(iso).new_gas_cost[7] * REGIONAL_DEMAND_TWH[iso];
    });
    var newGasGW = Math.round(totalNewGas / 1000);
    var annualCostB = Math.round(totalAnnualCost / 1000);

    // Animate counters
    animateCounter(document.getElementById('ctrNewGas'), newGasGW, '', '');
    animateCounter(document.getElementById('ctrAnnualCost'), annualCostB, '$', 'B');

    // Build charts
    buildHeroChart();

    // Lazy-build section charts when they scroll into view
    var chartObs = new IntersectionObserver(function(entries) {
        entries.forEach(function(e) {
            if (!e.isIntersecting) return;
            var id = e.target.id;
            if (id === 'gasTrapChart' && !gasTrapChart) {
                buildGasTrapChart();
                renderNarrative('gasTrapCard', GAS_TRAP_TEXT, gasTrapISO);
            }
            if (id === 'displacementChart' && !displacementChart) {
                buildDisplacementChart();
                renderNarrative('displacementCard', DISPLACEMENT_TEXT, displacementISO);
            }
            if (id === 'investmentChart' && !investmentChart) {
                buildInvestmentChart();
            }
            chartObs.unobserve(e.target);
        });
    }, { threshold: 0.05, rootMargin: '200px' });

    ['gasTrapChart', 'displacementChart', 'investmentChart'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) chartObs.observe(el);
    });

    // Wire ISO selectors
    wireISOSelector('gasTrapISO', function(iso) {
        gasTrapISO = iso;
        updateGasTrapChart();
    }, function(iso) {
        renderNarrative('gasTrapCard', GAS_TRAP_TEXT, iso);
    });

    wireISOSelector('displacementISO', function(iso) {
        displacementISO = iso;
        updateDisplacementChart();
    }, function(iso) {
        renderNarrative('displacementCard', DISPLACEMENT_TEXT, iso);
    });

    // Scroll fade-in
    initFadeIn();
});
</script>
</body>
</html>
