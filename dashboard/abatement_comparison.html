<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The 8,760 Problem — Marginal Carbon Abatement Analysis</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
@font-face {
    font-family: 'Franklin Gothic Demi';
    src: local('Franklin Gothic Demi'), local('Franklin Gothic Medium'), local('ITC Franklin Gothic Demi');
    font-weight: 600; font-style: normal; font-display: swap;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 17px; -webkit-font-smoothing: antialiased; scroll-behavior: smooth; }
body {
    font-family: 'Plus Jakarta Sans', 'Helvetica Neue', Arial, sans-serif;
    background: #F3F4F8; color: #1A1A1A; line-height: 1.6; min-height: 100vh;
}
:root {
    --navy: #1A2744; --navy-light: #2D3A52;
    --accent-blue: #4a90d9; --accent-warm: #f4a261;
    --bg-card: #FFFFFF; --border: #D4D8E0; --text-muted: #6B7280;
}

/* ===== HEADER ===== */
.header {
    background: linear-gradient(135deg, #0F1A2E 0%, #122952 30%, #1565C0 70%, #0D47A1 100%);
    color: #fff; padding: 72px 24px 64px; text-align: center; position: relative; overflow: hidden;
}
.header::after {
    content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 4px;
    background: linear-gradient(90deg, #1A2744, #0EA5E9, #22C55E, #F59E0B, #EF4444);
}
.header h1 {
    font-family: 'Franklin Gothic Demi', 'Lexend', sans-serif;
    font-size: 3rem; font-weight: 700; margin-bottom: 14px; position: relative; z-index: 2;
    text-shadow: 0 2px 20px rgba(0,0,0,0.5);
}
.header .subtitle {
    font-size: 1.1rem; opacity: 0.92; max-width: 660px; margin: 0 auto;
    position: relative; z-index: 2;
}

/* ===== LAYOUT ===== */
.page-wrap { max-width: 960px; margin: 0 auto; padding: 0 24px; }
section { padding: 48px 0 32px; }
section + section { border-top: 1px solid var(--border); }
h2 {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 1.8rem; color: var(--navy); margin-bottom: 12px; letter-spacing: -0.3px;
}
h3 {
    font-family: 'Franklin Gothic Demi', sans-serif;
    font-size: 1.15rem; color: var(--navy); margin-bottom: 8px;
}
.section-num {
    display: inline-block; font-size: 0.78rem; font-weight: 700; color: #0EA5E9;
    letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 6px;
}
p { margin-bottom: 14px; font-size: 0.93rem; line-height: 1.7; }
p:last-child { margin-bottom: 0; }

/* ===== CHART CONTAINERS ===== */
.chart-wrap {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px; margin: 24px 0; position: relative;
}
.chart-wrap canvas { width: 100% !important; }
.chart-title {
    font-family: 'Franklin Gothic Demi', sans-serif; font-size: 1rem;
    color: var(--navy); margin-bottom: 12px;
}

/* ===== COUNTER ROW ===== */
.counter-row { display: flex; gap: 16px; margin: 24px 0; flex-wrap: wrap; }
.counter-item {
    flex: 1; min-width: 140px; background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 18px 16px; text-align: center;
}
.counter-val {
    font-family: 'Barlow Semi Condensed', sans-serif; font-size: 2rem;
    font-weight: 800; color: var(--navy);
}
.counter-label { font-size: 0.78rem; color: var(--text-muted); margin-top: 4px; line-height: 1.4; }

/* ===== REGION CARDS ===== */
.region-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin: 20px 0; }
.region-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
    padding: 18px; border-top: 4px solid #ccc;
}
.region-card-head {
    display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
}
.region-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
.region-name { font-family: 'Franklin Gothic Demi', sans-serif; font-weight: 700; font-size: 0.95rem; }
.region-mac99 { font-family: 'Barlow Semi Condensed', sans-serif; font-size: 1.3rem; font-weight: 800; margin-left: auto; }
.region-card p { font-size: 0.84rem; line-height: 1.55; }

/* ===== CALLOUT ===== */
.callout {
    background: rgba(14,165,233,0.06); border: 1px solid rgba(14,165,233,0.15);
    border-radius: 12px; padding: 18px 20px; margin: 20px 0; font-size: 0.9rem;
}
.callout-warn {
    background: rgba(245,158,11,0.06); border-color: rgba(245,158,11,0.2);
}

/* ===== TABLE ===== */
.inflection-wrap { overflow-x: auto; margin: 20px 0; }
.inflection-table {
    width: 100%; border-collapse: collapse; font-size: 0.85rem;
    background: var(--navy); color: #fff; border-radius: 10px; overflow: hidden;
}
.inflection-table th {
    padding: 12px 10px; font-weight: 600; font-size: 0.8rem;
    border-bottom: 1px solid rgba(255,255,255,0.15); text-align: center;
}
.inflection-table td {
    padding: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.08);
    font-weight: 600;
}
.cell-green { color: #4ADE80; }
.cell-orange { color: #FBBF24; }
.cell-red { color: #F87171; }

/* ===== FOOTER ===== */
.page-footer {
    background: var(--navy); color: rgba(255,255,255,0.6); text-align: center;
    padding: 32px 24px; font-size: 0.82rem;
}
.page-footer a { color: rgba(255,255,255,0.7); text-decoration: none; margin: 0 12px; }
.page-footer a:hover { color: #fff; }

/* ===== MOBILE ===== */
@media (max-width: 768px) {
    .header h1 { font-size: 2rem; }
    .page-wrap { padding: 0 16px; }
    h2 { font-size: 1.4rem; }
    .counter-row { flex-direction: column; }
    .chart-wrap { padding: 14px; }
}
</style>
</head>
<body>

<nav id="topNav"></nav>
<script src="js/nav.js"></script>

<!-- HEADER -->
<header class="header">
    <h1>Marginal Carbon Abatement</h1>
    <p class="subtitle">Where grid decarbonization beats alternatives — and where it doesn't.</p>
</header>

<div id="scrollProgress" style="position:fixed;top:0;left:0;height:3px;background:linear-gradient(90deg,var(--accent-blue),#22C55E);width:0%;z-index:10001;transition:width 0.1s linear;"></div>

<main class="page-wrap">

<!-- ============================================================ -->
<!-- SECTION 1: KEY METRICS (all dynamic) -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Overview</span>
    <h2>The Cost Envelope: Grid Abatement at a Glance</h2>
    <p id="introNarrative"></p>
    <div class="counter-row" id="keyCounters"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 2: MAC ENVELOPE + FAN CHART -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 1</span>
    <h2>Average MAC with Uncertainty Bands</h2>
    <p>The bold lines show the monotonic cost envelope (Medium scenario). Shaded bands show P10–P90
       uncertainty across 324 cost scenarios. Where bands are wide, cost assumptions drive outcomes.</p>
    <div class="chart-wrap" style="height: 420px;">
        <div class="chart-title">Average Abatement Cost Envelope ($/ton CO₂) — P10/P90 Uncertainty</div>
        <canvas id="envelopeChart"></canvas>
    </div>
    <div class="callout" id="envelopeInsight"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 3: STEPWISE MARGINAL MAC -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 2</span>
    <h2>Stepwise Marginal MAC: Where Grid Investment Stops Paying Off</h2>
    <p>Each bar shows the marginal cost of the next threshold step. Horizontal lines mark key
       benchmarks. When a bar exceeds a benchmark, consider investing in that alternative instead.</p>
    <div class="chart-wrap" style="height: 440px;">
        <div class="chart-title">Stepwise Marginal Abatement Cost by Region ($/ton CO₂)</div>
        <canvas id="marginalChart"></canvas>
    </div>
    <div class="callout" id="marginalInsight"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 4: ABATEMENT LADDER -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 3</span>
    <h2>The Abatement Cost Ladder</h2>
    <p>Grid decarbonization costs compared to alternative pathways. Dashed vertical lines show
       regional average MAC at key thresholds. DAC costs reflect 2040–2045 projections.</p>
    <div class="chart-wrap" style="height: 420px;">
        <div class="chart-title">Abatement Cost Ladder: Grid vs. Alternatives ($/ton CO₂)</div>
        <canvas id="ladderChart"></canvas>
    </div>
    <div class="callout callout-warn">
        <strong>Not apples-to-apples.</strong> Grid decarbonization avoids emissions in real-time. DAC permanently
        removes CO₂ but at higher cost today. SAF reduces hard-to-abate aviation emissions. Each pathway has a
        different role — the question is the right mix at the right price.
    </div>
</section>

<!-- ============================================================ -->
<!-- SECTION 5: REGIONAL CARDS -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 4</span>
    <h2>Regional Crossover Stories</h2>
    <p>Each region's grid has a unique cost profile shaped by resource quality, siting constraints,
       and existing clean energy mix.</p>
    <div class="region-cards" id="regionCards"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 6: INFLECTION TABLE -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 5</span>
    <h2>Inflection Points: Where Grid Costs Exceed Key Benchmarks</h2>
    <p>Marginal MAC crossovers — the threshold step where the next increment of grid investment
       exceeds each benchmark. Green = competitive through 99%+, orange = moderate, red = early crossover.</p>
    <div class="inflection-wrap">
        <table class="inflection-table" id="inflectionTable">
            <thead><tr id="inflectionHead"></tr></thead>
            <tbody id="inflectionBody"></tbody>
        </table>
    </div>
    <div class="counter-row" id="inflectionStats"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 7: ANOVA DECOMPOSITION -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 6</span>
    <h2>What Drives MAC Uncertainty?</h2>
    <p>ANOVA decomposition shows which cost toggle group drives the most variance in MAC
       across 324 scenarios. This tells procurement teams which assumptions to stress-test.</p>
    <div class="chart-wrap" style="height: 360px;">
        <div class="chart-title">MAC Variance Attribution by Toggle Group (η² — ANOVA)</div>
        <canvas id="anovaChart"></canvas>
    </div>
    <div class="callout" id="anovaInsight"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 8: PORTFOLIO -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 7</span>
    <h2>The Case for Portfolio Decarbonization</h2>
    <div id="portfolioNarrative"></div>
</section>

<!-- SOURCES -->
<section style="padding-bottom: 48px;">
    <h3 style="margin-bottom: 12px;">Sources</h3>
    <ol style="font-size: 0.82rem; color: var(--text-muted); line-height: 1.8; padding-left: 20px;">
        <li>EPA eGRID 2022 — regional emission rates, generation mix.</li>
        <li>EPA Social Cost of Carbon — Technical Support Document (2023), central estimate $190/ton.</li>
        <li>Rennert, K. et al. (2022). "Comprehensive evidence implies a higher social cost of CO₂." <em>Nature</em>, 610, 687-692.</li>
        <li>EU Emissions Trading System (EU ETS) — $65-92/ton (2024-2025 trading range).</li>
        <li>NREL Annual Technology Baseline (ATB) 2024.</li>
        <li>Lazard LCOE v17.0 (2024).</li>
        <li>EIA Hourly Electric Grid Monitor.</li>
        <li>IEAGHG — Global Assessment of DAC Costs (NOAK projections, 2024).</li>
        <li>Sievert, McQueen et al. (Joule, 2024) — DAC technology cost projections.</li>
        <li>DOE Carbon Negative Shot — $100/ton aspirational target.</li>
    </ol>
</section>

</main>

<footer class="page-footer">
    <div>
        <a href="index.html">Home</a>
        <a href="dashboard.html">Cost Optimizer</a>
        <a href="abatement_dashboard.html">Abatement Dashboard</a>
        <a href="region_deepdive.html">Regional Deep Dives</a>
        <a href="research_paper.html">Paper</a>
    </div>
    <div style="margin-top: 12px;">The 8,760 Problem — 2025 Snapshot Model</div>
</footer>

<!-- ================================================================== -->
<!-- DATA + CHARTS — everything computed from shared-data.js constants -->
<!-- ================================================================== -->
<script src="js/shared-data.js"></script>
<script src="js/mac-stats-data.js"></script>
<script>
'use strict';
// Globals
const REGIONS = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
const STEP_LABELS = ['75→80','80→85','85→87.5','87.5→90','90→92.5','92.5→95','95→97.5','97.5→99'];
const REGION_CLR = REGION_COLORS; // from shared-data.js

// Helpers
function $(id) { return document.getElementById(id); }
function txt(id, v) { const el = $(id); if (el) el.textContent = v; }
function html(id, v) { const el = $(id); if (el) el.innerHTML = v; }

// ---- Derived data ----
const mac = MAC_DATA.medium;
const marg = MARGINAL_MAC_DATA.medium;

// All marginal values (non-null, positive)
const allMarg = [];
REGIONS.forEach(r => {
    for (let i = 1; i < marg[r].length; i++) {
        if (marg[r][i] != null && marg[r][i] > 0)
            allMarg.push({ val: marg[r][i], iso: r, idx: i });
    }
});
const margMin = allMarg.reduce((a, b) => a.val < b.val ? a : b);
const margMax = allMarg.reduce((a, b) => a.val > b.val ? a : b);

const mac99 = REGIONS.map(r => mac[r][8]);
const mac75 = REGIONS.map(r => mac[r][0]);
const cheapestISO = REGIONS[mac99.indexOf(Math.min(...mac99))];
const highestISO  = REGIONS[mac99.indexOf(Math.max(...mac99))];

const dacMed = BENCHMARKS_DYNAMIC.dac.Medium;
const dacLow = BENCHMARKS_DYNAMIC.dac.Low;
const dacHigh = BENCHMARKS_DYNAMIC.dac.High;
const dacThreshold = dacMed.mid; // $250/ton for 2040-2045

const regionsExceedingDAC = REGIONS.filter(r =>
    marg[r].some((v, i) => i > 0 && v != null && v >= dacThreshold)
).length;

// ============================================================================
// 1. INTRO NARRATIVE + KEY COUNTERS
// ============================================================================
html('introNarrative',
    `Average abatement costs range from <strong>$${Math.min(...mac75)}–${Math.max(...mac99)}/ton</strong> ` +
    `across all five ISOs through 99% hourly matching — well below the social cost of carbon ($190/ton). ` +
    `But the <strong>marginal</strong> MAC reveals critical decision boundaries: individual threshold steps ` +
    `range from $${margMin.val}/ton (${margMin.iso} ${STEP_LABELS[margMin.idx - 1]}) to ` +
    `$${margMax.val}/ton (${margMax.iso} ${STEP_LABELS[margMax.idx - 1]}). ` +
    `${regionsExceedingDAC} region${regionsExceedingDAC !== 1 ? 's have' : ' has'} at least one step ` +
    `exceeding projected DAC costs ($${dacMed.mid}/ton by 2040–2045).`
);

html('keyCounters',
    `<div class="counter-item">` +
    `  <div class="counter-val">$${margMax.val}</div>` +
    `  <div class="counter-label">Max marginal MAC/ton<br>${margMax.iso} ${STEP_LABELS[margMax.idx - 1]}</div>` +
    `</div>` +
    `<div class="counter-item">` +
    `  <div class="counter-val">$${margMin.val}</div>` +
    `  <div class="counter-label">Min marginal MAC/ton<br>${margMin.iso} ${STEP_LABELS[margMin.idx - 1]}</div>` +
    `</div>` +
    `<div class="counter-item">` +
    `  <div class="counter-val">${regionsExceedingDAC}</div>` +
    `  <div class="counter-label">Regions with steps<br>exceeding DAC ($${dacMed.mid}+)</div>` +
    `</div>` +
    `<div class="counter-item">` +
    `  <div class="counter-val">$${Math.min(...mac99)}</div>` +
    `  <div class="counter-label">${cheapestISO} avg MAC<br>at 99% (cheapest)</div>` +
    `</div>`
);

// ============================================================================
// 2. ENVELOPE + FAN CHART
// ============================================================================
(function buildEnvelopeChart() {
    const ctx = $('envelopeChart')?.getContext('2d');
    if (!ctx) return;
    const thresholds = THRESHOLDS.slice(0, 9); // exclude 100%
    const datasets = [];

    REGIONS.forEach(iso => {
        const env = MAC_ENVELOPE_DATA?.[iso]?.envelope;
        const fan = MAC_FAN_DATA?.[iso];
        if (!fan) return;

        // P10-P90 fill
        const p90 = fan.p90.slice(0, 9).map((v, i) => ({ x: thresholds[i], y: v }));
        const p10 = fan.p10.slice(0, 9).map((v, i) => ({ x: thresholds[i], y: v }));
        datasets.push({
            label: iso + ' P90', data: p90,
            borderColor: 'transparent', backgroundColor: REGION_CLR[iso] + '18',
            borderWidth: 0, pointRadius: 0, fill: '+1', tension: 0.3, order: 3
        });
        datasets.push({
            label: iso + ' P10', data: p10,
            borderColor: REGION_CLR[iso] + '44', backgroundColor: 'transparent',
            borderWidth: 1, borderDash: [3, 3], pointRadius: 0, fill: false, tension: 0.3, order: 3
        });

        // Envelope (bold)
        const envData = (env || fan.p50).slice(0, 9).map((v, i) => ({ x: thresholds[i], y: v }));
        datasets.push({
            label: iso, data: envData,
            borderColor: REGION_CLR[iso], backgroundColor: REGION_CLR[iso] + '18',
            borderWidth: 2.5, pointRadius: 3, pointHoverRadius: 6,
            fill: false, tension: 0.3, order: 1
        });
    });

    new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: false },
            scales: {
                x: {
                    type: 'linear', min: 74, max: 100,
                    title: { display: true, text: 'Hourly Clean Energy Target (%)', font: { size: 13, weight: 600 } },
                    ticks: { stepSize: 5, callback: v => v + '%' },
                    grid: { display: false }
                },
                y: {
                    min: 0, max: 200,
                    title: { display: true, text: 'Average MAC ($/ton CO₂)', font: { size: 13, weight: 600 } },
                    ticks: { callback: v => '$' + v },
                    grid: { display: false }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        filter: item => !item.text.includes('P90') && !item.text.includes('P10'),
                        usePointStyle: true, pointStyle: 'circle', padding: 16, font: { size: 12, weight: 600 }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: items => items[0].raw.x + '% Target',
                        label: item => {
                            if (item.dataset.label.includes('P')) return null;
                            return item.dataset.label + ': $' + Math.round(item.raw.y) + '/ton';
                        }
                    }
                },
                annotation: {
                    annotations: {
                        scc: { type: 'line', yMin: 190, yMax: 190, borderColor: '#FF9800', borderWidth: 1.5, borderDash: [6, 4],
                            label: { display: true, content: 'SCC ($190/ton)', position: 'start', font: { size: 10 }, color: '#FF9800', backgroundColor: 'rgba(255,255,255,0.85)', padding: 3 }
                        },
                        euEts: { type: 'box', yMin: 65, yMax: 92, backgroundColor: 'rgba(33,150,243,0.06)', borderColor: 'rgba(33,150,243,0.2)', borderWidth: 1,
                            label: { display: true, content: 'EU ETS ($65-92)', position: 'end', font: { size: 10 }, color: '#2196F3', backgroundColor: 'rgba(255,255,255,0.85)', padding: 3 }
                        }
                    }
                },
                datalabels: { display: false }
            }
        }
    });

    // Insight callout
    const p10min = Math.round(Math.min(...REGIONS.map(r => Math.min(...MAC_FAN_DATA[r].p10.filter(v => v != null)))));
    const p90max = Math.round(Math.max(...REGIONS.map(r => Math.max(...MAC_FAN_DATA[r].p90.filter(v => v != null)))));
    html('envelopeInsight',
        `<strong>The envelope tells the story:</strong> Under Medium cost assumptions, no region's average MAC ` +
        `exceeds $${Math.max(...mac99)}/ton through 99%. The P10–P90 uncertainty band spans ` +
        `$${p10min}–${p90max}/ton — driven primarily by ` +
        `${Math.round(MAC_ANOVA.ERCOT['Renewable Gen'] * 100)}% renewable costs in ERCOT and ` +
        `${Math.round(MAC_ANOVA.NYISO['Firm Gen'] * 100)}% firm generation costs in NYISO.`
    );
})();

// ============================================================================
// 3. STEPWISE MARGINAL MAC CHART
// ============================================================================
(function buildMarginalChart() {
    const ctx = $('marginalChart')?.getContext('2d');
    if (!ctx) return;

    const datasets = REGIONS.map(iso => ({
        label: iso,
        data: STEP_LABELS.map((_, si) => {
            const val = marg[iso][si + 1];
            return (val != null && val > 0) ? Math.min(val, 1000) : null;
        }),
        backgroundColor: REGION_CLR[iso] + 'CC',
        borderColor: REGION_CLR[iso], borderWidth: 1,
        barPercentage: 0.85, categoryPercentage: 0.82
    }));

    new Chart(ctx, {
        type: 'bar',
        data: { labels: STEP_LABELS, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { font: { size: 12 }, padding: 16, usePointStyle: true, pointStyle: 'rect' } },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const raw = marg[ctx.dataset.label][ctx.dataIndex + 1];
                            if (raw == null) return ctx.dataset.label + ': CO₂ decreased';
                            return ctx.dataset.label + ': $' + raw.toLocaleString() + '/ton';
                        }
                    }
                },
                annotation: {
                    annotations: {
                        scc: { type: 'line', yMin: 190, yMax: 190, borderColor: '#FF9800', borderWidth: 2, borderDash: [8, 4],
                            label: { display: true, content: 'SCC ($190)', position: 'start', backgroundColor: '#FF9800', color: '#fff', font: { size: 11 }, padding: 4 }
                        },
                        dacMid: { type: 'line', yMin: dacMed.mid, yMax: dacMed.mid, borderColor: '#E91E63', borderWidth: 2, borderDash: [8, 4],
                            label: { display: true, content: 'DAC 2040 ($' + dacMed.mid + ')', position: 'start', backgroundColor: '#E91E63', color: '#fff', font: { size: 11 }, padding: 4 }
                        },
                        dacHigh: { type: 'line', yMin: dacHigh.mid, yMax: dacHigh.mid, borderColor: '#9C27B0', borderWidth: 1.5, borderDash: [6, 4],
                            label: { display: true, content: 'DAC High ($' + dacHigh.mid + ')', position: 'end', backgroundColor: '#9C27B0', color: '#fff', font: { size: 10 }, padding: 3 }
                        },
                        euEts: { type: 'line', yMin: 88, yMax: 88, borderColor: '#2196F3', borderWidth: 1.5, borderDash: [6, 4],
                            label: { display: true, content: 'EU ETS ($88)', position: 'end', backgroundColor: '#2196F3', color: '#fff', font: { size: 10 }, padding: 3 }
                        }
                    }
                },
                datalabels: { display: false }
            },
            scales: {
                y: { beginAtZero: true, max: 800, title: { display: true, text: 'Marginal MAC ($/ton CO₂)', font: { size: 13 } },
                    ticks: { callback: v => '$' + v, stepSize: 100 } },
                x: { title: { display: true, text: 'CFE Matching Step (%)', font: { size: 13 } } }
            }
        }
    });

    // Compute zone insights dynamically
    const effZone = [], volZone = [];
    REGIONS.forEach(r => {
        for (let i = 1; i <= 4; i++) if (marg[r][i] != null && marg[r][i] > 0) effZone.push(marg[r][i]);
        for (let i = 5; i <= 7; i++) if (marg[r][i] != null && marg[r][i] > 0) volZone.push(marg[r][i]);
    });
    html('marginalInsight',
        `<strong>Three zones emerge:</strong> ` +
        `<strong>Efficient (75–90%):</strong> Marginal MAC stays under $${Math.max(...effZone)}/ton. ` +
        `<strong>Volatile (90–97.5%):</strong> Swings from $${Math.min(...volZone)} to $${Math.max(...volZone)}/ton. ` +
        `<strong>Diminishing (&gt;97.5%):</strong> Some regions see CO₂ decrease (resource mix shifts prioritize matching over abatement). ` +
        `The grid backbone holds through ~90% everywhere. Beyond that, strategy is region-specific.`
    );
})();

// ============================================================================
// 4. ABATEMENT LADDER (horizontal bar chart)
// ============================================================================
(function buildLadderChart() {
    const ctx = $('ladderChart')?.getContext('2d');
    if (!ctx) return;

    const benchmarks = getAllBenchmarks();
    const labels = benchmarks.map(b => b.short || b.name);
    const barData = benchmarks.map(b => [Math.max(b.low, 0), b.high]);
    const midPoints = benchmarks.map(b => b.mid);
    const bgColors = benchmarks.map(b => b.color + '40');
    const borderColors = benchmarks.map(b => b.color);

    // Grid reference lines from MAC data
    const i90 = THRESHOLDS.indexOf(90), i95 = THRESHOLDS.indexOf(95), i99 = THRESHOLDS.indexOf(99);
    const annotations = {};
    [{iso:'ERCOT',t:90,i:i90},{iso:'ERCOT',t:95,i:i95},{iso:'ERCOT',t:99,i:i99},
     {iso:'NYISO',t:90,i:i90},{iso:'NYISO',t:99,i:i99}].forEach((m, idx) => {
        const cost = mac[m.iso][m.i];
        annotations['g' + idx] = {
            type: 'line', xMin: cost, xMax: cost,
            borderColor: REGION_CLR[m.iso] + 'aa', borderWidth: 2, borderDash: [4, 3],
            label: { display: true, content: m.iso + ' ' + m.t + '%', position: idx % 2 === 0 ? 'start' : 'end',
                font: { size: 9 }, color: REGION_CLR[m.iso], backgroundColor: 'rgba(255,255,255,0.9)', padding: 2 }
        };
    });

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'Cost Range', data: barData, backgroundColor: bgColors, borderColor: borderColors,
                    borderWidth: 2, borderRadius: 6, borderSkipped: false, barPercentage: 0.65 },
                { label: 'Mid Estimate', data: midPoints, type: 'scatter', pointRadius: 7, pointStyle: 'rectRounded',
                    backgroundColor: borderColors.map(c => c + 'cc'), borderColor: borderColors, borderWidth: 2 }
            ]
        },
        options: {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            scales: {
                x: { min: 0, max: 650, title: { display: true, text: '$/ton CO₂', font: { size: 13 } },
                    ticks: { stepSize: 50, callback: v => '$' + v }, grid: { display: false } },
                y: { ticks: { font: { size: 11, weight: 500 } }, grid: { display: false } }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => Array.isArray(ctx.raw) ? `Range: $${ctx.raw[0]}–$${ctx.raw[1]}/ton` : `Mid: $${ctx.raw}/ton`
                    }
                },
                annotation: { annotations },
                datalabels: { display: false }
            }
        }
    });
})();

// ============================================================================
// 5. REGIONAL CARDS (fully dynamic)
// ============================================================================
(function buildRegionCards() {
    const container = $('regionCards');
    if (!container) return;

    const colors = { CAISO: '#F59E0B', ERCOT: '#22C55E', PJM: '#4a90d9', NYISO: '#E91E63', NEISO: '#9C27B0' };
    const names = { CAISO: 'CAISO (California)', ERCOT: 'ERCOT (Texas)', PJM: 'PJM (Mid-Atlantic)',
                    NYISO: 'NYISO (New York)', NEISO: 'NEISO (New England)' };
    const stories = {
        CAISO: 'Solar abundance keeps early costs low. Solar saturation above 93% drives battery/LDES overbuilding.',
        ERCOT: 'The cost leader. Cheap wind ($40/MWh), Gulf Coast CCS geology, and fast permitting.',
        PJM:   'Coal-heavy grid = more CO₂ displaced per clean MWh. Cheapest per-ton abatement.',
        NYISO: 'Strong nuclear+hydro base, but constrained siting and no CCS geology drive high marginal costs.',
        NEISO: 'Most volatile curve. Offshore wind potential is high but uncertain. Nuclear base helps early.'
    };

    container.innerHTML = REGIONS.map(iso => {
        const c = colors[iso];
        const steps = [];
        for (let i = 1; i < marg[iso].length; i++) {
            if (marg[iso][i] != null && marg[iso][i] > 0) steps.push({ val: marg[iso][i], idx: i });
        }
        const minS = steps.reduce((a, b) => a.val < b.val ? a : b, steps[0]);
        const maxS = steps.reduce((a, b) => a.val > b.val ? a : b, steps[0]);
        const dacSteps = steps.filter(s => s.val >= dacThreshold).length;

        // ANOVA top driver
        let topDriver = '', topPct = 0;
        if (typeof MAC_ANOVA !== 'undefined' && MAC_ANOVA[iso]) {
            const sorted = Object.entries(MAC_ANOVA[iso]).sort((a, b) => b[1] - a[1]);
            topDriver = sorted[0][0]; topPct = Math.round(sorted[0][1] * 100);
        }

        return `<div class="region-card" style="border-top-color:${c}">` +
            `<div class="region-card-head">` +
            `  <span class="region-dot" style="background:${c}"></span>` +
            `  <span class="region-name">${names[iso]}</span>` +
            `  <span class="region-mac99" style="color:${c}">$${mac[iso][8]}/ton</span>` +
            `</div>` +
            `<p>Average MAC: $${mac[iso][0]}–${mac[iso][8]}/ton (75–99%). ` +
            `Marginal range: $${minS.val}/ton (${STEP_LABELS[minS.idx - 1]}) to ` +
            `$${maxS.val}/ton (${STEP_LABELS[maxS.idx - 1]}). ` +
            `${dacSteps > 0 ? dacSteps + ' step' + (dacSteps > 1 ? 's' : '') + ' exceed DAC.' : 'No steps exceed DAC.'} ` +
            `${topDriver ? topDriver + ' drives ' + topPct + '% of variance.' : ''}</p>` +
            `<p>${stories[iso]}</p>` +
            `</div>`;
    }).join('');
})();

// ============================================================================
// 6. INFLECTION TABLE (fully dynamic)
// ============================================================================
(function buildInflectionTable() {
    const headEl = $('inflectionHead');
    const bodyEl = $('inflectionBody');
    const statsEl = $('inflectionStats');
    if (!headEl || !bodyEl) return;

    const benchmarks = [
        { name: 'EU ETS', val: 88 },
        { name: 'SCC (EPA)', val: 190 },
        { name: 'SCC (Rennert)', val: 185 },
        { name: 'DAC 2040 Med', val: dacMed.mid },
        { name: 'DAC 2040 High', val: dacHigh.mid }
    ];

    headEl.innerHTML = '<th>Region</th>' + benchmarks.map(b =>
        `<th>${b.name}<br>($${b.val}/ton)</th>`
    ).join('');

    bodyEl.innerHTML = REGIONS.map(iso => {
        const cells = benchmarks.map(b => {
            const xo = findCrossover(mac[iso], b.val);
            const cls = xo === '>100' ? 'cell-green' : parseInt(xo) >= 95 ? 'cell-green' :
                parseInt(xo) >= 90 ? 'cell-orange' : 'cell-red';
            return `<td class="${cls}">${xo === '>100' ? '>99%' : xo + '%'}</td>`;
        });
        return `<tr><td style="font-weight:700;text-align:left;padding-left:14px;">${iso}</td>${cells.join('')}</tr>`;
    }).join('');

    // Stats row
    if (statsEl) {
        statsEl.innerHTML =
            `<div class="counter-item">` +
            `  <div class="counter-val" style="color:#4ADE80;">&gt;99%</div>` +
            `  <div class="counter-label">All regions stay below<br>DAC 2040 avg cost</div>` +
            `</div>` +
            `<div class="counter-item">` +
            `  <div class="counter-val">$${mac[cheapestISO][8]}</div>` +
            `  <div class="counter-label">${cheapestISO} avg MAC at 99%<br>(cheapest region)</div>` +
            `</div>` +
            `<div class="counter-item">` +
            `  <div class="counter-val">$${mac[highestISO][8]}</div>` +
            `  <div class="counter-label">${highestISO} avg MAC at 99%<br>(highest region)</div>` +
            `</div>`;
    }
})();

// ============================================================================
// 7. ANOVA CHART
// ============================================================================
(function buildAnovaChart() {
    const ctx = $('anovaChart')?.getContext('2d');
    if (!ctx || typeof MAC_ANOVA === 'undefined') return;

    const toggles = ['Renewable Gen', 'Firm Gen', 'Storage', 'Fossil Fuel', 'Transmission'];
    const toggleColors = ['#22C55E', '#1E3A5F', '#8B5CF6', '#FF5722', '#0EA5E9'];

    const datasets = toggles.map((tg, ti) => ({
        label: tg,
        data: REGIONS.map(r => Math.round((MAC_ANOVA[r]?.[tg] || 0) * 100)),
        backgroundColor: toggleColors[ti] + 'CC',
        borderColor: toggleColors[ti], borderWidth: 1,
        barPercentage: 0.8, categoryPercentage: 0.82
    }));

    new Chart(ctx, {
        type: 'bar',
        data: { labels: REGIONS, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { font: { size: 11 }, padding: 14, usePointStyle: true, pointStyle: 'rect' } },
                tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw + '% of variance' } },
                datalabels: { display: false }
            },
            scales: {
                y: { beginAtZero: true, max: 70, title: { display: true, text: 'Variance Explained (η²%)', font: { size: 13 } },
                    ticks: { callback: v => v + '%' } },
                x: { ticks: { font: { size: 12, weight: 600 } } }
            }
        }
    });

    // Insight
    const ercotRenew = Math.round(MAC_ANOVA.ERCOT['Renewable Gen'] * 100);
    const nyisoFirm = Math.round(MAC_ANOVA.NYISO['Firm Gen'] * 100);
    html('anovaInsight',
        `<strong>Key finding:</strong> MAC uncertainty is driven by different factors in each region. ` +
        `ERCOT's costs are ${ercotRenew}% driven by renewable costs (cheap wind). ` +
        `NYISO's are ${nyisoFirm}% driven by firm generation costs (expensive nuclear). ` +
        `Storage contributes &lt;2% of variance everywhere — it's a small share of total cost.`
    );
})();

// ============================================================================
// 8. PORTFOLIO NARRATIVE (dynamic)
// ============================================================================
(function buildPortfolio() {
    const n = $('portfolioNarrative');
    if (!n) return;

    // Find efficient inflection per region
    const inflections = {};
    REGIONS.forEach(r => {
        for (let i = 1; i < marg[r].length; i++) {
            if (marg[r][i] != null && marg[r][i] >= dacThreshold) {
                inflections[r] = THRESHOLDS[i - 1];
                return;
            }
        }
        inflections[r] = '>99';
    });

    const minInf = Math.min(...Object.values(inflections).filter(v => typeof v === 'number'));
    const maxInf = Math.max(...Object.values(inflections).filter(v => typeof v === 'number'));

    n.innerHTML =
        `<p>Push the grid backbone as far as it's efficient, then diversify. The optimal pivot point — where ` +
        `marginal grid cost exceeds DAC ($${dacMed.mid}/ton, 2040–2045 projection) — ranges from ` +
        `<strong>${minInf}% to ${maxInf === Infinity ? '>99' : maxInf}%</strong> depending on region.</p>` +

        `<div class="callout" style="margin: 20px 0;">` +
        `<strong>Regional inflection points (marginal MAC &gt; DAC $${dacMed.mid}/ton):</strong><br>` +
        REGIONS.map(r => `${r}: <strong>${inflections[r]}%</strong>`).join(' · ') +
        `</div>` +

        `<p><strong>The bottom line:</strong> Grid decarbonization is the most cost-effective abatement tool through ~90% ` +
        `everywhere. The last 5–10% costs 3–8× more per ton than the first 90%. Push each region to its ` +
        `inflection point (${minInf}–${maxInf}%), then invest the savings into DAC, BECCS, SAF, and ` +
        `industrial electrification. More total tons abated, across more sectors, at lower total cost.</p>`;
})();

// ============================================================================
// SCROLL PROGRESS BAR
// ============================================================================
window.addEventListener('scroll', () => {
    const bar = $('scrollProgress');
    if (!bar) return;
    const pct = window.scrollY / (document.documentElement.scrollHeight - window.innerHeight) * 100;
    bar.style.width = Math.min(pct, 100) + '%';
}, { passive: true });

</script>
</body>
</html>
