<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The 8,760 Problem — Marginal Carbon Abatement Analysis</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<link rel="stylesheet" href="styles/shared.css">
<style>
body { background: #F3F4F8; color: #1A1A1A; line-height: 1.6; }

/* ===== LAYOUT ===== */
.page-wrap { max-width: 960px; margin: 0 auto; padding: 0 24px; }
section { padding: 48px 0 32px; }
section + section { border-top: 1px solid var(--border); }
h2 {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 1.8rem; color: var(--navy); margin-bottom: 12px; letter-spacing: -0.3px;
}
h3 {
    font-size: 1.15rem; margin-bottom: 8px;
}
.section-num {
    display: inline-block; font-size: 0.78rem; font-weight: 700; color: #0EA5E9;
    letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 6px;
}
p { margin-bottom: 14px; font-size: 0.93rem; line-height: 1.7; }
p:last-child { margin-bottom: 0; }

/* ===== CHART CONTAINERS ===== */
.chart-wrap {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px; margin: 24px 0; position: relative;
}
.chart-wrap-tall { height: 420px; }
.chart-wrap-med  { height: 360px; }
.chart-wrap canvas { width: 100% !important; }
.chart-title {
    font-family: 'Franklin Gothic Demi', sans-serif; font-size: 1rem;
    color: var(--navy); margin-bottom: 12px;
}

/* ===== COUNTER ROW ===== */
.counter-row { display: flex; gap: 16px; margin: 24px 0; flex-wrap: wrap; }
.counter-item {
    flex: 1; min-width: 140px; background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 18px 16px; text-align: center;
}
.counter-val {
    font-family: 'Barlow Semi Condensed', sans-serif; font-size: 2rem;
    font-weight: 800; color: var(--navy);
}
.counter-label { font-size: 0.78rem; color: var(--text-muted); margin-top: 4px; line-height: 1.4; }

/* ===== REGION CARDS ===== */
.region-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin: 20px 0; }
.region-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
    padding: 18px; border-top: 4px solid #ccc;
}
.region-card-head {
    display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
}
.region-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
.region-name { font-family: 'Franklin Gothic Demi', sans-serif; font-weight: 700; font-size: 0.95rem; }
.region-mac99 { font-family: 'Barlow Semi Condensed', sans-serif; font-size: 1.3rem; font-weight: 800; margin-left: auto; }
.region-card p { font-size: 0.84rem; line-height: 1.55; }

/* ===== CALLOUT ===== */
.callout {
    background: rgba(14,165,233,0.06); border: 1px solid rgba(14,165,233,0.15);
    border-radius: 12px; padding: 18px 20px; margin: 20px 0; font-size: 0.9rem;
}
.callout-warn {
    background: rgba(245,158,11,0.06); border-color: rgba(245,158,11,0.2);
}

/* ===== TABLE ===== */
.inflection-wrap { overflow-x: auto; margin: 20px 0; }
.inflection-table {
    width: 100%; border-collapse: collapse; font-size: 0.85rem;
    background: var(--navy); color: #fff; border-radius: 10px; overflow: hidden;
}
.inflection-table th {
    padding: 12px 10px; font-weight: 600; font-size: 0.8rem;
    border-bottom: 1px solid rgba(255,255,255,0.15); text-align: center;
}
.inflection-table td {
    padding: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.08);
    font-weight: 600;
}
.cell-green { color: #4ADE80; }
.cell-orange { color: #FBBF24; }
.cell-red { color: #F87171; }

/* ===== PER-REGION ENVELOPE GRID ===== */
.envelope-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px; margin: 24px 0;
}
.envelope-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px; border-top: 3px solid #ccc; position: relative;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
}
.envelope-card:hover {
    border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.envelope-card-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.95rem; font-weight: 700; color: var(--navy); margin-bottom: 4px;
    display: flex; align-items: center; gap: 8px;
}
.envelope-card-subtitle {
    font-size: 0.78rem; color: var(--text-muted); margin-bottom: 10px;
}
.envelope-card canvas { width: 100% !important; height: 160px; }

/* ===== CSS BAR CHART (replaces Chart.js for mobile perf) ===== */
.css-bar-chart { position: relative; padding: 6px 0; }
.css-bar-row {
    display: flex; align-items: center; gap: 6px; margin-bottom: 5px;
    font-family: 'Barlow Semi Condensed', sans-serif; font-size: 0.78rem;
}
.css-bar-label {
    width: 72px; min-width: 72px; text-align: right; color: var(--text-muted);
    font-size: 0.72rem; white-space: nowrap;
}
.css-bar-track {
    flex: 1; height: 22px; background: rgba(0,0,0,0.03); border-radius: 4px;
    position: relative; overflow: visible;
}
.css-bar-fill {
    height: 100%; border-radius: 4px; transition: width 0.6s ease;
    position: relative; min-width: 2px;
}
.css-bar-val {
    position: absolute; right: -4px; top: 50%; transform: translate(100%, -50%);
    font-size: 0.7rem; font-weight: 600; white-space: nowrap; padding-left: 5px;
}
.css-bar-val.inside {
    right: 6px; transform: translateY(-50%); color: #fff; padding-left: 0;
}

/* ===== MOBILE ===== */
@media (max-width: 768px) {
    .page-wrap { padding: 0 16px; }
    h2 { font-size: 1.4rem; }
    .counter-row { flex-direction: column; }
    .chart-wrap { padding: 14px; }
    .chart-wrap-tall { height: 280px; }
    .chart-wrap-med  { height: 240px; }
    .envelope-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
    .envelope-card { padding: 10px; }
    .envelope-card canvas { height: 100px; }
    .envelope-card-title { font-size: 0.82rem; }
    .envelope-card-subtitle { font-size: 0.7rem; margin-bottom: 4px; }
    .css-bar-label { width: 56px; min-width: 56px; font-size: 0.65rem; }
    .css-bar-track { height: 18px; }
    .css-bar-val { font-size: 0.62rem; }
    .css-bar-row { margin-bottom: 3px; }
}
@media (max-width: 480px) {
    .chart-wrap-tall { height: 220px; }
    .chart-wrap-med  { height: 200px; }
    .envelope-grid { grid-template-columns: 1fr; gap: 10px; }
    .envelope-card canvas { height: 80px; }
    .css-bar-label { width: 52px; min-width: 52px; font-size: 0.65rem; }
    .css-bar-track { height: 18px; }
    .css-bar-val { font-size: 0.62rem; }
    .counter-item { min-width: 100%; }
    .region-cards { grid-template-columns: 1fr; }
    .inflection-table { font-size: 0.72rem; }
    .inflection-table th, .inflection-table td { padding: 6px 4px; }
}
</style>
</head>
<body>

<nav id="topNav"></nav>
<script src="js/nav.js"></script>

<!-- HEADER -->
<header class="header">
    <h1>The 8,760 Problem</h1>
    <p class="subtitle">Where grid decarbonization beats alternatives — and where it doesn't.</p>
    <div class="header-accent"></div>
</header>

<div id="scrollProgress" style="position:fixed;top:0;left:0;height:3px;background:linear-gradient(90deg,var(--accent-blue),#22C55E);width:0%;z-index:10001;transition:width 0.1s linear;"></div>

<main class="page-wrap">

<!-- ============================================================ -->
<!-- SECTION 1: KEY METRICS (all dynamic) -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Overview</span>
    <h2>The Cost Envelope: Grid Abatement at a Glance</h2>
    <p id="introNarrative"></p>
    <div class="counter-row" id="keyCounters"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 2: STEPWISE MARGINAL MAC -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 1</span>
    <h2>Marginal MAC: Where Grid Investment Stops Paying Off</h2>
    <p>The grid backbone (75→90%) is cheap abatement everywhere. Beyond 90%, marginal costs escalate
       as the optimizer adds storage, CCS, and LDES to cover the hardest hours.
       Each bar shows the marginal $/ton for one step — green means cheaper than the social cost of carbon,
       amber sits between SCC and DAC Medium, and red exceeds projected DAC Medium costs ($250/ton).</p>

    <!-- Per-region marginal MAC charts (separate, no overlapping) -->
    <div class="envelope-grid" id="marginalGrid"></div>
    <div class="callout" id="marginalInsight"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 4: ABATEMENT LADDER -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 3</span>
    <h2>The Abatement Cost Ladder</h2>
    <p>Grid decarbonization costs compared to alternative pathways (2040 projected costs).
       Dashed vertical lines show regional average MAC at key thresholds.
       DAC range: $115 (Low) – $225 (Med) – $375 (High).</p>
    <div class="chart-wrap chart-wrap-tall">
        <div class="chart-title">Abatement Cost Ladder: Grid vs. Alternatives — 2040 Projected ($/ton CO₂)</div>
        <canvas id="ladderChart"></canvas>
    </div>
    <div class="callout callout-warn">
        <strong>Not apples-to-apples.</strong> Grid decarbonization avoids emissions in real-time. DAC permanently
        removes CO₂ but at higher cost today. SAF reduces hard-to-abate aviation emissions. Each pathway has a
        different role — the question is the right mix at the right price.
    </div>
</section>

<!-- ============================================================ -->
<!-- SECTION 5: REGIONAL CARDS -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 4</span>
    <h2>Regional Crossover Stories</h2>
    <p>Each region's grid has a unique cost profile shaped by resource quality, siting constraints,
       and existing clean energy mix.</p>
    <div class="region-cards" id="regionCards"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 6: INFLECTION TABLE -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 5</span>
    <h2>Inflection Points: Where Grid Costs Exceed Key Benchmarks</h2>
    <p>Marginal MAC crossovers — the threshold step where the next increment of grid investment
       exceeds each benchmark. Green = competitive through 99%+, orange = moderate, red = early crossover.</p>
    <div class="inflection-wrap">
        <table class="inflection-table" id="inflectionTable">
            <thead><tr id="inflectionHead"></tr></thead>
            <tbody id="inflectionBody"></tbody>
        </table>
    </div>
    <div class="counter-row" id="inflectionStats"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 7: ANOVA DECOMPOSITION -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 6</span>
    <h2>What Drives MAC Uncertainty?</h2>
    <p>ANOVA decomposition shows which cost toggle group drives the most variance in MAC
       across 324 scenarios. This tells procurement teams which assumptions to stress-test.</p>
    <div class="chart-wrap chart-wrap-med">
        <div class="chart-title">MAC Variance Attribution by Toggle Group (η² — ANOVA)</div>
        <canvas id="anovaChart"></canvas>
    </div>
    <div class="callout" id="anovaInsight"></div>
</section>

<!-- ============================================================ -->
<!-- SECTION 8: PORTFOLIO -->
<!-- ============================================================ -->
<section>
    <span class="section-num">Section 7</span>
    <h2>The Case for Portfolio Decarbonization</h2>
    <div id="portfolioNarrative"></div>
</section>

<!-- SOURCES -->
<section style="padding-bottom: 48px;">
    <h3 style="margin-bottom: 12px;">Sources</h3>
    <ol style="font-size: 0.82rem; color: var(--text-muted); line-height: 1.8; padding-left: 20px;">
        <li>EPA eGRID 2022 — regional emission rates, generation mix.</li>
        <li>EPA Social Cost of Carbon — Technical Support Document (2023), central estimate $190/ton.</li>
        <li>Rennert, K. et al. (2022). "Comprehensive evidence implies a higher social cost of CO₂." <em>Nature</em>, 610, 687-692.</li>
        <li>EU Emissions Trading System (EU ETS) — $65-92/ton (2024-2025 trading range).</li>
        <li>NREL Annual Technology Baseline (ATB) 2024.</li>
        <li>Lazard LCOE v17.0 (2024).</li>
        <li>EIA Hourly Electric Grid Monitor.</li>
        <li>IEAGHG — Global Assessment of DAC Costs (NOAK projections, 2024).</li>
        <li>Sievert, McQueen et al. (Joule, 2024) — DAC technology cost projections.</li>
        <li>DOE Carbon Negative Shot — $100/ton aspirational target.</li>
    </ol>
</section>

</main>

<footer class="page-footer">
    <div>
        <a href="index.html">Home</a>
        <a href="dashboard.html">Cost Optimizer</a>
        <a href="abatement_dashboard.html">Abatement Dashboard</a>
        <a href="region_deepdive.html">Regional Deep Dives</a>
        <a href="research_paper.html">Paper</a>
    </div>
    <div style="margin-top: 12px;">The 8,760 Problem — 2025 Snapshot Model</div>
</footer>

<!-- ================================================================== -->
<!-- DATA + CHARTS — everything computed from shared-data.js constants -->
<!-- ================================================================== -->
<script src="js/shared-data.js"></script>
<script src="js/mac-stats-data.js"></script>
<script>
'use strict';
const REGIONS = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
const REGION_CLR = REGION_COLORS;
const REGION_NAMES = { CAISO: 'CAISO (California)', ERCOT: 'ERCOT (Texas)', PJM: 'PJM (Mid-Atlantic)',
                       NYISO: 'NYISO (New York)', NEISO: 'NEISO (New England)' };

function $(id) { return document.getElementById(id); }
function html(id, v) { const el = $(id); if (el) el.innerHTML = v; }

const mac = MAC_DATA.medium;
const marg = MARGINAL_MAC_DATA.medium;
const margLabels = MARGINAL_MAC_LABELS;

// Threshold index helpers (MAC_DATA arrays match THRESHOLDS order)
const T_IDX = {};  // e.g. T_IDX[75] = 3, T_IDX[99] = 11
THRESHOLDS.forEach((t, i) => T_IDX[t] = i);

// Derived metrics from shared data
const allMarg = [];
REGIONS.forEach(r => {
    marg[r].forEach((v, i) => { if (v != null && v > 0) allMarg.push({ val: v, iso: r, idx: i }); });
});
const margMin = allMarg.reduce((a, b) => a.val < b.val ? a : b);
const margMax = allMarg.reduce((a, b) => a.val > b.val ? a : b);
const mac99 = REGIONS.map(r => mac[r][T_IDX[99]]).filter(v => v != null);
const mac50 = REGIONS.map(r => mac[r][T_IDX[50]]).filter(v => v != null);
const cheapestISO = REGIONS[REGIONS.map(r => mac[r][T_IDX[99]]).indexOf(Math.min(...mac99))];
const highestISO  = REGIONS[REGIONS.map(r => mac[r][T_IDX[99]]).indexOf(Math.max(...mac99))];

const dacLow = BENCHMARKS_DYNAMIC.dac.Low;
const dacMed = BENCHMARKS_DYNAMIC.dac.Medium;
const dacHigh = BENCHMARKS_DYNAMIC.dac.High;

// Find regions where any step's marginal MAC exceeds the SBTi-year-indexed DAC Central cost
const regionsExceedingDAC = REGIONS.filter(r =>
    marg[r].some((v, i) => {
        if (v == null) return false;
        const dacAtYear = dacCostAtThreshold(MARGINAL_THRESHOLDS[i], 'central');
        return v >= dacAtYear;
    })
).length;

// ============================================================================
// 1. INTRO NARRATIVE + KEY COUNTERS
// ============================================================================
html('introNarrative',
    `Average abatement costs range from <strong>$${Math.min(...mac50)}\u2013${Math.max(...mac99)}/ton</strong> ` +
    `across all five ISOs through 99% hourly matching \u2014 well below the social cost of carbon ($190/ton). ` +
    `The entry zone (50\u219275%) costs $${Math.min(...REGIONS.map(r => marg[r][0]).filter(v=>v!=null))}\u2013${Math.max(...REGIONS.map(r => marg[r][0]).filter(v=>v!=null))}/ton; ` +
    `the grid backbone (75\u219290%) costs $${Math.min(...REGIONS.map(r => marg[r][1]).filter(v=>v!=null))}\u2013${Math.max(...REGIONS.map(r => marg[r][1]).filter(v=>v!=null))}/ton. ` +
    `Beyond 90%, marginal costs escalate sharply as storage and CCS enter the mix. ` +
    `${regionsExceedingDAC} region${regionsExceedingDAC !== 1 ? 's have' : ' has'} at least one step ` +
    `exceeding projected DAC costs ($${dacLow.mid}\u2013$${dacHigh.mid}/ton range).`
);

html('keyCounters',
    `<div class="counter-item">` +
    `  <div class="counter-val">$${Math.max(...REGIONS.map(r => marg[r][0]).filter(v=>v!=null))}</div>` +
    `  <div class="counter-label">Max entry MAC<br>(50\u219275%)</div>` +
    `</div>` +
    `<div class="counter-item">` +
    `  <div class="counter-val">$${margMax.val >= 1000 ? '1,000+' : margMax.val}</div>` +
    `  <div class="counter-label">Max last-mile MAC<br>${margMax.iso} ${margLabels[margMax.idx]}</div>` +
    `</div>` +
    `<div class="counter-item">` +
    `  <div class="counter-val">${regionsExceedingDAC}</div>` +
    `  <div class="counter-label">Regions with steps<br>exceeding DAC Med ($${dacMed.mid}+)</div>` +
    `</div>` +
    `<div class="counter-item">` +
    `  <div class="counter-val">$${Math.min(...mac99)}</div>` +
    `  <div class="counter-label">${cheapestISO} avg MAC<br>at 99% (cheapest)</div>` +
    `</div>`
);

// ============================================================================
// 2. PER-REGION MARGINAL MAC CHARTS (CSS bars — no canvas, mobile-safe)
// ============================================================================
(function buildMarginalGrid() {
    const grid = $('marginalGrid');
    if (!grid) return;

    // Shared scale max across all regions
    let yMax = 0;
    REGIONS.forEach(r => { yMax = Math.max(yMax, ...marg[r].filter(v => v != null)); });
    yMax = Math.min(Math.ceil(yMax / 100) * 100 + 50, 1100);

    const sccVal = 190;

    // Color thresholds: green < SCC, amber SCC–DAC(central at that year), red > DAC(central)
    function barColor(val, stepIdx) {
        if (val <= sccVal) return { bg: '#22C55E', border: '#16A34A' }; // green
        const dacAtYear = dacCostAtThreshold(MARGINAL_THRESHOLDS[stepIdx], 'central');
        if (val <= dacAtYear) return { bg: '#F59E0B', border: '#D97706' }; // amber
        return { bg: '#EF4444', border: '#DC2626' }; // red
    }

    grid.innerHTML = REGIONS.map(iso => {
        const c = REGION_CLR[iso];
        const backbone = marg[iso][0];
        const lastStep = marg[iso][marg[iso].length - 1];

        // Build CSS horizontal bars with threshold coloring
        const bars = margLabels.map((label, i) => {
            const raw = marg[iso][i];
            const val = raw != null ? Math.min(raw, 1050) : 0;
            const pct = Math.max((val / yMax) * 100, 0.5);
            const bc = barColor(raw != null ? raw : 0, i);
            const displayVal = raw >= 1000 ? '$1k+' : '$' + raw;
            const isWide = pct > 35;
            return `<div class="css-bar-row">` +
                `<div class="css-bar-label">${label}</div>` +
                `<div class="css-bar-track">` +
                `  <div class="css-bar-fill" style="width:${pct}%;background:${bc.bg};border:1.5px solid ${bc.border}">` +
                `    ${isWide ? `<span class="css-bar-val inside">${displayVal}</span>` : ''}` +
                `  </div>` +
                `  ${!isWide ? `<span class="css-bar-val" style="position:absolute;left:${pct}%;top:50%;transform:translateY(-50%);color:${bc.border};padding-left:5px;font-size:0.7rem;font-weight:600;white-space:nowrap">${displayVal}</span>` : ''}` +
                `</div>` +
                `</div>`;
        }).join('');

        // Compact legend
        const legend = `<div style="display:flex;gap:10px;margin-top:4px;font-size:0.62rem;color:var(--text-muted)">` +
            `<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#22C55E;vertical-align:middle;margin-right:2px"></span>&lt;SCC ($${sccVal})</span>` +
            `<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#F59E0B;vertical-align:middle;margin-right:2px"></span>SCC\u2013DAC</span>` +
            `<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#EF4444;vertical-align:middle;margin-right:2px"></span>&gt;DAC Med ($${dacVal})</span>` +
            `</div>`;

        return `<div class="envelope-card" style="border-top-color:${c}">` +
            `<div class="envelope-card-title">` +
            `  <span class="region-dot" style="background:${c}"></span> ${REGION_NAMES[iso]}` +
            `  <span style="margin-left:auto;font-family:'Barlow Semi Condensed',sans-serif;font-size:1rem;font-weight:800;color:${c}">$${backbone}\u2192$${lastStep >= 1000 ? '1k+' : lastStep}</span>` +
            `</div>` +
            `<div class="envelope-card-subtitle">Backbone \u2192 last step · Avg MAC at 99%: $${mac[iso][8]}/ton</div>` +
            `<div class="css-bar-chart">${bars}${legend}</div>` +
            `</div>`;
    }).join('');

    // Insight
    const entryVals = REGIONS.map(r => marg[r][0]).filter(v => v != null);
    const backboneVals = REGIONS.map(r => marg[r][1]).filter(v => v != null);
    const lastMileVals = REGIONS.map(r => marg[r][marg[r].length - 1]);
    html('marginalInsight',
        `<strong>Entry zone (50\u219275%):</strong> Marginal MAC ranges $${Math.min(...entryVals)}\u2013$${Math.max(...entryVals)}/ton \u2014 ` +
        `the cheapest abatement. <strong>Grid backbone (75\u219290%):</strong> $${Math.min(...backboneVals)}\u2013$${Math.max(...backboneVals)}/ton \u2014 ` +
        `still well below SCC ($190). ` +
        `<strong>Last mile (97.5\u219299%):</strong> Costs jump to $${Math.min(...lastMileVals)}\u2013$${Math.max(...lastMileVals) >= 1000 ? '1,000+' : Math.max(...lastMileVals)}/ton. ` +
        `The escalation from entry zone to last mile is where portfolio diversification into DAC, ` +
        `BECCS, and SAF becomes cost-competitive.`
    );
})();

// ============================================================================
// 3. ABATEMENT LADDER
// ============================================================================
(function buildLadderChart() {
    const ctx = $('ladderChart')?.getContext('2d');
    if (!ctx) return;

    const benchmarks = getAllBenchmarks2040();
    const labels = benchmarks.map(b => b.short || b.name);
    const barData = benchmarks.map(b => [Math.max(b.low, 0), b.high]);
    const midPoints = benchmarks.map(b => b.mid);
    const bgColors = benchmarks.map(b => b.color + '40');
    const borderColors = benchmarks.map(b => b.color);

    const i90 = THRESHOLDS.indexOf(90), i95 = THRESHOLDS.indexOf(95), i99 = THRESHOLDS.indexOf(99);
    const annotations = {};
    [{iso:'ERCOT',t:90,i:i90},{iso:'ERCOT',t:95,i:i95},{iso:'ERCOT',t:99,i:i99},
     {iso:'NYISO',t:90,i:i90},{iso:'NYISO',t:99,i:i99}].forEach((m, idx) => {
        const cost = mac[m.iso][m.i];
        annotations['g' + idx] = {
            type: 'line', xMin: cost, xMax: cost,
            borderColor: REGION_CLR[m.iso] + 'aa', borderWidth: 2, borderDash: [4, 3],
            label: { display: true, content: m.iso + ' ' + m.t + '%', position: idx % 2 === 0 ? 'start' : 'end',
                font: { size: 9 }, color: REGION_CLR[m.iso], backgroundColor: 'rgba(255,255,255,0.9)', padding: 2 }
        };
    });

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'Cost Range', data: barData, backgroundColor: bgColors, borderColor: borderColors,
                    borderWidth: 2, borderRadius: 6, borderSkipped: false, barPercentage: 0.65 },
                { label: 'Mid Estimate', data: midPoints, type: 'scatter', pointRadius: 7, pointStyle: 'rectRounded',
                    backgroundColor: borderColors.map(c => c + 'cc'), borderColor: borderColors, borderWidth: 2 }
            ]
        },
        options: {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            animation: window.innerWidth < 768 ? false : undefined,
            scales: {
                x: { min: 0, max: 650, title: { display: window.innerWidth >= 480, text: '$/ton CO\u2082', font: { size: 13 } },
                    ticks: { stepSize: window.innerWidth < 480 ? 100 : 50, callback: v => '$' + v, font: { size: window.innerWidth < 480 ? 9 : 11 } }, grid: { display: false } },
                y: { ticks: { font: { size: window.innerWidth < 480 ? 9 : 11, weight: 500 } }, grid: { display: false } }
            },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => Array.isArray(ctx.raw) ? `Range: $${ctx.raw[0]}\u2013$${ctx.raw[1]}/ton` : `Mid: $${ctx.raw}/ton` } },
                annotation: { annotations },
                datalabels: { display: false }
            }
        }
    });
})();

// ============================================================================
// 4. REGIONAL CARDS (fully dynamic from shared data)
// ============================================================================
(function buildRegionCards() {
    const container = $('regionCards');
    if (!container) return;

    const stories = {
        CAISO: 'Solar abundance keeps early costs low. Solar saturation above 93% drives battery/LDES overbuilding.',
        ERCOT: 'The cost leader. Cheap wind, Gulf Coast CCS geology, and fast permitting.',
        PJM:   'Coal-heavy grid = more CO\u2082 displaced per clean MWh. Cheapest per-ton abatement.',
        NYISO: 'Strong nuclear+hydro base, but constrained siting drives high marginal costs.',
        NEISO: 'Most volatile curve. Offshore wind potential is high but uncertain.'
    };

    container.innerHTML = REGIONS.map(iso => {
        const c = REGION_CLR[iso];
        const backbone = marg[iso][0];
        const lastStep = marg[iso][marg[iso].length - 1];
        const dacSteps = marg[iso].filter((v, i) => v != null && v >= dacCostAtThreshold(MARGINAL_THRESHOLDS[i], 'central')).length;
        let topDriver = '', topPct = 0;
        if (typeof MAC_ANOVA !== 'undefined' && MAC_ANOVA[iso]) {
            const sorted = Object.entries(MAC_ANOVA[iso]).sort((a, b) => b[1] - a[1]);
            topDriver = sorted[0][0]; topPct = Math.round(sorted[0][1] * 100);
        }

        return `<div class="region-card" style="border-top-color:${c}">` +
            `<div class="region-card-head">` +
            `  <span class="region-dot" style="background:${c}"></span>` +
            `  <span class="region-name">${REGION_NAMES[iso]}</span>` +
            `  <span class="region-mac99" style="color:${c}">$${mac[iso][T_IDX[99]]}/ton</span>` +
            `</div>` +
            `<p>Average MAC: $${mac[iso][T_IDX[50]] || mac[iso][T_IDX[60]]}\u2013${mac[iso][T_IDX[99]]}/ton (50\u201399%). ` +
            `Backbone: $${backbone}/ton. Last step: $${lastStep >= 1000 ? '1,000+' : lastStep}/ton. ` +
            `${dacSteps > 0 ? dacSteps + ' step' + (dacSteps > 1 ? 's' : '') + ' exceed DAC.' : 'No steps exceed DAC.'} ` +
            `${topDriver ? topDriver + ' drives ' + topPct + '% of variance.' : ''}</p>` +
            `<p>${stories[iso]}</p>` +
            `</div>`;
    }).join('');
})();

// ============================================================================
// 5. INFLECTION TABLE
// ============================================================================
(function buildInflectionTable() {
    const headEl = $('inflectionHead');
    const bodyEl = $('inflectionBody');
    const statsEl = $('inflectionStats');
    if (!headEl || !bodyEl) return;

    // Static benchmarks (fixed $/ton crossover)
    const staticBenchmarks = [
        { name: 'EU ETS', val: 88 },
        { name: 'SCC (EPA)', val: 190 },
        { name: 'SCC (Rennert)', val: 185 },
        { name: 'DAC Low', val: dacLow.mid },
        { name: 'DAC Med', val: dacMed.mid },
        { name: 'DAC High', val: dacHigh.mid }
    ];

    headEl.innerHTML = '<th>Region</th>' +
        staticBenchmarks.map(b => `<th>${b.name}<br>($${b.val}/ton)</th>`).join('') +
        dacTrajectories.map(d => `<th>${d.name}<br>(SBTi trajectory)</th>`).join('');

    // Helper: find where MAC exceeds trajectory-indexed DAC
    function findDacTrajectoryXO(regionMacArray, trajectory) {
        for (let i = 0; i < THRESHOLDS.length; i++) {
            const t = THRESHOLDS[i];
            const macVal = regionMacArray[i];
            if (macVal == null) continue;
            const dacAtYear = dacCostAtThreshold(t, trajectory);
            if (macVal >= dacAtYear) return t;
        }
        return '>99';
    }

    bodyEl.innerHTML = REGIONS.map(iso => {
        const staticCells = staticBenchmarks.map(b => {
            const xo = findCrossover(mac[iso], b.val);
            const cls = xo === '>99' ? 'cell-green' : parseInt(xo) >= 95 ? 'cell-green' :
                parseInt(xo) >= 90 ? 'cell-orange' : 'cell-red';
            return `<td class="${cls}">${xo === '>99' ? '>99%' : xo + '%'}</td>`;
        });
        const dacCells = dacTrajectories.map(d => {
            const xo = findDacTrajectoryXO(mac[iso], d.traj);
            const cls = xo === '>99' ? 'cell-green' : parseInt(xo) >= 95 ? 'cell-green' :
                parseInt(xo) >= 90 ? 'cell-orange' : 'cell-red';
            return `<td class="${cls}">${xo === '>99' ? '>99%' : xo + '%'}</td>`;
        });
        return `<tr><td style="font-weight:700;text-align:left;padding-left:14px;">${iso}</td>${staticCells.join('')}${dacCells.join('')}</tr>`;
    }).join('');

    if (statsEl) {
        statsEl.innerHTML =
            `<div class="counter-item">` +
            `  <div class="counter-val" style="color:#4ADE80;">&gt;99%</div>` +
            `  <div class="counter-label">All regions stay below<br>DAC Med ($${dacMed.mid}/ton)</div>` +
            `</div>` +
            `<div class="counter-item">` +
            `  <div class="counter-val">$${mac[cheapestISO][8]}</div>` +
            `  <div class="counter-label">${cheapestISO} avg MAC at 99%<br>(cheapest region)</div>` +
            `</div>` +
            `<div class="counter-item">` +
            `  <div class="counter-val">$${mac[highestISO][8]}</div>` +
            `  <div class="counter-label">${highestISO} avg MAC at 99%<br>(highest region)</div>` +
            `</div>`;
    }
})();

// ============================================================================
// 6. ANOVA CHART
// ============================================================================
(function buildAnovaChart() {
    const ctx = $('anovaChart')?.getContext('2d');
    if (!ctx || typeof MAC_ANOVA === 'undefined') return;

    const toggles = ['Renewable Gen', 'Firm Gen', 'Storage', 'Fossil Fuel', 'Transmission'];
    const toggleColors = ['#22C55E', '#1E3A5F', '#8B5CF6', '#FF5722', '#0EA5E9'];

    const datasets = toggles.map((tg, ti) => ({
        label: tg,
        data: REGIONS.map(r => Math.round((MAC_ANOVA[r]?.[tg] || 0) * 100)),
        backgroundColor: toggleColors[ti] + 'CC',
        borderColor: toggleColors[ti], borderWidth: 1,
        barPercentage: 0.8, categoryPercentage: 0.82
    }));

    new Chart(ctx, {
        type: 'bar',
        data: { labels: REGIONS, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: window.innerWidth < 768 ? false : undefined,
            plugins: {
                legend: { position: 'top', labels: { font: { size: window.innerWidth < 480 ? 9 : 11 }, padding: window.innerWidth < 480 ? 8 : 14, usePointStyle: true, pointStyle: 'rect' } },
                tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw + '% of variance' } },
                datalabels: { display: false }
            },
            scales: {
                y: { beginAtZero: true, max: 70, title: { display: window.innerWidth >= 480, text: 'Variance Explained (\u03B7\u00B2%)', font: { size: 13 } },
                    ticks: { callback: v => v + '%', font: { size: window.innerWidth < 480 ? 9 : 11 } } },
                x: { ticks: { font: { size: window.innerWidth < 480 ? 10 : 12, weight: 600 } } }
            }
        }
    });

    const ercotRenew = Math.round(MAC_ANOVA.ERCOT['Renewable Gen'] * 100);
    const nyisoFirm = Math.round(MAC_ANOVA.NYISO['Firm Gen'] * 100);
    html('anovaInsight',
        `<strong>Key finding:</strong> MAC uncertainty is driven by different factors in each region. ` +
        `ERCOT: ${ercotRenew}% renewable costs (cheap wind). ` +
        `NYISO: ${nyisoFirm}% firm generation costs (expensive nuclear). ` +
        `Storage contributes &lt;2% of variance everywhere.`
    );
})();

// ============================================================================
// 7. PORTFOLIO NARRATIVE (dynamic from marginal data)
// ============================================================================
(function buildPortfolio() {
    const n = $('portfolioNarrative');
    if (!n) return;

    // Find inflection using SBTi-year-indexed DAC Central trajectory
    const inflections = {};
    REGIONS.forEach(r => {
        for (let i = 0; i < marg[r].length; i++) {
            if (marg[r][i] != null) {
                const dacAtYear = dacCostAtThreshold(MARGINAL_THRESHOLDS[i], 'central');
                if (marg[r][i] >= dacAtYear) {
                    inflections[r] = MARGINAL_THRESHOLDS[i];
                    return;
                }
            }
        }
        inflections[r] = '>99';
    });

    const numInf = Object.values(inflections).filter(v => typeof v === 'number');
    const minInf = numInf.length ? Math.min(...numInf) : 90;
    const maxInf = numInf.length ? Math.max(...numInf) : 99;

    n.innerHTML =
        `<p>Push the grid backbone as far as it's efficient, then diversify. The optimal pivot point \u2014 where ` +
        `marginal grid cost exceeds DAC (Med $${dacMed.mid}/ton; range $${dacLow.mid}\u2013$${dacHigh.mid}) \u2014 ranges from ` +
        `<strong>${minInf}% to ${maxInf === Infinity ? '>99' : maxInf}%</strong> depending on region.</p>` +

        `<div class="callout" style="margin: 20px 0;">` +
        `<strong>Regional inflection points (marginal MAC &gt; DAC Med $${dacMed.mid}/ton):</strong><br>` +
        REGIONS.map(r => `${r}: <strong>${inflections[r]}%</strong>`).join(' \u00B7 ') +
        `</div>` +

        `<p><strong>The bottom line:</strong> Grid decarbonization is the most cost-effective abatement tool through ~90% ` +
        `everywhere. The last 5\u201310% costs 3\u20138\u00D7 more per ton. But DAC costs are declining too \u2014 ` +
        `by the time SBTi requires 90%+ matching (~2040), DAC Central projections drop to $${dacCostAtThreshold(90, 'central')}/ton. ` +
        `Push each region to its inflection point, then invest the savings into DAC, BECCS, SAF, and ` +
        `industrial electrification. More total tons abated, across more sectors, at lower total cost.</p>`;
})();

// ============================================================================
// SCROLL PROGRESS BAR
// ============================================================================
window.addEventListener('scroll', () => {
    const bar = $('scrollProgress');
    if (!bar) return;
    const pct = window.scrollY / (document.documentElement.scrollHeight - window.innerHeight) * 100;
    bar.style.width = Math.min(pct, 100) + '%';
}, { passive: true });

</script>
</body>
</html>
