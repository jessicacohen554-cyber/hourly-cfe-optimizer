<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FOAK Investment Signal — Clean Firm Learning Curve vs Pure Consequential</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles/shared.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
body { background: #0B1120; }

.page-footer { background: #0F1A2E; color: rgba(255,255,255,0.7); padding: 32px 24px; text-align: center; }
.footer-links { display: flex; flex-wrap: wrap; gap: 16px 24px; justify-content: center; margin-bottom: 12px; }
.footer-links a { color: rgba(255,255,255,0.65); text-decoration: none; font-size: 0.85rem; font-weight: 500; transition: color 0.2s; min-height: 44px; display: inline-flex; align-items: center; padding: 8px 4px; }
.footer-links a:hover { color: #ffffff; }
.footer-note { font-size: 0.78rem; color: rgba(255,255,255,0.4); }
.bottom-banner { height: 4px; background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 25%, #22C55E 50%, #F59E0B 75%, #EF4444 100%); }

/* Hero */
.hero { background: linear-gradient(180deg, #0B1120 0%, #13203D 100%); padding: 48px 24px 40px; text-align: center; }
.hero h1 { font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 2.2rem; font-weight: 800; color: #fff; margin-bottom: 12px; letter-spacing: -0.5px; }
.hero .subtitle { font-size: 1.05rem; color: rgba(255,255,255,0.7); max-width: 860px; margin: 0 auto 24px; line-height: 1.7; }

/* Headline cards */
.headline-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; max-width: 1200px; margin: 0 auto 40px; padding: 0 24px; }
.headline-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; }
.headline-card .val { font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.9rem; font-weight: 800; line-height: 1.1; margin-bottom: 6px; }
.headline-card .lbl { font-size: 0.72rem; color: rgba(255,255,255,0.5); text-transform: uppercase; font-weight: 600; letter-spacing: 0.05em; }
.val.green { color: #22C55E; } .val.red { color: #EF4444; } .val.amber { color: #F59E0B; } .val.blue { color: #0EA5E9; } .val.cyan { color: #06B6D4; }

/* Content sections */
.content-section { max-width: 1320px; margin: 0 auto; padding: 40px 24px; }
.section-title { font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.5rem; font-weight: 700; color: #fff; margin-bottom: 8px; }
.section-subtitle { color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-bottom: 24px; line-height: 1.6; }

/* Scenario legend (persistent) */
.scenario-legend { display: flex; gap: 24px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.82rem; color: rgba(255,255,255,0.8); }
.legend-dot { width: 12px; height: 12px; border-radius: 3px; }
.legend-dot.scn-a { background: #EF4444; }
.legend-dot.scn-b { background: #22C55E; }
.legend-label { font-weight: 600; }
.legend-desc { color: rgba(255,255,255,0.5); font-size: 0.75rem; }

/* Scenario tags */
.scenario-tag { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 8px; }
.tag-a { background: rgba(239,68,68,0.15); color: #EF4444; border: 1px solid rgba(239,68,68,0.3); }
.tag-b { background: rgba(34,197,94,0.15); color: #22C55E; border: 1px solid rgba(34,197,94,0.3); }

/* Scenario desc cards */
.scenario-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px; }
.scenario-card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; }
.scenario-card h3 { font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 0.95rem; color: rgba(255,255,255,0.9); margin-bottom: 6px; }
.scenario-card .toggles { font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-bottom: 8px; font-family: 'Rajdhani', monospace; }
.scenario-card p { color: rgba(255,255,255,0.65); font-size: 0.85rem; line-height: 1.7; margin: 0; }

/* Charts side-by-side */
.chart-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px; }
.chart-box { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; }
.chart-box h3 { font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 0.95rem; color: rgba(255,255,255,0.9); margin-bottom: 4px; }
.chart-box .chart-note { font-size: 0.75rem; color: rgba(255,255,255,0.45); margin-bottom: 12px; }
.chart-container { position: relative; height: 340px; }

/* Single wide chart */
.chart-wide { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; margin-bottom: 32px; }
.chart-wide h3 { font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 0.95rem; color: rgba(255,255,255,0.9); margin-bottom: 4px; }
.chart-wide .chart-note { font-size: 0.75rem; color: rgba(255,255,255,0.45); margin-bottom: 12px; }
.chart-container-wide { position: relative; height: 420px; }

/* Domino table */
.domino-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
.domino-table th { font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(255,255,255,0.5); padding: 10px 6px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.15); }
.domino-table td { padding: 7px 6px; border-bottom: 1px solid rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); white-space: nowrap; }
.domino-table tr:hover td { background: rgba(255,255,255,0.04); }
.domino-table .num { font-family: 'Rajdhani','Barlow Semi Condensed',monospace; font-weight: 600; font-size: 0.82rem; }
.negative { color: #22C55E; }
.positive { color: #EF4444; }
.mac-cheap { color: #22C55E; } .mac-mid { color: #F59E0B; } .mac-exp { color: #EF4444; }

/* ISO selector */
.iso-selector { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.iso-btn { padding: 8px 16px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.7); font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; min-height: 44px; }
.iso-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
.iso-btn.active { background: rgba(14,165,233,0.15); border-color: rgba(14,165,233,0.4); color: #0EA5E9; }

/* Callout */
.callout { background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); border-radius: 10px; padding: 16px 20px; margin-bottom: 28px; }
.callout-title { font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; color: #F59E0B; font-size: 0.85rem; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.03em; }
.callout p { color: rgba(255,255,255,0.7); font-size: 0.88rem; line-height: 1.7; margin: 0; }

/* Insight box */
.insight { background: rgba(14,165,233,0.06); border-left: 3px solid #0EA5E9; padding: 16px 20px; border-radius: 0 8px 8px 0; margin-bottom: 24px; }
.insight p { color: rgba(255,255,255,0.8); font-size: 0.88rem; line-height: 1.7; margin: 0; }
.insight strong { color: #0EA5E9; }
.insight.green { background: rgba(34,197,94,0.06); border-color: #22C55E; }
.insight.green strong { color: #22C55E; }

/* Deploy bar chart containers */
.deploy-chart-container { position: relative; height: 380px; }

@media (max-width: 768px) {
    .hero h1 { font-size: 1.5rem; }
    .chart-pair, .scenario-cards { grid-template-columns: 1fr; }
    .headline-row { grid-template-columns: 1fr 1fr; }
    .chart-container { height: 280px; }
    .chart-container-wide { height: 320px; }
    .deploy-chart-container { height: 320px; }
    .domino-table { font-size: 0.7rem; }
    .domino-table td, .domino-table th { padding: 5px 4px; }
    .deploy-table { font-size: 0.7rem; }
}
</style>
</head>
<body>
<nav id="topNav"></nav>

<!-- Hero -->
<section class="hero">
    <h1>The FOAK Investment Case</h1>
    <p class="subtitle">
        Two procurement strategies. One chases the cheapest $/tCO<sub>2</sub> at each step — locking in
        resources that can't be unbuilt. The other targets 95% CFE directly with cheap clean firm from
        FOAK learning curves. Same physics, same feasible mixes — radically different outcomes.
    </p>
</section>

<!-- Dynamic headline cards -->
<div class="headline-row" id="headlineCards"></div>

<!-- Scenario descriptions -->
<section class="content-section">
    <div class="scenario-legend">
        <div class="legend-item"><div class="legend-dot scn-a"></div><span class="legend-label">Pure Consequential</span><span class="legend-desc">&mdash; sequential, cheapest $/tCO₂ first, path-dependent lock-in</span></div>
        <div class="legend-item"><div class="legend-dot scn-b"></div><span class="legend-label">FOAK Investment</span><span class="legend-desc">&mdash; target 95% CFE directly, cheap clean firm from learning curves</span></div>
    </div>

    <div class="scenario-cards">
        <div class="scenario-card" style="border-color: rgba(239,68,68,0.25);">
            <span class="scenario-tag tag-a">Pure Consequential</span>
            <h3>Sequential Path-Dependent Optimization</h3>
            <div class="toggles">Ren: Low | Firm: High | CCS: High | LDES: High | Geo: High | Battery: Med | Fuel: Med | Tx: Med</div>
            <p>At each threshold (50% → 60% → 75% → ... → 100%), buy the cheapest resources to reach
            that target. Resources deployed at each step are <strong>locked in</strong> as committed infrastructure —
            they can't be unbuilt. The optimizer can only add on top.
            Result: early renewable overbuilding creates path dependency that makes later thresholds
            dramatically more expensive.</p>
        </div>
        <div class="scenario-card" style="border-color: rgba(34,197,94,0.25);">
            <span class="scenario-tag tag-b">FOAK Investment</span>
            <h3>Target 95% CFE Directly</h3>
            <div class="toggles">Ren: Low | Firm: Low | CCS: Low | LDES: Low | Geo: Low | Battery: Low | Fuel: Med | Tx: Med</div>
            <p>All buyers target 95% hourly CFE simultaneously. FOAK investment drives clean firm
            to Low LCOE via learning curves. The optimizer selects the globally optimal portfolio for 95% —
            a balanced mix of clean firm, renewables, and storage that achieves reliable hourly matching
            at a fraction of the sequential path's cost.</p>
        </div>
    </div>
</section>

<!-- 1. SBTi Timeline: MAC Comparison -->
<section class="content-section">
    <h2 class="section-title">Marginal Abatement Cost on the SBTi Timeline</h2>
    <p class="section-subtitle">Stepwise $/tCO<sub>2</sub> at each SBTi milestone. The pure consequential path costs more per ton displaced at every threshold above 90%.</p>

    <div class="iso-selector" id="macIsoSelector"></div>

    <div class="chart-wide">
        <h3 id="macTimelineTitle">PJM — Marginal $/tCO<sub>2</sub> by SBTi Year</h3>
        <p class="chart-note">Red = Pure Consequential | Green = FOAK Investment. Capped at $2,000/tCO₂. Hover for exact values.</p>
        <div class="chart-container-wide"><canvas id="macTimelineChart"></canvas></div>
    </div>

    <div class="insight">
        <p><strong>The path-dependent trap reveals itself above 80%.</strong> The sequential strategy locks in massive
        renewable overbuilds early (they're the cheapest $/tCO<sub>2</sub> at each step). But those locked-in renewables
        have declining marginal value for hourly matching — you've already saturated the sunny and windy hours.
        To reach higher thresholds, the optimizer is forced into even more extreme overbuilding because clean firm
        is expensive at High LCOE. The FOAK 95% target achieves the same physics with a balanced portfolio —
        clean firm provides the nighttime/winter hours that no amount of renewables can cover.</p>
    </div>
</section>

<!-- 2. What Resources Get Deployed at Each Zone -->
<section class="content-section">
    <h2 class="section-title">What Gets Deployed at Each Zone?</h2>
    <p class="section-subtitle">The consequential path deploys resources sequentially — locked-in at each threshold before
    optimizing the next. By contrast, the FOAK path procures a single balanced portfolio targeting 95% CFE. The sequential
    path shows escalating renewable overbuilding as each step inherits prior commitments; the FOAK path shows stable deployment
    because it's one optimized portfolio from the start.</p>

    <div class="iso-selector" id="deployIsoSelector"></div>

    <div class="chart-pair">
        <div class="chart-box">
            <span class="scenario-tag tag-a">Sequential Path-Dependent</span>
            <h3 id="deployTitleA">PJM — Resources at Each Threshold (TWh)</h3>
            <p class="chart-note">Horizontal bars show total deployed resources + gas backup (GW, rightmost). Hover for details.</p>
            <div class="deploy-chart-container"><canvas id="deployChartA"></canvas></div>
        </div>
        <div class="chart-box">
            <span class="scenario-tag tag-b">FOAK Target 95%</span>
            <h3 id="deployTitleB">PJM — Resources at Each Threshold (TWh)</h3>
            <p class="chart-note">Single target portfolio — same resource mix at every threshold.</p>
            <div class="deploy-chart-container"><canvas id="deployChartB"></canvas></div>
        </div>
    </div>

    <div class="callout">
        <div class="callout-title">Path Dependency Creates Renewable Saturation</div>
        <p>Because the sequential strategy locks in the cheapest resources first, it overbuilds renewables at early thresholds.
        Those resources are committed — they can't be unbuilt. At 80%+, the optimizer inherits this oversized renewable base
        and must add even more to push hourly matching higher, because clean firm is expensive at High LCOE. The result:
        PJM reaches 2,400 TWh of solar at 95% (vs. 27 TWh in the FOAK target). ERCOT hits 1,400+ TWh of solar at 85%.
        This is the cost of local optimization — each step was the cheapest $/tCO<sub>2</sub> at the time, but the cumulative
        path is 3-5&times; more expensive than targeting a high threshold directly.</p>
    </div>
</section>

<!-- 3. Gas Capacity: The Stranding Story -->
<section class="content-section">
    <h2 class="section-title">Gas Capacity: Overbuilding vs. Efficient Displacement</h2>
    <p class="section-subtitle">Gas backup capacity at each milestone. The sequential path's massive renewable overbuilding
    eventually eliminates gas through sheer overcapacity — but at 3-5&times; the cost. The FOAK target path maintains
    some gas at 95% but achieves near-full decarbonization at a fraction of the system cost.</p>

    <div class="iso-selector" id="gasIsoSelector"></div>

    <div class="chart-wide">
        <h3 id="gasChartTitle">PJM — Gas Backup Capacity (MW)</h3>
        <p class="chart-note">Red = Pure Consequential | Green = FOAK Investment. Shaded gap = avoided gas infrastructure.</p>
        <div class="chart-container-wide"><canvas id="gasChart"></canvas></div>
    </div>

    <div class="insight green">
        <p><strong>The gas story is counterintuitive.</strong> The sequential path's extreme renewable overbuilding
        actually eliminates gas at high thresholds — PJM hits 0 MW gas at 90% because it's deployed so much
        solar and wind that capacity credits exceed the RA requirement. But this comes at
        $252/MWh vs. the FOAK path's $63/MWh. The FOAK 95% target retains ~<span id="gasGapPJM">110 GW</span> of gas
        in PJM but achieves 95% CFE at 4&times; lower cost. The efficient path doesn't require eliminating every MW of gas —
        it requires matching clean energy to demand hourly.</p>
    </div>
</section>

<!-- 4. Resource Mix Side-by-Side -->
<section class="content-section">
    <h2 class="section-title">What Gets Built: Path-Dependent vs. Target Portfolio</h2>
    <p class="section-subtitle">The sequential path's resource mix evolves erratically as each threshold inherits prior overbuilds.
    The FOAK target is a single stable portfolio — the same optimized mix at every point because that's what everyone is building toward.</p>

    <div class="iso-selector" id="mixIsoSelector"></div>

    <div class="chart-pair">
        <div class="chart-box">
            <span class="scenario-tag tag-a">Pure Consequential</span>
            <h3 id="mixTitleA">PJM — Resource Mix (TWh)</h3>
            <div class="chart-container"><canvas id="mixChartA"></canvas></div>
        </div>
        <div class="chart-box">
            <span class="scenario-tag tag-b">FOAK Investment</span>
            <h3 id="mixTitleB">PJM — Resource Mix (TWh)</h3>
            <div class="chart-container"><canvas id="mixChartB"></canvas></div>
        </div>
    </div>
</section>

<!-- 5. Effective System Cost Overlay -->
<section class="content-section">
    <h2 class="section-title">Effective System Cost: The Learning Curve Dividend</h2>
    <p class="section-subtitle">$/MWh effective system cost at each milestone. The sequential path escalates 3-5&times; as locked-in
    renewables saturate. The FOAK 95% target is a flat line — one portfolio, one cost — dramatically cheaper at every threshold.</p>

    <div class="iso-selector" id="costIsoSelector"></div>

    <div class="chart-wide">
        <h3 id="costChartTitle">PJM — Effective System Cost ($/MWh)</h3>
        <p class="chart-note">Red = Pure Consequential | Green = FOAK Investment. Shaded gap = savings from learning curve investment.</p>
        <div class="chart-container-wide"><canvas id="costChart"></canvas></div>
    </div>
</section>

<!-- 6. Clean Firm Deployment Comparison -->
<section class="content-section">
    <h2 class="section-title">Clean Firm Deployment: Early Entry vs. Last-Minute Cliff</h2>
    <p class="section-subtitle">Total clean firm generation (nuclear + CCS + geothermal) at each threshold.
    The sequential path eventually needs massive clean firm at extreme thresholds; the FOAK target gets it right from the start.</p>

    <div class="iso-selector" id="firmIsoSelector"></div>

    <div class="chart-wide">
        <h3 id="firmChartTitle">PJM — Clean Firm + CCS Deployment (TWh)</h3>
        <p class="chart-note">Red = Pure Consequential | Green = FOAK Investment. The FOAK path builds clean firm 2-3x earlier.</p>
        <div class="chart-container-wide"><canvas id="firmChart"></canvas></div>
    </div>

    <div class="callout" style="background: rgba(239,68,68,0.06); border-color: rgba(239,68,68,0.2);">
        <div class="callout-title" style="color: #EF4444;">The Path-Dependent Trap</div>
        <p>The sequential path's clean firm deployment is erratic — forced into large buildouts at certain thresholds
        where the inherited renewable base simply can't achieve hourly matching. PJM needs 1,000+ TWh of clean firm
        at 90% in the sequential path vs. 815 TWh in the FOAK target. The difference: the FOAK portfolio was
        <em>designed</em> for 95% reliability from the start. The sequential path has to compensate for
        a renewable-heavy legacy that wasn't designed for high-threshold hourly matching.</p>
    </div>
</section>

<!-- 7. Domino Sequence Tables -->
<section class="content-section">
    <h2 class="section-title">The Sequential Deployment Queue</h2>
    <p class="section-subtitle">The consequential path deploys resources step-by-step, ordered by cheapest $/tCO<sub>2</sub> first.
    Each row inherits all prior resource commitments. The FOAK path has no queue — it's a single portfolio targeting 95%.</p>

    <div class="chart-wide" style="overflow-x: auto;">
        <span class="scenario-tag tag-a">Pure Consequential — Sequential Queue</span>
        <table class="domino-table" id="dominoTableA"></table>
    </div>
    <div class="insight" style="margin-top: 16px;">
        <p><strong>No queue for the FOAK path.</strong> In the target-95% scenario, there's no sequential deployment —
        every buyer procures the same optimized portfolio simultaneously. The "queue" concept only applies
        to the sequential strategy, where each step depends on what was locked in before.</p>
    </div>
</section>

<!-- Bottom line -->
<section class="content-section">
    <h2 class="section-title">Bottom Line: Local Optimization Fails Globally</h2>
    <div class="insight green">
        <p><strong>Targeting 95% CFE directly costs 3-5&times; less per MWh than getting there sequentially.</strong>
        At 95%, PJM pays $290/MWh through the sequential path vs. $63/MWh targeting directly — a $227/MWh gap
        on 833 TWh of demand. Across all 5 ISOs, the sequential path to 95% costs ~$255B more per year in
        effective system cost. The "cheap" sequential strategy — always buying the next cheapest $/tCO<sub>2</sub> —
        is a textbook local optimization that produces a globally suboptimal outcome.</p>
    </div>
    <div class="insight">
        <p><strong>The mechanism is path dependency.</strong> Resources deployed at 50% are locked in at 60%.
        Because renewables are cheapest at each step (clean firm is expensive at FOAK pricing), the sequential
        strategy builds massive renewable portfolios that saturate the sunny/windy hours. At higher thresholds,
        the hard hours — winter nights, low-wind weeks — need firm generation. But the optimizer is trapped:
        it can't unwind the renewable overbuilding, so it piles on even more at escalating cost.
        The FOAK path avoids this by targeting a high threshold from the start — the optimizer naturally selects
        a balanced mix of firm + renewables + storage because that's what hourly matching requires.</p>
    </div>
</section>

<!-- Methodology -->
<section class="content-section" style="border-top: 1px solid rgba(255,255,255,0.08); padding-top: 48px;">
    <h2 class="section-title">Methodology</h2>
    <p class="section-subtitle">How this comparison is constructed and what it does (and doesn't) model.</p>

    <div style="color: rgba(255,255,255,0.75); font-size: 0.88rem; line-height: 1.8; max-width: 900px;">

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">Same Physics, Different Procurement Strategies</h3>
    <p>Both scenarios draw from an <strong>identical pool of ~33,000 physics-feasible resource mixes</strong> produced by the 8,760-hour dispatch model
    (Step 1 PFS Generator). Each mix is a validated combination of clean firm, solar, wind, CCS-CCGT, hydro, 4-hour battery, 8-hour battery,
    and 100-hour LDES that achieves a specific hourly CFE threshold across all 8,760 hours of 2025 demand and generation data.
    The physics are fixed — what changes between scenarios is the <em>procurement strategy</em>: sequential path-dependent
    optimization vs. targeting a single high threshold directly.</p>

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">Scenario A: Sequential Path-Dependent Optimization</h3>
    <p>The consequential scenario models a buyer who procures the cheapest resources at each threshold step,
    with <strong>prior deployments locked in as committed infrastructure</strong>:</p>
    <ol style="padding-left: 20px; margin: 8px 0;">
        <li>At 50% CFE: find the cheapest feasible mix from the existing grid floor. Deploy those resources.</li>
        <li>At 60% CFE: resources deployed at 50% are now the <strong>floor</strong> — they can't be unbuilt.
            The optimizer can only add on top. Among all feasible mixes at 60% that meet the floor constraint
            (every resource &ge; what was deployed at 50%), select the cheapest.</li>
        <li>Continue sequentially through 70%, 75%, 80%, ... 100%. Each step inherits all prior commitments.</li>
        <li>Resources remain priced at their original LCOE — committed capacity does NOT shift to wholesale pricing.
            The sunk cost creates path dependency but doesn't create a pricing advantage.</li>
    </ol>
    <p>When the discrete feasible-mix space is too sparse for strict monotonicity, the optimizer uses a <strong>soft floor</strong>:
    each mix is scored by its total floor violation (TWh shortfall across all resources), and the cheapest mix with
    minimum violation is selected. The floor ratchets up using the element-wise maximum of the old floor and new deployment.</p>

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">Scenario B: Target 95% Directly</h3>
    <p>The FOAK scenario models collective procurement where all buyers target <strong>95% hourly CFE simultaneously</strong>.
    FOAK investment has driven clean firm technologies to Low LCOE via learning curves. The optimizer finds the single
    cheapest feasible mix at the 95% threshold — that portfolio IS the target everyone is building toward.
    Every threshold on the trajectory charts shows this same 95% target mix, because the procurement strategy is
    "build the right portfolio for 95% and deploy it."</p>

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">Cost Toggle Comparison</h3>

    <table style="width:100%; border-collapse:collapse; margin: 16px 0 24px; font-size: 0.82rem;">
        <thead>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <th style="text-align:left; padding: 8px; color: rgba(255,255,255,0.5); font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.05em;">Toggle</th>
                <th style="text-align:center; padding: 8px; color: #EF4444; font-size: 0.72rem; text-transform: uppercase;">Sequential</th>
                <th style="text-align:center; padding: 8px; color: #22C55E; font-size: 0.72rem; text-transform: uppercase;">FOAK Target</th>
            </tr>
        </thead>
        <tbody>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.06);"><td style="padding:6px 8px;">Renewable Gen (Solar/Wind LCOE)</td><td style="text-align:center; padding:6px;">Low</td><td style="text-align:center; padding:6px;">Low</td></tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.06);"><td style="padding:6px 8px;">Firm Gen (Nuclear new-build LCOE)</td><td style="text-align:center; padding:6px; color:#EF4444;">High</td><td style="text-align:center; padding:6px; color:#22C55E;">Low</td></tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.06);"><td style="padding:6px 8px;">CCS-CCGT (w/ 45Q offset)</td><td style="text-align:center; padding:6px; color:#EF4444;">High</td><td style="text-align:center; padding:6px; color:#22C55E;">Low</td></tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.06);"><td style="padding:6px 8px;">LDES (100hr iron-air storage)</td><td style="text-align:center; padding:6px; color:#EF4444;">High</td><td style="text-align:center; padding:6px; color:#22C55E;">Low</td></tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.06);"><td style="padding:6px 8px;">Geothermal (CAISO only)</td><td style="text-align:center; padding:6px; color:#EF4444;">High</td><td style="text-align:center; padding:6px; color:#22C55E;">Low</td></tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.06);"><td style="padding:6px 8px;">Battery (4hr Li-ion)</td><td style="text-align:center; padding:6px;">Medium</td><td style="text-align:center; padding:6px; color:#22C55E;">Low</td></tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.06);"><td style="padding:6px 8px;">Fossil Fuel (wholesale price)</td><td style="text-align:center; padding:6px;">Medium</td><td style="text-align:center; padding:6px;">Medium</td></tr>
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.06);"><td style="padding:6px 8px;">Transmission</td><td style="text-align:center; padding:6px;">Medium</td><td style="text-align:center; padding:6px;">Medium</td></tr>
            <tr><td style="padding:6px 8px;">45Q Tax Credit</td><td style="text-align:center; padding:6px;">On</td><td style="text-align:center; padding:6px;">On</td></tr>
        </tbody>
    </table>

    <p>In the sequential scenario, clean firm technologies are at <strong>High cost</strong> — FOAK pricing before learning curves.
    Renewables and battery are cheap. In the FOAK scenario, learning curves have materialized and <strong>all</strong>
    clean technologies are at Low cost.</p>

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">Cost Function (Both Scenarios)</h3>
    <p>Effective system cost = total procurement cost / hourly match fraction, including:</p>
    <ul style="padding-left: 20px; margin: 8px 0;">
        <li>Existing generation at wholesale price; new generation at LCOE + transmission adder</li>
        <li>Clean firm tranche pricing: uprates first, then geothermal (CAISO), then cheapest of nuclear/CCS</li>
        <li>Storage costs: battery (4hr/8hr) and LDES at scenario-specific LCOE</li>
        <li>Gas backup: resource adequacy requirement (15% margin above peak) minus clean capacity credits, priced at fixed O&amp;M (existing) or full annualized cost (new build)</li>
    </ul>
    <p>The cost function is identical between scenarios. What differs is (a) the cost toggle levels, (b) the optimization
    strategy (sequential with floor constraints vs. single-target), and (c) the resulting optimal resource mix.</p>

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">Gas Backup &amp; Capacity Credits</h3>
    <p>Gas capacity is <strong>not a choice variable</strong> — it's derived from resource adequacy constraints. Each clean resource receives a
    capacity credit (clean firm: 100%, CCS: 90%, LDES: 90%, battery: 95%, hydro: 50%, solar: 30%, wind: 10%). The remaining gap between
    clean capacity and the RA requirement (peak demand &times; 1.15) must be filled by gas. Clean firm's 100% capacity credit
    displaces gas MW-for-MW; wind's 10% credit means 10 MW of wind displaces only 1 MW of gas.</p>

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">Marginal Abatement Cost</h3>
    <p>Stepwise MAC is computed between consecutive thresholds using the dispatch-stack fossil retirement model:
    coal retires first (highest emissions + marginal cost), then oil, then gas. The marginal emission rate
    of displaced fossil shifts from coal-heavy (~1.0 tCO<sub>2</sub>/MWh) at low thresholds to gas-only (~0.4 tCO<sub>2</sub>/MWh) at high thresholds.
    MAC = &Delta;(system cost &times; demand) / &Delta;CO<sub>2</sub> displaced between threshold steps.</p>

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">SBTi Timeline Mapping</h3>
    <p>CFE thresholds are mapped to SBTi-aligned deployment years: 50%&rarr;2025, 60%&rarr;2027, 70%&rarr;2029, 75%&rarr;2030, 80%&rarr;2032,
    85%&rarr;2035, 87.5%&rarr;2037, 90%&rarr;2040, 92.5%&rarr;2042, 95%&rarr;2045, 97.5%&rarr;2047, 99%&rarr;2049, 100%&rarr;2050.
    This maps the static threshold comparison onto a temporal deployment trajectory.</p>

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">What This Analysis Does Not Model</h3>
    <ul style="padding-left: 20px; margin: 8px 0;">
        <li><strong>Dynamic learning curves</strong> — costs are fixed within each scenario. The FOAK scenario assumes learning curves have already materialized; it does not model the investment-to-learning feedback loop endogenously.</li>
        <li><strong>Construction timelines</strong> — all resources are assumed available at each threshold. In practice, the 99% cliff in the consequential path would face multi-year nuclear/CCS construction lead times.</li>
        <li><strong>Demand growth</strong> — base 2025 demand is used throughout. Real demand growth (1-3.5%/yr by region) would amplify all effects shown here.</li>
        <li><strong>Inter-regional transmission</strong> — each ISO is optimized independently. Cross-ISO power flows could moderate some regional cost differences.</li>
        <li><strong>Gas stranding economics</strong> — gas backup is costed at annual fixed O&amp;M / annualized capital, not lifecycle NPV. The economic loss from building-then-stranding gas is understated.</li>
    </ul>

    <h3 style="font-family: 'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif; font-size: 1.05rem; color: #fff; margin: 24px 0 8px;">Data Sources</h3>
    <p>EIA hourly generation profiles (2025), eGRID emission rates, NREL ATB cost projections (Low/Medium/High), Lazard LCOE benchmarks,
    regional wholesale prices from ISO market data. Full cost tables and assumptions documented in the
    <a href="optimizer_methodology.html" style="color: #0EA5E9;">Optimizer Methodology</a> page.</p>

    </div>
</section>

<footer class="page-footer">
    <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Cost Optimizer</a>
        <a href="consequential_accounting.html">Consequential Accounting</a>
        <a href="research_paper.html">Research Paper</a>
    </div>
    <div class="footer-note">Hourly CFE Optimizer &mdash; 8,760-hour dispatch model</div>
</footer>
<div class="bottom-banner"></div>

<script src="js/nav.js"></script>
<script src="js/scenario-comparison-data.js"></script>
<script>
(function() {
'use strict';

const DATA = SCENARIO_COMPARISON;
const ISOS = DATA.metadata.isos;
const THRESHOLDS = DATA.metadata.thresholds;
const YEAR_MAP = {};
Object.entries(DATA.metadata.sbti_year_map).forEach(([k,v]) => YEAR_MAP[parseFloat(k)] = v);

// Match dashboard color palette from shared-data.js MIX_COLORS
const COLORS = {
    A: '#EF4444', B: '#22C55E',
    A85: 'rgba(239,68,68,0.85)', B85: 'rgba(34,197,94,0.85)',
    A_fill: 'rgba(239,68,68,0.12)', B_fill: 'rgba(34,197,94,0.12)',
    A_area: 'rgba(239,68,68,0.25)', B_area: 'rgba(34,197,94,0.25)',
    clean_firm: '#1E3A5F', solar: '#F59E0B', wind: '#22C55E',
    ccs: '#0D9488', hydro: '#0EA5E9', battery: '#8B5CF6', ldes: '#EC4899',
    gas: '#6B7280',
};
const RES_RGB = {
    clean_firm: '30,58,95',  solar: '245,158,11', wind: '34,197,94',
    ccs_ccgt: '13,148,136',  hydro: '14,165,233', battery: '139,92,246', ldes: '236,72,153',
    gas: '107,114,128',
};
const RES_LABELS = {
    clean_firm: 'Nuclear', ccs_ccgt: 'CCS-CCGT', solar: 'Solar', wind: 'Wind',
    hydro: 'Hydro', battery: 'Battery', ldes: 'LDES', gas: 'Gas Backup',
};
const GRID_MIX = DATA.metadata.grid_mix_shares;
const DEMAND_TWH = DATA.metadata.base_demand_twh;

const CHART_DEFAULTS = {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { labels: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } } } },
};

function yearLabel(d) { return d.year + '\n(' + d.threshold + '%)'; }
function pctLabel(d) { return d.threshold + '%'; }

// ===== HEADLINE CARDS (dynamic from data) =====
function buildHeadlineCards() {
    const container = document.getElementById('headlineCards');
    const baseDemand = { CAISO: 217, ERCOT: 485, PJM: 833, NYISO: 154, NEISO: 117 };

    // Compare effective system cost at 95% threshold
    let annualCostA = 0, annualCostB = 0;
    ISOS.forEach(iso => {
        const trajA = DATA.trajectories.cheap_ren[iso] || [];
        const trajB = DATA.trajectories.clean_firm_invest[iso] || [];
        const a95 = trajA.find(d => d.threshold === 95);
        const b95 = trajB.find(d => d.threshold === 95);
        if (a95 && b95) {
            annualCostA += a95.effective_cost * baseDemand[iso]; // $/MWh × TWh = $M
            annualCostB += b95.effective_cost * baseDemand[iso];
        }
    });
    const savingsB = Math.round((annualCostA - annualCostB) / 1000);

    // PJM cost gap at 95%
    const trajA_PJM = DATA.trajectories.cheap_ren.PJM || [];
    const trajB_PJM = DATA.trajectories.clean_firm_invest.PJM || [];
    const a95_PJM = trajA_PJM.find(d => d.threshold === 95);
    const b95_PJM = trajB_PJM.find(d => d.threshold === 95);
    const costGapPJM = a95_PJM && b95_PJM ? Math.round(a95_PJM.effective_cost - b95_PJM.effective_cost) : 227;

    // Cost multiplier at 95% — ratio of sequential to FOAK
    const costMultiplier = (annualCostB > 0) ? (annualCostA / annualCostB).toFixed(1) : '3.5';

    // PJM solar overbuilding — TWh at 95% in sequential path
    const solarOverPJM = a95_PJM ? Math.round(a95_PJM.resource_twh.solar) : 2412;
    const solarFOAK_PJM = b95_PJM ? Math.round(b95_PJM.resource_twh.solar) : 27;

    container.innerHTML = `
        <div class="headline-card"><div class="val red">${costMultiplier}&times;</div><div class="lbl">Sequential Cost vs. FOAK at 95%</div></div>
        <div class="headline-card"><div class="val amber">$${savingsB}B</div><div class="lbl">Annual Savings From Targeting 95%</div></div>
        <div class="headline-card"><div class="val blue">$${costGapPJM}/MWh</div><div class="lbl">PJM Cost Gap at 95%</div></div>
        <div class="headline-card"><div class="val cyan">${solarOverPJM} TWh</div><div class="lbl">PJM Solar in Sequential (vs. ${solarFOAK_PJM} FOAK)</div></div>
    `;

    // Update gas callout text
    const gapEl = document.getElementById('gasGapPJM');
    if (gapEl && b95_PJM) gapEl.textContent = Math.round(b95_PJM.gas_backup_mw / 1000) + ' GW';
}
buildHeadlineCards();

// ===== ISO SELECTOR FACTORY =====
function createIsoSelector(containerId, defaultIso, onChange) {
    const container = document.getElementById(containerId);
    if (!container) return;
    ISOS.forEach(iso => {
        const btn = document.createElement('button');
        btn.className = 'iso-btn' + (iso === defaultIso ? ' active' : '');
        btn.textContent = iso;
        btn.addEventListener('click', () => {
            container.querySelectorAll('.iso-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            onChange(iso);
        });
        container.appendChild(btn);
    });
}

// ===== 1. MAC TIMELINE CHART =====
let macTimelineChart;
function renderMacTimeline(iso) {
    document.getElementById('macTimelineTitle').innerHTML = iso + ' &mdash; Marginal $/tCO<sub>2</sub> by SBTi Year';
    const trajA = DATA.trajectories.cheap_ren[iso] || [];
    const trajB = DATA.trajectories.clean_firm_invest[iso] || [];
    // Filter to only points with stepwise_mac
    const ptsA = trajA.filter(d => d.stepwise_mac !== null && d.stepwise_mac !== undefined);
    const ptsB = trajB.filter(d => d.stepwise_mac !== null && d.stepwise_mac !== undefined);
    const labels = ptsA.map(yearLabel);

    if (macTimelineChart) macTimelineChart.destroy();
    macTimelineChart = new Chart(document.getElementById('macTimelineChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Pure Consequential',
                    data: ptsA.map(d => Math.min(d.stepwise_mac, 2000)),
                    backgroundColor: 'rgba(239,68,68,0.7)',
                    borderColor: COLORS.A,
                    borderWidth: 1,
                    borderRadius: 3,
                    barPercentage: 0.85,
                    categoryPercentage: 0.85,
                },
                {
                    label: 'FOAK Investment',
                    data: ptsB.map(d => Math.min(d.stepwise_mac, 2000)),
                    backgroundColor: 'rgba(34,197,94,0.7)',
                    borderColor: COLORS.B,
                    borderWidth: 1,
                    borderRadius: 3,
                    barPercentage: 0.85,
                    categoryPercentage: 0.85,
                }
            ]
        },
        options: {
            ...CHART_DEFAULTS,
            plugins: {
                ...CHART_DEFAULTS.plugins,
                tooltip: {
                    callbacks: {
                        title: ctx => {
                            const idx = ctx[0].dataIndex;
                            return ptsA[idx].year + ' (' + ptsA[idx].threshold + '% CFE)';
                        },
                        label: ctx => {
                            const pts = ctx.datasetIndex === 0 ? ptsA : ptsB;
                            const raw = pts[ctx.dataIndex].stepwise_mac;
                            const val = raw >= 9999 ? 'Infinite' : '$' + Math.round(raw).toLocaleString();
                            return ctx.dataset.label + ': ' + val + '/tCO\u2082';
                        }
                    }
                },
                annotation: undefined,
            },
            scales: {
                x: { ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 }, maxRotation: 55 }, grid: { color: 'rgba(255,255,255,0.06)' } },
                y: {
                    ticks: { color: 'rgba(255,255,255,0.5)', callback: v => '$' + v.toLocaleString() },
                    grid: { color: 'rgba(255,255,255,0.08)' },
                    title: { display: true, text: 'Marginal $/tCO\u2082 (capped $2,000)', color: 'rgba(255,255,255,0.5)' },
                }
            }
        }
    });
}
createIsoSelector('macIsoSelector', 'PJM', renderMacTimeline);
renderMacTimeline('PJM');

// ===== 2. HORIZONTAL STACKED BAR CHARTS (Resources + Gas at each threshold) =====
let deployChartA, deployChartB;
const DEPLOY_RES_ORDER = ['clean_firm', 'ccs_ccgt', 'solar', 'wind', 'hydro', 'battery', 'ldes'];

function renderDeployCharts(iso) {
    document.getElementById('deployTitleA').textContent = iso + ' \u2014 Resources at Each Threshold (TWh)';
    document.getElementById('deployTitleB').textContent = iso + ' \u2014 Resources at Each Threshold (TWh)';

    const trajA = DATA.trajectories.cheap_ren[iso] || [];
    const trajB = DATA.trajectories.clean_firm_invest[iso] || [];
    const labels = trajA.map(d => d.threshold + '%');

    function makeDatasets(traj) {
        const datasets = [];
        DEPLOY_RES_ORDER.forEach(res => {
            datasets.push({
                label: RES_LABELS[res] || res,
                data: traj.map(d => Math.round(d.resource_twh[res] || 0)),
                backgroundColor: 'rgba(' + RES_RGB[res] + ',0.8)',
                borderColor: 'rgba(' + RES_RGB[res] + ',1)',
                borderWidth: 1,
            });
        });
        // Gas as GW converted to a comparable scale: show as TWh-equivalent using 8760h
        // But that distorts scale. Instead show gas as a separate dataset with annotation.
        // We'll add gas as actual GW value in a distinct gray bar.
        datasets.push({
            label: 'Gas Backup (GW)',
            data: traj.map(d => Math.round(d.gas_backup_mw / 1000)),
            backgroundColor: 'rgba(107,114,128,0.5)',
            borderColor: 'rgba(107,114,128,0.8)',
            borderWidth: 1,
            borderDash: [4, 2],
        });
        return datasets;
    }

    const opts = {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { labels: { color: 'rgba(255,255,255,0.7)', font: { size: 10 }, usePointStyle: true, pointStyle: 'rectRounded' } },
            tooltip: {
                callbacks: {
                    label: ctx => {
                        if (ctx.dataset.label.includes('Gas')) {
                            return ctx.dataset.label + ': ' + ctx.parsed.x.toLocaleString() + ' GW';
                        }
                        return ctx.dataset.label + ': ' + ctx.parsed.x.toLocaleString() + ' TWh';
                    }
                }
            }
        },
        scales: {
            x: {
                stacked: true,
                ticks: { color: 'rgba(255,255,255,0.5)' },
                grid: { color: 'rgba(255,255,255,0.06)' },
                title: { display: true, text: 'TWh (Gas in GW)', color: 'rgba(255,255,255,0.5)', font: { size: 10 } },
            },
            y: {
                stacked: true,
                ticks: { color: 'rgba(255,255,255,0.6)', font: { size: 10 } },
                grid: { color: 'rgba(255,255,255,0.06)' },
            }
        }
    };

    if (deployChartA) deployChartA.destroy();
    if (deployChartB) deployChartB.destroy();
    deployChartA = new Chart(document.getElementById('deployChartA'), { type: 'bar', data: { labels, datasets: makeDatasets(trajA) }, options: opts });
    deployChartB = new Chart(document.getElementById('deployChartB'), { type: 'bar', data: { labels, datasets: makeDatasets(trajB) }, options: opts });
}
createIsoSelector('deployIsoSelector', 'PJM', renderDeployCharts);
renderDeployCharts('PJM');

// ===== 3. GAS BACKUP CHART =====
let gasChart;
function renderGasChart(iso) {
    document.getElementById('gasChartTitle').textContent = iso + ' \u2014 Gas Backup Capacity (MW)';
    const trajA = DATA.trajectories.cheap_ren[iso] || [];
    const trajB = DATA.trajectories.clean_firm_invest[iso] || [];
    const labels = trajA.map(yearLabel);

    if (gasChart) gasChart.destroy();
    gasChart = new Chart(document.getElementById('gasChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Pure Consequential',
                    data: trajA.map(d => d.gas_backup_mw),
                    borderColor: COLORS.A85,
                    backgroundColor: COLORS.A_area,
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 5,
                    pointBackgroundColor: COLORS.A,
                    borderWidth: 2.5,
                },
                {
                    label: 'FOAK Investment',
                    data: trajB.map(d => d.gas_backup_mw),
                    borderColor: COLORS.B85,
                    backgroundColor: COLORS.B_fill,
                    fill: 'origin',
                    tension: 0.3,
                    pointRadius: 5,
                    pointBackgroundColor: COLORS.B,
                    borderWidth: 2.5,
                }
            ]
        },
        options: {
            ...CHART_DEFAULTS,
            plugins: {
                ...CHART_DEFAULTS.plugins,
                tooltip: {
                    callbacks: {
                        title: ctx => {
                            const idx = ctx[0].dataIndex;
                            return trajA[idx].year + ' (' + trajA[idx].threshold + '% CFE)';
                        },
                        label: ctx => ctx.dataset.label + ': ' + Math.round(ctx.parsed.y).toLocaleString() + ' MW',
                        afterBody: ctx => {
                            const idx = ctx[0].dataIndex;
                            const gap = trajA[idx].gas_backup_mw - trajB[idx].gas_backup_mw;
                            return gap > 0 ? ['\u0394 Gap: ' + Math.round(gap).toLocaleString() + ' MW avoided'] : [];
                        }
                    }
                }
            },
            scales: {
                x: { ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 }, maxRotation: 55 }, grid: { color: 'rgba(255,255,255,0.06)' } },
                y: {
                    ticks: { color: 'rgba(255,255,255,0.5)', callback: v => (v/1000).toFixed(0) + ' GW' },
                    grid: { color: 'rgba(255,255,255,0.08)' },
                    title: { display: true, text: 'Gas Backup Capacity (MW)', color: 'rgba(255,255,255,0.5)' },
                }
            }
        }
    });
}
createIsoSelector('gasIsoSelector', 'PJM', renderGasChart);
renderGasChart('PJM');

// ===== 4. WYN-PANEL RESOURCE MIX: existing (transparent) + new (saturated) + curtailment (striped) =====

// Create diagonal stripe pattern for curtailment
function createStripePattern(ctx, rgb) {
    const size = 8;
    const pCanvas = document.createElement('canvas');
    pCanvas.width = size; pCanvas.height = size;
    const pCtx = pCanvas.getContext('2d');
    pCtx.strokeStyle = 'rgba(' + rgb + ',0.6)';
    pCtx.lineWidth = 2;
    pCtx.beginPath();
    pCtx.moveTo(0, size); pCtx.lineTo(size, 0);
    pCtx.stroke();
    pCtx.beginPath();
    pCtx.moveTo(-2, 2); pCtx.lineTo(2, -2);
    pCtx.stroke();
    pCtx.beginPath();
    pCtx.moveTo(size - 2, size + 2); pCtx.lineTo(size + 2, size - 2);
    pCtx.stroke();
    return ctx.createPattern(pCanvas, 'repeat');
}

const EXISTING_ORDER = ['clean_firm', 'ccs_ccgt', 'hydro', 'wind', 'solar'];
const NEWBUILD_ORDER = ['solar', 'wind', 'hydro', 'battery', 'ldes', 'ccs_ccgt', 'clean_firm'];

let mixChartA, mixChartB;
function renderMixCharts(iso) {
    document.getElementById('mixTitleA').textContent = iso + ' \u2014 Resource Mix (TWh)';
    document.getElementById('mixTitleB').textContent = iso + ' \u2014 Resource Mix (TWh)';

    const trajA = DATA.trajectories.cheap_ren[iso] || [];
    const trajB = DATA.trajectories.clean_firm_invest[iso] || [];
    const labels = trajA.map(d => d.year + '\n' + d.threshold + '%');
    const demandTwh = DEMAND_TWH[iso];
    const existShares = GRID_MIX || {};
    const isoShares = existShares[iso] || {};

    // Compute existing TWh per resource
    const existingTwh = {};
    for (const res of EXISTING_ORDER) {
        existingTwh[res] = (isoShares[res] || 0) / 100 * demandTwh;
    }

    function makeDatasets(traj, canvasId) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        const datasets = [];

        // 1) Existing resources (transparent/light, bottom of stack)
        for (const res of EXISTING_ORDER) {
            const ex = existingTwh[res] || 0;
            if (ex < 0.5) continue;
            datasets.push({
                label: (RES_LABELS[res] || res) + ' (existing)',
                data: traj.map(() => Math.round(ex)),
                backgroundColor: 'rgba(' + (RES_RGB[res] || '128,128,128') + ',0.25)',
                borderColor: 'rgba(' + (RES_RGB[res] || '128,128,128') + ',0.5)',
                borderWidth: 1,
                stack: 'mix',
            });
        }

        // 2) New build resources (saturated/solid, middle)
        for (const res of NEWBUILD_ORDER) {
            datasets.push({
                label: (RES_LABELS[res] || res) + ' (new)',
                data: traj.map(d => {
                    const total = d.resource_twh[res] || 0;
                    const ex = existingTwh[res] || 0;
                    return Math.max(0, Math.round(total - ex));
                }),
                backgroundColor: 'rgba(' + (RES_RGB[res] || '128,128,128') + ',0.85)',
                borderColor: 'rgba(' + (RES_RGB[res] || '128,128,128') + ',1)',
                borderWidth: 1,
                stack: 'mix',
            });
        }

        // 3) Curtailment (diagonal stripes, top of stack)
        // Curtailed = total procured - threshold-matched demand
        // Allocate proportionally to solar and wind (variable renewables are curtailed)
        const curtailRes = ['solar', 'wind'];
        for (const res of curtailRes) {
            datasets.push({
                label: (RES_LABELS[res] || res) + ' (curtailed)',
                data: traj.map(d => {
                    const totalProcured = Object.values(d.resource_twh).reduce((s, v) => s + v, 0);
                    const matched = d.threshold / 100 * demandTwh;
                    const totalCurtailed = Math.max(0, totalProcured - matched);
                    if (totalCurtailed < 1) return 0;
                    // Allocate to this VRE proportionally
                    const newSol = Math.max(0, (d.resource_twh.solar || 0) - (existingTwh.solar || 0));
                    const newWnd = Math.max(0, (d.resource_twh.wind || 0) - (existingTwh.wind || 0));
                    const totalVRE = newSol + newWnd;
                    if (totalVRE < 1) return 0;
                    const share = res === 'solar' ? newSol / totalVRE : newWnd / totalVRE;
                    return Math.round(totalCurtailed * share);
                }),
                backgroundColor: createStripePattern(ctx, RES_RGB[res]),
                borderColor: 'rgba(' + RES_RGB[res] + ',0.4)',
                borderWidth: 1,
                stack: 'mix',
            });
        }

        return datasets;
    }

    const opts = {
        responsive: true, maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: 'rgba(255,255,255,0.7)', font: { size: 10 },
                    filter: item => {
                        // Collapse legend: show each resource once, plus one "(existing)" and one "(curtailed)" marker
                        if (item.text.includes('(existing)') && !item.text.startsWith('Nuclear'))
                            return false;
                        if (item.text.includes('(curtailed)') && !item.text.startsWith('Solar'))
                            return false;
                        return true;
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: ctx => {
                        const v = ctx.parsed.y;
                        if (v === 0) return null;
                        return ctx.dataset.label + ': ' + v.toLocaleString() + ' TWh';
                    }
                }
            }
        },
        scales: {
            x: { stacked: true, ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 9 }, maxRotation: 55 }, grid: { color: 'rgba(255,255,255,0.06)' } },
            y: { stacked: true, ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.08)' }, title: { display: true, text: 'TWh', color: 'rgba(255,255,255,0.5)' } }
        }
    };

    if (mixChartA) mixChartA.destroy();
    if (mixChartB) mixChartB.destroy();
    mixChartA = new Chart(document.getElementById('mixChartA'), { type: 'bar', data: { labels, datasets: makeDatasets(trajA, 'mixChartA') }, options: opts });
    mixChartB = new Chart(document.getElementById('mixChartB'), { type: 'bar', data: { labels, datasets: makeDatasets(trajB, 'mixChartB') }, options: opts });
}
createIsoSelector('mixIsoSelector', 'PJM', renderMixCharts);
renderMixCharts('PJM');

// ===== 5. EFFECTIVE COST OVERLAY =====
let costChart;
function renderCostChart(iso) {
    document.getElementById('costChartTitle').textContent = iso + ' \u2014 Effective System Cost ($/MWh)';
    const trajA = DATA.trajectories.cheap_ren[iso] || [];
    const trajB = DATA.trajectories.clean_firm_invest[iso] || [];
    const labels = trajA.map(yearLabel);

    if (costChart) costChart.destroy();
    costChart = new Chart(document.getElementById('costChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Pure Consequential',
                    data: trajA.map(d => d.effective_cost),
                    borderColor: COLORS.A85,
                    backgroundColor: COLORS.A_area,
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 5,
                    pointBackgroundColor: COLORS.A,
                    borderWidth: 2.5,
                },
                {
                    label: 'FOAK Investment',
                    data: trajB.map(d => d.effective_cost),
                    borderColor: COLORS.B85,
                    backgroundColor: COLORS.B_fill,
                    fill: 'origin',
                    tension: 0.3,
                    pointRadius: 5,
                    pointBackgroundColor: COLORS.B,
                    borderWidth: 2.5,
                }
            ]
        },
        options: {
            ...CHART_DEFAULTS,
            plugins: {
                ...CHART_DEFAULTS.plugins,
                tooltip: {
                    callbacks: {
                        title: ctx => {
                            const idx = ctx[0].dataIndex;
                            return trajA[idx].year + ' (' + trajA[idx].threshold + '% CFE)';
                        },
                        label: ctx => ctx.dataset.label + ': $' + ctx.parsed.y.toFixed(1) + '/MWh',
                        afterBody: ctx => {
                            const idx = ctx[0].dataIndex;
                            const gap = trajA[idx].effective_cost - trajB[idx].effective_cost;
                            return gap > 0 ? ['\u0394 Savings: $' + gap.toFixed(1) + '/MWh'] : [];
                        }
                    }
                }
            },
            scales: {
                x: { ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 }, maxRotation: 55 }, grid: { color: 'rgba(255,255,255,0.06)' } },
                y: {
                    ticks: { color: 'rgba(255,255,255,0.5)', callback: v => '$' + v },
                    grid: { color: 'rgba(255,255,255,0.08)' },
                    title: { display: true, text: 'Effective $/MWh', color: 'rgba(255,255,255,0.5)' },
                }
            }
        }
    });
}
createIsoSelector('costIsoSelector', 'PJM', renderCostChart);
renderCostChart('PJM');

// ===== 6. CLEAN FIRM DEPLOYMENT CHART =====
let firmChart;
function renderFirmChart(iso) {
    document.getElementById('firmChartTitle').textContent = iso + ' \u2014 Clean Firm + CCS Deployment (TWh)';
    const trajA = DATA.trajectories.cheap_ren[iso] || [];
    const trajB = DATA.trajectories.clean_firm_invest[iso] || [];
    const labels = trajA.map(yearLabel);

    if (firmChart) firmChart.destroy();
    firmChart = new Chart(document.getElementById('firmChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Pure Consequential',
                    data: trajA.map(d => d.firm_total_twh || (d.resource_twh.clean_firm + (d.resource_twh.ccs_ccgt || 0))),
                    borderColor: COLORS.A85,
                    backgroundColor: COLORS.A_fill,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 5,
                    pointBackgroundColor: COLORS.A,
                    borderWidth: 2.5,
                },
                {
                    label: 'FOAK Investment',
                    data: trajB.map(d => d.firm_total_twh || (d.resource_twh.clean_firm + (d.resource_twh.ccs_ccgt || 0))),
                    borderColor: COLORS.B85,
                    backgroundColor: COLORS.B_fill,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 5,
                    pointBackgroundColor: COLORS.B,
                    borderWidth: 2.5,
                }
            ]
        },
        options: {
            ...CHART_DEFAULTS,
            plugins: {
                ...CHART_DEFAULTS.plugins,
                tooltip: {
                    callbacks: {
                        title: ctx => {
                            const idx = ctx[0].dataIndex;
                            return trajA[idx].year + ' (' + trajA[idx].threshold + '% CFE)';
                        },
                        label: ctx => ctx.dataset.label + ': ' + Math.round(ctx.parsed.y) + ' TWh',
                    }
                }
            },
            scales: {
                x: { ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 }, maxRotation: 55 }, grid: { color: 'rgba(255,255,255,0.06)' } },
                y: {
                    ticks: { color: 'rgba(255,255,255,0.5)' },
                    grid: { color: 'rgba(255,255,255,0.08)' },
                    title: { display: true, text: 'Clean Firm + CCS (TWh)', color: 'rgba(255,255,255,0.5)' },
                }
            }
        }
    });
}
createIsoSelector('firmIsoSelector', 'PJM', renderFirmChart);
renderFirmChart('PJM');

// ===== 7. DOMINO TABLES =====
function buildDominoTable(tableId, queue) {
    const table = document.getElementById(tableId);
    if (!table) return;
    let html = '<thead><tr><th>#</th><th>ISO</th><th>Zone</th><th>MAC</th><th>Primary Resource</th><th>&Delta;Gas</th></tr></thead><tbody>';
    let cumCo2 = 0;
    queue.forEach((step, i) => {
        if (i >= 29) return;
        cumCo2 += step.co2_displaced_mt;
        const mac = step.marginal_mac >= 9999 ? '&infin;' : '$' + Math.round(step.marginal_mac).toLocaleString();
        const macClass = step.marginal_mac < 0 ? 'mac-cheap' : step.marginal_mac < 100 ? 'mac-cheap' : step.marginal_mac < 500 ? 'mac-mid' : 'mac-exp';

        const deltas = step.delta_resources;
        const sorted = Object.entries(deltas).sort((a,b) => Math.abs(b[1]) - Math.abs(a[1]));
        let primaryParts = [];
        sorted.forEach(([res, val]) => {
            if (Math.abs(val) < 1) return;
            if (primaryParts.length >= 2) return;
            const name = res.replace('clean_firm','CF').replace('ccs_ccgt','CCS');
            primaryParts.push(name + ' ' + (val > 0 ? '+' : '') + Math.round(val));
        });

        const gasDir = step.delta_gas_mw > 0 ? 'positive' : step.delta_gas_mw < 0 ? 'negative' : '';
        html += `<tr>
            <td class="num">${i+1}</td>
            <td>${step.iso}</td>
            <td>${step.zone_label}</td>
            <td class="${macClass} num">${mac}</td>
            <td>${primaryParts.join(', ')}</td>
            <td class="${gasDir} num">${step.delta_gas_mw > 0 ? '+' : ''}${(step.delta_gas_mw/1000).toFixed(1)}k</td>
        </tr>`;
    });
    html += '</tbody>';
    table.innerHTML = html;
}

buildDominoTable('dominoTableA', DATA.queue_a);

})();
</script>
</body>
</html>
