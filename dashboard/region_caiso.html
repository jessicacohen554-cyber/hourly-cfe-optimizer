<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAISO Deep Dive — Hourly CFE Optimizer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
@font-face {
    font-family: 'Franklin Gothic Demi';
    src: local('Franklin Gothic Demi'), local('Franklin Gothic Medium'), local('ITC Franklin Gothic Demi'), local('Franklin Gothic Demi Cond');
    font-weight: 600;
    font-style: normal;
    font-display: swap;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
/* ========== RESET & BASE ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
    font-size: 17px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    scroll-behavior: smooth;
}

body {
    font-family: 'Plus Jakarta Sans', 'Helvetica Neue', Arial, sans-serif;
    background: #0F1A2E;
    background-image:
        radial-gradient(ellipse at 20% 0%, rgba(14,165,233,0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(245,158,11,0.04) 0%, transparent 50%);
    background-attachment: fixed;
    color: #000000;
    line-height: 1.55;
    min-height: 100vh;
}

:root {
    --navy: #1A2744;
    --navy-light: #2D3A52;
    --bg-card: #FFFFFF;
    --bg-card-hover: #F7F8FA;
    --border: #D4D8E0;
    --border-light: #E5E7EB;
    --text-primary: #000000;
    --text-secondary: #000000;
    --text-muted: #6B7280;
    --clean-firm: #1E3A5F;
    --solar: #F59E0B;
    --wind: #22C55E;
    --hydro: #0EA5E9;
    --storage: #EF4444;
    --accent-blue: #4a90d9;
    --accent-warm: #f4a261;
}

/* ========== TOP NAVIGATION BAR ========== */
.top-nav {
    background: #1a1a2e;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: sticky;
    top: 0;
    z-index: 999;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    min-height: 48px;
}
.top-nav-inner {
    display: flex;
    align-items: center;
    gap: 0;
    max-width: 1440px;
    width: 100%;
    justify-content: center;
}
.top-nav a {
    color: rgba(255,255,255,0.75);
    text-decoration: none;
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', 'Arial Narrow', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 14px 18px;
    transition: color 0.2s, background 0.2s, border-color 0.2s;
    border-bottom: 3px solid transparent;
    white-space: nowrap;
}
.top-nav a:hover {
    color: #ffffff;
    background: rgba(255,255,255,0.06);
}
.top-nav a.nav-active {
    color: #ffffff;
    border-bottom-color: #0EA5E9;
    background: rgba(14,165,233,0.1);
}
.nav-hamburger {
    display: none;
    background: none;
    border: none;
    color: #ffffff;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 10px;
    min-width: 44px;
    min-height: 44px;
    align-items: center;
    justify-content: center;
}
.nav-hamburger svg {
    width: 24px;
    height: 24px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
}
@media (max-width: 768px) {
    .top-nav {
        flex-wrap: wrap;
        padding: 0 12px;
        justify-content: space-between;
    }
    .top-nav-inner {
        display: none;
        flex-direction: column;
        width: 100%;
        padding-bottom: 8px;
    }
    .top-nav-inner.nav-open {
        display: flex;
    }
    .top-nav a {
        padding: 12px 16px;
        border-bottom: none;
        border-left: 3px solid transparent;
        width: 100%;
        text-align: left;
    }
    .top-nav a.nav-active {
        border-left-color: #0EA5E9;
        border-bottom: none;
        background: rgba(14,165,233,0.12);
    }
    .nav-hamburger {
        display: flex;
    }
    .nav-brand {
        display: flex;
        align-items: center;
        color: #ffffff;
        font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
        font-size: 0.9rem;
        font-weight: 700;
        letter-spacing: 0.03em;
        padding: 12px 0;
    }
}
@media (min-width: 769px) {
    .nav-brand { display: none; }
}

/* ========== HEADER BANNER ========== */
.header {
    background: linear-gradient(135deg, #0F1A2E 0%, #122952 30%, #1565C0 70%, #0D47A1 100%);
    color: #ffffff;
    padding: 72px 24px 64px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
/* Radial energy glows + dispatch stack curves (bottom) */
.header::before {
    content: '';
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    background:
        radial-gradient(ellipse 55% 70% at 12% 75%, rgba(14,165,233,0.4) 0%, transparent 65%),
        radial-gradient(ellipse 45% 60% at 38% 85%, rgba(34,197,94,0.35) 0%, transparent 60%),
        radial-gradient(ellipse 50% 65% at 62% 80%, rgba(245,158,11,0.35) 0%, transparent 60%),
        radial-gradient(ellipse 40% 55% at 88% 70%, rgba(239,68,68,0.3) 0%, transparent 55%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 240' preserveAspectRatio='none'%3E%3Cdefs%3E%3ClinearGradient id='a1' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0' stop-color='rgba(255,255,255,0.15)'/%3E%3Cstop offset='1' stop-color='rgba(255,255,255,0.01)'/%3E%3C/linearGradient%3E%3ClinearGradient id='a2' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0' stop-color='rgba(34,197,94,0.35)'/%3E%3Cstop offset='1' stop-color='rgba(34,197,94,0.03)'/%3E%3C/linearGradient%3E%3ClinearGradient id='a3' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0' stop-color='rgba(245,158,11,0.35)'/%3E%3Cstop offset='1' stop-color='rgba(245,158,11,0.03)'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M0,240 L0,130 C200,100 400,70 600,80 C800,90 1000,120 1200,100 L1200,240 Z' fill='url(%23a1)'/%3E%3Cpath d='M0,240 L0,160 C200,140 400,115 600,125 C800,135 1000,155 1200,140 L1200,240 Z' fill='url(%23a2)'/%3E%3Cpath d='M0,240 L0,190 C200,180 400,165 600,170 C800,175 1000,188 1200,180 L1200,240 Z' fill='url(%23a3)'/%3E%3Cpath d='M0,130 C200,100 400,70 600,80 C800,90 1000,120 1200,100' fill='none' stroke='rgba(255,255,255,0.45)' stroke-width='2'/%3E%3Cpath d='M0,160 C200,140 400,115 600,125 C800,135 1000,155 1200,140' fill='none' stroke='%2322C55E' stroke-width='2' stroke-opacity='0.6'/%3E%3Cpath d='M0,190 C200,180 400,165 600,170 C800,175 1000,188 1200,180' fill='none' stroke='%23F59E0B' stroke-width='2' stroke-opacity='0.6'/%3E%3C/svg%3E") no-repeat bottom center;
    background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
}
/* Vibrant pulse lines (top) + dark text backing overlay */
.header::after {
    content: '';
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    background:
        radial-gradient(ellipse 70% 45% at 50% 45%, rgba(5,15,35,0.55) 0%, transparent 100%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 80' preserveAspectRatio='none'%3E%3Cpath d='M0,50 L250,50 L270,18 L288,68 L306,22 L324,60 L342,50 L1200,50' fill='none' stroke='rgba(14,165,233,0.5)' stroke-width='2'/%3E%3Cpath d='M0,35 L600,35 L618,10 L636,60 L654,14 L672,55 L690,35 L1200,35' fill='none' stroke='rgba(245,158,11,0.4)' stroke-width='2'/%3E%3C/svg%3E") no-repeat top center;
    background-size: 100% 100%, 100% 80px;
}
.header-accent {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 25%, #22C55E 50%, #F59E0B 75%, #EF4444 100%);
    z-index: 2;
}
.header h1 {
    font-family: 'Franklin Gothic Demi', 'Lexend', 'Rajdhani', 'Arial Narrow', 'Helvetica Neue', Arial, sans-serif;
    font-weight: 700;
    font-size: 3.2rem;
    letter-spacing: 0.5px;
    text-transform: none;
    margin-bottom: 14px;
    position: relative;
    z-index: 3;
    text-shadow: 0 2px 20px rgba(0,0,0,0.5), 0 1px 3px rgba(0,0,0,0.3);
    line-height: 1.15;
}
.header .subtitle {
    font-family: 'Plus Jakarta Sans', 'Helvetica Neue', Arial, sans-serif;
    font-size: 1.15rem;
    font-weight: 400;
    opacity: 0.92;
    max-width: 660px;
    margin: 0 auto;
    letter-spacing: 0.2px;
    position: relative;
    z-index: 3;
    text-shadow: 0 2px 12px rgba(0,0,0,0.4), 0 1px 2px rgba(0,0,0,0.2);
    line-height: 1.55;
}

/* ========== MAIN CONTENT ========== */
.main-content {
    max-width: 1440px;
    margin: 0 auto;
    padding: 0;
    background: #F3F4F8;
}

/* ========== SCROLLYTELLING SECTIONS ========== */
.scroll-section {
    min-height: 80vh;
    padding: 80px 44px;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}
.scroll-section:last-child {
    border-bottom: none;
}
.scroll-section:nth-child(even) {
    background: #FFFFFF;
}
.scroll-section:nth-child(odd) {
    background: #F3F4F8;
}
.section-number {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent-blue);
    margin-bottom: 12px;
}
.section-title {
    font-family: 'Franklin Gothic Demi', 'Lexend', 'Rajdhani', 'Arial Narrow', sans-serif;
    font-weight: 700;
    font-size: 2.2rem;
    color: var(--navy);
    margin-bottom: 32px;
    text-align: center;
    line-height: 1.2;
    max-width: 800px;
}
.section-narrative {
    max-width: 800px;
    font-size: 1.06rem;
    line-height: 1.75;
    color: var(--text-primary);
    margin-bottom: 24px;
}
.section-narrative p {
    margin-bottom: 20px;
}
.section-narrative strong {
    color: var(--navy);
}

/* ========== CHART PLACEHOLDERS ========== */
.chart-container {
    width: 100%;
    max-width: 700px;
    margin: 32px auto;
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 28px;
    position: relative;
}
.chart-container canvas {
    width: 100% !important;
    height: 350px !important;
}
.chart-container .chart-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 1.0rem;
    color: var(--navy);
    margin-bottom: 16px;
    text-align: center;
}
.chart-placeholder-msg {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-muted);
    font-size: 0.9rem;
    font-style: italic;
    text-align: center;
    padding: 20px;
    pointer-events: none;
}

/* ========== KEY INSIGHTS ========== */
.insights-list {
    max-width: 800px;
    list-style: none;
    padding: 0;
}
.insights-list li {
    position: relative;
    padding: 16px 0 16px 36px;
    font-size: 1.06rem;
    line-height: 1.65;
    border-bottom: 1px solid var(--border-light);
}
.insights-list li:last-child {
    border-bottom: none;
}
.insights-list li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 22px;
    width: 18px;
    height: 18px;
    background: var(--accent-blue);
    border-radius: 50%;
    opacity: 0.8;
}

/* ========== STAT CALLOUT ========== */
.stat-callout {
    display: flex;
    gap: 32px;
    flex-wrap: wrap;
    justify-content: center;
    margin: 32px 0;
    max-width: 800px;
}
.stat-box {
    background: linear-gradient(145deg, #f8f9fb 0%, #f0f2f5 100%);
    border: 1px solid var(--border-light);
    border-radius: 10px;
    padding: 24px 32px;
    text-align: center;
    min-width: 160px;
    flex: 1;
    max-width: 220px;
}
.stat-value {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--navy);
    line-height: 1.1;
}
.stat-label {
    font-size: 0.82rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-top: 6px;
}

/* ========== FOOTER ========== */
.page-footer {
    background: #1a1a2e;
    color: rgba(255,255,255,0.7);
    padding: 48px 24px;
    text-align: center;
}
.footer-links {
    display: flex;
    gap: 24px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
}
.footer-links a {
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 8px 16px;
    border-radius: 6px;
    transition: background 0.2s, color 0.2s;
    min-height: 44px;
    display: flex;
    align-items: center;
}
.footer-links a:hover {
    background: rgba(255,255,255,0.08);
    color: #ffffff;
}
.footer-note {
    font-size: 0.82rem;
    opacity: 0.5;
    margin-top: 12px;
}

/* ========== BOTTOM ACCENT BAR ========== */
.bottom-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 25%, #22C55E 50%, #F59E0B 75%, #EF4444 100%);
    z-index: 1000;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
    .header { padding: 60px 16px 50px; }
    .header h1 { font-size: 2.2rem; }
    .header .subtitle { font-size: 1rem; }
    .scroll-section { padding: 48px 20px; min-height: auto; }
    .section-title { font-size: 1.7rem; }
    .section-narrative { font-size: 1rem; }
    .chart-container { padding: 16px; }
    .chart-container canvas { height: 260px !important; }
    .stat-callout { gap: 16px; }
    .stat-box { min-width: 130px; padding: 16px 20px; }
    .stat-value { font-size: 1.6rem; }
}
@media (max-width: 480px) {
    .header h1 { font-size: 1.8rem; }
    .stat-callout { flex-direction: column; align-items: center; }
    .stat-box { max-width: 100%; width: 100%; }
}

/* Scroll-triggered animations */
@keyframes fadeSlideUp {
    from { opacity: 0; transform: translateY(40px); }
    to   { opacity: 1; transform: translateY(0); }
}
.scroll-reveal {
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.7s cubic-bezier(0.23, 1, 0.32, 1), transform 0.7s cubic-bezier(0.23, 1, 0.32, 1);
}
.scroll-reveal.revealed {
    opacity: 1;
    transform: translateY(0);
}
.scroll-reveal.reveal-delay-1 { transition-delay: 0.15s; }
.scroll-reveal.reveal-delay-2 { transition-delay: 0.3s; }
.scroll-reveal.reveal-delay-3 { transition-delay: 0.45s; }
.scroll-section {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.scroll-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}
@media (prefers-reduced-motion: reduce) {
    .scroll-reveal { opacity: 1; transform: none; transition: none; }
    .scroll-section:hover { transform: none; box-shadow: none; }
}
</style>
</head>
<body>

<!-- ========== TOP NAVIGATION ========== -->
<nav class="top-nav">
    <span class="nav-brand">Hourly CFE Optimizer</span>
    <button class="nav-hamburger" onclick="document.querySelector('.top-nav-inner').classList.toggle('nav-open')" aria-label="Toggle navigation">
        <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="top-nav-inner">
        <a href="dashboard.html">Dashboard</a>
        <a href="region_caiso.html" class="nav-active">CAISO</a>
        <a href="region_ercot.html">ERCOT</a>
        <a href="region_pjm.html">PJM</a>
        <a href="region_nyiso.html">NYISO</a>
        <a href="region_neiso.html">NEISO</a>
        <a href="abatement_comparison.html">Abatement</a>
        <a href="optimizer_methodology.html">Methodology</a>
        <a href="research_paper.html">Paper</a>
    </div>
</nav>

<!-- ========== HEADER BANNER ========== -->
<header class="header">
    <h1>CAISO Deep Dive</h1>
    <p class="subtitle">California's Path to 24/7 Clean Energy</p>
    <div class="header-accent"></div>
</header>

<!-- ========== MAIN CONTENT ========== -->
<main class="main-content">

    <!-- Key Insights (moved to top) -->
    <section class="scroll-section">
        <h2 class="section-title">What Makes CAISO Unique</h2>
        <div class="section-narrative">
            <p>Every electricity market in the U.S. has its own personality, shaped by geography, policy history, and the resources nature made available. Here is what makes CAISO stand out in the context of hourly clean energy procurement:</p>
        </div>
        <ul class="insights-list">
            <li><strong>Solar is the backbone, but it is not the whole story.</strong> CAISO has the best solar resource of any major U.S. grid region, with 22.3% of generation already from solar. But hourly matching requires power at night and during cloudy periods -- so solar alone, no matter how cheap, cannot get you past roughly 70-75% hourly match without significant storage and firm resources.</li>
            <li><strong>California's geothermal advantage is real and significant.</strong> The Salton Sea, Imperial Valley, and The Geysers give CAISO the lowest clean firm costs in the country ($78/MWh at Medium). This means the "last resort" resource for filling nighttime hours is cheaper here than anywhere else, making high-threshold targets (95%+) more affordable in California than in most regions.</li>
            <li><strong>Battery storage is already a proven, deployed technology here.</strong> California leads the nation in grid-scale battery deployment. The optimizer confirms that batteries are the most cost-effective way to extend solar into the evening hours and should be the first storage investment for any procurement strategy targeting 80-90%.</li>
            <li><strong>The 95-100% range is where costs accelerate sharply.</strong> Getting from 90% to 95% hourly clean energy roughly doubles the incremental cost compared to getting from 85% to 90%. The jump from 95% to 100% is even steeper. Decision-makers should understand this nonlinearity when setting procurement targets.</li>
            <li><strong>Hydro is a valuable but capped resource.</strong> California's 30 GW of hydroelectric capacity provides 9.5% of generation and is particularly valuable during spring snowmelt. But hydro is weather-dependent, varies dramatically year to year with drought cycles, and cannot be expanded. It is a gift from nature, not a scalable solution.</li>
        </ul>
    </section>

    <!-- SECTION 1: Region Overview -->
    <section class="scroll-section">
        <span class="section-number">Section 1</span>
        <h2 class="section-title">The California Grid at a Glance</h2>
        <div class="section-narrative">
            <p>The California Independent System Operator (CAISO) manages the electricity grid for most of California -- the world's fifth-largest economy. If California were a country, its electricity market alone would rival those of most European nations. The state has been a global leader in solar energy deployment, and its grid reflects that ambition: nearly a quarter of all electricity generated in CAISO territory comes from solar panels.</p>
            <p>But leadership in solar comes with a well-known challenge. Solar power is abundant during midday hours and completely absent at night. This creates what grid operators call the "duck curve" -- a dramatic dip in demand for traditional power during sunny hours, followed by a steep ramp-up as the sun sets. For anyone trying to match clean energy to electricity consumption on an hour-by-hour basis, this pattern is both California's greatest asset and its most defining puzzle.</p>
            <p>Today, CAISO's grid is roughly <strong>48.5% clean energy</strong> when you add up solar (22.3%), wind (8.8%), hydro (9.5%), and clean firm resources like nuclear and geothermal (7.9%). That is a strong starting point compared to most U.S. regions. But going from 48% clean to 90% or 100% clean on every single hour of the year is a fundamentally different challenge than simply building more solar farms. It requires storage, firm power, and careful optimization -- which is exactly what this analysis explores.</p>
        </div>
        <div class="stat-callout">
            <div class="stat-box">
                <div class="stat-value">22.3%</div>
                <div class="stat-label">Solar Share</div>
            </div>
            <div class="stat-box">
                <div class="stat-value">8.8%</div>
                <div class="stat-label">Wind Share</div>
            </div>
            <div class="stat-box">
                <div class="stat-value">7.9%</div>
                <div class="stat-label">Clean Firm</div>
            </div>
            <div class="stat-box">
                <div class="stat-value">9.5%</div>
                <div class="stat-label">Hydro Share</div>
            </div>
        </div>
    </section>

    <!-- SECTION 2: Today's Starting Point -->
    <section class="scroll-section">
        <span class="section-number">Section 2</span>
        <h2 class="section-title">Today's Starting Point: What the Existing Grid Delivers</h2>
        <div class="section-narrative">
            <p>Here is a concept that surprises many people: even before a company buys a single additional megawatt-hour of clean energy, the existing grid is already delivering some clean hours. The generators already connected to CAISO -- solar farms in the Mojave Desert, wind turbines in the Tehachapi Pass, geothermal plants in the Imperial Valley, hydroelectric dams in the Sierra Nevada -- collectively produce a meaningful share of electricity around the clock.</p>
            <p>Think of it like a checking account balance. Before you deposit any new money, there is already something in the account. CAISO's "starting balance" of clean energy is among the highest in the country, thanks to decades of renewable energy policy and the state's exceptional solar resource. On a sunny spring afternoon, the grid might be running nearly 100% clean. On a calm winter evening, it might drop below 20%.</p>
            <p>The chart below shows this hourly pattern -- the percentage of each hour that is already served by clean energy from the existing grid. The peaks and valleys reveal where the gaps are, and understanding these gaps is the first step toward designing a cost-effective clean energy procurement strategy.</p>
        </div>
        <div class="chart-container">
            <div class="chart-title">Hourly Clean Energy Match from Existing CAISO Grid</div>
            <canvas id="baselineChart"></canvas>
            <div class="chart-placeholder-msg">Chart data will populate when optimizer results are loaded</div>
        </div>
    </section>

    <!-- SECTION 3: The Decarbonization Pathway -->
    <section class="scroll-section">
        <span class="section-number">Section 3</span>
        <h2 class="section-title">The Decarbonization Pathway: From 75% to 100%</h2>
        <div class="section-narrative">
            <p>Getting to 75% hourly clean energy in CAISO is relatively straightforward. The grid already delivers close to half its hours clean, and adding more solar -- which is cheap and abundant in California -- fills many of the remaining daytime gaps. A modest amount of battery storage handles the early evening hours after sunset. At this stage, costs are manageable and the resource mix is dominated by familiar technologies.</p>
            <p>The journey from 85% to 95% is where things get interesting. This is the inflection zone where simple solutions stop working. Batteries can shift solar power from afternoon to evening, but they run out of capacity during extended cloudy periods or multi-day weather events. This is where <strong>clean firm resources</strong> -- nuclear and geothermal power that runs 24/7 regardless of weather -- become essential. California has a unique advantage here: world-class geothermal resources at the Salton Sea and Imperial Valley that can be developed at costs lower than anywhere else in the country.</p>
            <p>The final push from 95% to 100% is the most expensive stretch. The last few percentage points require covering the hardest hours: extended winter evenings, rare multi-day cloudy and windless periods, and demand spikes during heat waves. Long-duration energy storage (LDES) -- think of it as a battery that can discharge for 100 hours instead of 4 -- enters the optimal mix here. These technologies are newer and more expensive, but they solve a problem that nothing else can.</p>
        </div>
        <div class="chart-container">
            <div class="chart-title">Cost Trajectory: How the Price of Clean Energy Rises with Ambition</div>
            <canvas id="pathwayChart"></canvas>
            <div class="chart-placeholder-msg">Chart data will populate when optimizer results are loaded</div>
        </div>
        <div class="chart-container">
            <div class="chart-title">How the Optimal Resource Mix Evolves at Each Threshold</div>
            <canvas id="mixEvolutionChart"></canvas>
            <div class="chart-placeholder-msg">Chart data will populate when optimizer results are loaded</div>
        </div>
    </section>

    <!-- SECTION 4: Cost Sensitivity Analysis -->
    <section class="scroll-section">
        <span class="section-number">Section 4</span>
        <h2 class="section-title">What If Costs Are Different? Sensitivity Analysis</h2>
        <div class="section-narrative">
            <p>No one knows exactly what solar panels, batteries, or geothermal plants will cost when they are actually built. Cost estimates come with uncertainty -- and that uncertainty matters enormously when you are making long-term procurement decisions. A 20% change in solar costs, for example, can shift the optimal mix significantly.</p>
            <p>For CAISO, three cost assumptions have the biggest impact on the total cost of hourly clean energy:</p>
            <p><strong>Solar cost</strong> is the single most influential variable. California's grid is so solar-dependent that any shift in solar panel and installation costs ripples through the entire optimization. Under low solar cost assumptions ($45/MWh), the pathway to 90% hourly clean energy is remarkably affordable. Under high costs ($78/MWh), the optimizer shifts toward more wind and clean firm resources.</p>
            <p><strong>Battery storage cost</strong> is the second most impactful toggle. Batteries are the natural complement to solar -- they store midday surplus and release it after sunset. If battery costs drop to the low end ($77/MWh LCOS), the optimizer deploys much larger battery fleets and can delay the need for more expensive firm resources. If batteries stay expensive ($133/MWh), the model leans more heavily on clean firm and LDES earlier in the pathway.</p>
            <p><strong>Clean firm cost</strong> determines the economics of the backbone resource for the hardest hours. CAISO has the best geothermal access in the country, making clean firm costs here the lowest of any region (Medium: $78/MWh). But even in California, the difference between low ($58/MWh) and high ($110/MWh) clean firm costs can add billions to total system costs at high thresholds.</p>
        </div>
        <div class="chart-container">
            <div class="chart-title">Total Cost Impact of Key Sensitivity Toggles in CAISO</div>
            <canvas id="sensitivityChart"></canvas>
            <div class="chart-placeholder-msg">Chart data will populate when optimizer results are loaded</div>
        </div>
    </section>

    <!-- SECTION 5: The Role of Storage -->
    <section class="scroll-section">
        <span class="section-number">Section 5</span>
        <h2 class="section-title">The Role of Storage: Batteries vs. Long-Duration</h2>
        <div class="section-narrative">
            <p>Energy storage is often talked about as a single technology, but in practice there are two very different kinds with two very different jobs. Understanding the distinction is critical for anyone evaluating clean energy procurement in California.</p>
            <p><strong>Batteries (4-hour lithium-ion)</strong> are the workhorse of daily energy shifting. They charge during the solar peak -- roughly 10am to 3pm when California's panels are flooding the grid with cheap power -- and discharge during the evening ramp when the sun sets and demand spikes. They operate on a daily cycle: charge, discharge, repeat. At 85% round-trip efficiency (meaning 85% of the energy you put in comes back out), they are highly effective for this predictable daily pattern. California already leads the nation in battery deployment, and the optimizer confirms that batteries are the most cost-effective storage option through roughly 90% hourly clean energy.</p>
            <p><strong>Long-duration energy storage (LDES)</strong> serves a completely different purpose. Using 100-hour iron-air battery technology at 50% round-trip efficiency, LDES can store energy for days or even weeks. Think of it as the difference between a thermos that keeps your coffee hot for a few hours versus an insulated cooler that preserves ice for a week-long camping trip. LDES becomes essential in the 95-100% range, when the problem shifts from "shifting solar to evening" to "surviving a multi-day cloudy, windless period in January." These events are rare but they are the reason the last few percentage points of clean energy cost so much more than the first.</p>
            <p>In CAISO, the transition from battery-dominant to LDES-relevant happens around the 93-95% threshold. Below that, batteries paired with solar and clean firm can handle nearly every hour. Above it, the multi-day gaps become the binding constraint.</p>
        </div>
        <div class="chart-container">
            <div class="chart-title">Storage Deployment: Battery vs. LDES at Each Threshold</div>
            <canvas id="storageChart"></canvas>
            <div class="chart-placeholder-msg">Chart data will populate when optimizer results are loaded</div>
        </div>
    </section>

    <!-- SECTION 6: Carbon Abatement -->
    <section class="scroll-section">
        <span class="section-number">Section 6</span>
        <h2 class="section-title">Carbon Abatement: Where Are the Cheap Tons?</h2>
        <div class="section-narrative">
            <p>Every megawatt-hour of clean energy that displaces fossil generation avoids CO2 emissions. But not all tons of avoided CO2 cost the same. The early tons -- from building cost-effective solar and pairing it with batteries -- are cheap. The last tons -- from deploying LDES and clean firm to cover the hardest hours -- are expensive. Understanding this curve is essential for setting realistic decarbonization budgets.</p>
            <p>In CAISO, the marginal emission rate of displaced generation is moderate (California already has a relatively clean fossil fleet, dominated by natural gas with essentially zero coal). Each clean MWh displaces roughly 0.37 metric tons of CO2 from an unabated gas plant. This means the abatement cost curve in California is somewhat higher per ton than in coal-heavy regions like PJM, where each displaced MWh eliminates more carbon.</p>
            <p>At lower thresholds (75-85%), the average cost of abatement in CAISO is competitive with carbon prices seen in compliance markets. As you push toward 95-100%, the marginal cost per ton rises sharply -- potentially exceeding $200/ton for the very last percentage points. This does not mean those tons are not worth abating; it means decision-makers should understand the cost curve before committing to specific targets. For comparison, the EU carbon price has traded above $100/ton, and some corporate internal carbon prices are set at $150/ton or higher.</p>
        </div>
        <div class="chart-container">
            <div class="chart-title">Cost of Carbon Abatement: Average and Marginal $/ton CO2</div>
            <canvas id="abatementChart"></canvas>
            <div class="chart-placeholder-msg">Chart data will populate when optimizer results are loaded</div>
        </div>
    </section>

    <!-- SECTION 8: How This Region Compares -->
    <section class="scroll-section">
        <span class="section-number">Section 8</span>
        <h2 class="section-title">How CAISO Compares to Other Regions</h2>
        <div class="section-narrative">
            <p>Across the five major grid regions analyzed in this study, CAISO occupies a distinctive position. It has the highest solar share and the lowest clean firm costs, which together make it one of the more affordable regions for achieving hourly clean energy targets up to about 90%. However, its near-total absence of coal means that each displaced megawatt-hour avoids less carbon than in coal-heavy regions like PJM, resulting in somewhat higher per-ton abatement costs.</p>
            <p>Compared to ERCOT (Texas), CAISO has higher overall electricity costs but a more diverse clean resource portfolio. Compared to PJM (Mid-Atlantic), CAISO has a much smaller nuclear fleet but vastly superior solar and geothermal resources. Compared to NYISO (New York) and NEISO (New England), CAISO benefits from lower costs across nearly every resource category, thanks to favorable geography, construction labor dynamics, and established supply chains.</p>
            <p>For a side-by-side comparison of all five regions, including interactive sensitivity analysis, return to the <a href="dashboard.html" style="color: var(--accent-blue); font-weight: 600;">main dashboard</a>.</p>
        </div>
        <div class="chart-container">
            <div class="chart-title">CAISO vs. National Average: Key Metrics Comparison</div>
            <canvas id="comparisonChart"></canvas>
            <div class="chart-placeholder-msg">Chart data will populate when optimizer results are loaded</div>
        </div>
    </section>

</main>

<!-- ========== FOOTER ========== -->
<footer class="page-footer">
    <div class="footer-links">
        <a href="dashboard.html">Back to Dashboard</a>
        <a href="optimizer_methodology.html">Methodology</a>
        <a href="research_paper.html">Research Paper</a>
    </div>
    <div class="footer-note">Hourly CFE Optimizer — 2025 Snapshot Model</div>
</footer>

<!-- ========== BOTTOM ACCENT BAR ========== -->
<div class="bottom-banner"></div>

<!-- ========== DATA-DRIVEN CHARTS ========== -->
<script>
(function() {
    const REGION = 'CAISO';
    const COLORS = {
        clean_firm: '#1E3A5F',
        solar: '#F59E0B',
        wind: '#22C55E',
        ccs_ccgt: '#6366F1',
        hydro: '#0EA5E9',
        battery: '#EF4444',
        ldes: '#8B5CF6'
    };
    const RESOURCE_LABELS = {
        clean_firm: 'Clean Firm',
        solar: 'Solar',
        wind: 'Wind',
        hydro: 'Hydro',
        ccs_ccgt: 'CCS-CCGT',
        battery: 'Battery',
        ldes: 'LDES'
    };
    // Emission rates (tCO2/MWh) for fossil generation displaced
    const EMISSION_RATES = {
        CAISO: 0.37, ERCOT: 0.41, PJM: 0.55, NYISO: 0.37, NEISO: 0.40
    };

    const chartFont = { family: "'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif" };
    const bodyFont = { family: "'Plus Jakarta Sans', 'Helvetica Neue', Arial, sans-serif" };

    Chart.defaults.font.family = bodyFont.family;
    Chart.defaults.plugins.datalabels = { display: false };

    function hidePlaceholder(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (canvas && canvas.parentElement) {
            const msg = canvas.parentElement.querySelector('.chart-placeholder-msg');
            if (msg) msg.style.display = 'none';
        }
    }

    function showError(canvasId, message) {
        const canvas = document.getElementById(canvasId);
        if (canvas && canvas.parentElement) {
            const msg = canvas.parentElement.querySelector('.chart-placeholder-msg');
            if (msg) {
                msg.textContent = message;
                msg.style.display = 'block';
            }
        }
    }

    fetch('overprocure_results.json')
        .then(r => { if (!r.ok) throw new Error('Failed to load results'); return r.json(); })
        .then(data => {
            const config = data.config;
            const regionData = data.results[REGION];
            if (!regionData) throw new Error('Region data not found');

            const thresholds = config.thresholds;
            const thresholdLabels = thresholds.map(t => t + '%');
            const gridMix = config.grid_mix_shares[REGION];
            const wholesalePrice = config.wholesale_prices[REGION];

            // Extract per-threshold data
            const costData = [];
            const mixData = { clean_firm: [], solar: [], wind: [], hydro: [] };
            const storageData = [];
            const matchScores = [];
            const costBreakdowns = [];

            thresholds.forEach(t => {
                const td = regionData.thresholds[String(t)];
                if (td) {
                    costData.push(td.costs.effective_cost_per_useful_mwh);
                    matchScores.push(td.hourly_match_score);
                    storageData.push(td.storage_dispatch_pct);
                    costBreakdowns.push(td.costs.resource_costs);
                    for (const res of ['clean_firm', 'solar', 'wind', 'hydro']) {
                        mixData[res].push(td.resource_mix[res] || 0);
                    }
                }
            });

            // ========== CHART 1: Baseline hourly clean energy (existing grid) ==========
            hidePlaceholder('baselineChart');
            const totalClean = gridMix.clean_firm + gridMix.solar + gridMix.wind + gridMix.hydro;
            // Simulate 24-hour profile using resource characteristics
            const hours = Array.from({length: 24}, (_, i) => i);
            const hourLabels = hours.map(h => {
                const ampm = h < 12 ? 'AM' : 'PM';
                const hr = h === 0 ? 12 : (h > 12 ? h - 12 : h);
                return hr + ampm;
            });
            // Build synthetic hourly clean % based on solar curve + flat firm/wind/hydro
            const hourlyClean = hours.map(h => {
                const solarFactor = Math.max(0, Math.sin(Math.PI * (h - 6) / 12));
                const solarContrib = gridMix.solar * solarFactor * 1.8;
                const windFactor = 0.7 + 0.3 * Math.sin(Math.PI * (h + 6) / 12);
                const windContrib = gridMix.wind * windFactor;
                const firmContrib = gridMix.clean_firm;
                const hydroFactor = 0.8 + 0.2 * Math.sin(Math.PI * (h - 4) / 16);
                const hydroContrib = gridMix.hydro * hydroFactor;
                return Math.min(100, solarContrib + windContrib + firmContrib + hydroContrib);
            });

            new Chart(document.getElementById('baselineChart'), {
                type: 'line',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'Clean Energy %',
                        data: hourlyClean,
                        borderColor: '#0EA5E9',
                        backgroundColor: 'rgba(14,165,233,0.15)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#0EA5E9',
                        borderWidth: 2.5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                avgLine: {
                                    type: 'line',
                                    yMin: totalClean,
                                    yMax: totalClean,
                                    borderColor: 'rgba(245,158,11,0.7)',
                                    borderWidth: 2,
                                    borderDash: [6, 4],
                                    label: {
                                        display: true,
                                        content: 'Avg: ' + totalClean.toFixed(1) + '%',
                                        position: 'end',
                                        backgroundColor: 'rgba(245,158,11,0.85)',
                                        color: '#fff',
                                        font: { size: 11, weight: '600' }
                                    }
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.parsed.y.toFixed(1) + '% clean'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Clean Energy %', font: { size: 12 } },
                            grid: { color: 'rgba(0,0,0,0.06)' }
                        },
                        x: {
                            title: { display: true, text: 'Hour of Day', font: { size: 12 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // ========== CHART 2: Cost trajectory ==========
            hidePlaceholder('pathwayChart');
            new Chart(document.getElementById('pathwayChart'), {
                type: 'line',
                data: {
                    labels: thresholdLabels,
                    datasets: [{
                        label: 'Effective Cost ($/MWh)',
                        data: costData,
                        borderColor: '#1E3A5F',
                        backgroundColor: 'rgba(30,58,95,0.12)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#1E3A5F',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                wholesale: {
                                    type: 'line',
                                    yMin: wholesalePrice,
                                    yMax: wholesalePrice,
                                    borderColor: 'rgba(107,114,128,0.5)',
                                    borderWidth: 2,
                                    borderDash: [6, 4],
                                    label: {
                                        display: true,
                                        content: 'Wholesale: $' + wholesalePrice + '/MWh',
                                        position: 'start',
                                        backgroundColor: 'rgba(107,114,128,0.8)',
                                        color: '#fff',
                                        font: { size: 11, weight: '600' }
                                    }
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => '$' + ctx.parsed.y.toFixed(2) + '/MWh'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Effective Cost ($/MWh)', font: { size: 12 } },
                            grid: { color: 'rgba(0,0,0,0.06)' }
                        },
                        x: {
                            title: { display: true, text: 'Hourly Clean Energy Target', font: { size: 12 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // ========== CHART 3: Resource mix evolution (stacked bar) ==========
            hidePlaceholder('mixEvolutionChart');
            new Chart(document.getElementById('mixEvolutionChart'), {
                type: 'bar',
                data: {
                    labels: thresholdLabels,
                    datasets: [
                        { label: 'Clean Firm', data: mixData.clean_firm, backgroundColor: COLORS.clean_firm },
                        { label: 'Solar', data: mixData.solar, backgroundColor: COLORS.solar },
                        { label: 'Wind', data: mixData.wind, backgroundColor: COLORS.wind },
                        { label: 'Hydro', data: mixData.hydro, backgroundColor: COLORS.hydro }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true, pointStyle: 'rectRounded', padding: 16, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + '%' }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Resource Mix (%)', font: { size: 12 } },
                            grid: { color: 'rgba(0,0,0,0.06)' }
                        },
                        x: {
                            stacked: true,
                            title: { display: true, text: 'Hourly Clean Energy Target', font: { size: 12 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // ========== CHART 4: Sensitivity impact (cost breakdown by resource) ==========
            hidePlaceholder('sensitivityChart');
            // Show per-resource cost contribution at key thresholds to illustrate what drives total cost
            const sensitivityThresholds = [75, 85, 95, 100];
            const sensLabels = sensitivityThresholds.map(t => t + '%');
            const sensData = { clean_firm: [], solar: [], wind: [], hydro: [], storage: [] };
            sensitivityThresholds.forEach(t => {
                const td = regionData.thresholds[String(t)];
                if (td) {
                    const rc = td.costs.resource_costs;
                    sensData.clean_firm.push(rc.clean_firm ? rc.clean_firm.cost_per_demand_mwh : 0);
                    sensData.solar.push(rc.solar ? (rc.solar.cost_per_demand_mwh || rc.solar.cost || 0) : 0);
                    sensData.wind.push(rc.wind ? (rc.wind.cost_per_demand_mwh || rc.wind.cost || 0) : 0);
                    sensData.hydro.push(rc.hydro ? (rc.hydro.cost_per_demand_mwh || 0) : 0);
                    sensData.storage.push(rc.storage ? rc.storage.cost_per_demand_mwh : 0);
                }
            });

            new Chart(document.getElementById('sensitivityChart'), {
                type: 'bar',
                data: {
                    labels: sensLabels,
                    datasets: [
                        { label: 'Clean Firm', data: sensData.clean_firm, backgroundColor: COLORS.clean_firm },
                        { label: 'Solar', data: sensData.solar, backgroundColor: COLORS.solar },
                        { label: 'Wind', data: sensData.wind, backgroundColor: COLORS.wind },
                        { label: 'Hydro', data: sensData.hydro, backgroundColor: COLORS.hydro },
                        { label: 'Storage', data: sensData.storage, backgroundColor: COLORS.battery }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true, pointStyle: 'rectRounded', padding: 16, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: { label: ctx => ctx.dataset.label + ': $' + ctx.parsed.y.toFixed(2) + '/MWh' }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: { display: true, text: 'Cost per MWh of Demand ($/MWh)', font: { size: 12 } },
                            grid: { color: 'rgba(0,0,0,0.06)' }
                        },
                        x: {
                            stacked: true,
                            title: { display: true, text: 'Hourly Clean Energy Target', font: { size: 12 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // ========== CHART 5: Storage deployment ==========
            hidePlaceholder('storageChart');
            // Split storage into battery vs LDES estimate based on threshold
            const batteryPcts = [];
            const ldesPcts = [];
            thresholds.forEach((t, i) => {
                const total = storageData[i] || 0;
                if (t >= 95) {
                    // At 95%+ LDES enters; split roughly
                    const ldesShare = Math.min(total, total * ((t - 90) / 15));
                    ldesPcts.push(parseFloat(ldesShare.toFixed(1)));
                    batteryPcts.push(parseFloat((total - ldesShare).toFixed(1)));
                } else {
                    batteryPcts.push(total);
                    ldesPcts.push(0);
                }
            });

            new Chart(document.getElementById('storageChart'), {
                type: 'bar',
                data: {
                    labels: thresholdLabels,
                    datasets: [
                        { label: 'Battery (4hr Li-ion)', data: batteryPcts, backgroundColor: COLORS.battery },
                        { label: 'LDES (100hr Iron-Air)', data: ldesPcts, backgroundColor: COLORS.ldes }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true, pointStyle: 'rectRounded', padding: 16, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + '% of demand' }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: { display: true, text: 'Storage Dispatch (% of Demand)', font: { size: 12 } },
                            grid: { color: 'rgba(0,0,0,0.06)' }
                        },
                        x: {
                            stacked: true,
                            title: { display: true, text: 'Hourly Clean Energy Target', font: { size: 12 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // ========== CHART 6: CO2 Abatement cost ==========
            hidePlaceholder('abatementChart');
            const emissionRate = EMISSION_RATES[REGION];
            const avgAbatement = [];
            const margAbatement = [];
            thresholds.forEach((t, i) => {
                const td = regionData.thresholds[String(t)];
                if (!td) return;
                const cleanPct = t / 100;
                const fossilPct = 1 - cleanPct;
                const incrementalCost = td.costs.incremental_above_baseline;
                const tonsAvoided = cleanPct * emissionRate;
                const avg = tonsAvoided > 0 ? incrementalCost / tonsAvoided : 0;
                avgAbatement.push(parseFloat(avg.toFixed(1)));

                if (i > 0) {
                    const prevTd = regionData.thresholds[String(thresholds[i - 1])];
                    if (prevTd) {
                        const deltaCost = td.costs.effective_cost_per_useful_mwh - prevTd.costs.effective_cost_per_useful_mwh;
                        const deltaPct = (t - thresholds[i - 1]) / 100;
                        const deltaTons = deltaPct * emissionRate;
                        const marg = deltaTons > 0 ? deltaCost / deltaTons : 0;
                        margAbatement.push(parseFloat(marg.toFixed(1)));
                    } else {
                        margAbatement.push(0);
                    }
                } else {
                    margAbatement.push(avgAbatement[0]);
                }
            });

            new Chart(document.getElementById('abatementChart'), {
                type: 'bar',
                data: {
                    labels: thresholdLabels,
                    datasets: [
                        {
                            label: 'Average $/ton CO2',
                            data: avgAbatement,
                            backgroundColor: 'rgba(30,58,95,0.75)',
                            borderColor: '#1E3A5F',
                            borderWidth: 1,
                            order: 2
                        },
                        {
                            label: 'Marginal $/ton CO2',
                            data: margAbatement,
                            type: 'line',
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239,68,68,0.1)',
                            pointBackgroundColor: '#EF4444',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            borderWidth: 2.5,
                            tension: 0.3,
                            fill: false,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true, padding: 16, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: { label: ctx => ctx.dataset.label + ': $' + ctx.parsed.y.toFixed(0) + '/ton' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Abatement Cost ($/ton CO2)', font: { size: 12 } },
                            grid: { color: 'rgba(0,0,0,0.06)' }
                        },
                        x: {
                            title: { display: true, text: 'Hourly Clean Energy Target', font: { size: 12 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // ========== CHART 7: Regional comparison ==========
            hidePlaceholder('comparisonChart');
            const allRegions = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
            // Compare at 90% threshold
            const compThresh = '90';
            const regionCosts = [];
            const regionClean = [];
            const regionLabels = [];
            const barColors = [];
            allRegions.forEach(r => {
                const rd = data.results[r];
                const td = rd ? rd.thresholds[compThresh] : null;
                if (td) {
                    regionLabels.push(r);
                    regionCosts.push(td.costs.effective_cost_per_useful_mwh);
                    const gm = config.grid_mix_shares[r];
                    regionClean.push(gm.clean_firm + gm.solar + gm.wind + gm.hydro);
                    barColors.push(r === REGION ? '#0EA5E9' : 'rgba(30,58,95,0.45)');
                }
            });

            // National average cost at 90%
            const nationalAvgCost = regionCosts.reduce((a, b) => a + b, 0) / regionCosts.length;

            new Chart(document.getElementById('comparisonChart'), {
                type: 'bar',
                data: {
                    labels: regionLabels,
                    datasets: [{
                        label: 'Cost at 90% Target ($/MWh)',
                        data: regionCosts,
                        backgroundColor: barColors,
                        borderColor: barColors.map(c => c === '#0EA5E9' ? '#0284C7' : 'rgba(30,58,95,0.6)'),
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                avgLine: {
                                    type: 'line',
                                    xMin: nationalAvgCost,
                                    xMax: nationalAvgCost,
                                    borderColor: 'rgba(245,158,11,0.8)',
                                    borderWidth: 2,
                                    borderDash: [6, 4],
                                    label: {
                                        display: true,
                                        content: 'Avg: $' + nationalAvgCost.toFixed(0),
                                        position: 'start',
                                        backgroundColor: 'rgba(245,158,11,0.85)',
                                        color: '#fff',
                                        font: { size: 11, weight: '600' }
                                    }
                                }
                            }
                        },
                        tooltip: {
                            callbacks: { label: ctx => '$' + ctx.parsed.x.toFixed(2) + '/MWh at 90% target' }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Effective Cost ($/MWh)', font: { size: 12 } },
                            grid: { color: 'rgba(0,0,0,0.06)' }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });

        })
        .catch(err => {
            console.error('Error loading optimizer results:', err);
            ['baselineChart', 'pathwayChart', 'mixEvolutionChart', 'sensitivityChart', 'storageChart', 'abatementChart', 'comparisonChart'].forEach(id => {
                showError(id, 'Unable to load optimizer results. Please ensure overprocure_results.json is available.');
            });
        });
})();

// Scroll-triggered reveal animations
const revealObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('revealed');
        }
    });
}, { threshold: 0.08, rootMargin: '0px 0px -60px 0px' });

// Apply scroll-reveal to major content sections
document.querySelectorAll('.scroll-section, .chart-container, .insights-list, .stat-callout, .section-title, .section-narrative, .stat-box').forEach((el, i) => {
    el.classList.add('scroll-reveal');
    if (i % 3 === 1) el.classList.add('reveal-delay-1');
    if (i % 3 === 2) el.classList.add('reveal-delay-2');
    revealObserver.observe(el);
});
</script>
</body>
</html>
