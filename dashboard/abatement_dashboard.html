<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The 8,760 Problem — Carbon Abatement Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles/shared.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
/* Page-specific background */
body { background: #F3F4F8; }

/* ========== DASHBOARD LAYOUT ========== */
.dashboard-wrap {
    max-width: 1320px;
    margin: 0 auto;
    padding: 32px 24px 48px;
}
.page-title-section {
    text-align: center;
    margin-bottom: 28px;
}
.page-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', 'Arial Narrow', sans-serif;
    font-size: 2.2rem;
    font-weight: 800;
    color: #DC2626;
    margin-bottom: 10px;
    letter-spacing: -0.5px;
    line-height: 1.2;
}
.page-intro {
    font-size: 0.95rem;
    color: #374151;
    line-height: 1.7;
    max-width: 800px;
    margin: 0 auto;
}

/* ========== CONTROLS PANEL ========== */
.controls-panel {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 14px;
    padding: 28px 32px;
    margin-bottom: 28px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.controls-panel-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--navy);
    margin-bottom: 4px;
}
.controls-panel-subtitle {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 20px;
}
.controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
}
.ctrl-group label {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--navy);
    display: block;
    margin-bottom: 8px;
    letter-spacing: 0.03em;
}
.ctrl-group .info-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: rgba(74,144,217,0.1);
    color: var(--accent-blue);
    font-size: 0.75rem;
    font-weight: 700;
    cursor: help;
    margin-left: 4px;
    vertical-align: middle;
}
.ctrl-toggle {
    display: flex;
    gap: 0;
    border: 2px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
}
.ctrl-toggle button {
    flex: 1;
    padding: 8px 14px;
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    border: none;
    background: #fff;
    color: var(--navy);
    cursor: pointer;
    transition: all 0.2s;
    min-height: 44px;
}
.ctrl-toggle button:not(:last-child) {
    border-right: 1px solid var(--border-light);
}
.ctrl-toggle button:hover {
    background: rgba(74,144,217,0.06);
}
.ctrl-toggle button.active {
    background: var(--navy);
    color: #fff;
}

/* ========== SUMMARY STRIP ========== */
.summary-strip {
    background: linear-gradient(135deg, rgba(14,165,233,0.06), rgba(233,30,99,0.04));
    border: 2px solid rgba(14,165,233,0.15);
    border-radius: 12px;
    padding: 18px 24px;
    margin-top: 20px;
    font-size: 0.9rem;
    color: #374151;
    line-height: 1.65;
    transition: opacity 0.3s;
}
.summary-strip strong { color: var(--navy); }

/* ========== PER-REGION ENVELOPE GRID ========== */
.envelope-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px; margin: 8px 0;
}
.envelope-card {
    background: #F8F9FB; border: 1px solid var(--border-light); border-radius: 10px;
    padding: 14px; border-top: 3px solid #ccc; position: relative;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
}
.envelope-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.envelope-card-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.88rem; font-weight: 700; color: var(--navy); margin-bottom: 2px;
    display: flex; align-items: center; gap: 6px;
}
.envelope-card-subtitle {
    font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;
}
.envelope-card canvas { width: 100% !important; height: 180px !important; }

/* ========== CHART GRID ========== */
.chart-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 28px;
}
.chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.chart-card-full {
    grid-column: 1 / -1;
}
.chart-card-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--navy);
    margin-bottom: 14px;
    text-align: center;
}
.chart-card canvas {
    width: 100% !important;
    height: 340px !important;
}
.chart-card-full canvas {
    height: 400px !important;
}

/* ========== INFLECTION TABLE ========== */
.inflection-card {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 14px;
    padding: 24px;
    margin-bottom: 28px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    overflow-x: auto;
}
.inflection-card table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.inflection-card th {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--navy);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 12px 10px;
    border-bottom: 2px solid var(--border);
    text-align: center;
    white-space: nowrap;
}
.inflection-card td {
    padding: 10px;
    text-align: center;
    font-weight: 600;
    border-bottom: 1px solid var(--border-light);
}
.inflection-card td:first-child {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    color: var(--navy);
    text-align: left;
    font-weight: 700;
}
.cell-green { background: rgba(34,197,94,0.12); color: #15803d; }
.cell-yellow { background: rgba(245,158,11,0.12); color: #b45309; }
.cell-orange { background: rgba(239,68,68,0.08); color: #c2410c; }
.cell-red { background: rgba(220,38,38,0.12); color: #dc2626; }

/* ========== FOOTER ========== */
.page-footer {
    background: #0F1A2E;
    color: rgba(255,255,255,0.7);
    padding: 32px 24px;
    text-align: center;
}
.footer-links { display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; margin-bottom: 12px; }
.footer-links a { color: rgba(255,255,255,0.65); text-decoration: none; font-size: 0.85rem; font-weight: 500; transition: color 0.2s; }
.footer-links a:hover { color: #ffffff; }
.footer-note { font-size: 0.78rem; color: rgba(255,255,255,0.4); }

.bottom-banner {
    height: 4px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 25%, #22C55E 50%, #F59E0B 75%, #EF4444 100%);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 900px) {
    .chart-grid { grid-template-columns: 1fr; }
    .controls-grid { grid-template-columns: 1fr 1fr; }
    .envelope-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
}
@media (max-width: 600px) {
    .envelope-grid { grid-template-columns: 1fr; }
    .envelope-card canvas { height: 140px !important; }
    .dashboard-wrap { padding: 20px 14px 36px; }
    .controls-panel { padding: 20px 16px; }
    .controls-grid { grid-template-columns: 1fr; }
    .chart-card { padding: 16px; }
    .chart-card canvas { height: 220px !important; }
    .chart-card-full canvas { height: 240px !important; }
    .page-title { font-size: 1.6rem; }
    .inflection-card { padding: 14px; }
    .inflection-card table { font-size: 0.75rem; }
    .inflection-card th { font-size: 0.75rem; padding: 8px 6px; }
    .inflection-card td { padding: 8px 6px; }
}

/* ========== HERO SCROLLYTELL ========== */
.hero-scrolly {
    background: linear-gradient(180deg, #0B1120 0%, #13203D 100%);
    position: relative;
    overflow: hidden;
}
.hero-scrolly::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 30% 20%, rgba(14,165,233,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(233,30,99,0.06) 0%, transparent 60%);
    pointer-events: none;
}
.hero-scrolly-container {
    position: relative;
    display: flex;
    max-width: 1400px;
    margin: 0 auto;
}
.hero-scrolly-sticky {
    position: sticky;
    top: 0;
    width: 55%;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 32px;
    z-index: 1;
}
.hero-scrolly-chart-wrap {
    background: rgba(15,26,46,0.85);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(74,144,217,0.2);
    border-radius: 16px;
    padding: 28px 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 100%;
    min-height: 420px;
    display: flex;
    flex-direction: column;
}
.hero-scrolly-chart-wrap canvas {
    width: 100% !important;
    flex: 1;
    min-height: 350px;
}
.hero-chart-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    color: rgba(255,255,255,0.85);
    text-align: center;
    margin-bottom: 10px;
    letter-spacing: 0.02em;
    transition: opacity 0.4s;
}
.hero-chart-subtitle {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-size: 0.72rem;
    color: rgba(255,255,255,0.45);
    text-align: center;
    margin-top: 6px;
}
.hero-scrolly-steps {
    width: 45%;
    position: relative;
    z-index: 2;
}
.hero-scrolly-step {
    min-height: 85vh;
    display: flex;
    align-items: center;
    padding: 80px 48px 80px 40px;
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}
.hero-scrolly-step:first-child { padding-top: 120px; }
.hero-scrolly-step:last-child { padding-bottom: 120px; }
.hero-scrolly-step.visible {
    opacity: 1;
    transform: translateY(0);
}
.hero-step-card {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 32px;
    transition: border-color 0.4s, box-shadow 0.4s, transform 0.4s;
}
.hero-scrolly-step.active .hero-step-card {
    border-color: rgba(14,165,233,0.4);
    box-shadow: 0 10px 30px rgba(14,165,233,0.1);
    transform: translateY(-2px);
}
.hero-step-card h3 {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 1.5rem;
    font-weight: 800;
    color: #fff;
    margin-bottom: 12px;
    line-height: 1.25;
    letter-spacing: -0.3px;
}
.hero-step-card p {
    font-size: 0.92rem;
    color: rgba(255,255,255,0.75);
    line-height: 1.75;
    margin-bottom: 0;
}
.hero-step-card .step-stat {
    display: inline-block;
    margin-top: 14px;
    padding: 8px 16px;
    border-radius: 10px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-size: 0.88rem;
    font-weight: 700;
}
.step-stat-green {
    background: rgba(34,197,94,0.12);
    border: 1px solid rgba(34,197,94,0.25);
    color: #4ade80;
}
.step-stat-amber {
    background: rgba(245,158,11,0.12);
    border: 1px solid rgba(245,158,11,0.25);
    color: #fbbf24;
}
.step-stat-red {
    background: rgba(239,68,68,0.12);
    border: 1px solid rgba(239,68,68,0.25);
    color: #f87171;
}
.step-stat-blue {
    background: rgba(14,165,233,0.12);
    border: 1px solid rgba(14,165,233,0.25);
    color: #38bdf8;
}
/* Region color accent bars */
.hero-step-card .region-tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    margin-bottom: 10px;
    text-transform: uppercase;
}

@media (max-width: 900px) {
    .hero-scrolly-container { flex-direction: column; }
    .hero-scrolly-sticky { width: 100%; height: 50vh; min-height: 380px; position: sticky; top: 0; padding: 16px; }
    .hero-scrolly-steps { width: 100%; }
    .hero-scrolly-step { min-height: auto; padding: 40px 20px; }
    .hero-step-card { padding: 24px 20px; }
    .hero-step-card h3 { font-size: 1.25rem; }
}
@media (max-width: 600px) {
    .hero-scrolly-sticky { height: 45vh; min-height: 300px; padding: 12px; }
    .hero-scrolly-chart-wrap { padding: 16px 12px; min-height: 280px; }
    .hero-scrolly-step { padding: 32px 14px; }
    .hero-step-card { padding: 20px 16px; }
    .hero-step-card h3 { font-size: 1.1rem; }
    .hero-step-card p { font-size: 0.85rem; }
}
</style>
</head>
<body>

<!-- TOP NAV (injected by nav.js) -->
<nav id="topNav"></nav>
<script src="js/nav.js"></script>
<div style="background:#F3F4F8;padding:8px 24px;"><a href="index.html" style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-size:0.82rem;font-weight:600;color:#1A2744;text-decoration:none;display:inline-flex;align-items:center;gap:6px;letter-spacing:0.03em;min-height:44px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>Back to Home</a></div>

<!-- HEADER BANNER -->
<header class="header">
    <h1>The 8,760 Problem</h1>
    <p class="subtitle">Comparing the cost of CO₂ abatement through hourly clean energy procurement across regions and ambition levels.<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[10]</sup></p>
    <div class="header-accent"></div>
</header>

<!-- HERO SCROLLYTELL: Key Conclusions -->
<section class="hero-scrolly">
    <div class="hero-scrolly-container">
        <!-- Sticky chart panel -->
        <div class="hero-scrolly-sticky">
            <div class="hero-scrolly-chart-wrap">
                <div class="hero-chart-title" id="heroChartTitle">Marginal Abatement Cost vs. Projected DAC — All Regions</div>
                <canvas id="heroScrollyChart"></canvas>
                <div class="hero-chart-subtitle">Solid line = stepwise envelope (Medium cost) &middot; Shaded band = P10–P90 across 324 scenarios &middot; Dashed = DAC projections</div>
            </div>
        </div>

        <!-- Scrolly narrative steps -->
        <div class="hero-scrolly-steps">

            <!-- Step 1: The big picture -->
            <div class="hero-scrolly-step" data-hero-step="overview">
                <div class="hero-step-card">
                    <h3>The marginal cost of the next percent of clean energy tells the real story</h3>
                    <p>Average abatement costs hide the escalating price of each additional increment. The marginal cost of going from 90% to 92.5% clean can be 3&times; higher than going from 80% to 85%. This is where DAC becomes relevant — not as a replacement for grid decarbonization, but as a ceiling on how far to push it.</p>
                    <span class="step-stat step-stat-blue">324 cost scenarios &times; 5 ISOs &times; 10 thresholds = 16,200 marginal cost points</span>
                </div>
            </div>

            <!-- Step 2: ERCOT -->
            <div class="hero-scrolly-step" data-hero-step="ercot">
                <div class="hero-step-card">
                    <span class="region-tag" style="background:rgba(34,197,94,0.15);color:#22C55E;">ERCOT</span>
                    <h3>ERCOT: Grid wins through 90% under all scenarios, even vs. optimistic DAC</h3>
                    <p>At 90%, ERCOT's marginal P90 is $141/ton — still below central DAC at $225. But marginal costs spike unpredictably at 92.5% (P90 hits $1,370/ton) before falling back. At 95%, median marginal cost ($141) exceeds optimistic DAC ($90) but stays well below central ($200).</p>
                    <span class="step-stat step-stat-green">Marginal P90 at 90%: $141/ton vs. DAC central $225/ton</span>
                </div>
            </div>

            <!-- Step 3: PJM -->
            <div class="hero-scrolly-step" data-hero-step="pjm">
                <div class="hero-step-card">
                    <span class="region-tag" style="background:rgba(74,144,217,0.15);color:#4a90d9;">PJM</span>
                    <h3>PJM: Cheap marginal costs through 92.5%, then a cliff at 95%</h3>
                    <p>PJM has remarkably low marginal costs through 92.5% — P90 stays below $285/ton, well under conservative DAC. But at 95%, the marginal P50 jumps to $197/ton, exceeding optimistic DAC ($90) and nearly matching central ($200). By 99%, even the P10 (best-case) is $120/ton — DAC central at $184 is within reach.</p>
                    <span class="step-stat step-stat-amber">95% cliff: marginal P50 jumps from $101 to $197/ton</span>
                </div>
            </div>

            <!-- Step 4: CAISO -->
            <div class="hero-scrolly-step" data-hero-step="caiso">
                <div class="hero-step-card">
                    <span class="region-tag" style="background:rgba(245,158,11,0.15);color:#F59E0B;">CAISO</span>
                    <h3>CAISO: High variance makes the grid-vs-DAC call uncertain from 75% on</h3>
                    <p>CAISO's marginal costs are among the most volatile. At 75%, the P50 ($152) already exceeds optimistic DAC ($141). The median stays below central DAC through ~92.5%, but the P90 is extreme — $619/ton at 85%, $709 at 87.5%. Firm generation cost (48% of variance) drives this spread. Under favorable costs, grid wins to 95%+; under unfavorable, DAC is cheaper from 75%.</p>
                    <span class="step-stat step-stat-red">P90 marginal MAC at 85%: $619/ton vs. DAC central $238</span>
                </div>
            </div>

            <!-- Step 5: Northeast -->
            <div class="hero-scrolly-step" data-hero-step="northeast">
                <div class="hero-step-card">
                    <span class="region-tag" style="background:rgba(233,30,99,0.15);color:#E91E63;">NYISO</span>
                    <span class="region-tag" style="background:rgba(156,39,176,0.15);color:#9C27B0;margin-left:6px;">NEISO</span>
                    <h3>Northeast: DAC wins the marginal dollar above 92.5% in most scenarios</h3>
                    <p>At 95%, NYISO's marginal P50 is $307/ton and NEISO's is $352/ton — both far exceeding central DAC at $200. By 99%, NYISO P50 hits $1,032/ton and NEISO $906/ton. Even NEISO's P90 exceeds conservative DAC ($431) as early as 75%. The last 5–10% of decarbonization costs 3–5&times; more per ton than DAC.</p>
                    <span class="step-stat step-stat-red">NEISO marginal P50 at 95%: $352/ton vs. DAC central $200</span>
                </div>
            </div>

            <!-- Step 6: The swing factor -->
            <div class="hero-scrolly-step" data-hero-step="drivers">
                <div class="hero-step-card">
                    <h3>The swing factor: Clean firm generation, not storage</h3>
                    <p>Storage costs contribute less than 1% of marginal cost variance in every region. The grid-vs-DAC question is decided by firm generation costs (nuclear, geothermal) in CAISO/NYISO/NEISO (39–58% of variance), and fossil fuel prices in ERCOT/PJM (43%). If clean firm achieves cost learning, the marginal crossover point pushes higher. If it doesn't, DAC wins the marginal dollar earlier.</p>
                    <span class="step-stat step-stat-blue">Storage: &lt;1% of variance &middot; Firm Gen: 39–58%</span>
                </div>
            </div>

            <!-- Step 7: Bottom line -->
            <div class="hero-scrolly-step" data-hero-step="conclusion">
                <div class="hero-step-card">
                    <h3>Bottom line: Grid to ~90%, then ask the DAC question</h3>
                    <p>In every region, the marginal cost of grid decarbonization stays below central DAC through ~90%. Beyond that, the answer depends on where you are and what clean firm resources cost. ERCOT and PJM can push to 92.5% confidently. CAISO, NYISO, and NEISO hit marginal cost walls between 90–95% where DAC becomes the cheaper abatement path — unless firm generation costs fall.</p>
                    <span class="step-stat step-stat-green">Grid wins to ~90% in all regions, all scenarios</span>
                </div>
            </div>

        </div>
    </div>
</section>

<!-- MAIN DASHBOARD -->
<div class="dashboard-wrap">

    <!-- Title + Intro -->
    <div class="page-title-section">
        <h2 class="page-title">Carbon Abatement Dashboard</h2>
        <p class="page-intro">
            How does hourly grid decarbonization compare to alternative carbon removal strategies?<sup style="font-size:0.7em;color:#6B7280;">[10]</sup>
            Adjust the toggles below to stress-test different cost assumptions and see how crossover points shift
            across regions and technologies in real time. Regional emission rates from EPA eGRID 2022<sup style="font-size:0.7em;color:#6B7280;">[1]</sup>; hourly profiles from EIA.<sup style="font-size:0.7em;color:#6B7280;">[7]</sup>
        </p>
    </div>

    <!-- Controls Panel -->
    <div class="controls-panel">
        <div class="controls-panel-title">Stress-Test Assumptions</div>
        <div class="controls-panel-subtitle">Adjust cost assumptions for grid decarbonization and competing technologies to see how crossover points shift.</div>
        <div class="controls-grid">
            <div class="ctrl-group">
                <label>Grid Cost Scenario <span class="info-icon" title="Low = cheap renewables, fast permitting, falling storage costs. High = tariffs, supply chain disruptions, permitting delays. Cost ranges per NREL ATB 2024 [5] and Lazard LCOE v17 [6].">i</span></label>
                <div class="ctrl-toggle" data-ctrl="grid">
                    <button data-value="Low">Low</button>
                    <button data-value="Medium" class="active">Medium</button>
                    <button data-value="High">High</button>
                </div>
            </div>
            <div class="ctrl-group">
                <label>DAC Cost Trajectory <span class="info-icon" title="Low = aggressive learning curves, $150/ton. Medium = current trajectory, $250/ton. High = slow scaling, $400/ton. Range shown on charts. Per NREL ATB 2024 [5].">i</span></label>
                <div class="ctrl-toggle" data-ctrl="dac">
                    <button data-value="Low">Low</button>
                    <button data-value="Medium" class="active">Medium</button>
                    <button data-value="High">High</button>
                </div>
            </div>
            <div class="ctrl-group">
                <label>Industrial Decarb Cost <span class="info-icon" title="Low = electrification is cheaper than fossil (net savings). Medium = moderate carbon price needed. High = expensive retrofit + high energy costs. Based on McKinsey MAC methodology [10].">i</span></label>
                <div class="ctrl-toggle" data-ctrl="industrial">
                    <button data-value="Low">Low</button>
                    <button data-value="Medium" class="active">Medium</button>
                    <button data-value="High">High</button>
                </div>
            </div>
            <div class="ctrl-group">
                <label>Carbon Removal Alternatives <span class="info-icon" title="Low = BECCS + enhanced weathering hit scale, $50-100/ton. Medium = moderate scaling. High = limited deployment, $200+/ton. Benchmarks from IPCC AR6 WG3 [9] and NREL ATB [5].">i</span></label>
                <div class="ctrl-toggle" data-ctrl="removal">
                    <button data-value="Low">Low</button>
                    <button data-value="Medium" class="active">Medium</button>
                    <button data-value="High">High</button>
                </div>
            </div>
        </div>
        <div class="summary-strip" id="crossoverSummary"></div>
    </div>

    <!-- Per-Region Envelope Grid -->
    <div class="chart-card chart-card-full" style="margin-bottom:24px;">
        <div class="chart-card-title">Abatement Cost by Region — P10/P90 Uncertainty Envelopes<sup style="font-size:0.7em;color:#6B7280;">[1][7]</sup></div>
        <div class="envelope-grid" id="macEnvelopeGrid"></div>
    </div>

    <!-- Chart Grid -->
    <div class="chart-grid">
        <!-- ANOVA Sensitivity -->
        <div class="chart-card">
            <div class="chart-card-title">What Drives MAC Uncertainty? (ANOVA Decomposition)</div>
            <canvas id="anovaChart"></canvas>
        </div>

        <!-- Marginal MAC by Region (toggle-responsive) -->
        <div class="chart-card">
            <div class="chart-card-title">Marginal MAC by Region — Six-Zone Stepwise View</div>
            <canvas id="portfolioChart"></canvas>
        </div>

        <!-- Abatement Ladder (full width) -->
        <div class="chart-card chart-card-full">
            <div class="chart-card-title">Abatement Cost Ladder: Grid vs. Alternatives — 2040 Projected<sup style="font-size:0.7em;color:#6B7280;">[5][6][10]</sup></div>
            <canvas id="ladderChart"></canvas>
        </div>
    </div>

    <!-- Inflection Table -->
    <div class="inflection-card">
        <div class="chart-card-title" style="margin-bottom:16px;">Cost Crossover Analysis: Where Grid Average MAC Exceeds Benchmarks<sup style="font-size:0.7em;color:#6B7280;">[2][3][4]</sup></div>
        <table>
            <thead><tr id="inflectionHead"></tr></thead>
            <tbody id="inflectionBody"></tbody>
        </table>
    </div>

</div>

<!-- SOURCES -->
<div style="max-width:1320px;margin:0 auto;padding:0 24px 24px;">
    <details style="background:#fff;border:1px solid #E5E7EB;border-radius:10px;padding:16px 20px;">
        <summary style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-size:0.9rem;font-weight:600;color:#1A2744;cursor:pointer;">Sources &amp; References</summary>
        <ol style="font-size:0.8rem;color:#6B7280;line-height:1.8;padding-left:20px;margin-top:12px;">
            <li>EPA eGRID 2022 — regional emission rates and CO&#8322; intensity by balancing authority.</li>
            <li>EPA Social Cost of Carbon — Technical Support Document (2020), central estimate $51/tonne.</li>
            <li>Rennert, K. et al. (2022). "Comprehensive evidence implies a higher social cost of CO&#8322;." <em>Nature</em>, 610, 687-692. $185/tonne.</li>
            <li>EU Emissions Trading System (EU ETS) — carbon price range $60-100/tonne.</li>
            <li>NREL Annual Technology Baseline (ATB) 2024 — technology costs for wind, solar, storage, nuclear, CCS, DAC.</li>
            <li>Lazard Levelized Cost of Energy Analysis v17.0 (2024) — generation technology cost benchmarks.</li>
            <li>EIA Hourly Electric Grid Monitor — hourly generation data by fuel type and balancing authority.</li>
            <li>IEA Net Zero by 2050 Roadmap (2023 update) — sector emission reduction benchmarks.</li>
            <li>IPCC AR6 Working Group III (2022) — power sector targets and mitigation pathways.</li>
            <li>McKinsey Marginal Abatement Cost Curve methodology — cross-sector decarbonization benchmarks.</li>
        </ol>
    </details>
</div>

<!-- FOOTER -->
<footer class="page-footer">
    <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Cost Optimizer</a>
        <a href="abatement_comparison.html">CO&#8322; Abatement Summary</a>
        <a href="eac_scarcity.html">EAC Scarcity</a>
        <a href="region_deepdive.html">Regional Deep Dives</a>
        <a href="research_paper.html">Methodology &amp; Paper</a>
        <a href="about.html">About</a>
        <a href="../power-gen-decarbonization/site/index.html">Generator Analysis</a>
        <a href="about.html">About</a>
    </div>
    <div class="footer-note">The 8,760 Problem &mdash; 2025 Snapshot Model</div>
</footer>
<div class="bottom-banner"></div>

<script src="js/shared-data.js"></script>
<script src="js/mac-stats-data.js"></script>
<script>
// ============================================================================
// HERO SCROLLYTELL CHART
// ============================================================================
let heroChart = null;
const yMaxHero = 700; // cap for readability in hero chart

function initHeroScrolly() {
    const ctx = document.getElementById('heroScrollyChart')?.getContext('2d');
    if (!ctx) return;

    const regions = ['ERCOT', 'PJM', 'CAISO', 'NYISO', 'NEISO'];
    const colors = { ERCOT: '#22C55E', PJM: '#4a90d9', CAISO: '#F59E0B', NYISO: '#E91E63', NEISO: '#9C27B0' };

    // Use stepwise (marginal) MAC data — same data feeding the dashboard envelope charts
    const stepFan = typeof MAC_STEPWISE_FAN !== 'undefined' ? MAC_STEPWISE_FAN : null;
    const stepEnv = typeof MAC_ENVELOPE_DATA !== 'undefined' ? MAC_ENVELOPE_DATA : null;
    const avgFan = typeof MAC_FAN_DATA !== 'undefined' ? MAC_FAN_DATA : null;

    // Build datasets: envelope line + P10-P90 band per region, plus 3 DAC lines
    const datasets = [];
    regions.forEach(iso => {
        const fan = stepFan?.[iso];
        const env = stepEnv?.[iso]?.stepwise_envelope;
        const fb = avgFan?.[iso]; // fallback for null-filling
        if (!fan && !env) return;
        const c = colors[iso];

        // P90 band (fills to P10) — stepwise fan with fallback
        const p90pts = (fan?.p90 || []).map((v, i) => {
            const val = v ?? fb?.p90?.[i] ?? null;
            return { x: THRESHOLDS[i], y: val != null ? Math.min(val, yMaxHero) : null };
        }).filter(d => d.y != null);
        const p10pts = (fan?.p10 || []).map((v, i) => {
            const val = v ?? fb?.p10?.[i] ?? null;
            return { x: THRESHOLDS[i], y: val != null ? Math.min(val, yMaxHero) : null };
        }).filter(d => d.y != null);

        // Envelope line (monotonic marginal MAC at Medium cost)
        const envPts = (env || fan?.p50 || []).map((v, i) => {
            const val = v ?? fb?.p50?.[i] ?? null;
            return { x: THRESHOLDS[i], y: val != null ? Math.min(val, yMaxHero) : null };
        }).filter(d => d.y != null);

        datasets.push({
            label: iso + ' P90', data: p90pts, borderColor: 'transparent', backgroundColor: c + '15',
            borderWidth: 0, pointRadius: 0, fill: '+1', tension: 0.3, order: 10,
            _region: iso, _type: 'band'
        });
        datasets.push({
            label: iso + ' P10', data: p10pts, borderColor: c + '30', backgroundColor: 'transparent',
            borderWidth: 0.5, borderDash: [2, 2], pointRadius: 0, fill: false, tension: 0.3, order: 10,
            _region: iso, _type: 'band'
        });
        datasets.push({
            label: iso, data: envPts, borderColor: c, backgroundColor: c + '10',
            borderWidth: 2.5, pointRadius: 0, fill: false, tension: 0.3, order: 5,
            _region: iso, _type: 'line'
        });
    });

    // DAC trajectories
    const dacThresholds = [];
    for (let t = 50; t <= 100; t += 2.5) dacThresholds.push(t);
    const dacOpt = dacThresholds.map(t => ({ x: t, y: dacCostAtThreshold(t, 'optimistic') }));
    const dacCen = dacThresholds.map(t => ({ x: t, y: dacCostAtThreshold(t, 'central') }));
    const dacCon = dacThresholds.map(t => ({ x: t, y: dacCostAtThreshold(t, 'conservative') }));

    datasets.push({
        label: 'DAC Optimistic', data: dacOpt, borderColor: '#E91E6366',
        borderWidth: 1.5, borderDash: [4, 3], pointRadius: 0, fill: false, tension: 0.3, order: 2, _type: 'dac'
    });
    datasets.push({
        label: 'DAC Central', data: dacCen, borderColor: '#E91E6399',
        borderWidth: 2, borderDash: [6, 4], pointRadius: 0, fill: '-1', backgroundColor: 'rgba(255,193,7,0.10)', tension: 0.3, order: 2, _type: 'dac'
    });
    datasets.push({
        label: 'DAC Conservative', data: dacCon, borderColor: '#E91E6344',
        borderWidth: 1.5, borderDash: [4, 3], pointRadius: 0, fill: '-1', backgroundColor: 'rgba(233,30,99,0.08)', tension: 0.3, order: 2, _type: 'dac'
    });

    heroChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 600, easing: 'easeInOutQuart' },
            scales: {
                x: {
                    type: 'linear', min: 48, max: 100,
                    afterBuildTicks: axis => { axis.ticks = [50, 60, 70, 80, 90, 95, 100].map(v => ({ value: v })); },
                    ticks: {
                        callback: v => {
                            const yearMap = { 50: "'30", 60: "'32", 70: "'35", 80: "'37", 90: "'40", 95: "'45", 100: "'50" };
                            return [v + '%', yearMap[v] || ''];
                        },
                        font: { size: 9 }, color: 'rgba(255,255,255,0.5)', maxRotation: 0
                    },
                    grid: { color: 'rgba(255,255,255,0.06)' },
                    border: { display: true, color: 'rgba(255,255,255,0.15)' }
                },
                y: {
                    min: 0, max: yMaxHero,
                    ticks: { callback: v => '$' + v, font: { size: 9 }, color: 'rgba(255,255,255,0.5)', stepSize: 100 },
                    grid: { color: 'rgba(255,255,255,0.06)' },
                    border: { display: true, color: 'rgba(255,255,255,0.15)' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
                datalabels: { display: false },
                annotation: { annotations: {} }
            }
        }
    });

    // Scroll observer for steps
    const steps = document.querySelectorAll('.hero-scrolly-step');
    const fadeObs = new IntersectionObserver(entries => {
        entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
    }, { threshold: 0.15, rootMargin: '0px 0px -50px 0px' });

    let activeHeroStep = null;
    const stepObs = new IntersectionObserver(entries => {
        let best = null;
        entries.forEach(e => {
            if (e.isIntersecting && (!best || e.intersectionRatio > best.intersectionRatio)) best = e;
        });
        if (best) {
            const stepName = best.target.getAttribute('data-hero-step');
            if (stepName !== activeHeroStep) {
                activeHeroStep = stepName;
                steps.forEach(s => s.classList.remove('active'));
                best.target.classList.add('active');
                updateHeroChart(stepName);
            }
        }
    }, { threshold: [0.1, 0.3, 0.5, 0.7, 0.9], rootMargin: '-20% 0px -30% 0px' });

    steps.forEach(s => { fadeObs.observe(s); stepObs.observe(s); });

    // Initialize chart
    const initObs = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting) {
            updateHeroChart('overview');
            initObs.disconnect();
        }
    }, { threshold: 0.05 });
    initObs.observe(document.querySelector('.hero-scrolly'));
}

function updateHeroChart(step) {
    if (!heroChart) return;
    const regions = ['ERCOT', 'PJM', 'CAISO', 'NYISO', 'NEISO'];
    const titleEl = document.getElementById('heroChartTitle');

    // Highlight config per step
    const highlights = {
        overview:   { show: regions, title: 'Marginal Abatement Cost vs. Projected DAC — All Regions' },
        ercot:      { show: ['ERCOT'], title: 'ERCOT: Marginal Grid Cost vs. DAC Projections' },
        pjm:        { show: ['PJM'], title: 'PJM: Marginal Grid Cost vs. DAC Projections' },
        caiso:      { show: ['CAISO'], title: 'CAISO: Marginal Grid Cost vs. DAC Projections' },
        northeast:  { show: ['NYISO', 'NEISO'], title: 'Northeast: NYISO & NEISO Marginal Cost vs. DAC' },
        drivers:    { show: regions, title: 'What Drives the Marginal Cost P10–P90 Spread?' },
        conclusion: { show: regions, title: 'Grid Wins the Marginal Dollar to ~90% Everywhere' }
    };

    const cfg = highlights[step] || highlights.overview;
    if (titleEl) titleEl.textContent = cfg.title;

    const showSet = new Set(cfg.show);
    const emphasizeBands = (step === 'drivers');

    heroChart.data.datasets.forEach(ds => {
        if (ds._type === 'dac') {
            // Always show DAC lines
            ds.borderWidth = (step === 'drivers') ? 1 : (ds.label === 'DAC Central' ? 2 : 1.5);
            return;
        }
        const visible = showSet.has(ds._region);
        // Look up the base color from REGION_COLORS
        const baseC = { ERCOT: '#22C55E', PJM: '#4a90d9', CAISO: '#F59E0B', NYISO: '#E91E63', NEISO: '#9C27B0' }[ds._region] || '#888';
        if (ds._type === 'band') {
            if (visible) {
                ds.backgroundColor = ds.label.includes('P90') ? baseC + (emphasizeBands ? '30' : '15') : 'transparent';
                ds.borderWidth = ds.label.includes('P10') ? (emphasizeBands ? 1.5 : 0.5) : 0;
                if (ds.label.includes('P10')) ds.borderColor = baseC + (emphasizeBands ? '80' : '30');
            } else {
                ds.backgroundColor = 'transparent';
                ds.borderWidth = 0;
                ds.borderColor = 'transparent';
            }
        } else if (ds._type === 'line') {
            ds.borderWidth = visible ? 2.5 : 0.5;
            ds.borderColor = visible ? baseC : baseC + '18';
        }
    });

    // Add annotation for crossover zone per step
    const annotations = {};
    if (step === 'ercot') {
        annotations.crossover = {
            type: 'box', xMin: 92.5, xMax: 100, yMin: 0, yMax: yMaxHero,
            backgroundColor: 'rgba(34,197,94,0.04)', borderColor: 'rgba(34,197,94,0.15)',
            borderWidth: 1, borderDash: [4, 4],
            label: { display: true, content: 'Marginal spike zone', position: 'start',
                font: { size: 10, weight: 600 }, color: 'rgba(34,197,94,0.6)', padding: 4 }
        };
    } else if (step === 'pjm') {
        annotations.crossover = {
            type: 'box', xMin: 95, xMax: 100, yMin: 0, yMax: yMaxHero,
            backgroundColor: 'rgba(74,144,217,0.06)', borderColor: 'rgba(74,144,217,0.2)',
            borderWidth: 1, borderDash: [4, 4],
            label: { display: true, content: '95% cliff', position: 'start',
                font: { size: 10, weight: 600 }, color: 'rgba(74,144,217,0.7)', padding: 4 }
        };
    } else if (step === 'caiso') {
        annotations.crossover = {
            type: 'box', xMin: 75, xMax: 99, yMin: 0, yMax: yMaxHero,
            backgroundColor: 'rgba(245,158,11,0.05)', borderColor: 'rgba(245,158,11,0.2)',
            borderWidth: 1, borderDash: [4, 4],
            label: { display: true, content: 'High-variance zone', position: 'start',
                font: { size: 10, weight: 600 }, color: 'rgba(245,158,11,0.7)', padding: 4 }
        };
    } else if (step === 'northeast') {
        annotations.crossover = {
            type: 'box', xMin: 92.5, xMax: 99, yMin: 0, yMax: yMaxHero,
            backgroundColor: 'rgba(233,30,99,0.06)', borderColor: 'rgba(233,30,99,0.2)',
            borderWidth: 1, borderDash: [4, 4],
            label: { display: true, content: 'DAC wins marginal $', position: 'start',
                font: { size: 10, weight: 600 }, color: 'rgba(233,30,99,0.7)', padding: 4 }
        };
    }
    heroChart.options.plugins.annotation.annotations = annotations;
    heroChart.update('default');
}

// ============================================================================
// HELPERS
// ============================================================================
function getState() {
    const state = { grid: 'Medium', dac: 'Medium', industrial: 'Medium', removal: 'Medium' };
    document.querySelectorAll('.ctrl-toggle').forEach(toggle => {
        const ctrl = toggle.dataset.ctrl;
        const active = toggle.querySelector('button.active');
        if (active && ctrl) state[ctrl] = active.dataset.value;
    });
    return state;
}

// findCrossover(), cellClass(), getAllBenchmarks() provided by shared-data.js

// Shared chart defaults: rounded bars, no grid lines, keep axes
const CHART_DEFAULTS = {
    borderRadius: 6,
    grid: { display: false },
    axisStyle: { grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
};

// ============================================================================
// CHART: Per-Region MAC Envelope Charts (small multiples)
// ============================================================================
let macChartInstances = {};
function buildMacChart() {
    const s = getState();
    const grid = document.getElementById('macEnvelopeGrid');
    if (!grid) return;

    const regions = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
    const regionNames = { CAISO: 'CAISO (California)', ERCOT: 'ERCOT (Texas)', PJM: 'PJM (Mid-Atlantic)',
                          NYISO: 'NYISO (New York)', NEISO: 'NEISO (New England)' };
    const thresholds9 = THRESHOLDS;
    const gridLevel = s.grid.toLowerCase();
    const macData = MAC_DATA[gridLevel] || MAC_DATA.medium;
    // Build declining DAC trajectory datasets (one value per threshold via SBTi year mapping)
    const dacCurveThresholds = THRESHOLDS.filter(t => t >= 50);
    const dacOptData = dacCurveThresholds.map(t => ({ x: t, y: dacCostAtThreshold(t, 'optimistic') }));
    const dacCenData = dacCurveThresholds.map(t => ({ x: t, y: dacCostAtThreshold(t, 'central') }));
    const dacConData = dacCurveThresholds.map(t => ({ x: t, y: dacCostAtThreshold(t, 'conservative') }));
    // Threshold index lookup (MAC_DATA arrays match THRESHOLDS order)
    const _TI = {};
    THRESHOLDS.forEach((t, i) => _TI[t] = i);

    // Destroy old instances
    Object.values(macChartInstances).forEach(c => c.destroy());
    macChartInstances = {};

    // Use stepwise (marginal) MAC data for cost curves — matches horizontal bar methodology
    // MAC_STEPWISE_FAN has P10/P50/P90 of marginal cost per step (not cumulative average)
    const useFan = typeof MAC_STEPWISE_FAN !== 'undefined' ? MAC_STEPWISE_FAN : MAC_FAN_DATA;

    // Compute shared Y max/min from stepwise data (with fallback to average fan)
    const avgFan = typeof MAC_FAN_DATA !== 'undefined' ? MAC_FAN_DATA : null;
    let yMax = 0, yMin = 0;
    regions.forEach(iso => {
        const fan = useFan?.[iso];
        const fb = avgFan?.[iso];
        const p90vals = (fan?.p90 || []).map((v, i) => v ?? fb?.p90?.[i] ?? null).filter(v => v != null && v < 2000);
        const p10vals = (fan?.p10 || []).map((v, i) => v ?? fb?.p10?.[i] ?? null).filter(v => v != null);
        if (p90vals.length) yMax = Math.max(yMax, ...p90vals);
        if (p10vals.length) yMin = Math.min(yMin, ...p10vals);
    });
    yMax = Math.min(Math.ceil(yMax / 50) * 50 + 50, 1200);
    if (yMin < 0) yMin = Math.floor(yMin / 50) * 50 - 25;

    // Build card HTML — show marginal MAC at 99% step
    grid.innerHTML = regions.map(iso => {
        const c = REGION_COLORS[iso];
        const margMac = MARGINAL_MAC_DATA?.medium?.[iso];
        const lastStep = margMac ? margMac[margMac.length - 1] : 0;
        const fan = useFan[iso];
        const p10_99 = fan?.p10?.[_TI[99]] != null ? Math.round(fan.p10[_TI[99]]) : '--';
        const p90_99 = fan?.p90?.[_TI[99]] != null ? Math.round(fan.p90[_TI[99]]) : '--';
        return `<div class="envelope-card" style="border-top-color:${c}">` +
            `<div class="envelope-card-title">` +
            `  <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${c}"></span>` +
            `  ${regionNames[iso]}` +
            `  <span style="margin-left:auto;font-family:'Barlow Semi Condensed',sans-serif;font-size:1rem;font-weight:800;color:${c}">$${lastStep}/ton</span>` +
            `</div>` +
            `<div class="envelope-card-subtitle">Marginal MAC at 97.5→99% step · Range: $${p10_99}–$${p90_99}/ton</div>` +
            `<canvas id="macEnv_${iso}"></canvas>` +
            `</div>`;
    }).join('');

    // Build each chart — using stepwise (marginal) MAC data, falling back to
    // average MAC fan data where stepwise values are null (e.g. NEISO/PJM early thresholds)
    regions.forEach(iso => {
        const ctx = document.getElementById('macEnv_' + iso)?.getContext('2d');
        if (!ctx) return;
        const fan = useFan?.[iso];
        const env = MAC_ENVELOPE_DATA?.[iso]?.stepwise_envelope;
        if (!fan) return;

        const c = REGION_COLORS[iso];
        const fb = avgFan?.[iso]; // fallback average fan for null-filling
        const p90 = fan.p90.map((v, i) => {
            const val = v ?? fb?.p90?.[i] ?? null;
            return { x: thresholds9[i], y: val != null ? Math.min(val, 1200) : null };
        }).filter(d => d.y != null);
        const p10 = fan.p10.map((v, i) => {
            const val = v ?? fb?.p10?.[i] ?? null;
            return { x: thresholds9[i], y: val };
        }).filter(d => d.y != null);
        const midSrc = env || fan.p50;
        const p50 = midSrc.map((v, i) => {
            const val = v ?? fb?.p50?.[i] ?? null;
            return { x: thresholds9[i], y: val != null ? Math.min(val, 1200) : null };
        }).filter(d => d.y != null);

        macChartInstances[iso] = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    { label: 'P90', data: p90, borderColor: 'transparent', backgroundColor: c + '20',
                        borderWidth: 0, pointRadius: 0, fill: '+1', tension: 0.3, order: 3 },
                    { label: 'P10', data: p10, borderColor: c + '44', backgroundColor: 'transparent',
                        borderWidth: 1, borderDash: [3, 3], pointRadius: 0, fill: false, tension: 0.3, order: 3 },
                    { label: 'Midpoint', data: p50, borderColor: c, backgroundColor: c + '18',
                        borderWidth: 2.5, pointRadius: 2, pointHoverRadius: 5, fill: false, tension: 0.3, order: 1 },
                    // DAC declining trajectory curves (SBTi year-indexed)
                    { label: 'DAC Optimistic', data: dacOptData, borderColor: '#E91E6366',
                        borderWidth: 1, borderDash: [3, 3], pointRadius: 0, fill: false, tension: 0.3, order: 5 },
                    { label: 'DAC Central', data: dacCenData, borderColor: '#E91E6388',
                        borderWidth: 1.5, borderDash: [5, 3], pointRadius: 0, fill: '-1', backgroundColor: 'rgba(255,193,7,0.13)', tension: 0.3, order: 4 },
                    { label: 'DAC Conservative', data: dacConData, borderColor: '#E91E6333',
                        borderWidth: 1, borderDash: [3, 3], pointRadius: 0, fill: '-1', backgroundColor: 'rgba(233,30,99,0.10)', tension: 0.3, order: 5 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', min: 48, max: 100,
                        afterBuildTicks: function(axis) {
                            axis.ticks = [50, 60, 70, 80, 90, 95, 100].map(v => ({ value: v }));
                        },
                        ticks: {
                            callback: function(v) {
                                const yearMap = { 50: "'30", 60: "'32", 70: "'35", 80: "'37", 90: "'40", 95: "'45", 100: "'50" };
                                return [v + '%', yearMap[v] || ''];
                            },
                            font: { size: 8 }, maxRotation: 0
                        },
                        grid: { display: false }, border: { display: true, color: '#D4D8E0' }
                    },
                    y: { ...(yMin < 0 ? { min: yMin } : {}), max: yMax,
                        ticks: { callback: v => '$' + v, font: { size: 9 }, stepSize: 50 },
                        grid: { color: 'rgba(0,0,0,0.04)' }, border: { display: true, color: '#D4D8E0' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    annotation: { annotations: {} },
                    datalabels: { display: false }
                }
            }
        });
    });
}

// ============================================================================
// CHART: ANOVA Sensitivity Decomposition
// ============================================================================
let anovaChartInst = null;
function buildAnovaChart() {
    const ctx = document.getElementById('anovaChart').getContext('2d');
    const toggleNames = ['Renewable\nGen', 'Firm\nGen', 'Storage', 'Fossil\nFuel', 'Trans-\nmission'];
    const toggleColors = ['#22C55E', '#1E3A5F', '#8B5CF6', '#EF4444', '#F59E0B'];
    const regions = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
    const anovaKeys = ['Renewable Gen', 'Firm Gen', 'Storage', 'Fossil Fuel', 'Transmission'];

    const datasets = regions.map(region => ({
        label: region,
        data: anovaKeys.map(k => Math.round((MAC_ANOVA[region]?.[k] || 0) * 100)),
        backgroundColor: REGION_COLORS[region] + '90',
        borderColor: REGION_COLORS[region],
        borderWidth: 1.5,
        borderRadius: 4,
        barPercentage: 0.75,
        categoryPercentage: 0.85
    }));

    if (anovaChartInst) anovaChartInst.destroy();
    anovaChartInst = new Chart(ctx, {
        type: 'bar',
        data: { labels: toggleNames, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { ticks: { font: { size: 10, weight: 600 }, maxRotation: 0 },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' } },
                y: { min: 0, max: 70,
                    title: { display: true, text: '% of MAC Variance Explained', font: { size: 11, weight: 600 } },
                    ticks: { stepSize: 10, callback: v => v + '%', font: { size: 10 } },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
            },
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle', padding: 12, font: { size: 10, weight: 600 } } },
                tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw + '%' } },
                datalabels: { display: false }
            }
        }
    });
}

// ============================================================================
// CHART: Marginal MAC by Region (toggle-responsive, two-zone view)
// ============================================================================
let portfolioInst = null;
function buildPortfolio() {
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    const s = getState();
    const gridLevel = s.grid.toLowerCase();
    const margData = MARGINAL_MAC_DATA[gridLevel] || MARGINAL_MAC_DATA.medium;
    const regions = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];

    // DAC cost at each zone's end-threshold (declining via SBTi year)
    const zoneEndThresholds = [75, 90, 92.5, 95, 97.5, 99];
    const dacOptZone = zoneEndThresholds.map(t => dacCostAtThreshold(t, 'optimistic'));
    const dacCenZone = zoneEndThresholds.map(t => dacCostAtThreshold(t, 'central'));
    const dacConZone = zoneEndThresholds.map(t => dacCostAtThreshold(t, 'conservative'));

    const datasets = [
        ...regions.map(iso => ({
            label: iso,
            data: margData[iso].map(v => v != null ? Math.min(v, 1050) : 0),
            backgroundColor: REGION_COLORS[iso] + 'AA',
            borderColor: REGION_COLORS[iso],
            borderWidth: 1.5,
            borderRadius: 4,
            barPercentage: 0.75,
            categoryPercentage: 0.85,
            type: 'bar'
        })),
        // DAC declining trajectories as line overlays
        { label: 'DAC Optimistic', type: 'line', data: dacOptZone,
            borderColor: '#E91E6366', borderWidth: 1, borderDash: [3, 3],
            pointRadius: 0, fill: false, tension: 0.3, order: -1 },
        { label: 'DAC Central', type: 'line', data: dacCenZone,
            borderColor: '#E91E6388', borderWidth: 2, borderDash: [6, 4],
            pointRadius: 2, pointBackgroundColor: '#E91E63', fill: '-1', backgroundColor: 'rgba(255,193,7,0.13)', tension: 0.3, order: -1 },
        { label: 'DAC Conservative', type: 'line', data: dacConZone,
            borderColor: '#E91E6333', borderWidth: 1, borderDash: [3, 3],
            pointRadius: 0, fill: '-1', backgroundColor: 'rgba(233,30,99,0.10)', tension: 0.3, order: -1 }
    ];

    if (portfolioInst) portfolioInst.destroy();
    portfolioInst = new Chart(ctx, {
        type: 'bar',
        data: { labels: MARGINAL_MAC_LABELS, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { title: { display: true, text: 'CFE Matching Step (SBTi Year)', font: { size: 11, weight: 600 } },
                    ticks: { font: { size: 9 }, maxRotation: 45, minRotation: 20,
                        callback: function(value, index) {
                            const labels = MARGINAL_MAC_LABELS;
                            const years = zoneEndThresholds.map(t => {
                                const ms = SBTI_MILESTONES;
                                for (let i = 0; i < ms.length - 1; i++) {
                                    if (t >= ms[i].threshold && t <= ms[i+1].threshold) {
                                        const frac = (t - ms[i].threshold) / (ms[i+1].threshold - ms[i].threshold);
                                        return Math.round(ms[i].year + frac * (ms[i+1].year - ms[i].year));
                                    }
                                }
                                return t >= 100 ? 2050 : 2025;
                            });
                            return labels[index] + '\n~' + years[index];
                        }
                    },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' } },
                y: { min: 0, max: 1100,
                    title: { display: true, text: 'Marginal MAC ($/ton CO\u2082)', font: { size: 11, weight: 600 } },
                    ticks: { callback: v => '$' + v, font: { size: 10 }, stepSize: 200 },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
            },
            plugins: {
                legend: { position: 'bottom', labels: {
                    usePointStyle: true, pointStyle: 'circle', padding: 12, font: { size: 10, weight: 600 },
                    filter: item => !item.text.startsWith('DAC')
                } },
                tooltip: { enabled: false },
                datalabels: { display: false },
                annotation: { annotations: {} }
            }
        }
    });
}

// ============================================================================
// CHART: Abatement Ladder (horizontal bar)
// ============================================================================
let ladderInst = null;
function buildLadder() {
    const ctx = document.getElementById('ladderChart').getContext('2d');
    const s = getState();
    const benchmarks = getAllBenchmarks2040(s);
    const gridLevel = s.grid.toLowerCase();
    const macData = MAC_DATA[gridLevel] || MAC_DATA.medium;

    const labels = benchmarks.map(b => b.short || b.name);
    const barData = benchmarks.map(b => [Math.max(b.low, 0), Math.min(b.high, 650)]);
    const bgColors = benchmarks.map(b => b.color + '40');
    const borderColors = benchmarks.map(b => b.color);

    // Grid crossover annotations
    const annotations = {};
    const markerPairs = [
        { label: 'ERCOT 90%', cost: macData.ERCOT[THRESHOLDS.indexOf(90)], color: REGION_COLORS.ERCOT },
        { label: 'CAISO 95%', cost: macData.CAISO[THRESHOLDS.indexOf(95)], color: REGION_COLORS.CAISO },
        { label: 'NYISO 99%', cost: macData.NYISO[THRESHOLDS.indexOf(99)], color: REGION_COLORS.NYISO },
        { label: 'NEISO 99%', cost: macData.NEISO[THRESHOLDS.indexOf(99)], color: REGION_COLORS.NEISO }
    ];
    markerPairs.forEach((m, i) => {
        annotations['grid' + i] = {
            type: 'line', xMin: m.cost, xMax: m.cost,
            borderColor: m.color + 'aa', borderWidth: 2, borderDash: [4, 3],
            label: { display: true, content: m.label, position: i % 2 === 0 ? 'start' : 'end',
                font: { size: 9 }, color: m.color, backgroundColor: 'rgba(255,255,255,0.9)', padding: 2 }
        };
    });

    if (ladderInst) ladderInst.destroy();
    ladderInst = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Cost Range',
                data: barData,
                backgroundColor: bgColors,
                borderColor: borderColors,
                borderWidth: 2,
                borderRadius: 6,
                borderSkipped: false,
                barPercentage: 0.65
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { min: 0, max: 650,
                    title: { display: true, text: '$/ton CO\u2082', font: { size: 12, weight: 600 } },
                    ticks: { stepSize: 50, callback: v => '$' + v, font: { size: 10 } },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' }
                },
                y: { ticks: { font: { size: 11, weight: 500 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
            },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => Array.isArray(ctx.raw) ? 'Range: $' + ctx.raw[0] + ' \u2013 $' + ctx.raw[1] + '/ton' : '' } },
                datalabels: { display: false },
                annotation: { annotations }
            }
        }
    });
}

// ============================================================================
// TABLE: Inflection Points
// ============================================================================
function buildInflectionTable() {
    const s = getState();
    const gridLevel = s.grid.toLowerCase();
    const macData = MAC_DATA[gridLevel] || MAC_DATA.medium;
    const dacLowMid = BENCHMARKS_DYNAMIC.dac.Low.mid;
    const dacMedMid = BENCHMARKS_DYNAMIC.dac.Medium.mid;
    const dacHighMid = BENCHMARKS_DYNAMIC.dac.High.mid;
    const indMid = (BENCHMARKS_DYNAMIC.industrial[s.industrial] || BENCHMARKS_DYNAMIC.industrial.Medium).mid;
    const remMid = (BENCHMARKS_DYNAMIC.removal[s.removal] || BENCHMARKS_DYNAMIC.removal.Medium).mid;

    const head = document.getElementById('inflectionHead');
    head.innerHTML = '<th>Region</th><th>EPA SCC<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[2]</sup><br>($190)</th><th>EU ETS<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[4]</sup><br>($88)</th><th>Rennert SCC<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[3]</sup><br>($185)</th><th>Industrial<br>($' + indMid + ')</th><th>Removal<br>($' + remMid + ')</th><th>DAC Low<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[5]</sup><br>($' + dacLowMid + ')</th><th>DAC Med<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[5]</sup><br>($' + dacMedMid + ')</th><th>DAC High<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[5]</sup><br>($' + dacHighMid + ')</th>';

    const tbody = document.getElementById('inflectionBody');
    tbody.innerHTML = '';
    ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'].forEach(region => {
        const row = document.createElement('tr');
        const vals = [
            findCrossover(macData[region], 190),
            findCrossover(macData[region], 88),
            findCrossover(macData[region], 185),
            findCrossover(macData[region], Math.max(indMid, 10)),
            findCrossover(macData[region], remMid),
            findCrossover(macData[region], dacLowMid),
            findCrossover(macData[region], dacMedMid),
            findCrossover(macData[region], dacHighMid)
        ];
        row.innerHTML = '<td>' + region + '</td>' + vals.map(v => '<td class="' + cellClass(v) + '">' + (v === '>99' || v === '>100' ? '>99%' : v + '%') + '</td>').join('');
        tbody.appendChild(row);
    });
}

// ============================================================================
// SUMMARY
// ============================================================================
// Find threshold where MAC exceeds the SBTi-year-indexed DAC trajectory
function findDacTrajectoryIntersection(regionMacArray, trajectory) {
    trajectory = trajectory || 'central';
    for (let i = 0; i < THRESHOLDS.length; i++) {
        const t = THRESHOLDS[i];
        const mac = regionMacArray[i];
        if (mac == null) continue;
        const dacAtYear = dacCostAtThreshold(t, trajectory);
        if (mac >= dacAtYear) return t;
    }
    return '>99';
}

function updateSummary() {
    const s = getState();
    const gridLevel = s.grid.toLowerCase();
    const data = MAC_DATA[gridLevel] || MAC_DATA.medium;
    const dacMedVal = BENCHMARKS_DYNAMIC.dac.Medium.mid;
    const dacLowVal = BENCHMARKS_DYNAMIC.dac.Low.mid;
    const dacHighVal = BENCHMARKS_DYNAMIC.dac.High.mid;

    const regions = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
    const insights = regions.map(r => ({ region: r, dacCross: findCrossover(data[r], dacMedVal) }));
    const best = insights.reduce((a, b) => {
        const aVal = a.dacCross === '>99' ? 101 : a.dacCross;
        const bVal = b.dacCross === '>99' ? 101 : b.dacCross;
        return aVal > bVal ? a : b;
    });
    const worst = insights.reduce((a, b) => {
        const aVal = a.dacCross === '>99' ? 101 : a.dacCross;
        const bVal = b.dacCross === '>99' ? 101 : b.dacCross;
        return aVal < bVal ? a : b;
    });

    const el = document.getElementById('crossoverSummary');
    let html = '<strong>Under these assumptions:</strong> Grid decarbonization beats DAC (Medium $' + dacMedVal + '/ton) through <strong>' +
        (best.dacCross === '>99' ? '>99%' : best.dacCross + '%') + '</strong> in ' + best.region +
        ' (best) and through <strong>' + (worst.dacCross === '>99' ? '>99%' : worst.dacCross + '%') +
        '</strong> in ' + worst.region + ' (worst). DAC range: $' + dacLowVal + ' (Low) \u2013 $' + dacHighVal + ' (High).';
    if (s.grid === 'High') html += ' High grid costs accelerate the crossover \u2014 tariffs and permitting delays weaken the backbone.';
    el.innerHTML = html;
}

// ============================================================================
// REBUILD ALL
// ============================================================================
function rebuildAll() {
    buildMacChart();
    buildAnovaChart();
    buildPortfolio();
    buildLadder();
    buildInflectionTable();
    updateSummary();
}

// ============================================================================
// INIT
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    rebuildAll();
    initHeroScrolly();

    // Wire toggle buttons
    document.querySelectorAll('.ctrl-toggle button').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.ctrl-toggle').querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            rebuildAll();
        });
    });
});
</script>
</body>
</html>
