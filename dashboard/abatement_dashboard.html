<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The 8,760 Problem — Carbon Abatement Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles/shared.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
/* Page-specific background */
body { background: #F3F4F8; }

/* ========== DASHBOARD LAYOUT ========== */
.dashboard-wrap {
    max-width: 1320px;
    margin: 0 auto;
    padding: 32px 24px 48px;
}
.page-title-section {
    text-align: center;
    margin-bottom: 28px;
}
.page-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', 'Arial Narrow', sans-serif;
    font-size: 2.2rem;
    font-weight: 800;
    color: #DC2626;
    margin-bottom: 10px;
    letter-spacing: -0.5px;
    line-height: 1.2;
}
.page-intro {
    font-size: 0.95rem;
    color: #374151;
    line-height: 1.7;
    max-width: 800px;
    margin: 0 auto;
}

/* ========== CONTROLS PANEL ========== */
.controls-panel {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 14px;
    padding: 28px 32px;
    margin-bottom: 28px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.controls-panel-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--navy);
    margin-bottom: 4px;
}
.controls-panel-subtitle {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 20px;
}
.controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
}
.ctrl-group label {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--navy);
    display: block;
    margin-bottom: 8px;
    letter-spacing: 0.03em;
}
.ctrl-group .info-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: rgba(74,144,217,0.1);
    color: var(--accent-blue);
    font-size: 0.75rem;
    font-weight: 700;
    cursor: help;
    margin-left: 4px;
    vertical-align: middle;
}
.ctrl-toggle {
    display: flex;
    gap: 0;
    border: 2px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
}
.ctrl-toggle button {
    flex: 1;
    padding: 8px 14px;
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    border: none;
    background: #fff;
    color: var(--navy);
    cursor: pointer;
    transition: all 0.2s;
    min-height: 44px;
}
.ctrl-toggle button:not(:last-child) {
    border-right: 1px solid var(--border-light);
}
.ctrl-toggle button:hover {
    background: rgba(74,144,217,0.06);
}
.ctrl-toggle button.active {
    background: var(--navy);
    color: #fff;
}

/* ========== SUMMARY STRIP ========== */
.summary-strip {
    background: linear-gradient(135deg, rgba(14,165,233,0.06), rgba(233,30,99,0.04));
    border: 2px solid rgba(14,165,233,0.15);
    border-radius: 12px;
    padding: 18px 24px;
    margin-top: 20px;
    font-size: 0.9rem;
    color: #374151;
    line-height: 1.65;
    transition: opacity 0.3s;
}
.summary-strip strong { color: var(--navy); }

/* ========== PER-REGION ENVELOPE GRID ========== */
.envelope-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px; margin: 8px 0;
}
.envelope-card {
    background: #F8F9FB; border: 1px solid var(--border-light); border-radius: 10px;
    padding: 14px; border-top: 3px solid #ccc; position: relative;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
}
.envelope-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.envelope-card-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.88rem; font-weight: 700; color: var(--navy); margin-bottom: 2px;
    display: flex; align-items: center; gap: 6px;
}
.envelope-card-subtitle {
    font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;
}
.envelope-card canvas { width: 100% !important; height: 180px !important; }

/* ========== CHART GRID ========== */
.chart-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 28px;
}
.chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.chart-card-full {
    grid-column: 1 / -1;
}
.chart-card-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--navy);
    margin-bottom: 14px;
    text-align: center;
}
.chart-card canvas {
    width: 100% !important;
    height: 340px !important;
}
.chart-card-full canvas {
    height: 400px !important;
}

/* ========== INFLECTION TABLE ========== */
.inflection-card {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 14px;
    padding: 24px;
    margin-bottom: 28px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    overflow-x: auto;
}
.inflection-card table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.inflection-card th {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--navy);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 12px 10px;
    border-bottom: 2px solid var(--border);
    text-align: center;
    white-space: nowrap;
}
.inflection-card td {
    padding: 10px;
    text-align: center;
    font-weight: 600;
    border-bottom: 1px solid var(--border-light);
}
.inflection-card td:first-child {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    color: var(--navy);
    text-align: left;
    font-weight: 700;
}
.cell-green { background: rgba(34,197,94,0.12); color: #15803d; }
.cell-yellow { background: rgba(245,158,11,0.12); color: #b45309; }
.cell-orange { background: rgba(239,68,68,0.08); color: #c2410c; }
.cell-red { background: rgba(220,38,38,0.12); color: #dc2626; }

/* ========== FOOTER ========== */
.page-footer {
    background: #0F1A2E;
    color: rgba(255,255,255,0.7);
    padding: 32px 24px;
    text-align: center;
}
.footer-links { display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; margin-bottom: 12px; }
.footer-links a { color: rgba(255,255,255,0.65); text-decoration: none; font-size: 0.85rem; font-weight: 500; transition: color 0.2s; }
.footer-links a:hover { color: #ffffff; }
.footer-note { font-size: 0.78rem; color: rgba(255,255,255,0.4); }

.bottom-banner {
    height: 4px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 25%, #22C55E 50%, #F59E0B 75%, #EF4444 100%);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 900px) {
    .chart-grid { grid-template-columns: 1fr; }
    .controls-grid { grid-template-columns: 1fr 1fr; }
    .envelope-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
}
@media (max-width: 600px) {
    .envelope-grid { grid-template-columns: 1fr; }
    .envelope-card canvas { height: 140px !important; }
    .dashboard-wrap { padding: 20px 14px 36px; }
    .controls-panel { padding: 20px 16px; }
    .controls-grid { grid-template-columns: 1fr; }
    .chart-card { padding: 16px; }
    .chart-card canvas { height: 220px !important; }
    .chart-card-full canvas { height: 240px !important; }
    .page-title { font-size: 1.6rem; }
    .inflection-card { padding: 14px; }
    .inflection-card table { font-size: 0.75rem; }
    .inflection-card th { font-size: 0.75rem; padding: 8px 6px; }
    .inflection-card td { padding: 8px 6px; }
}
</style>
</head>
<body>

<!-- TOP NAV (injected by nav.js) -->
<nav id="topNav"></nav>
<script src="js/nav.js"></script>
<div style="background:#F3F4F8;padding:8px 24px;"><a href="index.html" style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-size:0.82rem;font-weight:600;color:#1A2744;text-decoration:none;display:inline-flex;align-items:center;gap:6px;letter-spacing:0.03em;min-height:44px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>Back to Home</a></div>

<!-- HEADER BANNER -->
<header class="header">
    <h1>The 8,760 Problem</h1>
    <p class="subtitle">Comparing the cost of CO₂ abatement through hourly clean energy procurement across regions and ambition levels.<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[10]</sup></p>
    <div class="header-accent"></div>
</header>

<!-- MAIN DASHBOARD -->
<div class="dashboard-wrap">

    <!-- Title + Intro -->
    <div class="page-title-section">
        <h2 class="page-title">Carbon Abatement Dashboard</h2>
        <p class="page-intro">
            How does hourly grid decarbonization compare to alternative carbon removal strategies?<sup style="font-size:0.7em;color:#6B7280;">[10]</sup>
            Adjust the toggles below to stress-test different cost assumptions and see how crossover points shift
            across regions and technologies in real time. Regional emission rates from EPA eGRID 2022<sup style="font-size:0.7em;color:#6B7280;">[1]</sup>; hourly profiles from EIA.<sup style="font-size:0.7em;color:#6B7280;">[7]</sup>
        </p>
    </div>

    <!-- Controls Panel -->
    <div class="controls-panel">
        <div class="controls-panel-title">Stress-Test Assumptions</div>
        <div class="controls-panel-subtitle">Adjust cost assumptions for grid decarbonization and competing technologies to see how crossover points shift.</div>
        <div class="controls-grid">
            <div class="ctrl-group">
                <label>Grid Cost Scenario <span class="info-icon" title="Low = cheap renewables, fast permitting, falling storage costs. High = tariffs, supply chain disruptions, permitting delays. Cost ranges per NREL ATB 2024 [5] and Lazard LCOE v17 [6].">i</span></label>
                <div class="ctrl-toggle" data-ctrl="grid">
                    <button data-value="Low">Low</button>
                    <button data-value="Medium" class="active">Medium</button>
                    <button data-value="High">High</button>
                </div>
            </div>
            <div class="ctrl-group">
                <label>DAC Cost Trajectory <span class="info-icon" title="Low = aggressive learning curves, $250/ton by 2030. Medium = current trajectory, $400-600/ton. High = slow scaling, $1000+/ton. Per NREL ATB 2024 [5].">i</span></label>
                <div class="ctrl-toggle" data-ctrl="dac">
                    <button data-value="Low">Low</button>
                    <button data-value="Medium" class="active">Medium</button>
                    <button data-value="High">High</button>
                </div>
            </div>
            <div class="ctrl-group">
                <label>Industrial Decarb Cost <span class="info-icon" title="Low = electrification is cheaper than fossil (net savings). Medium = moderate carbon price needed. High = expensive retrofit + high energy costs. Based on McKinsey MAC methodology [10].">i</span></label>
                <div class="ctrl-toggle" data-ctrl="industrial">
                    <button data-value="Low">Low</button>
                    <button data-value="Medium" class="active">Medium</button>
                    <button data-value="High">High</button>
                </div>
            </div>
            <div class="ctrl-group">
                <label>Carbon Removal Alternatives <span class="info-icon" title="Low = BECCS + enhanced weathering hit scale, $50-100/ton. Medium = moderate scaling. High = limited deployment, $200+/ton. Benchmarks from IPCC AR6 WG3 [9] and NREL ATB [5].">i</span></label>
                <div class="ctrl-toggle" data-ctrl="removal">
                    <button data-value="Low">Low</button>
                    <button data-value="Medium" class="active">Medium</button>
                    <button data-value="High">High</button>
                </div>
            </div>
        </div>
        <div class="summary-strip" id="crossoverSummary"></div>
    </div>

    <!-- Per-Region Envelope Grid -->
    <div class="chart-card chart-card-full" style="margin-bottom:24px;">
        <div class="chart-card-title">Abatement Cost by Region — P10/P90 Uncertainty Envelopes<sup style="font-size:0.7em;color:#6B7280;">[1][7]</sup></div>
        <div class="envelope-grid" id="macEnvelopeGrid"></div>
    </div>

    <!-- Chart Grid -->
    <div class="chart-grid">
        <!-- ANOVA Sensitivity -->
        <div class="chart-card">
            <div class="chart-card-title">What Drives MAC Uncertainty? (ANOVA Decomposition)</div>
            <canvas id="anovaChart"></canvas>
        </div>

        <!-- Marginal MAC by Region (toggle-responsive) -->
        <div class="chart-card">
            <div class="chart-card-title">Marginal MAC by Region — Two-Zone View</div>
            <canvas id="portfolioChart"></canvas>
        </div>

        <!-- Abatement Ladder (full width) -->
        <div class="chart-card chart-card-full">
            <div class="chart-card-title">Abatement Cost Ladder: Grid vs. Alternatives<sup style="font-size:0.7em;color:#6B7280;">[5][6][10]</sup></div>
            <canvas id="ladderChart"></canvas>
        </div>
    </div>

    <!-- Inflection Table -->
    <div class="inflection-card">
        <div class="chart-card-title" style="margin-bottom:16px;">Cost Crossover Analysis: Where Grid Average MAC Exceeds Benchmarks<sup style="font-size:0.7em;color:#6B7280;">[2][3][4]</sup></div>
        <table>
            <thead><tr id="inflectionHead"></tr></thead>
            <tbody id="inflectionBody"></tbody>
        </table>
    </div>

</div>

<!-- SOURCES -->
<div style="max-width:1320px;margin:0 auto;padding:0 24px 24px;">
    <details style="background:#fff;border:1px solid #E5E7EB;border-radius:10px;padding:16px 20px;">
        <summary style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-size:0.9rem;font-weight:600;color:#1A2744;cursor:pointer;">Sources &amp; References</summary>
        <ol style="font-size:0.8rem;color:#6B7280;line-height:1.8;padding-left:20px;margin-top:12px;">
            <li>EPA eGRID 2022 — regional emission rates and CO&#8322; intensity by balancing authority.</li>
            <li>EPA Social Cost of Carbon — Technical Support Document (2020), central estimate $51/tonne.</li>
            <li>Rennert, K. et al. (2022). "Comprehensive evidence implies a higher social cost of CO&#8322;." <em>Nature</em>, 610, 687-692. $185/tonne.</li>
            <li>EU Emissions Trading System (EU ETS) — carbon price range $60-100/tonne.</li>
            <li>NREL Annual Technology Baseline (ATB) 2024 — technology costs for wind, solar, storage, nuclear, CCS, DAC.</li>
            <li>Lazard Levelized Cost of Energy Analysis v17.0 (2024) — generation technology cost benchmarks.</li>
            <li>EIA Hourly Electric Grid Monitor — hourly generation data by fuel type and balancing authority.</li>
            <li>IEA Net Zero by 2050 Roadmap (2023 update) — sector emission reduction benchmarks.</li>
            <li>IPCC AR6 Working Group III (2022) — power sector targets and mitigation pathways.</li>
            <li>McKinsey Marginal Abatement Cost Curve methodology — cross-sector decarbonization benchmarks.</li>
        </ol>
    </details>
</div>

<!-- FOOTER -->
<footer class="page-footer">
    <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Cost Optimizer</a>
        <a href="abatement_comparison.html">CO&#8322; Abatement Summary</a>
        <a href="eac_scarcity.html">EAC Scarcity</a>
        <a href="region_deepdive.html">Regional Deep Dives</a>
        <a href="research_paper.html">Methodology &amp; Paper</a>
        <a href="about.html">About</a>
        <a href="../power-gen-decarbonization/site/index.html">Generator Analysis</a>
        <a href="about.html">About</a>
    </div>
    <div class="footer-note">The 8,760 Problem &mdash; 2025 Snapshot Model</div>
</footer>
<div class="bottom-banner"></div>

<script src="js/shared-data.js"></script>
<script src="js/mac-stats-data.js"></script>
<script>
// ============================================================================
// HELPERS
// ============================================================================
function getState() {
    const state = { grid: 'Medium', dac: 'Medium', industrial: 'Medium', removal: 'Medium' };
    document.querySelectorAll('.ctrl-toggle').forEach(toggle => {
        const ctrl = toggle.dataset.ctrl;
        const active = toggle.querySelector('button.active');
        if (active && ctrl) state[ctrl] = active.dataset.value;
    });
    return state;
}

// findCrossover(), cellClass(), getAllBenchmarks() provided by shared-data.js

// Shared chart defaults: rounded bars, no grid lines, keep axes
const CHART_DEFAULTS = {
    borderRadius: 6,
    grid: { display: false },
    axisStyle: { grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
};

// ============================================================================
// CHART: Per-Region MAC Envelope Charts (small multiples)
// ============================================================================
let macChartInstances = {};
function buildMacChart() {
    const s = getState();
    const grid = document.getElementById('macEnvelopeGrid');
    if (!grid) return;

    const regions = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
    const regionNames = { CAISO: 'CAISO (California)', ERCOT: 'ERCOT (Texas)', PJM: 'PJM (Mid-Atlantic)',
                          NYISO: 'NYISO (New York)', NEISO: 'NEISO (New England)' };
    const thresholds9 = THRESHOLDS;
    const gridLevel = s.grid.toLowerCase();
    const macData = MAC_DATA[gridLevel] || MAC_DATA.medium;
    const dacCosts = BENCHMARKS_DYNAMIC.dac[s.dac] || BENCHMARKS_DYNAMIC.dac.Medium;

    // Destroy old instances
    Object.values(macChartInstances).forEach(c => c.destroy());
    macChartInstances = {};

    // Compute shared Y max
    let yMax = 0;
    regions.forEach(iso => {
        const fan = MAC_FAN_DATA?.[iso];
        if (fan) yMax = Math.max(yMax, ...fan.p90.filter(v => v != null));
    });
    yMax = Math.ceil(yMax / 25) * 25 + 25;

    // Build card HTML
    grid.innerHTML = regions.map(iso => {
        const c = REGION_COLORS[iso];
        const mac99 = macData[iso]?.[8] || 0;
        const p10_99 = Math.round(MAC_FAN_DATA[iso]?.p10?.[8] || 0);
        const p90_99 = Math.round(MAC_FAN_DATA[iso]?.p90?.[8] || 0);
        return `<div class="envelope-card" style="border-top-color:${c}">` +
            `<div class="envelope-card-title">` +
            `  <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${c}"></span>` +
            `  ${regionNames[iso]}` +
            `  <span style="margin-left:auto;font-family:'Barlow Semi Condensed',sans-serif;font-size:1rem;font-weight:800;color:${c}">$${mac99}/ton</span>` +
            `</div>` +
            `<div class="envelope-card-subtitle">At 99% · Range: $${p10_99}–$${p90_99}/ton</div>` +
            `<canvas id="macEnv_${iso}"></canvas>` +
            `</div>`;
    }).join('');

    // Build each chart
    regions.forEach(iso => {
        const ctx = document.getElementById('macEnv_' + iso)?.getContext('2d');
        if (!ctx) return;
        const fan = MAC_FAN_DATA?.[iso];
        const env = MAC_ENVELOPE_DATA?.[iso]?.envelope;
        if (!fan) return;

        const c = REGION_COLORS[iso];
        const p90 = fan.p90.map((v, i) => ({ x: thresholds9[i], y: v }));
        const p10 = fan.p10.map((v, i) => ({ x: thresholds9[i], y: v }));
        const p50 = (env || fan.p50).map((v, i) => ({ x: thresholds9[i], y: v }));

        macChartInstances[iso] = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    { label: 'P90', data: p90, borderColor: 'transparent', backgroundColor: c + '20',
                        borderWidth: 0, pointRadius: 0, fill: '+1', tension: 0.3, order: 3 },
                    { label: 'P10', data: p10, borderColor: c + '44', backgroundColor: 'transparent',
                        borderWidth: 1, borderDash: [3, 3], pointRadius: 0, fill: false, tension: 0.3, order: 3 },
                    { label: 'Midpoint', data: p50, borderColor: c, backgroundColor: c + '18',
                        borderWidth: 2.5, pointRadius: 2, pointHoverRadius: 5, fill: false, tension: 0.3, order: 1 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'nearest', intersect: false },
                scales: {
                    x: { type: 'linear', min: 74, max: 100,
                        ticks: { stepSize: 5, callback: v => v + '%', font: { size: 9 } },
                        grid: { display: false }, border: { display: true, color: '#D4D8E0' }
                    },
                    y: { min: 0, max: yMax,
                        ticks: { callback: v => '$' + v, font: { size: 9 }, stepSize: 50 },
                        grid: { color: 'rgba(0,0,0,0.04)' }, border: { display: true, color: '#D4D8E0' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(26,39,68,0.92)',
                        titleFont: { family: "'Barlow Semi Condensed', sans-serif", size: 11, weight: '600' },
                        bodyFont: { family: "'Barlow Semi Condensed', sans-serif", size: 10 },
                        padding: 8, cornerRadius: 6,
                        callbacks: {
                            title: items => items[0].raw.x + '% Target',
                            label: item => {
                                if (item.dataset.label !== 'Midpoint') return null;
                                const idx = THRESHOLDS.indexOf(item.raw.x);
                                return 'MAC: $' + Math.round(item.raw.y) + '/ton' +
                                    (idx >= 0 ? ' (P10: $' + Math.round(fan.p10[idx]) + ', P90: $' + Math.round(fan.p90[idx]) + ')' : '');
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            scc: { type: 'line', yMin: 190, yMax: 190, borderColor: '#FF980099', borderWidth: 1.5, borderDash: [5, 3],
                                label: { display: true, content: 'SCC $190', position: 'start', font: { size: 8 }, color: '#FF9800', backgroundColor: 'rgba(255,255,255,0.85)', padding: 2 }
                            },
                            dac: { type: 'line', yMin: dacCosts.mid, yMax: dacCosts.mid, borderColor: '#E91E6399', borderWidth: 1.5, borderDash: [5, 3],
                                label: { display: true, content: 'DAC $' + dacCosts.mid, position: 'end', font: { size: 8 }, color: '#E91E63', backgroundColor: 'rgba(255,255,255,0.85)', padding: 2 }
                            }
                        }
                    },
                    datalabels: { display: false }
                }
            }
        });
    });
}

// ============================================================================
// CHART: ANOVA Sensitivity Decomposition
// ============================================================================
let anovaChartInst = null;
function buildAnovaChart() {
    const ctx = document.getElementById('anovaChart').getContext('2d');
    const toggleNames = ['Renewable\nGen', 'Firm\nGen', 'Storage', 'Fossil\nFuel', 'Trans-\nmission'];
    const toggleColors = ['#22C55E', '#1E3A5F', '#8B5CF6', '#EF4444', '#F59E0B'];
    const regions = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
    const anovaKeys = ['Renewable Gen', 'Firm Gen', 'Storage', 'Fossil Fuel', 'Transmission'];

    const datasets = regions.map(region => ({
        label: region,
        data: anovaKeys.map(k => Math.round((MAC_ANOVA[region]?.[k] || 0) * 100)),
        backgroundColor: REGION_COLORS[region] + '90',
        borderColor: REGION_COLORS[region],
        borderWidth: 1.5,
        borderRadius: 4,
        barPercentage: 0.75,
        categoryPercentage: 0.85
    }));

    if (anovaChartInst) anovaChartInst.destroy();
    anovaChartInst = new Chart(ctx, {
        type: 'bar',
        data: { labels: toggleNames, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { ticks: { font: { size: 10, weight: 600 }, maxRotation: 0 },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' } },
                y: { min: 0, max: 70,
                    title: { display: true, text: '% of MAC Variance Explained', font: { size: 11, weight: 600 } },
                    ticks: { stepSize: 10, callback: v => v + '%', font: { size: 10 } },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
            },
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle', padding: 12, font: { size: 10, weight: 600 } } },
                tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw + '%' } },
                datalabels: { display: false }
            }
        }
    });
}

// ============================================================================
// CHART: Marginal MAC by Region (toggle-responsive, two-zone view)
// ============================================================================
let portfolioInst = null;
function buildPortfolio() {
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    const s = getState();
    const gridLevel = s.grid.toLowerCase();
    const margData = MARGINAL_MAC_DATA[gridLevel] || MARGINAL_MAC_DATA.medium;
    const dacCosts = BENCHMARKS_DYNAMIC.dac[s.dac] || BENCHMARKS_DYNAMIC.dac.Medium;
    const regions = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];

    const datasets = regions.map(iso => ({
        label: iso,
        data: margData[iso].map(v => v != null ? Math.min(v, 1050) : 0),
        backgroundColor: REGION_COLORS[iso] + 'AA',
        borderColor: REGION_COLORS[iso],
        borderWidth: 1.5,
        borderRadius: 4,
        barPercentage: 0.75,
        categoryPercentage: 0.85
    }));

    if (portfolioInst) portfolioInst.destroy();
    portfolioInst = new Chart(ctx, {
        type: 'bar',
        data: { labels: MARGINAL_MAC_LABELS, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { title: { display: true, text: 'CFE Matching Step', font: { size: 11, weight: 600 } },
                    ticks: { font: { size: 9 }, maxRotation: 45, minRotation: 20 },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' } },
                y: { min: 0, max: 1100,
                    title: { display: true, text: 'Marginal MAC ($/ton CO\u2082)', font: { size: 11, weight: 600 } },
                    ticks: { callback: v => '$' + v, font: { size: 10 }, stepSize: 200 },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
            },
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle', padding: 12, font: { size: 10, weight: 600 } } },
                tooltip: { callbacks: { label: item => item.dataset.label + ': $' + margData[item.dataset.label][item.dataIndex] + '/ton' } },
                datalabels: { display: false },
                annotation: {
                    annotations: {
                        scc: { type: 'line', yMin: 190, yMax: 190, borderColor: '#FF980088', borderWidth: 2, borderDash: [6, 4],
                            label: { display: true, content: 'SCC $190', position: 'start', font: { size: 9, weight: 600 }, color: '#FF9800', backgroundColor: 'rgba(255,255,255,0.9)', padding: 3 } },
                        dac: { type: 'line', yMin: dacCosts.mid, yMax: dacCosts.mid, borderColor: '#E91E6388', borderWidth: 2, borderDash: [6, 4],
                            label: { display: true, content: 'DAC $' + dacCosts.mid, position: 'end', font: { size: 9, weight: 600 }, color: '#E91E63', backgroundColor: 'rgba(255,255,255,0.9)', padding: 3 } }
                    }
                }
            }
        }
    });
}

// ============================================================================
// CHART: Abatement Ladder (horizontal bar)
// ============================================================================
let ladderInst = null;
function buildLadder() {
    const ctx = document.getElementById('ladderChart').getContext('2d');
    const s = getState();
    const benchmarks = getAllBenchmarks(s);
    const gridLevel = s.grid.toLowerCase();
    const macData = MAC_DATA[gridLevel] || MAC_DATA.medium;

    const labels = benchmarks.map(b => b.short || b.name);
    const barData = benchmarks.map(b => [Math.max(b.low, 0), Math.min(b.high, 650)]);
    const bgColors = benchmarks.map(b => b.color + '40');
    const borderColors = benchmarks.map(b => b.color);

    // Grid crossover annotations
    const annotations = {};
    const markerPairs = [
        { label: 'ERCOT 90%', cost: macData.ERCOT[THRESHOLDS.indexOf(90)], color: REGION_COLORS.ERCOT },
        { label: 'CAISO 95%', cost: macData.CAISO[THRESHOLDS.indexOf(95)], color: REGION_COLORS.CAISO },
        { label: 'NYISO 99%', cost: macData.NYISO[THRESHOLDS.indexOf(99)], color: REGION_COLORS.NYISO },
        { label: 'NEISO 99%', cost: macData.NEISO[THRESHOLDS.indexOf(99)], color: REGION_COLORS.NEISO }
    ];
    markerPairs.forEach((m, i) => {
        annotations['grid' + i] = {
            type: 'line', xMin: m.cost, xMax: m.cost,
            borderColor: m.color + 'aa', borderWidth: 2, borderDash: [4, 3],
            label: { display: true, content: m.label, position: i % 2 === 0 ? 'start' : 'end',
                font: { size: 9 }, color: m.color, backgroundColor: 'rgba(255,255,255,0.9)', padding: 2 }
        };
    });

    if (ladderInst) ladderInst.destroy();
    ladderInst = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Cost Range',
                data: barData,
                backgroundColor: bgColors,
                borderColor: borderColors,
                borderWidth: 2,
                borderRadius: 6,
                borderSkipped: false,
                barPercentage: 0.65
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { min: 0, max: 650,
                    title: { display: true, text: '$/ton CO\u2082', font: { size: 12, weight: 600 } },
                    ticks: { stepSize: 50, callback: v => '$' + v, font: { size: 10 } },
                    grid: { display: false }, border: { display: true, color: '#D4D8E0' }
                },
                y: { ticks: { font: { size: 11, weight: 500 } }, grid: { display: false }, border: { display: true, color: '#D4D8E0' } }
            },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => Array.isArray(ctx.raw) ? 'Range: $' + ctx.raw[0] + ' \u2013 $' + ctx.raw[1] + '/ton' : '' } },
                datalabels: { display: false },
                annotation: { annotations }
            }
        }
    });
}

// ============================================================================
// TABLE: Inflection Points
// ============================================================================
function buildInflectionTable() {
    const s = getState();
    const gridLevel = s.grid.toLowerCase();
    const macData = MAC_DATA[gridLevel] || MAC_DATA.medium;
    const dacMid = (BENCHMARKS_DYNAMIC.dac[s.dac] || BENCHMARKS_DYNAMIC.dac.Medium).mid;
    const indMid = (BENCHMARKS_DYNAMIC.industrial[s.industrial] || BENCHMARKS_DYNAMIC.industrial.Medium).mid;
    const remMid = (BENCHMARKS_DYNAMIC.removal[s.removal] || BENCHMARKS_DYNAMIC.removal.Medium).mid;

    const head = document.getElementById('inflectionHead');
    head.innerHTML = '<th>Region</th><th>EPA SCC<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[2]</sup><br>($190)</th><th>EU ETS<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[4]</sup><br>($88)</th><th>Rennert SCC<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[3]</sup><br>($185)</th><th>Industrial<br>($' + indMid + ')</th><th>Removal<br>($' + remMid + ')</th><th>DAC<sup style="font-size:0.7em;color:rgba(255,255,255,0.7);">[5]</sup><br>($' + dacMid + ')</th>';

    const tbody = document.getElementById('inflectionBody');
    tbody.innerHTML = '';
    ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'].forEach(region => {
        const row = document.createElement('tr');
        const vals = [
            findCrossover(macData[region], 190),
            findCrossover(macData[region], 88),
            findCrossover(macData[region], 185),
            findCrossover(macData[region], Math.max(indMid, 10)),
            findCrossover(macData[region], remMid),
            findCrossover(macData[region], dacMid)
        ];
        row.innerHTML = '<td>' + region + '</td>' + vals.map(v => '<td class="' + cellClass(v) + '">' + (v === '>99' || v === '>100' ? '>99%' : v + '%') + '</td>').join('');
        tbody.appendChild(row);
    });
}

// ============================================================================
// SUMMARY
// ============================================================================
function updateSummary() {
    const s = getState();
    const gridLevel = s.grid.toLowerCase();
    const data = MAC_DATA[gridLevel] || MAC_DATA.medium;
    const dacMid = (BENCHMARKS_DYNAMIC.dac[s.dac] || BENCHMARKS_DYNAMIC.dac.Medium).mid;

    const regions = ['CAISO', 'ERCOT', 'PJM', 'NYISO', 'NEISO'];
    const insights = regions.map(r => ({ region: r, dacCross: findCrossover(data[r], dacMid) }));
    const best = insights.reduce((a, b) => {
        const aVal = a.dacCross === '>99' ? 101 : a.dacCross;
        const bVal = b.dacCross === '>99' ? 101 : b.dacCross;
        return aVal > bVal ? a : b;
    });
    const worst = insights.reduce((a, b) => {
        const aVal = a.dacCross === '>99' ? 101 : a.dacCross;
        const bVal = b.dacCross === '>99' ? 101 : b.dacCross;
        return aVal < bVal ? a : b;
    });

    const el = document.getElementById('crossoverSummary');
    let html = '<strong>Under these assumptions:</strong> Grid decarbonization beats DAC through <strong>' +
        (best.dacCross === '>99' ? '>99%' : best.dacCross + '%') + '</strong> in ' + best.region +
        ' (best) and through <strong>' + (worst.dacCross === '>99' ? '>99%' : worst.dacCross + '%') +
        '</strong> in ' + worst.region + ' (worst).';
    if (s.dac === 'Low') html += ' With aggressive DAC cost declines, crossovers shift 2\u20134 points earlier.';
    if (s.grid === 'High') html += ' High grid costs accelerate the crossover \u2014 tariffs and permitting delays weaken the backbone.';
    el.innerHTML = html;
}

// ============================================================================
// REBUILD ALL
// ============================================================================
function rebuildAll() {
    buildMacChart();
    buildAnovaChart();
    buildPortfolio();
    buildLadder();
    buildInflectionTable();
    updateSummary();
}

// ============================================================================
// INIT
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    rebuildAll();

    // Wire toggle buttons
    document.querySelectorAll('.ctrl-toggle button').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.ctrl-toggle').querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            rebuildAll();
        });
    });
});
</script>
</body>
</html>
