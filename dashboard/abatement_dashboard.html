<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The 8,760 Problem — CO₂ Abatement Analysis</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles/shared.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
/* Page-specific background */
body { background: #F3F4F8; }

/* ========== FOOTER ========== */
.page-footer {
    background: #0F1A2E;
    color: rgba(255,255,255,0.7);
    padding: 32px 24px;
    text-align: center;
}
.footer-links { display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; margin-bottom: 12px; }
.footer-links a { color: rgba(255,255,255,0.65); text-decoration: none; font-size: 0.85rem; font-weight: 500; transition: color 0.2s; }
.footer-links a:hover { color: #ffffff; }
.footer-note { font-size: 0.78rem; color: rgba(255,255,255,0.4); }

.bottom-banner {
    height: 4px;
    background: linear-gradient(90deg, #1A2744 0%, #0EA5E9 25%, #22C55E 50%, #F59E0B 75%, #EF4444 100%);
}

/* ========== HERO OVERVIEW ========== */
.hero-overview {
    background: linear-gradient(180deg, #0B1120 0%, #13203D 100%);
    position: relative;
    overflow: hidden;
    padding: 60px 24px 48px;
}
.hero-overview::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 30% 20%, rgba(14,165,233,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(233,30,99,0.06) 0%, transparent 60%);
    pointer-events: none;
}
.hero-overview-inner {
    position: relative;
    max-width: 1320px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 48px;
    align-items: center;
}
.hero-text-block {
    z-index: 2;
}
.hero-text-block h2 {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 2rem;
    font-weight: 800;
    color: #fff;
    margin-bottom: 16px;
    line-height: 1.2;
    letter-spacing: -0.5px;
}
.hero-text-block p {
    font-size: 0.95rem;
    color: rgba(255,255,255,0.75);
    line-height: 1.75;
    margin-bottom: 16px;
}
.hero-chart-block {
    z-index: 1;
}
.chart-panel {
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(74,144,217,0.2);
    border-radius: 16px;
    padding: 28px 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 100%;
}
.chart-panel-overview {
    background: rgba(15,26,46,0.85);
    height: 480px;
}
.chart-panel-overview canvas {
    width: 100% !important;
    height: 380px !important;
}
.hero-chart-title {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    color: rgba(255,255,255,0.85);
    text-align: center;
    margin-bottom: 10px;
    letter-spacing: 0.02em;
}
.hero-chart-subtitle {
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-size: 0.72rem;
    color: rgba(255,255,255,0.45);
    text-align: center;
    margin-top: 6px;
}

/* ========== REGION SECTIONS (sticky chart + narrative) ========== */
.region-section {
    background: #0B1120;
    position: relative;
    border-top: 1px solid rgba(255,255,255,0.06);
}
.region-section-inner {
    max-width: 1320px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    min-height: 100vh;
}
.region-chart-col {
    position: sticky;
    top: 0;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 32px;
}
.chart-panel-region {
    background: rgba(0,0,0,0.95);
    border-color: rgba(255,255,255,0.08);
    height: 480px;
}
.chart-panel-region canvas {
    width: 100% !important;
    height: 380px !important;
}
.region-narrative-col {
    padding: 80px 48px 80px 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.region-step-card {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 32px;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}
.region-step-card.visible {
    opacity: 1;
    transform: translateY(0);
}
.region-step-card h3 {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 1.5rem;
    font-weight: 800;
    color: #fff;
    margin-bottom: 12px;
    line-height: 1.25;
    letter-spacing: -0.3px;
}
.region-step-card p {
    font-size: 0.92rem;
    color: rgba(255,255,255,0.75);
    line-height: 1.75;
    margin-bottom: 0;
}
.region-step-card .step-stat {
    display: inline-block;
    margin-top: 14px;
    padding: 8px 16px;
    border-radius: 10px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-size: 0.88rem;
    font-weight: 700;
}
.step-stat-green {
    background: rgba(34,197,94,0.12);
    border: 1px solid rgba(34,197,94,0.25);
    color: #4ade80;
}
.step-stat-amber {
    background: rgba(245,158,11,0.12);
    border: 1px solid rgba(245,158,11,0.25);
    color: #fbbf24;
}
.step-stat-red {
    background: rgba(239,68,68,0.12);
    border: 1px solid rgba(239,68,68,0.25);
    color: #f87171;
}
.step-stat-blue {
    background: rgba(14,165,233,0.12);
    border: 1px solid rgba(14,165,233,0.25);
    color: #38bdf8;
}
.region-tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-family: 'Barlow Semi Condensed', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    margin-bottom: 10px;
    text-transform: uppercase;
}

/* ========== SYNTHESIS SECTION ========== */
.synthesis-section {
    background: linear-gradient(180deg, #0B1120 0%, #13203D 100%);
    padding: 80px 24px;
}
.synthesis-inner {
    max-width: 900px;
    margin: 0 auto;
}
.synthesis-card {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 32px;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s ease, transform 0.8s ease;
}
.synthesis-card.visible {
    opacity: 1;
    transform: translateY(0);
}
.synthesis-card h3 {
    font-family: 'Franklin Gothic Demi', 'Barlow Semi Condensed', sans-serif;
    font-size: 1.5rem;
    font-weight: 800;
    color: #fff;
    margin-bottom: 12px;
    line-height: 1.25;
}
.synthesis-card p {
    font-size: 0.92rem;
    color: rgba(255,255,255,0.75);
    line-height: 1.75;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 900px) {
    .hero-overview-inner { grid-template-columns: 1fr; gap: 24px; }
    .hero-text-block h2 { font-size: 1.5rem; }
    .chart-panel-overview { height: 350px; }
    .chart-panel-overview canvas { height: 270px !important; }
    .region-section-inner { grid-template-columns: 1fr; min-height: auto; }
    .region-chart-col { position: relative; height: auto; padding: 24px 16px 0; }
    .chart-panel-region { height: 320px; padding: 16px 14px; }
    .chart-panel-region canvas { height: 240px !important; }
    .region-narrative-col { padding: 24px 20px 48px; }
    .region-step-card { padding: 24px 20px; }
    .region-step-card h3 { font-size: 1.25rem; }
    .synthesis-section { padding: 48px 20px; }
    .synthesis-card { padding: 28px 24px; }
}
@media (max-width: 600px) {
    .hero-overview { padding: 40px 16px 32px; }
    .chart-panel-overview { height: 300px; padding: 14px 12px; }
    .chart-panel-overview canvas { height: 220px !important; }
    .chart-panel-region { height: 290px; padding: 12px 10px; }
    .chart-panel-region canvas { height: 210px !important; }
    .region-narrative-col { padding: 20px 14px 40px; }
    .region-step-card { padding: 18px 14px; }
    .region-step-card h3 { font-size: 1.05rem; }
    .region-step-card p { font-size: 0.85rem; }
    .synthesis-card { padding: 20px 16px; }
    .synthesis-card h3 { font-size: 1.15rem; }
}
</style>
</head>
<body>

<!-- TOP NAV (injected by nav.js) -->
<nav id="topNav"></nav>
<script src="js/nav.js"></script>
<div style="background:#F3F4F8;padding:8px 24px;"><a href="index.html" style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-size:0.82rem;font-weight:600;color:#1A2744;text-decoration:none;display:inline-flex;align-items:center;gap:6px;letter-spacing:0.03em;min-height:44px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>Back to Home</a></div>

<!-- HEADER BANNER -->
<header class="header">
    <h1>The 8,760 Problem</h1>
    <p class="subtitle">Comparing the cost of CO₂ abatement through hourly clean energy procurement across regions and ambition levels</p>
    <div class="header-accent"></div>
</header>

<!-- HERO: Overview chart + framing text -->
<section class="hero-overview">
    <div class="hero-overview-inner">
        <div class="hero-text-block">
            <h2>Today's investment decisions determine where grid decarb outcompetes DAC</h2>
            <p>The marginal cost of each additional percent of clean energy — not the average — determines when DAC becomes the cheaper path. Across thousands of sensitivity scenarios per region, the crossover point shifts by 10–25 percentage points depending on which technologies get investment today.</p>
            <p>Early bets on nuclear, geothermal, or renewables have catalytic effects on how deep grid decarbonization can go before DAC wins.</p>
            <span class="step-stat step-stat-blue">5,832+ cost scenarios &times; 5 ISOs: crossover shifts 10–25 points on policy choices</span>
        </div>
        <div class="hero-chart-block">
            <div class="chart-panel chart-panel-overview">
                <div class="hero-chart-title">Marginal Abatement Cost vs. Projected DAC — All Regions</div>
                <canvas id="heroScrollyChart"></canvas>
                <div class="hero-chart-subtitle">Solid line = stepwise envelope (Medium cost) &middot; Shaded band = P10–P90 &middot; Dashed = DAC projections</div>
            </div>
        </div>
    </div>
</section>

<!-- REGION: ERCOT -->
<section class="region-section" data-region="ERCOT">
    <div class="region-section-inner">
        <div class="region-chart-col">
            <div class="chart-panel chart-panel-region" style="width:100%;">
                <div class="hero-chart-title">ERCOT (Texas)</div>
                <canvas id="envScrolly_ERCOT"></canvas>
            </div>
        </div>
        <div class="region-narrative-col">
            <div class="region-step-card">
                <span class="region-tag" style="background:rgba(34,197,94,0.15);color:#22C55E;">ERCOT</span>
                <h3>Renewable tax credits make ERCOT a no-regrets bet to 97.5%</h3>
                <p>At medium costs, ERCOT's grid decarb beats central DAC through 97.5%. With low renewable costs — the trajectory sustained by IRA tax credits — the crossover extends to 99%. Even under all-high cost assumptions, grid investment wins to 97.5%. ERCOT is the strongest case for continued grid investment: deep solar/wind resources mean no plausible future where DAC is cheaper before ~95%.</p>
                <span class="step-stat step-stat-green">Low renewables: grid wins to 99% &middot; All High: still wins to 97.5%</span>
            </div>
        </div>
    </div>
</section>

            <!-- Act 3: PJM -->
            <div class="hero-scrolly-step" data-hero-step="pjm">
                <div class="hero-step-card">
                    <span class="region-tag" style="background:rgba(74,144,217,0.15);color:#4a90d9;">PJM</span>
                    <h3>PJM hits a cliff at 90%: cheap firm generation buys another 2.5 points</h3>
                    <p>At medium costs, PJM's marginal grid cost beats DAC central through 90%. Low firm generation costs (achieved nuclear/geothermal) extend this to 92.5%. But high renewables + high firm gen drops the crossover to just 87.5%. The policy signal: PJM's path past 90% depends entirely on whether new nuclear generation achieves cost learning — renewables alone aren't enough at these penetration levels.</p>
                    <span class="step-stat step-stat-amber">Low firm gen: grid wins to 92.5% &middot; High firm + high RE: only 87.5%</span>
                </div>
            </div>

            <!-- Act 4: CAISO -->
            <div class="hero-scrolly-step" data-hero-step="caiso">
                <div class="hero-step-card">
                    <span class="region-tag" style="background:rgba(245,158,11,0.15);color:#F59E0B;">CAISO</span>
                    <h3>CAISO: High marginal cost volatility, but grid still wins deep under medium costs</h3>
                    <p>CAISO shows extreme marginal cost swings — $738/metric ton at 75% under medium costs, yet grid still beats DAC central through 99% because later steps are cheap. The variance is driven by how new nuclear resources dispatch. Low firm + low renewable costs extend the crossover to 97.5%. High firm + high renewable costs mean grid never beats even optimistic DAC. The lesson: CAISO's path past 90% is a bet on firm generation, not more solar.</p>
                    <span class="step-stat step-stat-red">High firm + high RE: grid never beats optimistic DAC &middot; Low combo: wins to 97.5%</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- REGION: CAISO -->
<section class="region-section" data-region="CAISO">
    <div class="region-section-inner">
        <div class="region-chart-col">
            <div class="chart-panel chart-panel-region" style="width:100%;">
                <div class="hero-chart-title">CAISO (California)</div>
                <canvas id="envScrolly_CAISO"></canvas>
            </div>
        </div>
        <div class="region-narrative-col">
            <div class="region-step-card">
                <span class="region-tag" style="background:rgba(245,158,11,0.15);color:#F59E0B;">CAISO</span>
                <h3>CAISO: High marginal cost volatility, but grid still wins deep under medium costs</h3>
                <p>CAISO shows extreme marginal cost swings — $738/metric ton at 75% under medium costs, yet grid still beats DAC central through 99% because later steps are cheap. The variance is driven by how clean firm resources dispatch. Low firm + low renewable costs extend the crossover to 97.5%. High firm + high renewable costs mean grid never beats even optimistic DAC. The lesson: CAISO's path past 90% is a bet on firm generation, not more solar.</p>
                <span class="step-stat step-stat-red">High firm + high RE: grid never beats optimistic DAC &middot; Low combo: wins to 97.5%</span>
            </div>
        </div>
    </div>
</section>

<!-- REGION: NYISO -->
<section class="region-section" data-region="NYISO">
    <div class="region-section-inner">
        <div class="region-chart-col">
            <div class="chart-panel chart-panel-region" style="width:100%;">
                <div class="hero-chart-title">NYISO (New York)</div>
                <canvas id="envScrolly_NYISO"></canvas>
            </div>
        </div>
        <div class="region-narrative-col">
            <div class="region-step-card">
                <span class="region-tag" style="background:rgba(233,30,99,0.15);color:#E91E63;">NYISO</span>
                <h3>NYISO: Hydro and nuclear carry the grid to 85%, then costs spike</h3>
                <p>New York benefits from significant existing hydro and nuclear capacity, keeping marginal abatement costs moderate through 85% clean energy. At medium costs, grid decarb beats DAC central through 85%. Low firm generation costs push the crossover to 90% — but the gain is narrow. Past 90%, NYISO's limited wind resource and constrained transmission corridors drive marginal costs sharply higher. New York's climate law (CLCPA) requires either breakthrough firm generation costs or acceptance that DAC closes the final gap more cheaply.</p>
                <span class="step-stat step-stat-red">Medium: grid wins to 85% &middot; Low firm gen: 90% &middot; High costs: only 80%</span>
            </div>
        </div>
    </div>
</section>

<!-- REGION: NEISO -->
<section class="region-section" data-region="NEISO">
    <div class="region-section-inner">
        <div class="region-chart-col">
            <div class="chart-panel chart-panel-region" style="width:100%;">
                <div class="hero-chart-title">NEISO (New England)</div>
                <canvas id="envScrolly_NEISO"></canvas>
            </div>
        </div>
        <div class="region-narrative-col">
            <div class="region-step-card">
                <span class="region-tag" style="background:rgba(156,39,176,0.15);color:#9C27B0;">NEISO</span>
                <h3>NEISO: The strongest case for nuclear — 15-point gain from cheap firm generation</h3>
                <p>New England faces the steepest marginal cost curve of any region. At medium costs, grid decarb only beats DAC central through 70% — the lowest crossover of any ISO. But low firm + low renewable costs push this to 85%, a 15-point gain that represents the largest catalytic effect anywhere in the study. NEISO's winter gas pipeline constraints add $13/MWh to CCS costs, making nuclear and enhanced geothermal the decisive technologies. Without firm generation cost reductions, New England hits a hard economic wall at 70%.</p>
                <span class="step-stat step-stat-red">Medium: only 70% &middot; Low firm + low RE: 85% (15-point catalytic gain)</span>
            </div>
        </div>
    </div>
</section>

<!-- SYNTHESIS: Policy levers + conclusion -->
<section class="synthesis-section">
    <div class="synthesis-inner">
        <div class="synthesis-card">
            <h3>Three policy levers, three different effects</h3>
            <p><strong>Renewable tax credits</strong> (IRA/PTC/ITC) are most catalytic in ERCOT, extending grid competitiveness to 99%. Moderate effect in PJM/CAISO. Minimal impact in the Northeast where the constraint is firm generation, not renewables.<br><br>
            <strong>Nuclear/geothermal investment</strong> (NRC licensing, DOE LPO loans, HALEU supply) is decisive in NYISO/NEISO/CAISO. Cheap firm generation shifts the DAC crossover 10–15 percentage points higher.<br><br>
            <strong>Storage costs</strong> contribute &lt;1% of variance in every region — battery/LDES prices are not the bottleneck.</p>
            <span class="step-stat step-stat-blue">RE credits: +2–5 pts &middot; Firm gen: +10–15 pts &middot; Storage: ~0 pts</span>
        </div>
        <div class="synthesis-card">
            <h3>The optimal strategy: grid to the crossover, DAC for the rest</h3>
            <p>Grid decarbonization is the cheaper abatement path to at least 85–90% in every region under any cost scenario. Past that, the right answer depends on today's policy choices. Investment in firm clean generation (nuclear, enhanced geothermal, CCS) has the largest catalytic effect — buying 10–15 additional points of grid decarb that outcompetes DAC. Renewable tax credits are necessary but not sufficient in high-cost regions. The optimal portfolio: push grid decarb to its natural crossover point, then let DAC close the gap.</p>
            <span class="step-stat step-stat-green">Grid to 85–97.5% (region-dependent) &middot; DAC for the final stretch</span>
        </div>
    </div>
</section>

<!-- SOURCES -->
<div style="max-width:1320px;margin:0 auto;padding:24px 24px 24px;">
    <details style="background:#fff;border:1px solid #E5E7EB;border-radius:10px;padding:16px 20px;">
        <summary style="font-family:'Franklin Gothic Demi','Barlow Semi Condensed',sans-serif;font-size:0.9rem;font-weight:600;color:#1A2744;cursor:pointer;">Sources &amp; References</summary>
        <ol style="font-size:0.8rem;color:#6B7280;line-height:1.8;padding-left:20px;margin-top:12px;">
            <li>EPA eGRID 2022 — regional emission rates and CO&#8322; intensity by balancing authority.</li>
            <li>EPA Social Cost of Carbon — Technical Support Document (2020), central estimate $51/metric ton.</li>
            <li>Rennert, K. et al. (2022). "Comprehensive evidence implies a higher social cost of CO&#8322;." <em>Nature</em>, 610, 687-692. $185/metric ton.</li>
            <li>EU Emissions Trading System (EU ETS) — carbon price range $60-100/metric ton.</li>
            <li>NREL Annual Technology Baseline (ATB) 2024 — technology costs for wind, solar, storage, nuclear, CCS, DAC.</li>
            <li>Lazard Levelized Cost of Energy Analysis v17.0 (2024) — generation technology cost benchmarks.</li>
            <li>EIA Hourly Electric Grid Monitor — hourly generation data by fuel type and balancing authority.</li>
            <li>IEA Net Zero by 2050 Roadmap (2023 update) — sector emission reduction benchmarks.</li>
            <li>IPCC AR6 Working Group III (2022) — power sector targets and mitigation pathways.</li>
            <li>McKinsey Marginal Abatement Cost Curve methodology — cross-sector decarbonization benchmarks.</li>
        </ol>
    </details>
</div>

<!-- FOOTER -->
<footer class="page-footer">
    <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Cost Optimizer</a>
        <a href="abatement_dashboard.html">CO&#8322; Abatement</a>
        <a href="research_paper.html">Methodology &amp; Paper</a>
        <a href="about.html">About</a>
        <a href="../power-gen-decarbonization/site/index.html">Generator Analysis</a>
    </div>
    <div class="footer-note">The 8,760 Problem &mdash; 2025 Snapshot Model</div>
</footer>
<div class="bottom-banner"></div>

<script src="js/shared-data.js"></script>
<script src="js/mac-stats-data.js"></script>
<script>
// ============================================================================
// CHART INSTANCES & STATE
// ============================================================================
let heroChart = null;
const regionCharts = {};
const yMaxHero = 700;

// ============================================================================
// (Panel switching removed — regional charts are now in static sections)
// ============================================================================

// ============================================================================
// DAC CURVE THRESHOLDS (shared by all charts)
// ============================================================================
const dacCurveThresholds = [];
for (let t = 50; t <= 100; t += 2.5) dacCurveThresholds.push(t);

function dacDatasets() {
    const dacOpt = dacCurveThresholds.map(t => ({ x: t, y: dacCostAtThreshold(t, 'optimistic') }));
    const dacCen = dacCurveThresholds.map(t => ({ x: t, y: dacCostAtThreshold(t, 'central') }));
    const dacCon = dacCurveThresholds.map(t => ({ x: t, y: dacCostAtThreshold(t, 'conservative') }));
    return [
        { label: 'DAC Optimistic', data: dacOpt, borderColor: '#E91E6366',
          borderWidth: 1.5, borderDash: [4, 3], pointRadius: 0, fill: false, tension: 0.3, order: 2, _type: 'dac' },
        { label: 'DAC Central', data: dacCen, borderColor: '#E91E6399',
          borderWidth: 2, borderDash: [6, 4], pointRadius: 0, fill: '-1', backgroundColor: 'rgba(255,193,7,0.10)', tension: 0.3, order: 2, _type: 'dac' },
        { label: 'DAC Conservative', data: dacCon, borderColor: '#E91E6344',
          borderWidth: 1.5, borderDash: [4, 3], pointRadius: 0, fill: '-1', backgroundColor: 'rgba(233,30,99,0.08)', tension: 0.3, order: 2, _type: 'dac' }
    ];
}

// ============================================================================
// BUILD HERO CHART (all regions, overview/drivers/conclusion)
// ============================================================================
function buildHeroChart() {
    const ctx = document.getElementById('heroScrollyChart')?.getContext('2d');
    if (!ctx) return;

    const regions = ['ERCOT', 'PJM', 'CAISO', 'NYISO', 'NEISO'];
    const colors = { ERCOT: '#22C55E', PJM: '#4a90d9', CAISO: '#F59E0B', NYISO: '#E91E63', NEISO: '#9C27B0' };

    const stepFan = typeof MAC_STEPWISE_FAN !== 'undefined' ? MAC_STEPWISE_FAN : null;
    const stepEnv = typeof MAC_ENVELOPE_DATA !== 'undefined' ? MAC_ENVELOPE_DATA : null;
    const avgFan = typeof MAC_FAN_DATA !== 'undefined' ? MAC_FAN_DATA : null;

    const datasets = [];
    regions.forEach((iso, rIdx) => {
        const fan = stepFan?.[iso];
        const env = stepEnv?.[iso]?.stepwise_envelope;
        const fb = avgFan?.[iso];
        if (!fan && !env) return;
        const c = colors[iso];

        const p90pts = (fan?.p90 || []).map((v, i) => {
            const val = v ?? fb?.p90?.[i] ?? null;
            return { x: THRESHOLDS[i], y: val != null ? Math.min(val, yMaxHero) : null };
        }).filter(d => d.y != null);
        const p10pts = (fan?.p10 || []).map((v, i) => {
            const val = v ?? fb?.p10?.[i] ?? null;
            return { x: THRESHOLDS[i], y: val != null ? Math.min(val, yMaxHero) : null };
        }).filter(d => d.y != null);
        const envPts = (env || fan?.p50 || []).map((v, i) => {
            const val = v ?? fb?.p50?.[i] ?? null;
            return { x: THRESHOLDS[i], y: val != null ? Math.min(val, yMaxHero) : null };
        }).filter(d => d.y != null);

        datasets.push({
            label: iso + ' P90', data: p90pts, borderColor: 'transparent', backgroundColor: c + '15',
            borderWidth: 0, pointRadius: 0, fill: '+1', tension: 0.3, order: 10,
            _region: iso, _type: 'band'
        });
        datasets.push({
            label: iso + ' P10', data: p10pts, borderColor: c + '30', backgroundColor: 'transparent',
            borderWidth: 0.5, borderDash: [2, 2], pointRadius: 0, fill: false, tension: 0.3, order: 10,
            _region: iso, _type: 'band'
        });
        datasets.push({
            label: iso, data: envPts, borderColor: c, backgroundColor: c + '10',
            borderWidth: 2.5, pointRadius: 0, fill: false, tension: 0.3, order: 5,
            _region: iso, _type: 'line'
        });
    });

    datasets.push(...dacDatasets());

    heroChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: {
                duration: 1200,
                easing: 'easeOutQuart',
                delay: ctx => ctx.type === 'data' ? ctx.dataIndex * 30 + ctx.datasetIndex * 100 : 0
            },
            scales: {
                x: {
                    type: 'linear', min: 48, max: 100,
                    afterBuildTicks: axis => { axis.ticks = [50, 60, 70, 80, 90, 95, 100].map(v => ({ value: v })); },
                    ticks: {
                        callback: v => {
                            const yearMap = { 50: "'30", 60: "'32", 70: "'35", 80: "'37", 90: "'40", 95: "'45", 100: "'50" };
                            return [v + '%', yearMap[v] || ''];
                        },
                        font: { size: 9 }, color: 'rgba(255,255,255,0.5)', maxRotation: 0
                    },
                    grid: { color: 'rgba(255,255,255,0.06)' },
                    border: { display: true, color: 'rgba(255,255,255,0.15)' },
                    title: { display: true, text: 'Clean Energy Target', color: 'rgba(255,255,255,0.35)', font: { size: 9 } }
                },
                y: {
                    min: 0, max: yMaxHero,
                    ticks: { callback: v => '$' + v, font: { size: 9 }, color: 'rgba(255,255,255,0.5)', stepSize: 100 },
                    grid: { color: 'rgba(255,255,255,0.06)' },
                    border: { display: true, color: 'rgba(255,255,255,0.15)' },
                    title: { display: true, text: '$/metric ton CO₂', color: 'rgba(255,255,255,0.35)', font: { size: 9 } }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
                datalabels: { display: false },
                annotation: { annotations: {} }
            }
        }
    });
}

// ============================================================================
// BUILD REGIONAL ENVELOPE CHART (per-region, dark background)
// ============================================================================
function buildRegionalChart(iso) {
    const canvasId = 'envScrolly_' + iso;
    const ctx = document.getElementById(canvasId)?.getContext('2d');
    if (!ctx) return;

    const stepFan = typeof MAC_STEPWISE_FAN !== 'undefined' ? MAC_STEPWISE_FAN : null;
    const stepEnv = typeof MAC_ENVELOPE_DATA !== 'undefined' ? MAC_ENVELOPE_DATA : null;
    const avgFan = typeof MAC_FAN_DATA !== 'undefined' ? MAC_FAN_DATA : null;

    const fan = stepFan?.[iso];
    const env = stepEnv?.[iso]?.stepwise_envelope;
    const fb = avgFan?.[iso];
    if (!fan && !env) return;

    const c = REGION_COLORS[iso];
    const yMax = 1200;

    const p90 = (fan?.p90 || []).map((v, i) => {
        const val = v ?? fb?.p90?.[i] ?? null;
        return { x: THRESHOLDS[i], y: val != null ? Math.min(val, yMax) : null };
    }).filter(d => d.y != null);
    const p10 = (fan?.p10 || []).map((v, i) => {
        const val = v ?? fb?.p10?.[i] ?? null;
        return { x: THRESHOLDS[i], y: val };
    }).filter(d => d.y != null);
    const midSrc = env || fan?.p50 || [];
    const p50 = midSrc.map((v, i) => {
        const val = v ?? fb?.p50?.[i] ?? null;
        return { x: THRESHOLDS[i], y: val != null ? Math.min(val, yMax) : null };
    }).filter(d => d.y != null);

    const datasets = [
        { label: 'P90', data: p90, borderColor: 'transparent', backgroundColor: c + '25',
          borderWidth: 0, pointRadius: 0, fill: '+1', tension: 0.3, order: 3 },
        { label: 'P10', data: p10, borderColor: c + '55', backgroundColor: 'transparent',
          borderWidth: 1, borderDash: [3, 3], pointRadius: 0, fill: false, tension: 0.3, order: 3 },
        { label: 'Envelope', data: p50, borderColor: c, backgroundColor: c + '18',
          borderWidth: 3, pointRadius: 3, pointBackgroundColor: c, pointBorderColor: '#000',
          pointBorderWidth: 1, pointHoverRadius: 6, fill: false, tension: 0.3, order: 1 },
        ...dacDatasets()
    ];

    // Compute dynamic Y max from data
    let dataYMax = 0;
    p90.forEach(d => { if (d.y != null && d.y < 2000) dataYMax = Math.max(dataYMax, d.y); });
    dataYMax = Math.min(Math.ceil(dataYMax / 100) * 100 + 100, 1200);

    regionCharts[iso] = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: {
                duration: 1400,
                easing: 'easeOutQuart',
                delay: ctx => ctx.type === 'data' ? ctx.dataIndex * 40 + ctx.datasetIndex * 150 : 0
            },
            scales: {
                x: {
                    type: 'linear', min: 48, max: 100,
                    afterBuildTicks: axis => { axis.ticks = [50, 60, 70, 80, 90, 95, 100].map(v => ({ value: v })); },
                    ticks: {
                        callback: v => {
                            const yearMap = { 50: "'30", 60: "'32", 70: "'35", 80: "'37", 90: "'40", 95: "'45", 100: "'50" };
                            return [v + '%', yearMap[v] || ''];
                        },
                        font: { size: 9 }, color: 'rgba(255,255,255,0.55)', maxRotation: 0
                    },
                    grid: { color: 'rgba(255,255,255,0.08)' },
                    border: { display: true, color: 'rgba(255,255,255,0.2)' },
                    title: { display: true, text: 'Clean Energy Target', color: 'rgba(255,255,255,0.4)', font: { size: 9 } }
                },
                y: {
                    min: 0, max: dataYMax,
                    ticks: { callback: v => '$' + v, font: { size: 9 }, color: 'rgba(255,255,255,0.55)', stepSize: 100 },
                    grid: { color: 'rgba(255,255,255,0.08)' },
                    border: { display: true, color: 'rgba(255,255,255,0.2)' },
                    title: { display: true, text: '$/metric ton CO₂', color: 'rgba(255,255,255,0.4)', font: { size: 9 } }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0,0,0,0.85)',
                    titleFont: { size: 11, weight: 600 },
                    bodyFont: { size: 10 },
                    cornerRadius: 8,
                    padding: 10,
                    callbacks: {
                        title: items => items[0] ? items[0].raw.x + '% Clean' : '',
                        label: item => {
                            if (item.dataset.label === 'P90' || item.dataset.label === 'P10') return null;
                            return item.dataset.label + ': $' + Math.round(item.raw.y) + '/metric ton CO₂';
                        }
                    },
                    filter: item => item.dataset.label !== 'P90' && item.dataset.label !== 'P10'
                },
                datalabels: { display: false },
                annotation: { annotations: {} }
            }
        }
    });
}

// ============================================================================
// SCROLL-TRIGGERED ANIMATIONS & LAZY CHART BUILDS
// ============================================================================
function initObservers() {
    // Fade-in observer for narrative cards and synthesis cards
    const fadeObs = new IntersectionObserver(entries => {
        entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
    }, { threshold: 0.15, rootMargin: '0px 0px -50px 0px' });

    document.querySelectorAll('.region-step-card, .synthesis-card').forEach(el => fadeObs.observe(el));

    // Lazy chart build observer for region sections
    const chartObs = new IntersectionObserver(entries => {
        entries.forEach(e => {
            if (!e.isIntersecting) return;
            const iso = e.target.getAttribute('data-region');
            if (iso && !regionCharts[iso]) {
                requestAnimationFrame(() => buildRegionalChart(iso));
            }
            chartObs.unobserve(e.target);
        });
    }, { threshold: 0.1, rootMargin: '200px 0px 200px 0px' });

    document.querySelectorAll('.region-section').forEach(el => chartObs.observe(el));
}

// ============================================================================
// INIT
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    // Build hero overview chart
    buildHeroChart();

    // Start scroll-triggered observers (lazy chart builds + fade-ins)
    initObservers();
});
</script>
</body>
</html>
